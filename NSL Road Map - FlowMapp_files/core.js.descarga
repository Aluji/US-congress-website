var cursorX,cursorY;function getServerTime(){return+new Date}function fullName(t,e){return(t&&t.length?t+" ":"")+(e&&e.length?e:"")}!function(){var o={getUser:"/flowmapp/application/getajaxdata",userStorage:"/flowmapp/application/params",test:"/flowmapp/application/test",getProjectsList:"/flowmapp/application/getprojectlist",getProjectShortList:"/flowmapp/application/getprojects",leaveproject:"/flowmapp/application/leaveproject",removeproject:"/flowmapp/application/removeproject",archiveproject:"/flowmapp/application/archiveproject",addproject:"/flowmapp/application/addproject",updateproject:"/flowmapp/application/updateproject",getproject:"/flowmapp/application/getproject",projects_uptodate:"/flowmapp/stats/project",switchprojects:"/account/members/switchprojects",duplicateProject:"/flowmapp/application/dupproject",projectRight:"/flowmapp/application/hasrights",setcover:"/flowmapp/application/setcover",getarchivelist:"/flowmapp/application/getprojectlist?archive=true",unarchiveproject:"/flowmapp/application/unarchiveproject",archive_uptodate:"/flowmapp/stats/project",friendlist:"/account/members/getlist",userlist:"/account/members/getlist",switchmembers:"/account/members/switchmembers",usersbyproject:"/account/members/getlistbyproject",removeMember:"/account/members/remove",getInviteLink:"/account/members/getinvitelink",index:"app.flowmapp.com",indexDev:"dev.flowmapp.com",flowmapp:"/flowmapp/application/getcardlist",getFlowmappData:"/flowmapp/application/getdata",getShareData:"/flowmapp/application/getshared",addflowmap:"/flowmapp/application/addcard",removeflowmap:"/flowmapp/application/removecard",flowmapdrag:"/flowmapp/application/movecard",flowmapDuplicate:"/flowmapp/application/dupcard",flowmapgetcard:"/flowmapp/application/getcard",flowmapUpdateCard:"/flowmapp/application/updatecard",flowmapCardSetLabel:"/flowmapp/application/setlabel",flowmapCardUnSetLabel:"/flowmapp/application/unsetlabel",userFlowList:"/flowmapp/userflow/getschemalist",userFlowScheme:"/flowmapp/userflow/setschema",removeFlowScheme:"/flowmapp/userflow/deleteschema",userFlowItem:"/flowmapp/userflow/setelement",removeUserFlowItem:"/flowmapp/userflow/deleteelement",getSchema:"/flowmapp/userflow/getschema",userFlowDuplicate:"/flowmapp/userflow/dupschema",flowmapDiscussionGet:"/flowmapp/discussion/get",flowmapDiscussionSend:"/flowmapp/discussion/send",flowmapDiscussionEdit:"/flowmapp/discussion/edit",flowmapDiscussionDelete:"/flowmapp/discussion/delete",flowmapAttach:"/flowmapp/application/setattach",flowmapUnAttach:"/flowmapp/application/unsetattach",userflowAttach:"/flowmapp/userflow/setattach",userflowUnAttach:"/flowmapp/userflow/unsetattach",getOrders:"/account/application/getuserorders",canUploadFile:"/checksize",userinfo:"/account/application/getuser",searchcountry:"/account/application/searchcountry",userUpdate:"/account/application/setuser",setuserPic:"/account/application/setuserpic",setPassword:"/account/application/changepass",setNotificationMod:"/account/application/setnoticefrequency",setProjectNotice:"/account/application/setprojectnotice",fastSpringProfileLink:"/account/application/getauth",updateLabel:"/account/application/updatelabel",addLabel:"/account/application/addlabel",removeLabel:"/account/application/removelabel",setUserEmailNotifications:"/account/application/setusernotice",deleteMyAccount:"/account/application/delete",exportPersonalData:"/account/application/exportmydata",getMyFiles:"/account/application/getmyfiles",activity:"/account/application/getactivity",activityUnReaded:"/account/application/unreaded",activityRead:"/account/application/read",share:"/flowmapp/share/switchshare",ping:"/account/application/ping",countryList:"/account/application/searchcountry",fsAccount:"/account/application/getauth",getTarifs:"/flowmapp/tarif/gettarif",getQuota:"/flowmapp/tarif/getquota",changePlan:"/account/payment/changeplan",cancelSubscription:"/account/payment/cancel",subscribe:"/account/payment/subscribe",continueSubscription:"/account/payment/uncancel",login:"/site/auth/login",slackAuth:"/service/application/auth",slackIntegrationTest:"/service/application/test",slackChannels:"/service/application/channels",slackGroups:"/service/application/groups",slackUsers:"/service/application/users",slackTeams:"/service/application/teams",slackRemoveAuth:"/service/application/revoke",slackSettings:"/service/application/settings",setTeam:"/account/teams/setteam",teamList:"/account/teams/teamlist",removeTeam:"/account/teams/removeteam",leaveTeam:"/account/teams/leaveteam",getTeam:"/account/teams/team",addUser:"/account/teams/adduser",switchUser:"/account/teams/switchuser",removeUser:"/account/teams/removeuser",teamValidate:"/account/teams/validate",metricCounter:"/account/application/fire",createBackup:{method:"GET",url:"/backup/application/archive"},restoreBackup:{method:"GET",url:"/backup/application/restore"},validateBackup:"/backup/application/validate",removeBackup:"/backup/application/remove",uploadBackup:"/backup/application/upload",backupList:"/backup/application/getbackuplist",setPageCoversPack:"/covers/cover/setpack",removePageCoversPack:"/covers/cover/removepack",getPageCoversPacks:"/covers/cover/getpacks",setCustomCover:"/covers/cover/setcover",removeCustomCover:"/covers/cover/removecover"};app.serverRequest=function(t,e){var i;if("string"==typeof t)if(o.hasOwnProperty(t))if("string"==typeof o[t])i={url:o[t]};else{if("object"!=typeof o[t])throw new Error('Requested endpoints("'+t+'") exist, but contain not valid data');i=o[t]}else i={url:t};else{if("object"!=typeof t||Array.isArray(t))throw new Error('Invalid property "key"! It should be object or string');i=t}var a=new Headers;a.set("http_x_requested_with","xmlhttprequest"),a.set("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");var n=$.param(e||!1);return i=Object.assign({url:"/",method:"POST",headers:a,mode:"cors",credentials:"same-origin",cache:"default"},i),n.length&&("GET"===i.method?i.url+="?"+n:"POST"===i.method&&(i.body=n)),fetch(i.url,i).then(function(t){return t.json()}).then(function(t){return t})},app.staticServerRequest=function(e,n){var t=function(){this.url=e};t.prototype={execute:function(t,e){e?(this.currentRequest&&(this.currentRequest.callbacks.length=0),this.currentRequest=this.request(t)):this.currentRequest?this.currentRequest.callbacks.push(t):this.currentRequest=this.request(t)},request:function(t){var i=this,a={callbacks:[t]};return app.serverRequest(e).then(function(e){i.currentRequest=null,a.callbacks&&a.callbacks.length&&a.callbacks.forEach(function(t){t.call(n||window,e)})}).catch(app.log),a}};var i=new t;return i.execute.bind(i)},app.upload=function(e,t){var i=new FormData;if(i.append(e.fileKey||"upload",e.file),e.data)for(var a in e.data)i.append(a,e.data[a]);var n=new XMLHttpRequest;return"function"==typeof e.progress&&(n.upload.onprogress=function(t){e.progress(Math.round(t.loaded/t.total*100))}),n.onload=n.onerror=function(){200==this.status?"function"==typeof e.done&&e.done(this.responseText):"function"==typeof e.error&&e.error(this.responseText)},n.open("POST",o[e.url]||e.url,!0),n.send(i),n},app.ajr=function(){if(0==arguments.length)return!1;var e,i={url:!!arguments[0]&&(o[arguments[0]]?"object"==typeof o[arguments[0]]?o[arguments[0]].url:o[arguments[0]]:arguments[0]),data:vod(arguments[1],!1),method:vod(arguments[2],"post","string"),dataType:vod(arguments[3],"json","string"),headers:vod(arguments[4],{http_x_requested_with:"xmlhttprequest"},"object"),cb:vod(arguments[arguments.length-1],!1,"function")||vod(arguments[arguments.length-2],!1,"function"),quiet:vod(arguments[arguments.length-1],!1,"boolean"),success:function(t){i.quiet||(app.log("%c server request to "+this.url+" successfully end in "+(+new Date-e)+"ms",console_styles.war),app.log(t)),this.cb&&this.cb(t)},error:function(t){i.quiet||(app.log("%c server request to "+this.url+" unsuccessfully end in "+(+new Date-e)+"ms",console_styles.error),app.log(t),app.log(t.responseText))}};return e=+new Date,$.ajax(i)}}(),document.onmousemove=function(t){cursorX=t.pageX,cursorY=t.pageY},jQuery.event.special.destroyed={remove:function(t){t.handler&&t.handler()}},function(e){$.fn.attr=function(){if(0!==arguments.length)return e.apply(this,arguments);if(0===this.length)return null;var t={};return $.each(this[0].attributes,function(){this.specified&&(t[this.name]=this.value)}),t}}(jQuery.fn.attr),jQuery.fn.transform=function(t){return t=Object.assign({x:0,y:0,o:1,z:1,s:1,p:!0},t),this.css({transform:"translate("+t.x+"px, "+t.y+"px) scale("+t.s+")",opacity:t.o,"pointer-events":t.hasOwnProperty("p")?"auto":"none","z-index":t.o?t.z:1})},jQuery.fn.setTransform=function(t){var e={};return(t.hasOwnProperty("x")||t.hasOwnProperty("y")||t.hasOwnProperty("s"))&&(e.transform="translate( "+(t.x||0)+"px, "+(t.y||0)+"px ) scale("+(t.s||1)+") rotate("+(t.r||0)+"deg)"),t.hasOwnProperty("o")&&(e.opacity=t.o),t.hasOwnProperty("z")&&(e["z-index"]=t.z),t.hasOwnProperty("p")&&(e["pointer-events"]="boolean"==typeof t.p?t.p?"auto":"none":t.p),this.css(e)},function(a){a.fn.setBackground=function(t){return"string"==typeof t&&(t={url:t}),t=Object.assign({url:"",loader:"cover",default:!1},t),this.each(function(){var e=a(this);if(t.url&&t.url.length){var i="function"==typeof t.loader?t.loader:e.loader(t.loader);app.img(t.url).then(function(t){e.css("background-image","url("+t+")"),i.done()},function(){t.default&&e.css("background-image","url("+t.default+")"),i.done()})}else t.default&&e.css("background-image","url("+t.default+")")})},a.fn.setCover=function(t){var o=a(this);return new Promise(function(i,a){if(t instanceof File&&-1<["jpeg","jpg","png"].indexOf(t.name.split(".").pop())&&t.size<=105e4){var n=o.loader("coverLoad");app.upload({file:t,url:"setcover",progress:function(t){n.state(t)},done:function(e){(e=JSON.parse(e)).status?app.img(e.file.filename).then(function(t){o.css("background-image","url("+t+")"),n.done(),i({id:e.file.id,img:t})},function(){n.done(),a()}):(n.done(),a())},error:function(t){n.done(),a()}})}else app.modules.get("alert",{type:"alert",heading:"Can't upload this file",content:"Use formats .jpg .png. The size of the file does not more 1Mb. Best resolution 278⨯184",buttons:["Ok"]}),a()})}}(jQuery),function(c){c.fn.clickOutside=function(e,i){var a=this,n=null;i=Object.assign({mouseButton:1,once:!1},i||{});var o=function(t){return!c(t.target).closest(a).length&&[].concat(i.mouseButton).includes(t.which)},t=function(t){n=o(t)?c(t.target):null},s=function(t){n&&o(t)&&n.is(t.target)&&(e(t),i.once&&r())},r=function(){c(document).off("mousedown",t),c(document).off("mouseup",s)};return c(document).on("mousedown",t),c(document).on("mouseup",s),r}}(jQuery),function(c){c.fn.mouseLeaveTimer=function(){var n=[],o=vod(arguments[arguments.length-1],!1,"number")||vod(arguments[arguments.length-2],3e3,"number"),s=vod(arguments[0],function(){},"function"),r=vod(arguments[arguments.length-1],!1,"boolean");return r&&(o/=2),this.each(function(){var e,i=c(this),a=function(){clearTimeout(e)},t=function(t){a(),e=setTimeout(function(){s(i)},t||o)};i.hover(function(){a()},function(){t()}),n.push({fn:i.off,context:i,args:["mouseenter mouseleave"]}),r&&t(2*o)}),function(){n.forEach(function(t){t.fn.apply(t.context,[t.args])}),n.length=0}}}(jQuery),jQuery.fn.onTransitionEnd=function(i){return new Promise(function(t,e){transitionEndEventName?(this.one(transitionEndEventName,t),i&&setTimeout(t,2*i)):i&&setTimeout(t,i)}.bind(this))},jQuery.event.special.scrolldelta={delegateType:"scroll",bindType:"scroll",handle:function(t){var e,i=t.handleObj,a=jQuery.data(t.target),n=t.target,o=n===document,s=a.top||0,r=a.left||0;return a.top=o?n.documentElement.scrollTop+n.body.scrollTop:n.scrollTop,a.left=o?n.documentElement.scrollLeft+n.body.scrollLeft:n.scrollLeft,t.scrollTopDelta=a.top-s,t.scrollTop=a.top,t.scrollLeftDelta=a.left-r,t.scrollLeft=a.left,t.type=i.origType,e=i.handler.apply(this,arguments),t.type=i.type,e}},function(e){var a={get button_blue(){return{bar:!1,background:"inherit",signBackground:"inherit",colHeight:14,colWidth:3,colBackground:"#fff",margin:3}},get button(){return{bar:!1,background:"inherit",signBackground:"inherit",colHeight:14,colWidth:3,colBackground:"#fff",margin:3,signWidth:"auto",signHeight:"auto",signBorder:"none"}},get block(){return{background:"rgba(255,255,255,1)"}},get blockLight(){return{background:"rgba(255,255,255,1)",signBackground:"rgba(255,255,255,0)",signBorder:"1px solid rgba(255,255,255,0)"}},get input(){return{background:"rgba(255,255,255,0)",signBackground:"inherit",signBorder:"none"}},get cover(){return{bar:!1,background:"rgba(255,255,255,0.8)",signBackground:"rgba(255,255,255,0)",signBorder:"1px solid rgba(255,255,255,0)",colHeight:14,colWidth:3,colBackground:"rgb(77, 150, 224)",margin:3,signWidth:"auto",signHeight:"auto"}},get coverLoad(){return{bar:!0,background:"rgba(255,255,255,0.8)",signBackground:"rgba(255,255,255,0)",signBorder:"1px solid rgba(255,255,255,0)",barBackground:"#58a8f7",colHeight:14,colWidth:3,colBackground:"rgb(77, 150, 224)",margin:3,signWidth:"auto",signHeight:"auto"}},get coverLight(){return{bar:!1,background:"rgba(255,255,255,0)",signBackground:"rgba(255,255,255,0)",signBorder:"1px solid rgba(255,255,255,0)",colHeight:14,colWidth:3,colBackground:"rgb(77, 150, 224)",margin:3,signWidth:"auto",signHeight:"auto"}},get backstage(){return{bar:!0,background:"#F0F4F7",signBackground:"rgba(255,255,255,0)",signBorder:"1px solid rgba(255,255,255,0)",colHeight:14,colWidth:3,colBackground:"rgb(77, 150, 224)",margin:3,signWidth:"auto",signHeight:"auto"}},get flowmapCard(){return{bar:!1,background:"rgba(255,255,255,0.4)",signBackground:"rgba(255,255,255,0.8)",colHeight:14,colWidth:3,colBackground:"rgb(77, 150, 224)",margin:3}},get modalOverlay(){return{bar:!1,background:"rgba(82,86,95,.25)",signBackground:"none",signBorder:"none",colHeight:14,colWidth:3,colBackground:"rgb(77, 150, 224)",margin:3,signWidth:"auto",signHeight:"auto"}},get modal(){return{bar:!1,background:"none",signBackground:"none",signBorder:"none",colHeight:14,colWidth:3,colBackground:"rgb(77, 150, 224)",margin:3,signWidth:"auto",signHeight:"auto"}}},i=function(t,e,i){this.step=0,this.target=t,this.settings="object"==typeof e?this.defineSettings(e):"string"==typeof e?this.defineSettings(a[e]||{}):this.defineSettings({}),this.param=Object.assign({mod:!1,autoLoader:!1},i||{}),this.define(),this.inject(t),t.data("loader",this)};i.prototype={autoLoader:function(){var t=0;this.timer=setInterval(function(){t+=0<=t&&t<.2?.1:.2<=t&&t<.5?.04:.5<=t&&t<.8?.02:.8<=t&&t<.99?.005:0,this.state(100*t)}.bind(this),this.param.loaderInterval||150)},done:function(t){this.timer&&(clearInterval(this.timer),this.state(100)),t?this.dom.remove():this.dom.fadeOut(150,e.fn.remove.bind(this.dom)),this.target.removeData("loader")},defineSettings:function(t){return Object.assign({width:"",height:"",background:"rgba(255,255,255,1)",signWidth:"44px",signHeight:"32px",signBackground:"#eaeaea",signBorder:"1px solid rgba(88,168,247,.11)",colBackground:"#58a8f7",colWidth:"4px",colHeight:"22px",bar:!1,barBackground:"rgb(77, 150, 224)",barHeight:"3px",barWidth:"100%",barTop:0,barLeft:0,margin:4},t)},state:function(t){this.bar.css("width",t+"%")},define:function(){this.bar=this.dom.find(".bar"),this.param.autoLoader&&this.autoLoader()},inject:function(t){this.param.fastInject?(this.dom.addClass("active"),this.dom.appendTo(t)):(this.dom.appendTo(t),forceReflow(this.dom),this.dom.addClass("active"))},get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){var t='<div class="block__loader '+app.modules.get("html").clarify(this.param.mod,"block__loader")+'" data-role="loader"><div class="progress"><div data-role="bar" class="bar"></div></div><div class="sign"><div class="col"></div><div class="col"></div><div class="col"></div></div></div>';return(t=e(t)).css({background:this.settings.background}),t.find(".progress").css({width:this.settings.barWidth,height:this.settings.barHeight,left:this.settings.barLeft,top:this.settings.barTop,display:this.settings.bar?"block":"none"}),this.settings.bar?(this.bar=t.find(".bar"),this.bar.css({background:this.settings.barBackground})):t.find(".bar").hide(),t.find(".sign").css({width:this.settings.signWidth,height:this.settings.signHeight,background:this.settings.signBackground,border:this.settings.signBorder}),t.find(".col").css({width:this.settings.colWidth,height:this.settings.colHeight,background:this.settings.colBackground}),t.find(".col").eq(1).css({margin:"0 "+this.settings.margin+"px"}),this.param.style&&t.css(this.param.style),t}},e.fn.loader=function(t,e){return this.data("loader")?this.data("loader"):new i(this,t,e)}}(jQuery),function(i){var a=function(t,e,i){this.data=t,this.settings=e,this.parent=i,this.bind()};a.prototype={get id(){return this.data.value},get value(){return this.data.value},get searchName(){return this._searhName||(this._searhName=this.data.text.replace(/ /g,"")),this._searhName},index:function(t){var e=t?this.searchName.search(t):-1;return 0<=e?this.dom.html(this.data.text.replace(t,'<span class="matched">$&</span>')):(this.dom.html(this.data.text),e=9999999),e},get select(){return!!this._select},set select(t){equals(t,this.state)||(this._select=t,this.dom.toggleClass("selected",t),this.settings.multiple&&setTimeout(function(){this.dom.find("input").prop("checked",t)}.bind(this),10))},get template(){return i((this.settings.multiple?this.settings.optionMultipleTemplate:this.settings.optionTemplate).replace(/#(.+?)#/g,function(t){var e=t.replace(/#/g,"");return this.data.hasOwnProperty(e)?this.data[e]:t}.bind(this)))},get dom(){return this._dom||(this._dom=this.template),this._dom},bind:function(){this.dom.on("click",function(t){t.preventDefault(),t.stopPropagation(),!this.settings.multiple&&this.select||this.parent.select(this.id)}.bind(this))}};var e=function(t,e){e=Object.assign({},n,e),this.selectDom=t,this.selectValue={},this.settings=e,this.options=[],this.settings.multiple&&this.selectDom.attr("multiple","multiple"),this.defineOptions().then(function(){this.settings.value?this.select(this.settings.value,!0):this.selectDom.val("")}.bind(this)),this.bind(),t.data("flowmapSelect",this)},n={method:"init",labels:!(e.prototype={get state(){return!!this._state},set state(t){equals(t,this.state)||((this._state=t)?(this.dom.append(this.optionbox),this.optionbox.toggleClass("select__optionbox--top",this.direction),forceReflow(this.dom),this.dom.addClass("open")):(this.searchBox&&(this.searchBox.find("input").val(""),this.search=""),this.dom.removeClass("open"),this.optionbox.onTransitionEnd(150).then(function(){this.state||this.optionbox.detach()}.bind(this))))},set search(t){t=!!(t=t.replace(/ /g,"")).length&&t,equals(t,this.search)||((this._search=t)||this.options.forEach(function(t){t.index(!1)}),this.view())},get search(){return this._search||!1},get orderList(){if(this.search){var e=new RegExp(this.search.split("").join(" ?"),"i");return this.options.forEach(function(t){t.searchIndex=t.index(e)}),this.options.sort(function(t,e){return t.searchIndex-e.searchIndex})}return this.settings.search?this.options.sort(function(t,e){return t.searchName<e.searchName?-1:t.searchName>e.searchName?1:0}):this.options},view:function(){this.selectbox.html(this.placeholder);var i=this.entryPoint;this.orderList.forEach(function(t){var e=t.dom;e.detach(),e.appendTo(i)})},updateSelectbox:function(){this.selectbox.html(this.placeholder)},get direction(){return this.dom.height()+this.dom.offset().top+this.optionbox.height()+10>i(window).scrollTop()+i(window).height()},setValue:function(t){var e=this.getOption(t.id);if(e){if(this.settings.multiple){var i=t.hasOwnProperty("state")?t.state:!e.select;(e.select=i)?this.selectValue[t.id]=!0:this.selectValue.hasOwnProperty(t.id)&&delete this.selectValue[t.id],this.view()}else this.selectValue&&this.getOption(this.selectValue.id)&&(this.getOption(this.selectValue.id).select=!1),this.selectValue=t,this.state=!1,this.updateSelectbox();this.selectDom.val(this.value)}},select:function(t,e){convertToPromise(t).then(function(t){[].concat(t).forEach(function(t){this.getOption(t)?this.setValue({id:t}):(this.selectValue&&this.getOption(this.selectValue.id)&&(this.getOption(this.selectValue.id).select=!1),this.selectValue=!1,this.updateSelectbox())},this),e||this.selectDom.trigger("change")}.bind(this))},get value(){return this.settings.multiple?this.selectValue.mapToArray(function(t,e){return e}):this.selectValue.id},get length(){return Object.keys(this.options).length},getOption:function(e){return this.options.find(function(t){return t.id==e})},get placeholder(){if(this.settings.multiple){var t=Object.keys(this.selectValue).length;return t>this.settings.maxResultVisible?this.settings.manySelected.replace("#C#",t).replace("#M#",this.length):0<t?this.selectValue.mapToArray(function(t,e){var i=this.getOption(e);return!!i&&i.data.text},this).join(this.settings.separateSymbol):'<div class="select__placeholder select__placeholder--empty">'+this.settings.placeholder+"</div>"}return this.selectValue&&Object.keys(this.selectValue).length?'<div class="select__placeholder">'+this.getOption(this.selectValue.id).template.html()+"</div>":this.settings.placeholderOption&&this.getOption(this.settings.placeholderOption.id)?'<div class="select__placeholder">'+this.getOption(this.settings.placeholderOption.id).template.html()+"</div>":'<div class="select__placeholder select__placeholder--empty">'+this.settings.placeholder+"</div>"},parseOption:function(t){return i.makeArray(t.find("option")).map(function(t){return t=i(t),Object.assign({value:t.attr("value"),text:t.html()},t.data())})},defineOptions:function(){var e=this.parseOption(this.selectDom),t=this.dom.loader("cover");return Promise.resolve(!0).then(function(){if(this.settings.hasOwnProperty("options")){if(this.settings.options instanceof Promise)return this.settings.options.then(function(t){Array.prototype.push.apply(e,t)}.bind(this));if("function"==typeof this.settings.options)return Array.prototype.push.apply(e,this.settings.options());if(Array.isArray(this.settings.options))return Array.prototype.push.apply(e,this.settings.options)}}.bind(this)).then(function(){this.addOption(e.map(function(t){return"string"==typeof t?{value:t,text:t}:t})),t.done()}.bind(this))},addOption:function(t){[].concat(t).forEach(function(t){var e=new a(t,this.settings,this);this.options.find(function(t){return t.id==e.id})||(this.options.push(e),this.selectDom.find('option[value="'+e.value+'"]').length||this.selectDom.append('<option value="'+e.value+'"></option>'))}.bind(this)),this.view()},bind:function(){var t=this;this.selectbox.on("click",function(t){this.state=!this.state}.bind(this)),this.clickOutside=this.dom.clickOutside(function(){this.state&&(this.state=!1)}.bind(this)),this.searchBox&&this.searchBox.on("input","input",function(){t.search=i(this).val()})},get entryPoint(){return this._entryPoint||(this._entryPoint=this.optionbox.find(".select__list")),this._entryPoint},get selectbox(){return this._selectbox||(this._selectbox=this.dom.find(".select__selectbox")),this._selectbox},get optionbox(){return this._optionbox||(this._optionbox=i('<div class="select__optionbox"><div class="select__list"></div></div>')),this._optionbox},get dom(){return this._dom||(this._dom=this.template,this._dom.append(this.selectDom)),this._dom},get template(){var t=i('<div class="select"><div class="select__selectbox"></div></div>');return t.append(this.optionbox),this.settings.search&&(this.searchBox=i('<div class="select__search"></div>').append(this.settings.searchTemplate),this.optionbox.prepend(this.searchBox)),this.settings.scroll&&(i('<div class="select__scroller"></div>').wrapInner(t.find(".select__list")).appendTo(this.optionbox).customScroll(),this.settings.height&&t.find(".select__scroller").css("height",this.settings.height)),this.settings.height&&(this.settings.scroll?t.find(".select__scroller").css("height",this.settings.height):this.optionbox.css("height",this.settings.height)),this.optionbox.detach(),t}}),multiple:!1,search:!1,searchTemplate:'<div class="input input--main input--narrow input--horizontal input--icon"><div class="input__container"><input placeholder="" value="" type="text"><div class="input__decorations"></div><div class="svg-icon svg-icon--search "><svg><use xlink:href="/app/img/svg-sprite.svg#icon-search"></use></svg></div></div></div>',searchPlaceholder:"Search",placeholder:"Select something",placeholderOption:!1,chosenText:"",optionTemplate:'<div class="select__option">#text#</div>',optionMultipleTemplate:'<div class="select__option"> <div class="input input--main input--checkbox input--lightlabel input--lightlabelweight"> <label class="input__label">#text#</label> <div class="input__container"> <input type="checkbox"> <span class="indicator"></span> </div> </div> </div>',separateSymbol:", ",maxResultVisible:3,manySelected:"#C# of #M# selected",maxHeight:6,button:!0,buttonText:"Choose",customTag:{option_box:[],option_wrapper:[]},ajax:!1,url:"",ajax_type:"get",ajax_headers:{},ajax_key_text:"text",ajax_key_value:"value",ajax_value:!1},o={init:function(t){return this.data("flowmapSelect")?this.data("flowmapSelect"):new e(this,t)},value:function(t,e){o.init.call(this).select(t,e)},update:function(){},die:function(){},add:function(){},clear:function(){}};i.fn.flowmapSelect=function(){var t=vod(arguments[0],"init","string"),e=argsToArray({arguments:arguments}).slice(1*(1<arguments.length));if(o.hasOwnProperty(t))return o[t].apply(i(this),e)}}(jQuery),function(n){n.fn.customScroll=function(i){var a=app.modules.get("html");return i=Object.assign({drt:"v",mod:!1},i||{}),this.each(function(){var t=n(this);if(t.data("custom_scroll"))return!1;var e=t.wrapInner(a({param:{class:"scroller "+a.clarify(i.mod,"scroller")}})).children();switch(e.attr("data-scroll",!0),i.drt){case"v":e.append('<div class="scroller__track"><div class="scroller__bar"></div></div>').baron({bar:".scroller__bar",direction:"v"});break;case"h":e.append('<div class="scroller__track scroller__track-h"><div class="scroller__bar scroller__bar-h"></div></div>').baron({bar:".scroller__bar-h",direction:"v"});break;case"bi":e.append('<div class="scroller__track"><div class="scroller__bar"></div></div>').append('<div class="scroller__track scroller__track-h"><div class="scroller__bar scroller__bar-h"></div></div>').baron({bar:".scroller__bar",direction:"v"}).baron({bar:".scroller__bar-h",direction:"h"})}t.data("custom_scroll",!0)})}}(jQuery),function(t){var a=function(t,e,i){return this.state=!1,this.target=t,this.settings=Object.assign({clickOutside:!0},i||{}),this.target.append(this.dom),this.bind(),e&&this.insert(e),this.open(),this.api};a.prototype={insert:function(t){this.dom.html(""),this.dom.append(t instanceof jQuery?t:app.modules.get("html",t))},calculateDirection:function(){},open:function(){this.calculateDirection(),setTimeout(function(){this.settings.mark&&this.target.addClass(this.settings.mark),this.dom.addClass("open"),this.state=!0}.bind(this),20)},close:function(){this.state&&!this.fixed&&(this.settings.mark&&this.target.removeClass(this.settings.mark),this.dom.addClass("close"),setTimeout(function(){this.die(),this.target.removeData("popover")}.bind(this),170),this.onClose&&(this.onClose(),this.onClose=null))},get dom(){if(!this._dom){var t={};this.settings.width&&(t.width=this.settings.width),this.settings.height&&(t.height=this.settings.height),this._dom=app.modules.get("html",{name:"popover",param:{mod:this.settings.mod||!1,style:Object.assign(t,this.settings.style||{})}})}return this._dom},bind:function(){this.settings.clickOutside&&(this.clickOutside=this.dom.clickOutside(function(){this.close()}.bind(this),"object"==typeof this.settings.clickOutside?this.settings.clickOutside:{})),this.settings.mouseleave&&this.settings.mouseleaveDelay&&(this.mouse=!0,this.settings.mouseleave.on("mouseleave",{_this:this},this.mouseleave),this.settings.mouseleave.on("mouseenter",{_this:this},this.mouseenter)),this.settings.stopEvent&&this.dom.click(function(t){t.stopPropagation()})},mouseenter:function(t){t.data._this.mouse=!0},mouseleave:function(t){var e=t.data._this;e.mouse=!1,setTimeout(function(){e.mouse||e.close()},e.settings.mouseleaveDelay||150)},unbind:function(){this.dom.off(),this.clickOutside(),this.settings.mouseleave&&(this.settings.mouseleave.off("mouseleave",this.mouseleave),this.settings.mouseleave.off("mouseenter",this.mouseenter)),this.dom.find("[data-scroll]").baron().dispose()},die:function(){this.unbind(),this.dom.remove()},get api(){return{bind:function(){return t.fn.on.apply(this.dom,arguments)}.bind(this),close:this.close.bind(this),insert:this.insert.bind(this),onClose:function(t){this.onClose=t}.bind(this),fixed:function(t){this.fixed=!!t}.bind(this),dom:this.dom}}},t.fn.popover=function(t,e){if(!this.data("popover")){var i=new a(this,t,e);return this.data("popover",i),i}this.data("popover").close()}}(jQuery),function(i){i.fn.inputFocus=function(e){return this.each(function(){var t=i(this).is(":input")?i(this):i(this).find(":input").length?i(this).find(":input"):i(this);t.is("select")||(t.focus(),e&&t.get(0).select())})},i.fn.inputBlur=function(){(window.getSelection?window.getSelection():document.selection).focusNode}}(jQuery),function(i){i.fn.insert=function(){var t=argsToArray({arguments:arguments});return this.each(function(){var e=i(this).html("");t.forEach(function(t){e.append(t)})})}}(jQuery),function(l){l.fn.makeMeScroll=function(t){var e=l(this);for(var i in e.stop(),t)if(t[i]){var a=t[i],n="x"==i?"scrollLeft":"scrollTop",o="x"==i?"maxScrollLeft":"maxScrollTop",s={},r=e[n](),c=a.drt?e[o]():0;s[n]=c,e.animate(s,{duration:Math.abs(r-c)*a.speed,queue:!1,easing:"linear"})}}}(jQuery),function(i){i.fn.getEventsList=function(t){var e=i._data(this.get(0),"events")||{};return t?e[t]||null:e}}(jQuery),function(n){var t=function(t,e,i){n.fn[t].apply(this,argsToArray(i));var a=this.getEventsList();e.forEach(function(t){var e=a[t];Array.isArray(e)&&Array.prototype.unshift.apply(e,e.splice(-1,1))})};n.fn.onBefore=function(){t.apply(this,["on",arguments[0].split(" "),{arguments:arguments}])},n.fn.oneBefore=function(){t.apply(this,["one",arguments[0].split(" "),{arguments:arguments}])}}(jQuery),jQuery.fn.cssComputed=function(t){var e=this.get(0),i="";return window.getComputedStyle?i=document.defaultView.getComputedStyle(e,null).getPropertyValue(t):e.currentStyle&&(i=e.currentStyle[t]),i},jQuery.fn.writeJson=function(t){var e=JSON.stringify(t,null,"\t");["input","textarea"].includes(this.get(0).nodeName.toLowerCase())?this.val(e):this.html(e),this.css("white-space","pre")},function(i){i.fn.flash=function(e){return i(this).each(function(){var t=i(this);t.data("$.fn.flash")||(t.addClass(e),t.data("$.fn.flash",!0),t.onTransitionEnd(200).then(function(){t.removeClass(e),t.removeData("$.fn.flash")}))})}}(jQuery),function(c){c.fn.maxScrollLeft=function(){return this.get(0).maxScrollLeft},c.fn.maxScrollTop=function(){return this.get(0).maxScrollTop},c.fn.translate=function(t,e){return this.each(function(){c(this).css("transform","translate("+t+"px,"+e+"px)")})},c.fn.getTranslate=function(){var t=getComputedTranslate(this);return{x:t[4],y:t[5]}},c.fn.serializeJson=function(){var t=this.find(":input"),a={};return t.each(function(){var t=this.name,e=c(this).val(),i=this.type;"radio"===i&&!this.checked||!t.length||"checkbox"===i&&!this.checked||!t.length||(void 0!==a[t]?Array.isArray(a[t])?a[t].push(e):a[t]=[a[t],e]:a[t]=e)}),a},c.fn.serializeFormData=function(){var t=this.find(":input"),a=new FormData;return t.each(function(){var t=this.name,e=c(this).val(),i=this.type;"radio"===i&&!this.checked||!t.length||"checkbox"===i&&!this.checked||!t.length||(void 0!==a[t]?Array.isArray(a[t])?a[t].push(e):a[t]=[a[t],e]:"file"===i?e.length&&a.append(t,this.files[0]):a.append(t,e))}),a},c.fn.elmTimer=function(t,e,i){var a,n=this,o=n.data("timer");e=e||2e3,i=i||e/2;on=function(){clearTimeout(a)},out=function(){clearTimeout(a),a=setTimeout(end,i)},end=function(){n.data("timer",!1),clearTimeout(a),t()},init=function(){n.data("timer",!0),a=setTimeout(end,e),n.on("mouseenter",on).on("mouseleave",out)},o?end():init()},c.fn.autoheight=function(){var n=this,o=n.get(0),s=n.outerHeight();this.data("rows");this.on("input keyup",function(t){var e=t.keyCode,i=t.metaKey||t.ctrlKey;if(13==e||88==e&&i)n.css("height",0),n.css("height",o.scrollHeight);else{app.log("no key code");var a=o.scrollHeight+o.offsetHeight-o.clientHeight;s<a?(app.log(a),n.css("height",a)):n.css("height",s)}})},jQuery.upload=function(){var t=vod(arguments[0],!1),e=vod(arguments[1],{},"object"),i=vod(arguments[2],!1,"string")||vod(arguments[1],!1,"string"),a=vod(arguments[arguments.length-2],!1,"function"),n=vod(arguments[arguments.length-1],!1,"function");if(!t||!i)return!1;var o=new FormData;if(o.append("upload",t),o)for(var s in e)o.append(s,e[s]);var r=new XMLHttpRequest;r.upload.onprogress=function(t){var e=Math.round(t.loaded/t.total*100);a(e)},r.onload=r.onerror=function(){this.status,n(this.responseText)},c.ajr("/checksize",{size:t.size},function(t){t.can_upload?(r.open("POST",i,!0),r.send(o)):c.alert("fileQuotaExceeded",appData.thisUserInfoMore.disc,function(t){t&&(location="/upgradeplan")})})},c.fn.liveSearch=function(){this.find('[data-role="live_search"]').each(function(){var t=c(this),e=t.find(".js-liveinput"),i=t.find(".js-livelist"),a=t.find(".js-liveresult"),n=e.attr("formaction"),o=(a.attr("name"),e.data("live-title")),s=e.data("live-value");e.data().init&&e.data().init.live_search||e.on("input",function(){if(e.val().length){var t=e.serialize();c.ajr(n,t,"get",function(t){var e="";t.forEach(function(t){e+='<option value="'+t[s]+'">'+t[o]+"</option>"}),i.html(e)})}})})},c.fn.attrList=function(){for(var t=this.get(0).attributes,e=t.length,i={};e--;)i[t[e].name]=t[e].value;return i}}(jQuery);var List=function(t){this._list=[],t&&this.call(t);var i=this;return function(t,e){return i.call(t,e)}};List.prototype={call:function(t,e){if(Array.isArray(t))this._list=this._list.concat(t);else if("function"==typeof t)this.parse(t,e);else if("object"==typeof t)return this.find(t,e);return this._list},find:function(t,e){var i=!1,a=t.key,n=t.value;return this.parse(function(t,e){if(t[a]==n)return!(i={index:e,value:t})},this),i},parse:function(i,a){this._list.some(function(t,e){return 0==i.call(a||t,t,e)})}};var AllButtonsStateConstructor=function(){return this.mouse={},this.keyboard={},this.init()};AllButtonsStateConstructor.prototype={init:function(){var e=this;return $(document).on("keydown",function(t){e.keyboard[t.keyCode]=!0}),$(document).on("keyup",function(t){e.keyboard[t.keyCode]=!1}),$(document).on("mousedown",function(t){e.mouse[t.which]=!0}),$(document).on("mouseup",function(t){e.mouse[t.which]=!1}),this},check:function(t,e){return e?!!this[e]&&!!this[e][t]:!!this.keyboard[t]||!!this.mouse[t]}};var sideTools,buttonsState=new AllButtonsStateConstructor;!function(){var i={action:["NEW_PROJECT","UPDATE_PROJECT","UPDATE_PROJECT_DESCRIPTION","UPDATE_PROJECT_TITLE","NEW_CARD","CARD_UPDATED","CARD_REMOVED","CARD_UPDATED_TITLE","CARD_UPDATED_DESCRIPTION","CARD_UPDATED_PAGESTRUCTURE","USER_JOINED","USER_LEFT","USER_REMOVED","ADD_TO_PROJECT","USERFLOW_CREATE","USERFLOW_DELETE","USERFLOW_CHANGE_TITLE"],comments:["MENTION","DISCUSSION","MENTION_PROJECT","PROJECT_MENTION","DISCUSSION_PROJECT","USERFLOW_DISCUSSION"]},t=["ADD_TO_PROJECT","MENTION","MENTION_PROJECT","PROJECT_MENTION","USERFLOW_CREATE","USERFLOW_DELETE","USERFLOW_CHANGE_TITLE","USERFLOW_CHANGE_DESCRIPTION","USERFLOW_MENTION","USERFLOW_DISCUSSION"],a=["ADD_TO_PROJECT","MENTION","MENTION_PROJECT","PROJECT_MENTION"],o={NEW_PROJECT:'<b>###senderName###</b> created project <a class="link link--green" href="###project_link###" target="_blank">###project_name###</a>',UPDATE_PROJECT_OLD:'<b>###senderName###</b> updated project <a class="link" href="###project_link###" target="_blank">###project_name###</a>',UPDATE_PROJECT_TITLE:'<b>###senderName###</b> changed project name from <a class="link link--gray link--dead" >###titles.add_old_title###</a> to <a class="link link--green" href="###project_link###" target="_blank">###project_name###</a>',UPDATE_PROJECT_TITLE_OLD:'<b>###senderName###</b> changed project name of <a class="link" href="###project_link###" target="_blank">###project_name###</a>',REMOVE_PROJECT:'<b>###senderName###</b> deleted project <a class="link link--gray link--dead" href="" target="_blank">###project_name###</a>',UPDATE_PROJECT_DESCRIPTION:'<b>###senderName###</b> edited project description on <a class="link" href="###project_link####info" target="_blank">###project_name###</a>',DISCUSSION_PROJECT:'<b>###senderName###</b> commented project description on <a class="link" href="###project_link####info" target="_blank">###project_name###</a>',PROJECT_MENTION:'<b>###senderName###</b> commented project description on <a class="link" href="###project_link####info" target="_blank">###project_name###</a>',USER_JOINED:'<b>###senderName###</b> joined the project <a class="link" href="###project_link###" target="_blank">###project_name###</a>',USER_LEFT:'<b>###senderName###</b> left the project <a class="link" href="###project_link###" target="_blank">###project_name###</a>',PROJECT_ARCHIVATED:'<b>###senderName###</b> archived project <a class="link" href="###project_link###" target="_blank">###project_name###</a>',PROJECT_UNARCHIVATED:'<b>###senderName###</b> unarchived project <a class="link" href="###project_link###" target="_blank">###project_name###</a>',ADD_TO_PROJECT:'<b>###senderName###</b> invited you to project <a class="link" href="###project_link###" target="_blank">###project_name###</a>',USER_REMOVED:'<b>###senderName###</b> removed user <b>###titles.add_removed_name|||titles.add_removed_login###</b> from project <a class="link" href="###project_link###" target="_blank">###project_name###</a>',USER_REMOVED_OLD:'<b>###senderName###</b> was removed from project <a class="link" href="###project_link###" target="_blank">###project_name###</a>',NEW_CARD:'<b>###senderName###</b> created page <a class="link link--green" href="###card_link###" target="_blank">###card_title###</a>',CARD_REMOVED:'<b>###senderName###</b> deleted page <a class="link link--gray link--dead" href="###card_link###" target="_blank">###card_title###</a>',CARD_UPDATED_TITLE:'<b>###senderName###</b> changed page name from <a class="link link--gray link--dead">###titles.add_old_title###</a> to <a class="link link--green" href="###card_link###" target="_blank">###card_title###</a>',CARD_UPDATED_TITLE_OLD:'<b>###senderName###</b> changed page name of <a class="link" href="###card_link###" target="_blank">###card_title###</a>',CARD_UPDATED_DESCRIPTION:'<b>###senderName###</b> edited page description on <a class="link" href="###card_link###" target="_blank">###card_title###</a>',DISCUSSION:'<b>###senderName###</b> commented page <a class="link" href="###card_link###" target="_blank">###card_title###</a>',MENTION:'<b>###senderName###</b> commented page <a class="link" href="###card_link###" target="_blank">###card_title###</a>',CARD_UPDATED_PAGESTRUCTURE:'<b>###senderName###</b> edited the page structure of <a class="link" href="###card_link###" target="_blank">###card_title###</a>',USERFLOW_CREATE:'<b>###senderName###</b> created user flow <a class="link link--green" href="###userflow_link###" target="_blank">###userflow_title###</a>',USERFLOW_DELETE:'<b>###senderName###</b> deleted user flow <a class="link link--gray link--dead" href="###userflow_link###" target="_blank">###userflow_title###</a>',USERFLOW_CHANGE_TITLE:'<b>###senderName###</b> user flow name from <a class="link link--gray link--dead">###titles.add_old_title###</a> to <a class="link link--green" href="###userflow_link###" target="_blank">###titles.add_new_title###</a>',USERFLOW_CHANGE_DESCRIPTION:'<b>###senderName###</b> edited user flow description on <a class="link" href="###userflow_link####info" target="_blank">###userflow_title###</a>',USERFLOW_CHANGE_DESCRIPTIONS_OLD:"<b>###senderName###</b> change userflow description",USERFLOW_DISCUSSION:'<b>###senderName###</b> commented user flow <a class="link" href="###userflow_link####info" target="_blank">###userflow_title###</a>',USERFLOW_MENTION:'<b>###senderName###</b> commented user flow <a class="link" href="###userflow_link####info" target="_blank">###userflow_title###</a>',TEAM_USER_REMOVED:"<b>###titles.add_team_member###</b> left the team «<b>###titles.add_team###</b>»",TEAM_USER_APPEND:"<b>###titles.add_team_member###</b> joined the team «<b>###titles.add_team###</b>»"},n={version0:function(t){var e={},i=t.event_code;if(e.senderName=t.sender_name,e.senderAvatar=t.sender_userpic,e.date=t.date_create,e.project_id=t.project_id,e.project_title=t.project_title,e.event=i,e.project_name=t.project_title,e.project_link="/projects/"+t.project_id,e.card_title=t.card_title,e.card_link=e.project_link+"/"+t.card_id,e.titles={},e.readed=!!(1*t.is_readed),e.id=t.id,["USERFLOW_CREATE","USERFLOW_DELETE","USERFLOW_CHANGE_TITLE"].includes(i)){var a=parseBadJson(t.message);e.userflow_link=e.project_link+"/"+a.id,e.userflow_title=a.title,e.titles.add_old_title=a.old_title,e.titles.add_new_title=a.title}else["USERFLOW_DISCUSSION","USERFLOW_MENTION"].includes(i)?(e.outputMessage=parseBadJson(t.message),e.userflow_link=e.project_link+"/"+t.card_id,e.userflow_title=t.card_title):["DISCUSSION","MENTION","DISCUSSION_PROJECT","PROJECT_MENTION"].includes(i)?e.outputMessage=parseBadJson(t.message):["ADD_TO_PROJECT","USER_JOINED","CARD_UPDATED_PAGESTRUCTURE","CARD_REMOVED","NEW_CARD","UPDATE_PROJECT_DESCRIPTION","CARD_UPDATED_DESCRIPTION","NEW_PROJECT"].includes(i)||(e.event=i+"_OLD");return e},version1:function(t){var e={};return t.message=parseBadJson(t.message),t.titles=parseBadJson(t.titles),e.senderName=fullName(t.titles.from_first_name,t.titles.from_last_name),e.customerName=fullName(t.titles.to_first_name,t.titles.to_last_name),e.senderAvatar=t.titles.from_userpic||!1,e.event=t.event_code,e.date=t.date_create,e.project_id=t.project_id,e.project_title=t.project_title,e.readed=!!(1*t.is_readed),e.id=t.id,"project"===t.entity&&(e.project_name=t.titles.title||"Unknown project",e.project_link="/projects/"+t.entity_id),"card"===t.entity&&(e.card_title=t.titles.title,e.card_link="/projects/"+t.titles.project_id+"#"+t.entity_id),"userflow"===t.entity&&(e.userflow_title=t.titles.title,e.userflow_link="/projects/"+t.titles.project_id+"/userflow/"+t.entity_id),["TEAM_USER_REMOVED","TEAM_USER_APPEND"].includes(t.event_code)&&(e.senderAvatar=safetyObjectAccess(t,["titles","add_team_member_img"],!1)),["DISCUSSION","MENTION","DISCUSSION_PROJECT","USERFLOW_DISCUSSION","PROJECT_MENTION","USERFLOW_MENTION"].includes(t.event_code)&&(e.outputMessage=parseBadJson(t.message.entity)),e.titles=t.titles,e.message=t.message,e}};app.activity={init:function(){Subscriber(this),app.getReady().then(this.autoUpdateState.bind(this)),this.bind()},openModal:function(){if(this.modal)return!1;this.modal=new e,this.modal.modal.subscriber("on",{event:"close"},function(){this.modal=null}.bind(this))},get headerIcon(){return $("header.header").find(".js-notification")},get unreaded(){return this._unreaded||{}},set unreaded(t){var e=0;for(var i in t)t[i]<=0?delete t[i]:e+=t[i];e&&(t.all=e),this._unreaded=t,this.subscriber("add",{event:"unreaded"})},autoUpdateState:function(){var e=this,t=app.staticServerRequest("activityUnReaded");timeLoop(function(){t(function(t){e.unreaded=t},!0)},9e3)},bind:function(){this.subscriber("on",{event:"unreaded"},function(){this.headerIcon.toggleClass("active",!!Object.keys(this.unreaded).length)}.bind(this))}};var e=function(){this.beforeDieExecuting=[],this.modal=app.modules.get("modal",{mod:["side","right","transparent","large"]}),this.modal.insert(this.dom),this.selectedSection="all",this.bind(),setTimeout(this.renderActivityList.bind(this),350),setTimeout(this.modal.open,150)};e.prototype={get selectedSection(){return this._selectedSection||"all"},set selectedSection(t){equals(t,this.selectedSection)||(this._selectedSection=t,this.renderActivityList())},renderActivityList:function(){this.activityList&&this.activityList.die(),this.activityList=!1,this.resetFilter(),this.activityList=new s(this.selectedSection,this.activityListContainer)},projectList:function(){var a=this,t=app.modules.get("html"),e=t({name:"table",param:{mod:["pointer","hover","stretch"],contentHeight:"100%",contentScroll:!0}}).addClass(".js-project-list"),n=e.find(".fm-table__content"),i=t({name:"panel",param:{heading:$("<h4>Projects</h4>"),mod:"stretch"},content:e}).css("width",210),o=[{id:"all",title:"All project",date_update:9999999999999}];e.on("click","[data-project-id]",function(){$(this).addClass("selected").siblings().removeClass("selected"),a.selectedSection=$(this).data("projectId")});var s=function(){o.sort(function(t,e){return e.date_update-t.date_update}),n.insert(t(o.map(function(t){var e=app.activity.unreaded.hasOwnProperty(t.id)?app.activity.unreaded[t.id]:0;return{name:"row",param:{attr:{"data-project-id":t.id},selected:t.id==a.selectedSection},content:$('<div class="activity__project"> <div class="project">'+t.title+'</div><span class="activity__unreaded" data-value="'+e+'"></span></div>')}})))};Array.prototype.push.apply(o,app.projects.getBy({archive:!1}));var r=app.projects.subscriber("on",function(t){t.forEach(function(t){var e=t.data;switch(t.event){case"add":0==e.archive&&(o.find(function(t){return t.id==e.id})||(o.push(e),s()));break;case"remove":0<=(i=o.findIndex(function(t){return t.id==e.id}))&&(o.remove(i),n.find('[data-project-id="'+e.id+'"]').remove(),e.id==a.selectedSection&&(n.find('[data-project-id="all"]').addClass("selected"),a.selectedSection="all"));break;case"update":var i;0<=(i=o.findIndex(function(t){return t.id==e.id}))&&(o[i]=e,s())}}.bind(this))}.bind(this));this.beforeDieExecuting.push({fn:app.projects.subscriber,ctx:this,args:["off",r]});var c=app.activity.subscriber("on",{event:"unreaded"},function(t){n.find("[data-project-id]").each(function(){var t=$(this).data("project-id");$(this).find("[data-value]").attr("data-value",app.activity.unreaded.hasOwnProperty(t)?app.activity.unreaded[t]:0)})});return this.beforeDieExecuting.push({fn:app.activity.subscriber,ctx:this,args:["off",c]}),s(),i},bind:function(){this.modal.subscriber("on",{event:"close"},function(){this.beforeDieExecuting.forEach(function(t){t.fn.apply(t.ctx||window,t.args)}),this.activityList&&this.activityList.die(),this.modal=null}.bind(this))},get activityListContainer(){return this._activityListContainer||(this._activityListContainer=this.dom.find(".js-activity-list")),this._activityListContainer},filter:function(t){if(!arguments.length)return this._filter||{};for(var e in t=Object.assign(this.filter(),t))t[e]||delete t[e];this._filter=t,this.activityList&&this.activityList.filter(t)},resetFilter:function(){this.activityListHeading.find('input[name="forme"]').prop("checked",!1),this.activityListHeading.find('select[name="mod"]').flowmapSelect("value","false")},get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){var i=this,t=app.modules.get("html"),e=$('<div class="activity__heading"><h3 class="title">Latest Activity</h3></div>'),a=$('<div class="activity__content"></div>'),n=t({name:"panel",param:{heading:t([$("<h4>Notifications</h4>"),{name:"input",param:{mod:["checkbox","auto"],type:"checkbox",label:"For me",value:"true",checked:!1,name:"forme",callback:function(t){var e={};e[t.name]=t.state,i.filter(e)}}},{name:"input",param:{type:"select",name:"mod",mod:["narrow","short","horizontal"],options:[{text:"All",value:"false"},{text:"Updates",value:"action"},{text:"Comments",value:"comments"},{text:"Unread",value:"unreaded"}],label:"Show",value:"false",placeholder:"Placeholder",callback:function(t){var e={};e[t.name]="false"!=t.value&&t.value,i.filter(e)}}}]),mod:"stretch"}}).css("width","calc(100% - 220px)");return this.activityListHeading=n.find(".fm-panel__heading"),a.append(this.projectList()),a.append(n),n.find(".fm-panel__content").addClass("js-activity-list"),t([e,a])},open:function(){var t=app.modules.get("modal",{mod:["side","right","transparent","large"]}),e=app.modules.get("html")({name:"panel",param:{heading:$("<h4>Projects</h4>"),mod:"stretch"},content:{name:"table",param:{mod:["striped","hover","stretch"],contentHeight:"100%",contentScroll:!0}}}).css("width",210);content.append(e),content.append(project_list),t.insert([heading,content]),setTimeout(function(){t.open()},300)}};var s=function(t,e){this.id=t,this.viewCount=50,this.viewPage=0,this.list=[],this.mod="all"==t?"all":"project",this.groups=[],this.bind(),e.append(this.dom),this.loadMore(),this.getBeforeInterval=setInterval(this.loadBefore.bind(this),4e3),debug=this};s.prototype={get viewLength(){return this._viewLength||0},set viewLength(t){this.viewLength!=t&&(this._viewLength=t)},get emptyState(){return this._emptyState||0},set emptyState(t){if(!equals(this.emptyState,t)){if(this._emptyState=t,this.placeholder){var e=this.placeholder;e.removeClass("open"),setTimeout(function(){e.remove()},150),this.placeholder=null}switch(t){case 1:this.placeholder=app.modules.get("html",{name:"emptyPlaceholder",param:{template:"activityEmpty",mod:"absolute"}}).appendTo(this.dom),setTimeout(function(){this.placeholder.addClass("open")}.bind(this),20);break;case 2:this.placeholder=app.modules.get("html",{name:"emptyPlaceholder",param:{template:"activityNotFound",mod:"absolute"}}).appendTo(this.dom),setTimeout(function(){this.placeholder.addClass("open")}.bind(this),20)}}},clearList:function(){this.groups.forEach(function(t){t.remove()}),this.list.length=0,this.groups.length=0,this.viewPage=0,this.inTheEnd=!1,this.loadMore()},filter:function(t){if(void 0===t)return this._filter;this._filter=t,this.clearList()},get inTheEnd(){return this._inTheEnd||!1},set inTheEnd(t){equals(t,this.inTheEnd)||((this._inTheEnd=t)?this.loadBlock.hide():this.loadBlock.show())},get loaderData(){var t=Object.assign({},this.filter());return"all"!=this.id&&(t.project_id=this.id),t},get complementListLoader(){if(this._complementListLoader)return this._complementListLoader;var t=Object.assign(this.loaderData,{count:this.viewCount,page:this.viewPage});return this._complementListLoader=app.serverRequest("activity",t).then(function(t){return this.viewPage++,this._complementListLoader=null,t&&t.length<this.viewCount&&(this.inTheEnd=!0),this.appendToList(t.filter(function(e){return e.date_create=app.clientTime(e.date_create),e.project_id||(e.project_id="all",e.project_title="Teams update",e.project_link="/people"),!this.list.find(function(t){return e.id==t.id})}.bind(this))),t}.bind(this)),this._complementListLoader},loadMore:function(){if(this._loadMore)return!1;var t=this,e=this.list.length?this.loadBlock.loader("blockLight",{mod:"instantly"}):this.dom.loader("blockLight",{mod:"instantly"});return t._loadMore=!0,this.complementListLoader.then(function(){t._loadMore=!1,e.done()})},appendToList:function(t){var n=this;t.map(function(t){return new c(t,n)}).forEach(function(e){var t=this.groups.find(function(t){return t.day==e.day});if(t)t.append(e);else{(t=new r("day","all"==n.mod?"project":"self")).append(e);for(var i=!1,a=0;a<this.groups.length;a++)if(t.day>this.groups[a].day){this.groups[a].dom.before(t.dom),i=!0;break}this.groups.push(t),i||this.listContainer.append(t.dom)}}.bind(this)),Array.prototype.push.apply(this.list,t),this.list.sort(function(t,e){return e.date_create-t.date_create}),this.viewLength=this.list.length,this.viewLength?this.emptyState=0:this.inTheEnd?this.list.length?this.emptyState=2:this.emptyState=1:(this.emptyState=0,this.loadMore())},bind:function(){var t=this;this.scroller.on("scroll",function(){$(this).maxScrollTop()-$(this).scrollTop()<=10&&!t.inTheEnd&&t.loadMore()})},get scroller(){return this._scroller||(this._scroller=this.dom.find("[data-scroll]")),this._scroller},get loadBlock(){return this._loadBlock||(this._loadBlock=this.dom.find(".js-load-more")),this._loadBlock},get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){var t=this,e=$('<div class="activity__loader js-load-more"></div>');e.append(app.modules.get("html",{name:"link",param:{callback:function(){t.loadMore()}},content:"Load more"}));var i=$('<div class="activity__list"><div class="activity__timeline"></div></div>'),a=$('<div class="activity__container"></div>').append($('<div class="activity__scroller" data-scroll></div>').append(i).append(e).customScroll());return this.listContainer=i,a},loadBefore:function(){var t=this.loaderData,a=!!this.list.length&&this.list[0].id;a&&(t.by=a),app.serverRequest("activity",t).then(function(t){a&&t.findAndRemove(function(t){return t.id==a});var i=this.list.map(function(t){return t.id}),e=t.reduce(function(t,e){return i.includes(e.id)||t.push(e),t},[]);e.length&&this.appendToList(e)}.bind(this))},die:function(){this.dom.find("[data-scroll]").baron().dispose(),this.dom.off(),this.dom.remove(),clearInterval(this.getBeforeInterval),this._dom=null}};var r=function(t,e){this.mod=t,this.appendMod=e,this.list=[]};r.prototype={append:function(e){var t=!1;if("self"==this.appendMod){for(var i=0;i<this.list.length;i++)if(e.date>this.list[i].date){this.list[i].dom.before(e.dom),t=!0;break}this.list.push(e),t||this.dom.append(e.dom)}else if("project"==this.appendMod){var a=this.list.find(function(t){return t.projectId==e.projectId});if(a)a.append(e);else{(a=new r("project","self")).append(e);for(i=0;i<this.list.length;i++)if(a.date>this.list[i].date){this.list[0].dom.before(a.dom),t=!0;break}this.list.push(a),t||this.dom.append(a.dom)}}return this.list.sort(function(t,e){return e.date-t.date}),e},get display(){return"boolean"!=typeof this._display||this._display},set display(t){equals(this.display,t)||((this._display=t)?this.dom.show():this.dom.hide())},filter:function(i){this._filter=i;var t=this.list.reduce(function(t,e){return e.filter(i)+t},0);return this.display=!!t,t},get day(){return this.list[0]?this.list[0].day:0},get date(){return Math.max(Math,this.list.map(function(t){return t.date}).concat(0))},get projectId(){return this.list[0]?this.list[0].projectId:0},get title(){return"day"==this.mod?formatDate(this.day,"M d. yyyy"):app.modules.get("html",{name:"link",param:{internal:!0,href:"/projects/"+this.projectId,target:"_blank",mod:"heading"},content:safetyObjectAccess(app.projects.get(this.projectId),["title"],!1)||safetyObjectAccess(this.list.find(function(t){return t.data.hasOwnProperty("project_title")&&!!t.data.project_title}),["data","project_title"],!1)||"Unknown"})},get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){var t=$('<div class="activity__group activity__group--'+this.mod+'"><div class="activity__caption"><div class="activity__title"></div><div class="activity__hide"></div></div></div>');return t.find(".activity__title").append(this.title),t},remove:function(){this.list.forEach(function(t){t.remove()}),this.dom.remove()}};var c=function(t,e){this.oldData=Object.assign({},t),this.version="version"+(t.version||0),this.data=n.hasOwnProperty(this.version)?n[this.version](t):n.version0(t),this.eventMod=ObjectFindKey(i,function(t,e){return 0<=t.indexOf(this.data.event_code)},this),this.selfMod=0<=a.indexOf(this.data.event_code)};c.prototype={get event(){return this.data.event},get id(){return this.data.id},get important(){return t.includes(this.event)},get readed(){return!!this.data.readed},get highlight(){return this._highlight||this.important&&!this.readed},set highlight(t){equals(this.highlight,t)||(this._highlight=t,this.dom.toggleClass("activity__item--highlight",t))},get display(){return"boolean"!=typeof this._display||this._display},set display(t){equals(this.display,t)||((this._display=t)?this.dom.show():this.dom.hide())},filter:function(t){var e=!0;for(var i in t)if(this[i]!=t[i]){e=!1;break}e=!0;for(var i in t)if(!t[i].includes(this[event_code])){e=!1;break}return e},get day(){return this._day||(this._day=+new Date(this.date).dayToStart()),this._day},get date(){return this.data.date},get projectId(){return this.data.project_id},get time(){return formatDate(this.data.date,"h:min som")},get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){var t,n,e=this,i=$('<p class="strong"></p>');return o.hasOwnProperty(this.event)?i.html((t=o[this.event],n=this.data,t.replace(/###(.+?)###/g,function(t){for(var e=t.replace(/#/g,"").split("|||"),i=0;i<e.length;i++){var a=safetyObjectAccess(n,e[i].split("."),!1);if(a)return a}return"unknown"}))):(i=$('<p class="strong"><b>Unhandled event</b><br><b>Event:</b> '+this.event+"<br><b>Version:</b> "+this.version+"</p>"),console.line(),app.log("PLEASE CHECK IT"),app.log(this.event),app.log(this),console.line()),app.modules.get("html",{param:{class:"activity__item"+(this.highlight?" activity__item--highlight":""),bind:!!this.highlight&&{mouseover:function(){app.serverRequest("activityRead",{id:[e.id]}),e.highlight=!1,$(this).off()}}},content:[{param:{class:"activity__pin"}},{param:{class:"activity__time"},content:this.time},{param:{class:"activity__avatar",call:{fn:$.fn.setBackground,args:[this.data.senderAvatar]}}},{param:{class:"activity__subject"},content:[{param:{class:"activity__event"},content:i},this.data.outputMessage?{param:{class:"activity__message"},content:{name:"quillTemplate",param:{data:this.data.outputMessage}}}:""]}]})},remove:function(){this.dom.off(),this.dom.remove()}},app.activity.init()}(),app.backup={list:function(t){var e=+new Date;return(!this._list||t||this._list.date+9e3>e)&&(this._list={date:e,data:app.serverRequest("backupList").then(function(t){return t.mapToArray(function(t,e){var i=t.title||"Unknown Project",a=i.replace(/ /g,"_"),n=t.project_id||"noneid",o=t.ctime;return{id:safetyObjectAccess(t,["file","id"],!1),name:e,date_create:o,displayName:formatDate(o,"M dd.yyyy h:min som"),project_id:n,project_name:i,owner_id:t.owner_id,owner_name:t.owner_name||"User unknown",fileName:[a+"("+n+")","backup",formatDate(o,"yyyy-mm-dd--hh--min-sec").replace(/-/g,"_")].join("_")+".fmb",fileLink:safetyObjectAccess(t,["file","filename"],"javascript:void(0);")}}).sort(function(t,e){return e.date_create-t.date_create})})}),this._list.data},create:function(a){return this.validate(a).then(function(t){return!!t&&new Promise(function(t,e){var i=!1;app.modules.get("modalTemplates","backup",{mod:"create",submit:function(e,t){this.chainRequest("createBackup",{projectID:a},function(t){e.onStep(t.step,t.message)}).then(function(t){t.state?(e.onDone(t.step,t),i=!0):e.onError(t.message)}).catch(function(){app.log(err),e.onError("Recovery Error")})}.bind(this),close:function(){t(i)}})}.bind(this))}.bind(this))},restore:function(a){return this.validate().then(function(t){return!!t&&new Promise(function(t,e){var i=!1;app.modules.get("modalTemplates","backup",{mod:"restore",submit:function(e,t){this.chainRequest("restoreBackup",Object.assign({id:a.id},t),function(t){e.onStep(t.step,t.message)}).then(function(t){t.state?(e.onDone(t.step,t),i=!0):e.onError(t.message)}).catch(function(){app.log(err),e.onError("Recovery Error")})}.bind(this),team:app.teams.list().then(function(t){var e=safetyObjectAccess(app.projects.get(a.project_id),["owner_id"],!1),i=e&&t.find(function(t){return e===t.owner_id});return{list:t,value:safetyObjectAccess(i,["id"],"false")}}),close:function(){t(i)}})}.bind(this))}.bind(this))},validate:function(t){return app.serverRequest("validateBackup",{projectID:t}).then(function(t){if(!1===t.status)switch(t.error){case"ERR_BACKUP_NOT_AVAILIABLE":case"ERR_USER_QUOTA_EXCITED":app.modules.get("modalTemplates","upgradeSubscriptionModal","projectBackup");break;case"ERR_OWNER_QUOTA_EXCITED":app.modules.get("alert",{type:"alert",heading:"Project Backup",content:"The project owner must upgrade subscription plan to make backup functions available for this project.\n",buttons:["Ok"]});break;case"ERR_TEAM_ACCESS_DENIED":app.modules.get("alert",{type:"alert",heading:"Project Backup",content:"You must be a part of the Project owner's Team to be able to create project’s backup",buttons:["Ok"]});break;case"ERR_PROJECT_NOT_FOUND":default:app.excuse()}return t.status})},upload:function(n){return this.validate().then(function(t){return!!t&&new Promise(function(t,e){var a=!1;app.modules.get("modalTemplates","backup",{mod:"upload",submit:function(i,t){app.upload({file:n,url:"uploadBackup",data:t,progress:function(t){i.onStep(t,"File uploading")},done:function(t){i.onStep(0,"Recovery initialization");var e=JSON.parse(t);e.status&&e.nextUrl?setTimeout(function(){this.chainRequest({url:e.nextUrl,method:"GET"},!1,function(t){i.onStep(t.step,t.message)}).then(function(t){t.state?(i.onDone(t.step,t),a=!0,app.projects.updateList(!0)):i.onError(t.message)}).catch(function(t){app.log(t),i.onError("Recovery Error")})}.bind(this),1e3):i.onError("Cant upload file!")}.bind(this),error:function(){i.onError("Cant upload file!")}})}.bind(this),team:app.teams.list().then(function(t){return{list:t,value:User.getUserSettings(["lastSelectedTeam"],"false")}}),close:function(){t(a)}})}.bind(this))}.bind(this))},remove:function(a){return new Promise(function(i,t){app.modules.get("alert",{heading:"Delete Backup copy",wfc:!0,content:"This copy will be deleted from your account.",buttons:["Delete Backup","Cancel"]},function(t,e){!0===t?app.serverRequest("removeBackup",{id:[].concat(a)}).then(function(t){e(),i(!0)}):(e(),i(!1))})})},chainRequest:function(t,e,r){var c=function(t){var e=safetyObjectAccess(t,["data","nextUrl"],!1);if(t.state){var i=safetyObjectAccess(t,["data","maxFiles"],0),a=safetyObjectAccess(t,["data","currFile"],i),n=safetyObjectAccess(t,["data","step"],0)+a,o=safetyObjectAccess(t,["data","total"],1)+i,s=Math.round(n/o*100);if("DONE"===t.state_desc)return Object.assign(t,{step:Math.round(s)});if(e)return r({message:t.message,step:Math.round(s)}),app.serverRequest({url:e,method:"GET"}).then(c)}return{state:!1,message:"Could not connect with flowmapp backup servers!"}};return app.serverRequest(t,e).then(c)}},app.canUpload=function(t){return app.serverRequest("canUploadFile",{size:t}).then(function(t){return!!t.can_upload})},function(){var a={init:function(){return app.data("help").then(function(t){var n={coord:{},direction:{vertical:"bottom",horizontal:"center"},active:!0,count:!0,point:!0,target:".content",container:"body",targetBox:!0,zIndex:127,contentType:!1,position:"absolute"};return this.list=t,this.list.forEach(function(a){for(var t in n)a.hasOwnProperty(t)||(a[t]=n[t]);return a.content=[].concat(a.content).map(function(t){for(var e in n)t.hasOwnProperty(e)||(t[e]=a[e]);if("simple"===t.contentType&&2===t.content.length&&(t.content=t.content.map(function(t,e){return"string"==typeof t?{name:"paragraph",param:{mod:!e&&["big","bold"]},content:t}:t})),t.hasOwnProperty("coord"))for(var i in t.coord)t.coord[i]*=1;return t}),a}),this.bind(),t}.bind(this),app.log)},get events(){return this.list.reduce(function(t,e){return e.active&&t.push(e.event),t},[])},startTour:function(e){if(this.currentTip)return!1;"string"==typeof e&&(e=this.list.find(function(t){return t.name===e})),e&&(this.currentTip=new t(e))},bind:function(){this.subscriberKey=app.subscriber("on",function(t){t.some(function(t){var e=t.event;if(this.currentTip&&this.currentTip.data.closeEvents.includes(e)&&this.currentTip.die(),!this.currentTip){var i=this.list.find(function(t){return!!toBoolean(t.active)&&(!toBoolean(User.getUserSettings(["help","readed",t.name],!1))&&!0!==t.readed&&(!(t.pageFilter&&![].concat(t.pageFilter).includes(safetyObjectAccess(app,["pages","current","data","name"])))&&(!![].concat(t.event).includes(e)&&!t.content.some(function(t){var e=$(t.container);if(!e.length||toBoolean(t.target)&&!e.find(t.target).length)return!0}))))});if(i)return setTimeout(function(){this.startTour(i)}.bind(this),i.delay||0),!0}},this)}.bind(this))},reset:function(t){User.setUserSettings(["help","readed"],this.list.reduce(function(t,e){return e.readed=!1,t[e.name]=!1,t},{})),t&&location.reload(!0)},skipAll:function(){User.setUserSettings(["help","readed"],this.list.reduce(function(t,e){return e.readed=!0,t[e.name]=!0,t},{})),this.currentTip&&this.currentTip.die()}},t=function(t){this.data=t,this.slides=[].concat(t.content),this.index=0,this.renderSlide(this.index)};t.prototype={die:function(t){this.sticker.close(),this.hidePoint(this.point),t&&this.markReaded(),a.currentTip===this&&(a.currentTip=null),this.dead=!0},markReaded:function(){this.data.readed=!0,User.setUserSettings(["help","readed",this.data.name],!0)},showPoint:function(t,e,i,a){var n=app.modules.get("html",{param:{class:"fm-help__point",style:Object.assign({},t,{position:i,"z-index":a-1})}});return $(e).append(n),forceReflow(n),n.addClass("show"),n},hidePoint:function(t){t&&(t.removeClass("show"),t.onTransitionEnd(200).then(function(){t.remove()}))},updateBar:function(){1<this.slides.length&&this.data.count&&(this.counter.find(".fm-help__count").text(this.index+1+"/"+this.slides.length),this.counter.find(".fm-help__bar").css("transform","scaleX("+(this.index+1)/this.slides.length+")"))},renderSlide:function(){this.sticker&&void 0!==this.prevIndex&&this.slides[this.prevIndex].container===this.slides[this.index].container?this.updateSlide(this.slides[this.index]):(this.sticker&&(this.sticker.currentSticker.dom.css("height",this.sticker.currentSticker.dom.outerHeight()),this.sticker.close()),this.generateSlide(this.slides[this.index])),this.prevIndex=this.index,this.slides.length-1===this.index&&setTimeout(function(){this.dead||this.markReaded()}.bind(this),2e3)},updateSlide:function(t){this.hidePoint(this.point);var e=this.calcPointCoord(t);toBoolean(t.point)&&(this.point=this.showPoint(e,t.container,t.position,t.zIndex));var i=this.calcTipCoord(e,t.direction,t.point);this.actionContainer.insert(app.modules.get("html",this.generateAction(t))),this.contentContainer.insert(app.modules.get("html",t.content)),this.sticker.currentSticker.dom.css(Object.assign({},i,{position:t.position,"z-index":t.zIndex})),this.updateBar()},generateSlide:function(t){this.hidePoint(this.point);var e=this.calcPointCoord(t);toBoolean(t.point)&&(this.point=this.showPoint(e,t.container,t.position,t.zIndex));var i=this.calcTipCoord(e,t.direction,toBoolean(t.point));this.sticker=app.modules.get("sticker",{heading:!!(1<this.slides.length&&this.data.count)&&this.counter,body:this.contentContainer.insert(app.modules.get("html",t.content)),actions:this.actionContainer.insert(app.modules.get("html",this.generateAction(t)))},{close:!1,size:t.size||{width:280,height:"auto"},style:{position:t.position,"z-index":t.zIndex},target:t.container,position:i}),this.updateBar(),setTimeout(function(){this.sticker.currentSticker.dom.css({transition:"0.3s ease-in-out"})}.bind(this),100)},generateAction:function(t){if(!t.actions)return{name:"buttonRow",content:1<this.slides.length?[{name:"button",param:{mod:["narrow","blue"],attr:{"data-help":this.index+1<this.slides.length?"next":"close"},style:{"min-width":"90px"},text:this.index+1<this.slides.length?"Next tip":"End tour"}},{name:"link",param:{attr:{"data-help":this.index+1<this.slides.length?"close":"restart"}},content:this.index+1<this.slides.length?"Skip tour":"Restart tour"}]:[{name:"button",param:{mod:["narrow","blue"],attr:{"data-help":"close"},style:"min-width: 90px",text:"Got it!"}}]}},calcPointCoord:function(t){var e=$(t.container||"body"),i=!!toBoolean(t.target)&&(e.is(t.target)?e:e.find(t.target));if(i&&i.length){var a={},n=e.get(0).getBoundingClientRect(),o=i.get(0).getBoundingClientRect(),s=o.left-n.left,r=o.right-n.right,c=o.top-n.top,l=o.bottom-n.bottom,d=o.width,h=o.height,u=t.targetBox?0:o.height,p=t.targetBox?0:o.width;return t.coord.hasOwnProperty("left")?(a.left=s+t.coord.left+p,a.right=""):t.coord.hasOwnProperty("right")?(a.right=r+t.coord.right-p,a.left=""):(a.left=s+d/2,a.right=""),t.coord.hasOwnProperty("top")?(a.top=c+t.coord.top+u,a.bottom=""):t.coord.hasOwnProperty("bottom")?(a.bottom=l+t.coord.bottom-u,a.top=""):(a.top=c+h/2,a.bottom=""),a}return t.coord},calcTipCoord:function(t,e,i){var a=i?38:0,n=i?38:0,o={left:0,top:0},s=t;if(i){switch(e.horizontal){case"left":o.left="-100%",s.left+=a;break;case"mid":case"middle":case"center":o.left="-50%";break;case"right":o.left="0%",s.left-=a}switch(e.vertical){case"top":o.top="-100%",s.top-=n;break;case"mid":case"middle":case"center":o.top="-50%";break;case"bottom":case"bot":o.top="0%",s.top+=n}}return s.transform="translate("+o.left+", "+o.top+")",s},eventHandler:function(t){var e=$(t.target),i=e.closest("[data-help]").data("help");switch(t.preventDefault(),t.stopPropagation(),i){case"next":++this.index<this.slides.length?this.renderSlide():this.die();break;case"close":this.die(!0);break;case"tour":this.die(!0),a.startTour(e.data("tour"));break;case"restart":this.index=0,this.renderSlide()}},get counter(){return this._counter||(this._counter=app.modules.get("html",{param:{class:"fm-help__progress"},content:[{param:{class:"fm-help__count"},content:this.index+1+"/"+this.slides.length},{param:{class:"fm-help__rail"},content:{param:{class:"fm-help__bar",style:{transform:"scaleX("+(this.index+1)/this.slides.length+")"}}}}]})),this._counter},get contentContainer(){return this._slideContainer||(this._slideContainer=app.modules.get("html",{param:{style:{position:"relative",transition:"0.3s ease-out"},callback:$.proxy(this.eventHandler,this)}})),this._slideContainer},get actionContainer(){return this._actionContainer||(this._actionContainer=app.modules.get("html",{param:{callback:$.proxy(this.eventHandler,this)}})),this._actionContainer},get slideTemplate(){}};app.help=a}(),function(){var e={sticker:function(t){return app.modules.get("sticker",t.content,t.param)},welcome:function(t){t.insert=app.modules.get("html",t.insert);var e=app.modules.get("modal",t);return t.insert.on("click",'[data-welcome="close"]',function(){e.close(),toBoolean($(this).data("skip-tour"))&&app.help.skipAll()}),e.open(),e}};app.message={init:function(){User.auth&&(this.list=[],this.instructions=[],this.loadData.then(function(t){this.instructions=t.instructions,this.list=this.sortList(this.filterList(t.list)),this.view()}.bind(this)))},approveRules:function(t){if(t&&Array.isArray(t)&&t.length){var e=!0,i=function(t){return Array.isArray(t)?safetyObjectAccess(window[t[0]],t.slice(1,-1),t[t.length-1]):t};return t.forEach(function(t){(function(t,e,i){switch(i){case"=":return t===e;case"<":return t<e;case">":return e<t}})(i(t.a),i(t.b),t.sign)||(e=!1)}),e}return!0},filterList:function(t){var e=User.getUserSettings(["mesages","readed"],{});return t.filter(function(t){return!toBoolean(e[t.id])&&!1!==t.show&&!1!==t.show&&this.approveRules(t.rules)}.bind(this))},sortList:function(t){return t},get loadData(){return app.data("messages")},view:function(){if(!this.currentMessage){var t=this.getMessageToShow();t&&this.showMessage(t)}},getMessageToShow:function(){return this.list[0]},showMessage:function(t){if(this.markReaded(t),e.hasOwnProperty(t.type))return this.currentMessage=e[t.type](t.data),this.currentMessage;this.view()},markReaded:function(t){User.setUserSettings(["mesages","readed",t.id],!0)}},app.getReady().then(function(){setTimeout(function(){app.message.init()},1e3)})}(),function(){app.pageCovers={getPacks:function(t){return Promise.all([this.loadPacks(t),this.defaultCovers]).then(function(t){return Array.prototype.concat.apply([],t)})},createPack:function(t){var e=this,i=!1,a=this.canCreate(t);return a.result?(i=a.team,app.modules.get("modalTemplates","coverPack",{team:i,showTeam:!t}).then(function(t){return!(!t||!t.result)&&app.serverRequest("setPageCoversPack",t.data).then(function(t){return t.status?t:(e.error(t.message),!1)})}).catch(this.error)):(this.error(a.error),Promise.resolve(!1))},canCreate:function(t){var e=!1,i=!1,a=!1,n=t&&app.projects.get(t)||!1;if(t)if(n&&!n.archive){var o=n.owner_id,s=app.teams.lastListData.find(function(t){return t.owner_id===o});o===User.id?"free"===User.tarif?a="user_quota_excited":e=!0:s?(e=!0,i=s.id):a="team_access_denied"}else a="project_not_found";else"free"===User.tarif?a="user_quota_excited":e=!0;return{result:e,team:i,error:a}},error:function(t){switch(t){case"team_access_denied":app.modules.get("alert",{type:"alert",heading:"Create Page Cover pack",content:"You must be a part of the Project owner's Team to be able to create custom Covers.",buttons:["Ok"]});break;case"user_quota_excited":app.modules.get("modalTemplates","upgradeSubscriptionModal","pageCovers");break;case"project_not_found":app.excuse();break;default:app.modules.get("alert",{type:"alert",heading:"Page cover pack create",content:"Unrecognized error: "+t,buttons:["Ok"]})}},get defaultCovers(){return this._defaultCovers||(this._defaultCovers=app.data("pageCovers").then(function(t){return new e({id:"default",title:"Basic Covers",owner:!1,editable:!1,list:t.map(function(t){return{id:getRandom(),title:t.name,tags:t.tag,link:t.link+"?v="+app.version}})})})),this._defaultCovers},removePack:function(i,t){return t?new Promise(function(e){app.modules.get("alert",{type:"alert",heading:"Delete Cover Set?",content:"Are you sure to delete this Cover Set? This action will delete Set and all Covers inside it that can't be restored.",buttons:["Delete Set","Cancel"]},function(t){e(t),t&&app.serverRequest("removePageCoversPack",{packID:i})})}):app.serverRequest("removePageCoversPack",{packID:i})},uploadCovers:function(t,a){var e=["image/jpeg","image/png","image/svg+xml"];return t.filter(function(t){return e.includes(t.file.type)}).map(function(i){var t=i.file.name.split(".");t.pop(),t=CFL(t.join("."));var e={pack_id:"object"==typeof a?a.id:a,title:t,index:-1,tags:[]};i.onStart(e),app.upload({file:i.file,url:"setCustomCover",data:e,progress:i.onProgress,done:function(t){var e=JSON.parse(t);e.status?i.onDone(e.cover):i.onError()},error:i.onError})})},removeCovers:function(t){return app.serverRequest("removeCustomCover",{coverID:[].concat(t)}).then(function(t){return t})},revokeCover:function(e){if(!["image/jpeg","image/png","image/svg+xml"].includes(e.file.type))return!1;e.onStart(),app.upload({file:e.file,url:"setCustomCover",data:{id:e.coverID},progress:e.onProgress,done:function(t){(t=JSON.parse(t)).status?e.onDone(t.cover):e.onError()},error:e.onError})},editCover:function(t,e){app.serverRequest("setCustomCover",Object.assign({id:t},e))},editPack:function(t,e){app.serverRequest("setPageCoversPack",Object.assign({id:t},e))},loadPacks:function(t){return app.serverRequest("getPageCoversPacks",{projectID:t}).then(function(t){return t.map(function(t){return new e({id:t.id,title:t.title,owner:t.owner_id,editable:t.owner_id===User.id||app.teams.getAccessibilityByUser(t.owner_id),list:(t.covers||[]).map(function(t){return{id:t.id,title:t.title,file_id:t.file_id,tags:Array.isArray(t.tags)?t.tags:[],index:t.index||-1,link:safetyObjectAccess(t,["file","filename"])}})})})})}};var e=function(t){Object.assign(this,t)}}(),function(){var i,t=function(){this.inProgress=!1};t.prototype={get ping(){return $.ajax({url:"/account/application/ping",context:this,dataType:"json",timeout:18e3})},set state(t){if(!equals(t,this.state))switch(this._state=t){case"online":this.offlineNotify&&(this.offlineNotify.die(),this.offlineNotify=!1),app.modules.get("notify",{mod:"green",content:"Connection was restored"});break;case"offline":this.offlineNotify||(this.offlineNotify=app.modules.get("notify",{mod:"red",timer:!1,content:"Could not connect to FlowMapp. Attempting to restore connection. Changes made now may not be saved."}));break;case"sessionOut":app.modules.get("alert",{heading:"Session lost",content:"For some reason your session has expired. All your actions will not make result. Please try to refresh your browser and sign in again",buttons:["Refresh page","Close"],wfc:!0},function(t,e){!0===t?location.reload(!0):e()})}},get state(){return this._state||"online"},update:function(t){if(!this.inProgress||t)return this.inProgress=!0,this.ping.done(function(t){t.state?this.state="online":User.auth&&(this.state="sessionOut")}).fail(function(t){this.state="offline"}).always(function(){this.inProgress=!1})}},app.online=function(){return new Promise(function(t,e){i.update(!0).always(function(){"online"===i.state?t(i.state):e(i.state)})})},app.getReady().then(function(){i=new t,setInterval(function(){i.update()},9e3)})}(),function(){var o=function(t){return t.toString().includes("p")?t:"p"+t},i=function(t){Object.assign(this,app.projects.filterField(t))};i.prototype={update:function(t){var e={};for(var i in t)null===this[i]?this[i]!==t[i]&&(e[i]=this[i]=t[i]):"object"==typeof this[i]?this[i].equals(t[i])||(e[i]=this[i]=t[i]):this[i]!==t[i]&&(e[i]=this[i]=t[i]);return!!Object.keys(e).length&&e}},app.projects={init:function(){return app.projects.loadData=app.staticServerRequest.apply(app.projects,["getProjectsList"]),new Promise(function(t,e){app.projects.updateList(!1,t),setInterval(function(){app.projects.updateList()},5e3)})},list:{},get:function(t){return t?this.list[o(t)]:this.list.mapToArray(function(t){return t})},getBy:function(i){return this.get().filter(function(t){for(var e in i)if(!t.hasOwnProperty(e)||t[e]!=i[e])return!1;return!0})},filterField:function(t){return{id:t.id,users:Array.isArray(t.users)?t.users:[],date_create:app.clientTime(t.date_create),date_update:app.clientTime(t.date_update),time_ago:timeAgo(t.date_update),title:t.title.length&&t.title?t.title:"Unnamed",description:deltaDefine(t.description),attaches:JsonParse(t.attaches,[]),img:t.img||!1,archive:!!(1*t.archive),accessibility:t.owner_id==User.id,owner_id:t.owner_id,services:t.services||{}}},add:function(t){var e=new i(t);this.list[o(t.id)]=e,this.subscriber("add",{scope:e.id,event:"add",data:e})},remove:function(t){var e=this.get(o(t));this.subscriber("add",{scope:e.id,event:"remove",data:e}),delete this.list[o(t)]},update:function(t){var e=this.get(o(t.id));if(e){var i=e.update(this.filterField(t));i&&this.subscriber("add",{scope:e.id,event:"update",data:i})}},get keys(){return Object.keys(this.list)},loadData:function(){},changeProjectProperties:function(t,a){[].concat(t).forEach(function(t){var e=this.get(t);for(var i in a)e[i]=a[i]},this)},getUsersByProject:function(t){var e=[],i=this.get(t);return i&&i.users.forEach(function(t){t.id!=User.id&&e.push({id:t.id,email:t.login,avatar:t.img||!1,first_name:t.first_name||"First Name",last_name:t.last_name||"Last Name"})}),e},userIncludes:function(e){return this.get().filter(function(t){return!!Array.isArray(t.users)&&!!t.users.find(function(t){return t.id==e})})},getUser:function(e){var i=[],a=[];return this.get().forEach(function(t){t.users.forEach(function(t){i.includes(t.id)||(i.push(t.id),a.push({id:t.id,email:t.login,avatar:t.img||!1,first_name:safetyObjectAccess(t,["account","first_name"],""),last_name:safetyObjectAccess(t,["account","last_name"],"")}))})}),a.find(function(t){return t.id==e})},get users(){var e=[],i=[];return this.get().forEach(function(t){t.users.forEach(function(t){t.id==User.id||e.includes(t.id)||(e.push(t.id),i.push({id:t.id,email:t.login,avatar:t.img||!1,first_name:t.first_name||"",last_name:t.last_name||""}))})}),i},updateList:function(t,n){this.loadData(function(t){this.subscriber("lock",!0);var e=Array.isArray(t.projects)?t.projects.reduce(function(t,e){return t[o(e.id)]=e,t},{}):{},i={};for(var a in this.keys.forEach(function(t){i[o(t)]=-1}),Object.keys(e).forEach(function(t){i[o(t)]=i.hasOwnProperty(o(t))?0:1}),i)switch(i[a]){case 1:this.add(e[a]);break;case-1:this.remove(a);break;case 0:this.update(e[a])}"function"==typeof n&&n(),this.subscriber("lock",!1)}.bind(this),!!t)}},Subscriber(app.projects)}(),app.teams={createTeam:function(){var e=this;return this.validate().then(function(t){return t?app.modules.get("modalTemplates","oneTitleModal",{label:"Team Name",value:"New Team",name:"title"}).then(function(t){return!!t&&app.serverRequest("setTeam",t).then(function(t){return!!t.status||(e.generateError(t.message),!1)})}):(e.generateError("quota"),!1)},function(){e.generateError("connection")})},editTeam:function(){},validate:function(){return app.serverRequest("teamValidate").then(function(t){return this.quota={current:t.current,limit:t.quota<0?1/0:t.quota},this.quota.current<this.quota.limit}.bind(this))},generateError:function(t){var e={quota:function(){this.lastListData.length?app.modules.get("modalTemplates","upgradeSubscriptionModal","unlimitedTeams"):app.modules.get("modalTemplates","upgradeSubscriptionModal","team")},quotaUsers:function(){app.modules.get("modalTemplates","upgradeSubscriptionModal","unlimitedUsers")},TEAM_USERS_QUOTA_EXCEEDED:function(){e.quotaUsers.apply(this,argsToArray({arguments:arguments}))},connection:function(){app.excuse()}};e.hasOwnProperty(t)&&e[t].apply(this,argsToArray({arguments:arguments}).slice(1))},getAccessibilityByUser:function(e){return this.lastListData.some(function(t){return t.owner_id===e})},getAccessibilityByTeam:function(e){return!!this.lastListData.find(function(t){return t.id===e})},getAccessibilityByProject:function(t){var e=t&&app.projects.get(t)||!1;return e&&this.getAccessibilityByUser(e.owner_id)},getTeamByProject:function(a){return new Promise(function(t){var e=a&&app.projects.get(a)||!1;if(e){var i=e.owner_id;t(this.list(function(t){return t.filter(function(t){return t.owner_id===i})}))}else t(!1)}.bind(this))},get showTeamList(){var t=!1,e="false",i=this.lastListData.map(function(t){return t.id});return 0<this.lastListData.length&&(1===this.lastListData.length&&(safetyObjectAccess(this,["lastListData",0,"owner_id"],!1)===User.id||"free"===User.tarif&&1===app.projects.getBy({archive:!1,accessibility:!0}).length)?(t=!1,e=safetyObjectAccess(this,["lastListData",0,"id"],"false")):(e=oneOfMany([User.getUserSettings(["lastSelectedTeam"],"false")],i,"false"),t=!0)),{state:t,value:e}},lastListData:[],list:function(){return User.auth?app.serverRequest("teamList").then(function(t){return this.lastListData=t||[],t}.bind(this)).catch(app.log):Promise.resolve([])}},function(){var _=function(t,e){return[].concat(t).reduce(function(t,e){if(null==e||"number"==typeof e&&isNaN(e)||!e)return t;if("object"!=typeof e)return t.add(document.createTextNode(e));if(Array.isArray(e))return t.add(this(e,!0));if(e instanceof jQuery||isNode(e))return t.add(e);var i=this.components[e.name||"html"];if(i){var a=("function"==typeof i?i:i.create).call(i,e),n=a instanceof jQuery;return a&&e.content&&[].concat(e.content).forEach(function(t){"object"==typeof t?a.append(this(t)):a.append(t)}.bind(this)),t.add(n?a:a.dom)}return console.warn("Component with name«"+e.name+"» not founded and ignored"),t}.bind(_),$())};_.clarify=function(t,e){return t=t?[].concat(t):[],e?("function"==typeof e?t.map(e):t.map(function(t){return e+"--"+t})).join(" "):t},_.appendData=function(t,e){return"object"==typeof e&&!Array.isArray(e)&&Object.keys(e).length?(t.data(e),e):{}},_.appendAttr=function(t,e){return"object"==typeof e&&!Array.isArray(e)&&Object.keys(e).length?(t.attr(e),e):{}},_.appendStyle=function(t,e){if(!e)return!1;"string"==typeof e&&(e=parseCssToObject(e)),t.css(e)},_.appendClass=function(t,e){e&&t.addClass(Array.isArray(e)?e.join(" ").trim():e)},_.bind=function(t,e){if(void 0===e)return!1;var i={};"object"==typeof e&&(Array.isArray(e)?e.forEach(function(t){i[t.event]=t.callback}):i=e,t.on(i))},_.hashParse=function(t){return[].concat(t).map(function(t){return"string"==typeof t?t.replace(/###(.+?)###/g,function(t){for(var e=t.replace(/#/g,"").split("|"),i=0;i<e.length;i++){var a=e[i].split("."),n=safetyObjectAccess(window,a,!1);if(n)return"function"==typeof n?n.call(safetyObjectAccess(window,a.slice(0,a.length-1),a[0])):n.toString()}return t}):t})},_.getExternalLink=function(t){return"//"==(t=t.replace(/ /g,"")).slice(0,2)||"http"==t.slice(0,4)?t:"//"+t},_.parseDomToJson=function(t){var l=function(t){var e=t.get(0),i={},a={param:i},n=t.attrList();for(var o in n){var s=n[o];"class"===o?i.class=s:"style"===o?i.style=s.split(";").reduce(function(t,e){var i=e.split(":"),a=i[0],n=i[1];return void 0!==a&&void 0!==n&&(t[a]=n),t},{}):safetyObjectOverwriting(i,["attr",o],s)}var r=e.tagName.toLowerCase();"div"!==r&&(i.tag=r);var c=$.makeArray(e.childNodes);return c.length&&(a.content=c.map(function(t){return"#text"===t.nodeName?t.nodeValue:l($(t))})),a};return l(t)},_.components={icon:{version:app.version,create:function(t){var e=t.param,i=_.clarify(e.mod,"svg-icon"),a=this.list[e.name]||"icon-"+e.name,n=$('<div class="svg-icon svg-icon--'+e.name+(e.cover?" svg-icon--coverage":"")+" "+i+'"><svg><use xlink:href="/app/img/svg-sprite.svg?v='+this.version+"#"+a+'"></use></svg></div>');return e.fill&&n.find("svg").css("fill",e.fill),e.style&&n.css(e.style),e.class&&n.addClass(e.class),n},list:{share:"icon-share",delete:"icon-trash-outline",trash:"icon-trash-fill",archive:"icon-archive",unarchive:"icon-unarchive",edit:"icon-edit",duplicate:"icon-dublicate",leave:"icon-leave",dragzone:"icon-drag",tile:"icon-tile-view",list:"icon-list-view",img:"icon-with-img",noimg:"icon-without-img",tree:"icon-left-sidebar",project_info:"icon-project-info",export:"icon-export",attach:"icon-attach",download:"icon-download",user:"icon-user",notification:"icon-notification",plus:"icon-plus",close:"icon-close",check:"icon-check",uncheck:"icon-off",search:"icon-search",alert:"icon-alert_oval",success:"icon-check-oval",warning:"icon-!2",lines:"icon-slider-lines",file:"icon-file_icon",dots:"icon-more-options",arrow:"icon-arrow-min",double_arrow:"icon-double_arrow",arrow_key:"icon-arrow",arrowSolid:"icon-arrow_solid",micro_arrow:"icon-micro_arrow",back:"icon-Back",userflow:"icon-userflow",comment:"icon-Comments",description:"icon-description",rhombus:"icon-rhombus",oval:"icon-oval",parallelogramLeft:"icon-parallelogramLeft",parallelogramRight:"icon-parallelogramRight",rectangle:"icon-rectangle",ring:"icon-ring",trapezium:"icon-trapezium",triangle:"icon-triangle",page:"icon-page",stroke:"icon-stroke",letterA:"icon-letter-a",fill:"icon-fill",yes:"icon-yes",no:"icon-no",none:"icon-none",message:"icon-comment",show_message:"icon-show_comments",template:"icon-template",add_template:"icon-add_template",settings:"icon-settings",grid:"icon-grid",lock:"icon-lock",help_normal:"icon-help_normal",help_hover:"icon-help_hover",chat:"icon-chat",keyboard:"icon-keyboard",question:"icon-question",link:"icon-link",cmd:"icon-cmd",slack_normal:"icon-slack-grayscale",slack_hover:"icon-slack-colour",borderimg:"icon-borderimg",bin_small:"icon-bin_small",bullet:"icon-bullet",ordered:"icon-ordered",preparation:"icon-preparation",hexagon:"icon-hexagon",document:"icon-document",wave:"icon-wave",delay:"icon-delay",trapezium_flip:"icon-trapezium_flip",display:"icon-display",several_forms:"icon-several_forms",several_icons:"icon-several_icons",replace:"icon-replace",puzzle:"icon-puzzle",rotate:"icon-rotate",sitemap_horisontal:"icon-sitemap_horisontal",sitemap_vertical:"icon-sitemap_vertical",backup:"icon-backup",sketch:"icon-sketch-logo",figma:"icon-figma-logo",reload:"icon-reload",tag:"icon-tag",covers:"icon-page_covers",labels:"icon-labels"}},iconArrow:function(t){var e=t.param||{},i=_.clarify(e.mod,"icon-arrow"),a=$('<div class="icon-arrow '+i+'"></div>');return _.appendData(a,e.data),_.appendAttr(a,e.attr),_.appendStyle(a,e.style),_.bind(a,e.bind),a},compositeIcon:function(t){var e=t.param||{},i=_.clarify(e.mod,"icon-composite"),a=$('<div class="icon-composite"></div>');return a.append(_({param:{class:"icon-composite "+i},content:[{param:{class:"icon-composite__cell icon-composite__cell--normal"},content:{name:"icon",param:{name:e.normal}}},{param:{class:"icon-composite__cell icon-composite__cell--active"},content:{name:"icon",param:{name:e.active}}}]})),a.toggleClass("active",!!e.state),_.appendAttr(a,e.attr),e.style&&a.css(e.style),!0===e.fixed?a.css("pointer-events","none"):e.callback&&"function"==typeof e.callback&&a.on("click",function(t){return e.callback.call(a,a,t)}),e.alt&&a.attr("title",e.alt),a},button:function(t){var e=t.param||{},i=_.clarify(e.mod,"button"),a=e.icon||!1,n=e.tag||"button";a&&(i+=" button--icon");var o=$("<"+n+' class="button '+i+'" '+vts(e.title,'title="'+e.title+'"')+">"+vts(e.text,'<span class="button__text">'+e.text+"</span>")+"</"+n+">");_.appendAttr(o,e.attr);var s=_.appendData(o,e.data);return _.appendAttr(o,e.attr),a&&o.prepend(_({name:"icon",param:{name:a}})),(e.addClass||e.class)&&[].concat(e.addClass||e.class).forEach(function(t){o.addClass(t)}),_.appendStyle(o,e.style),e.callback&&"function"==typeof e.callback&&o.on("click",function(t){return e.callback.call(o,s.value,o,t)}),o},buttonStack:function(t){var i=t.param||{},e=_.clarify(i.mod,"button-stack"),a=!(!i.callback||(i.callback,0))&&i.callback,n=i.name||!1,o=$('<div class="button-stack '+e+'"></div>');return o.on("click","button",function(){var t=$(this),e=t.data("value");void 0!==e&&"function"==typeof a&&n&&a({name:n,value:e}),i.fixed||(t.addClass("active"),t.siblings("button").removeClass("active"))}),i.hasOwnProperty("value")&&!i.fixed&&setTimeout(function(){o.find("button").each(function(){$(this).data("value")==i.value&&$(this).addClass("active")})},20),o},buttonRow:function(t){var e=t.param||{},i=_.clarify(e.mod,"button-row"),a=$('<div class="button-row '+i+'"></div>');return e.style&&a.css(e.style),a},buttonIcon:function(t){var e=t.param||{};return _({param:{class:"button-icon "+_.clarify(e.mod,"button-icon")+(e.class?" "+e.class:"")+(e.active?" active":""),tag:e.tag||"div",data:e.data,attr:Object.assign({title:e.title||""},e.attr||{}),style:e.style,bind:e.bind,event:e.event,callback:e.callback},content:{name:"icon",param:{name:e.name}}})},link:function(t){var e=t.param||{},i=_.clarify(e.mod,"link"),a=$('<a class="link '+i+'" href="'+(e.href||"javascript:void(0);")+'"></a>'),n=_.appendData(a,e.data);return _.appendAttr(a,e.attr),(t.target||e.target)&&a.attr("target",t.target||e.target),e.callback&&"function"==typeof e.callback&&a.on("click",function(t){return n.hasOwnProperty("value")?e.callback(n.value):e.callback.call(a,t)}),e.class&&a.addClass(e.class),e.internal&&e.href&&a.on("click",function(t){t.shiftKey&&t.metaKey||(t.preventDefault(),app.router(e.href))}),e.style&&a.css(e.style),a},input:{inputType:{select:function(t){var i=$('<select name="'+vts(t.name)+'"></select>');Array.isArray(t.options)&&t.options.length&&(t.options=t.options.map(function(t){return"string"==typeof t?{value:t,text:t}:t}),t.options.forEach(function(t){var e=$('<option value="'+vts(t.value)+'">'+vts(t.text)+"</option>");_.appendData(e,t.data),i.append(e)}));var e=(i=i.flowmapSelect(Object.assign({value:t.value||!1,placeholder:t.placeholder||""},t.settings||{}))).selectDom;return t.callback&&"function"==typeof t.callback&&e.on(t.events||"change",function(){t.callback({name:e.attr("name"),value:e.val()})}),i.dom},radio:function(t){var e=$('<input name="'+vts(t.name)+'" value="" type="radio"'+vts(t.checked,function(){return t.checked?" checked":""})+'><span class="indicator"></span>'),i=e.eq(0),a=i.prop("checked");return i.on("focus select",function(){1!=a&&($(this).prop("checked",!0),$(this).trigger("change"))}),t.value&&i.val(t.value),t.callback&&"function"==typeof t.callback&&i.on(t.events||"change input",function(){t.callback({name:i.attr("name"),value:t.value})}),e},range:function(t){var e=$('<input name="'+vts(t.name)+'" value="" min="'+(t.min||0)+'" max="'+(t.max||100)+'" step="'+(t.step||"any")+'" type="range">');return t.value&&e.val(t.value),t.callback&&"function"==typeof t.callback&&e.on(t.events||"input",function(){t.callback.call(e,{name:e.attr("name"),value:e.val()})}),e},checkbox:function(e){var t=$('<input name="'+vts(e.name)+'" value="" type="checkbox"'+vts(e.checked,function(){return e.checked?" checked":""})+'><span class="indicator"></span>'),i=t.eq(0);i.prop("checked");return e.value&&i.val(e.value),e.callback&&"function"==typeof e.callback&&i.on(e.events||"change",function(t){return t.preventDefault(),e.callback({name:i.attr("name"),value:e.value,state:i.prop("checked")},t)}),t},autowidth:function(t){var e=$('<input name="'+vts(t.name)+'" placeholder="'+vts(t.placeholder)+'" value="" type="text"><div class="fake-input">'+vts(t.value)+"</div>"),i=e.eq(0),a=e.eq(1),n=function(){a.text(i.val()),i.css("width",a.outerWidth())};return i.on("input change",n),setTimeout(n,30),t.value&&i.val(t.value),t.callback&&"function"==typeof t.callback&&i.on(t.events||"change input",function(){t.callback.call(i,{name:i.attr("name"),value:i.val()})}),e},textarea:function(t){var e=_({param:{tag:"textarea",attr:{placeholder:t.placeholder||"",name:t.name||""}},content:t.value||""});return t.autoresize&&e.on("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"}),e},default:function(e){var i=$('<input name="'+vts(e.name)+'" placeholder="'+vts(e.placeholder)+'" value="" type="'+vod(e.type,"text","string")+'">');return e.value&&i.val(e.value),e.callback&&"function"==typeof e.callback&&i.on(e.events||"change input",function(t){return e.callback.call(i,{name:i.attr("name"),value:i.val()},t)}),e.disabled&&i.addClass("disabled"),i}},create:function(t){var e=vod(t.param,{},"object"),i=e.type&&this.inputType.hasOwnProperty(e.type)?e.type:"default",a=[i].concat(e.mod||[]).uniq(),n=_.clarify(a,"input"),o=e.icon,s=0<=n.indexOf("material");o&&(n+=" input--icon");var r=_({param:{class:"input input--main "+n},content:[!s&&e.label?{param:{class:"input__label",tag:"label"},content:e.label}:"",{param:{class:"input__container"},content:[s&&e.label?{param:{class:"input__label",tag:"label"},content:e.label}:"",{param:{class:"input__decorations",attr:!!e.label&&{"data-label":e.label}}}]},{param:{class:"input__description",tag:"p"},content:e.description}]}),c=this.inputType[i](e);return _.appendAttr(c,e.attr),_.appendData(r,e.data),r.find(".input__container").prepend(c),s&&(r.on("input change","input",function(){$(this).toggleClass("empty",!$(this).val().length)}),r.find("input").toggleClass("empty",!r.find("input").val().length)),e.button&&r.find(".input__container").prepend($('<div class="input__button"></div>').append(_(e.button))),e.style&&c.css(e.style),e.class&&r.addClass(e.class),e.alt&&r.attr("title",e.alt),e.containerStyle&&r.css(e.containerStyle),_.bind(c,e.bind),r.on("click","label",function(){c.focus().get(0).select()}),o&&r.find(".input__container").append(_({name:"icon",param:{name:o}})),r}},inputStack:function(t){var e=t.param||{},i=$('<div class="input-stack"></div>');return e.class&&i.addClass(e.class),e.style&&i.css(e.style),e.callback&&i.on(e.event||"input change","input",e.callback),e.separator&&setTimeout(function(){i.find(".input:not(:last-child)").after(_({param:{class:"input-stack__separator"},content:{name:"icon",param:{name:"lock"}}}))},10),i},toggle:function(t){var e=t.param||{};return _({param:{class:"toggle "+_.clarify(e.mod,"toggle")+(e.class?" "+e.class:""),style:e.style,attr:e.attr,data:e.data,events:"change",callback:function(){var t=$(this).find("input");"function"==typeof e.callback&&e.callback.call(t,{name:t.attr("name"),value:t.attr("value"),state:t.prop("checked")})}},content:[{param:{tag:"input",attr:{type:"checkbox",name:e.name||"",value:e.value||"",checked:!!e.checked,disabled:!!e.disabled}}},{param:{class:"toggle__rail"},content:[{param:{class:"toggle__state toggle__state--true"},content:{name:"icon",param:{name:"check"}}},{param:{class:"toggle__state toggle__state--false"},content:{name:"icon",param:{name:"uncheck"}}},{param:{class:"toggle__switch"},content:{name:"icon",param:{name:"lines"}}}]}]})},form:function(t){var o=t.param||{},e=_.clarify(o.mod,"form"),s=!1,r=$('<form class="form '+e+'"'+vts(e.method,' method="'+e.method+'"')+vts(e.action,' action="'+e.action+'"')+"></form>"),c=function(t){t.reason.forEach(function(t){var e=r.find('[name="'+t.name+'"]'),i=e.parents(".input");i.attr("data-error",t.text),e.one("input",function(){i.removeAttr("data-error")})})};return o.style&&r.css(o.style),o.actions?(o.activeActions||(o.actions.find('[type="submit"]').addClass("disabled"),o.actions.find('[type="reset"]').addClass("disabled")),o.actions.on("click",'[type="submit"]',function(){if(s)return!1;var t=s=!0,e=r.serializeJson();if(o.validation){var i=o.validation(e);c(i),t=i.result}if(t)if(r.find(".input").each(function(){var t=$(this).find(":input[name]");$(this).data("value",t.val())}),o.actions.find('[type="reset"]').addClass("disabled"),o.callback&&"function"==typeof o.callback){var n=o.actions.find('[type="submit"]').loader("button"),a=o.callback(e);a instanceof Promise?a.then(function(t){var e,i,a;!t.status&&t.message.length&&c((e=t.message,i=[],a={INVALID_CURRENT_PASS:{name:"old_password",text:"Password incorrect"}},e.forEach(function(t){a.hasOwnProperty(t)&&i.push(a[t])}),{reason:i})),s=!1,n.done(),o.actions.find('[type="submit"]').addClass("disabled")}).catch(function(){s=!1,n.done(),o.actions.find('[type="submit"]').addClass("disabled")}):(o.actions.find('[type="submit"]').addClass("disabled"),s=!1)}else o.actions.find('[type="submit"]').addClass("disabled"),o.actions.find('[type="reset"]').addClass("disabled"),s=!1;else o.actions.find('[type="submit"]').addClass("disabled"),s=!1}).on("click",'[type="reset"]',function(){r.find(".input").each(function(){var t=$(this).find(":input[name]");t.is("select")?t.flowmapSelect("value",$(this).data("value"),!0):t.val($(this).data("value"))}),o.actions.find('[type="reset"]').addClass("disabled"),o.actions.find('[type="submit"]').addClass("disabled")}),r.on(o.events||"input change",":input",function(){o.actions.find('[type="reset"]').removeClass("disabled"),o.actions.find('[type="submit"]').removeClass("disabled")})):"function"==typeof o.callback&&r.on(o.event||"change",o.callback),o.default||r.on("submit",function(t){t.preventDefault(),t.stopPropagation()}),_.appendData(r,o.data),_.appendAttr(r,o.attr),_.appendStyle(r,o.style),_.bind(r,o.bind),r},formStack:function(t){var e=t.param||{},i=_.clarify(e.mod,"form__stack"),a=$('<div class="form__stack '+i+'"></div>');return e.heading&&a.append('<div class="heading">'+e.heading+"</div>"),e.style&&a.css(e.style),a},formPanel:function(t){var e=t.param||{},i=!!e.checked,a=_({param:{class:"form-panel__content",style:{display:i?"block":"none"}}}),n=_({name:"toggle",param:{name:e.name||"",value:e.value||"",checked:i,callback:function(t){r(!i)}}}),o=n.find("input"),s=_({param:{class:"form__panel "+_.clarify(e.mod,"form-panel"),style:e.style||!1},content:[{param:{class:"form-panel__header"},content:[{param:{class:"form-panel__title"},content:e.title},n]},a]}),r=function(t){i=!!t,o.prop("checked",i),i?a.slideDown(300):a.slideUp(300),e.callback&&e.callback(i)};return{dom:s,append:function(){$.fn.append.apply(a,argsToArray({arguments:arguments}))}}},internalLink:function(t){var e=t.param||{},i=_.clarify(e.mod,"fm-internal"),a=e.data||{},n=_({param:{class:"fm-internal "+i}});return convertToPromise(a).then(function(t){"function"==typeof t.interface&&"function"==typeof e.callback&&t.interface(e.callback),n.append(_(t.list.map(function(t,e){return{name:"spoiler",param:{speed:150,mod:"contentfree",header:t.title,state:0===e},content:t.content}})))}),n},quill:function(t){var o=t.param||{},e=_.clarify(o.mod,"quill"),i=_({param:{class:"input input--quill "+e,style:o.style||!1},content:[o.label?{param:{class:"input__label",tag:"label"},content:o.label}:"",{param:{class:"input__container"},content:{param:{class:"quill"},content:{param:{class:"quill__container"}}}},o.description?{param:{class:"input__description",tag:"p"},content:o.description}:""]}),a=i.find(".quill");_.appendAttr(a,o.attr),_.appendData(i,o.data),_.appendStyle(i,o.style);var n=function(){return a.trigger("quill-submit"),!0},s={toolbar:{container:[["bold","italic","underline"],["blockquote","code-block","link"],[{list:"ordered"},{list:"bullet"}]]},magicUrl:!0,keyboard:{bindings:{"customSubmitKey(shiftKey)":{key:13,shiftKey:!0,handler:n},"customSubmitKey(ctrlKey)":{key:13,ctrlKey:!0,handler:n},customCancelKey:{key:27,handler:function(){return a.trigger("quill-cancel"),!0}}}}};o.mentions&&(s.mention={allowedChars:/^[A-Za-z\sÅÄÖåäö]*$/,dataAttributes:["id"],isolateCharacter:!0,mentionDenotationChars:["@"],source:function(t,e,i){var n=t.toLowerCase(),a=o.mentions().reduce(function(t,e){var i=[];"string"==typeof e.login&&i.push(e.login.toLowerCase()),"string"==typeof e.name&&i.push(e.name.toLowerCase());var a=i.reduce(function(t,e){var i=e.indexOf(n);return-1<i?-1<t?Math.min(i,t):i:t},-1);return-1<a&&t.push({index:a,item:e}),t},[]);a.sort(function(t,e){return e<t?1:t<e?-1:0}),e(a.map(function(t){return Object.assign({value:t.item.name||t.item.login},t.item)}),t)},renderItem:function(t,e){var i=new RegExp(e,"i");return $.map(_([{param:{class:"ql-mention-list-item__avatar",style:!!t.avatar&&{"background-image":"url("+t.avatar+")"}}},{param:{class:"ql-mention-list-item__info"},content:[{param:{class:"ql-mention-list-item__name"},content:t.name.replace(i,'<span class="matched">$&</span>')},{param:{class:"ql-mention-list-item__email"},content:t.login.replace(i,'<span class="matched">$&</span>')}]}]),function(t){return t.outerHTML}).join("")}});var r=new Quill(i.find(".quill__container").get(0),{modules:s,placeholder:o.placeholder||"",bounds:o.bounds||i.get(0),formats:["bold","italic","underline","blockquote","code-block","link","image","indent","mention","list","emoji"],theme:"snow",clipboard:{matchVisual:!1}});o.value&&r.setContents(o.value.ops.map(function(t){return t.insert||(t.insert=""),t.hasOwnProperty("attributes")&&"object"==typeof t.attributes&&t.attributes.hasOwnProperty("mention")&&(t.insert={mention:{denotationChar:"@",id:t.attributes.mention,index:0,value:t.insert.slice(1)}},delete t.attributes.mention),t})),o.freezePlaceholder&&i.find(".ql-editor").attr("data-freeze-placeholder",o.freezePlaceholder||o.placeholder||""),a.data("quill",r);var c=$(r.theme.tooltip.root),l=c.find("input[data-link]");return r.theme.tooltip.root.querySelector("input[data-link]").dataset.link="https://app.flowmapp.com",o.internalLink&&(c.addClass("ql-tooltip--internallink"),l.css("padding-right",30),c.append(_([{param:{class:"ql-internallink__icon",callback:function(){var e=c.popover(_({name:"internalLink",param:{data:valueOrFunction(o.internalLink),callback:function(t){l.val(t),c.find(".ql-action").get(0).click(),e.close()}}}),{width:360,mod:["center"],style:{top:55}})}},content:{name:"icon",param:{name:"puzzle",cover:!0}}},{param:{class:"ql-internallink__note"},content:"Paste a link or select an internal element link"}]))),i},quillTemplate:{get dom(){return this._dom||(this._dom=_({name:"quill",param:{placeholder:"Empty",mod:["toggle"]}}),this._dom.find(".quill").addClass("quill--freeze")),this._dom},get quill(){return this._quill||(this._quill=this.dom.find(".quill").data("quill"),this._quill.disable()),this._quill},create:function(t){var e=t.param||{};return this.quill.setContents(deltaDefine(e.data||{})),$(this.dom.get(0).outerHTML)}},menu:function(t){var s=t.param||{};if("function"!=typeof s.callback)return console.warn("You should pass callback for using menu"),!1;if(!["object","function"].includes(typeof s.options))return console.warn("Option must be any kind of object or function and contain values name:value"),!1;var i=_({param:{class:[].concat("fm-menu",_.clarify(s.mod,"fm-menu")||[],s.class).join(" ").trim(),style:s.style,attr:s.attr}});s.hasOwnProperty("dots")&&!1===s.dots||i.append(_({name:"icon",param:{name:"dots",mod:"coverage"}}));return i.on(s.event||"click",function(t){if(!1===s.eventPropagation&&t.stopPropagation(),"function"!=typeof s.eventFilter||s.eventFilter(t)){var e=i.popover(_({param:{class:"fm-menu-list"},content:function(){var t,e,i,a=$(),n=valueOrFunction(s.options);for(var o in n)e=n[t=o],i=void 0,i=(e="object"==typeof e?e:{value:t,name:e}).selfTemplate?e.name:$('<div class="fm-menu-list__item"></div>').append(e.name),e.disabled&&i.addClass("disabled"),i.attr("data-menu-option",e.value),a=a.add(i);return a}()}),Object.assign({mouseleave:i.parent(),mouseleaveDelay:3e3,mod:["white","large","bot","left"]},s.settings||{}));e&&(i.addClass("active"),e.bind("click","[data-menu-option]",function(t){s.callback($(this).data("menu-option"),t),e.close()}),e.onClose(function(){i.removeClass("active"),"function"==typeof s.onClose&&s.onClose()}),"function"==typeof s.onOpen&&s.onOpen())}}),i},popoverMenu:function(t){var e=t.param||{},i=_,a=i(e.heading?{param:{tag:"p",class:e.headingClass||"big strong weight",style:Object.assign({"margin-bottom":"20px"},e.headingStyle||{})},content:e.heading}:""),n=i({param:{style:Object.assign({width:"100%",margin:"0 0 20px"},e.listStyle||{})}}),o=(n.loader("blockLight"),i(e.buttons?{name:"buttonRow",content:[{name:"button",param:{mod:["narrow","blue"],text:e.buttonOkText||"Save",callback:function(){}}},{name:"link",param:{callback:function(){}},content:e.buttonCancelText||"Cancel"}]}:""));e.target.popover(i([a,n,o]),{stopEvent:!0,mod:e.mod||["center","white","padding","bot"],style:e.style||{width:" 250px",left:" 50%","margin-left":"-125px"}}),convertToPromise(t.target).then(function(t){})},menuSelect:{list:{icon:function(o){return{settings:{width:142},placeholder:function(a,n,t){convertToPromise(t).then(function(t){var e=t.find(function(t){return t.value==n}),i=e?"string"==typeof e.icon?_({name:"icon",param:{name:e.icon,cover:!0}}):e.dom:o.placeholder?"boolean"==typeof o.placeholder&&t.length?_({name:"icon",param:{name:t[0].icon,cover:!0}}):"object"==typeof o.placeholder?_(o.placeholder):"string"==typeof o.placeholder?$("<p>"+o.placeholder+"</p>"):o.placeholder:$("<p>Placeholder...</p>");a.html(""),"function"!=typeof i.appendTo||i.appendTo(a.get(0))})},content:function(n,t,o){return convertToPromise(t).then(function(i){var a=$('<div class="fm-picker__list fm-picker__list--three"></div>');return o.listStyle&&a.css(o.listStyle),o.search?i=i.map(function(t){var e=t.searchArray.map(function(t){return t.indexOf(o.search)}).filter(function(t){return-1<t});return e=e.length?Math.min.apply(Math,e):i.length,Object.assign({searchIndex:e},t)}).sort(function(t,e){return t.value===n?-1:e.value===n?1:t.searchIndex-e.searchIndex}):i.sort(function(t,e){return t.value===n?-1:e.value===n?1:t.index-e.index}),i.forEach(function(t){var e=_({name:"html",param:{class:"fm-picker__item"+(t.value===n?" active":""),attr:{"data-option":t.value,title:t.title||t.name||t.value}}});o.colStyle&&e.css(o.colStyle),("string"==typeof t.icon?_({name:"icon",param:{name:t.icon,cover:!0}}):t.dom).appendTo(e.get(0)),a.append(e)}),a})}}},color:function(n){return{placeholder:function(t,e,i){var a=_({param:{class:"fm-picker__color"},content:[{param:{class:"fm-picker__icon"},content:{name:"icon",param:{name:n.icon,cover:!0}}},{param:{class:"fm-picker__indicator",style:{background:e}}}]});t.html(a)},content:function(e,t){return $('<div class="fm-colorpicker__list">'+(t||["#76E27A","#FD6764","#FF7C43","#FFD663","#848DEA","#58A8F7","#50E3C2","#CC92F1","#FFFFFF"]).map(function(t){return'<div class="fm-colorpicker__color'+(t==e?" active":"")+'" data-option="'+t+'" style="background: '+t+"; "+("#FFFFFF"==t?"border: 1px solid #DEE7EC;":"")+'"></div>'}).join("")+"</div>")},settings:{width:186}}},color2:function(n){return{placeholder:function(t,e,i){var a=_({param:{class:"fm-picker__color"},content:[{param:{class:"fm-picker__icon"},content:{name:"icon",param:{name:n.icon,cover:!0}}},{param:{class:"fm-picker__indicator",style:{background:e||n.placeholderColor||!1}}}]});t.html(a),a.on("click",function(t){t.stopImmediatePropagation(),app.colorList(a,{direction:{horizontal:"right",vertical:"top"},offset:5,value:e,autoSelectValue:!1,callback:{input:function(t){a.find(".fm-picker__indicator").css("background",t),"function"==typeof n.onInput&&n.onInput(t)}.bind(this),change:function(t){"function"==typeof n.callback&&n.callback(t)}.bind(this)}})})},content:function(t,e){return""},settings:{width:186}}},list:function(o){return{settings:{width:74},placeholder:function(t,e,i){var a=i.find(function(t){return t.value==e}),n=a?a.content:o.placeholder||"Placeholder...";t.html(n)},content:function(e,t){var i=$('<div class="fm-picker__list fm-picker__list"></div>');return t.forEach(function(t){i.append(_({name:"html",param:{class:"fm-picker__item"+(t.value==e?" active":""),attr:{"data-option":t.value}},content:$(t.content).clone()}))}),i}}}},create:function(s){var r=s.param||{},t=(s=r.options,r.type),c=r.value,l=this.list[t](r),d=$('<div class="fm-picker"><div class="fm-picker__placeholder"></div></div>'),h=d.find(".fm-picker__placeholder");return l.placeholder(h,c,s),h.on("click",function(){var t=d.popover(_({param:{class:"fm-menuselect"},content:{param:{class:"fm-menuselect__wrap",style:Object.assign({position:"relative"},r.listStyle||{})},content:{param:{class:"fm-menuselect__list"}}}}),Object.assign({mouseleave:d.parent(),mod:["white","medium","top","center"]},l.settings,r.settings));if(t){var e=t.dom.find(".fm-menuselect"),i=t.dom.find(".fm-menuselect__wrap"),a=t.dom.find(".fm-menuselect__list"),n=!1;r.scroll&&i.customScroll();var o=function(){convertToPromise(l.content(c,s,Object.assign({search:n},r.settings||{}))).then(function(t){a.insert(t)})};o(),r.search&&e.prepend(_({param:{class:"fm-menuselect__search",style:{padding:"10px"}},content:{name:"input",param:{mod:["narrow","full"],name:"search",value:"",placeholder:"Icon Name",icon:"search",callback:function(t){n=t.value.replace(/ /g,"").toUpperCase()||!1,o()}}}})),t.bind("click","[data-option]",function(){c=$(this).data("option"),r.callback(c),t.close(),l.placeholder(h,c,s)}),t.onClose(function(){t.dom.find("[data-scroll]").baron().dispose()})}}),d}},fileExtension:{list:[{synonyms:["ai"],text:"Ai",color:"#FF7B1F"},{synonyms:["doc","docx"],text:"Doc",color:"#234E8E"},{synonyms:["jpeg","jpg"],text:"Jpg",color:"#8292A2"},{synonyms:["pdf"],text:"Pdf",color:"#FD5C59"},{synonyms:["png"],text:"Png",color:"#474B54"},{synonyms:["ppt"],text:"Ppt",color:"#DD4F27"},{synonyms:["psd"],text:"Psd",color:"#0152AF"},{synonyms:["sketch"],text:"Skh",color:"#F4993C"},{synonyms:["svg"],text:"Svg",color:"#3AA3E3"},{synonyms:["xls"],text:"Xls",color:"#377437"}],create:function(t){var e=t.param||{},i=this.list.find(function(t){return t.synonyms.some(function(t){return e.extension==t})})||{text:"file",color:"#4DA0F6"},a=$('<div class="group-icon group-icon--extension"><div class="text" style="background: '+i.color+'">'+i.text+"</div></div>");return a.append(_({name:"icon",param:{name:"file"}})),a}},container:function(t){var e=t.param||{},i=_.clarify(e.mod,"container"),a=$('<div class="container '+i+'"></div>');return e.style&&a.css(e.style),e.class&&a.addClass(e.class),a},header:function(t){return $('<header class="header"></header>')},headerNavigation:function(t){var e=t.param,i=$('<div class="header__navigation"></div>').append(_({name:"container"}).append([].concat('<ul class="header__links">',e.links.map(function(t){return'<li class="header__link'+(t.intend?" header__link--intend":"")+(t.link==e.current?" header__link--current":"")+'"><a '+(t.internal?'class="js-internal"':"")+' href="'+t.link+'" target="_blank">'+vts(t.title)+"</a></li>"}),"</ul>").join("")).append(_({name:"userboard"})));return i.on("click",".js-internal",function(t){t.preventDefault(),app.router($(this).attr("href"))}),$(i)},userboard:function(t){return _({param:{class:"block__userboard"},content:[User.auth?{param:{class:"userboard__notification js-notification",callback:function(){app.activity.openModal()}},content:{name:"icon",param:{name:"notification",mod:"gray",cover:!0}}}:"",{param:{class:"userboard__user",callback:User.auth?function(){$(this).popover({name:"board",content:[{param:{class:"block__userinfo",callback:function(){app.router("/profile")}},content:[{param:{class:"avatar",call:{fn:$.fn.setBackground,args:[User.avatar]}}},{param:{class:"info"},content:[{param:{class:"name",tag:"h4"},content:User.definition},{param:{class:"light",tag:"p",attr:{title:User.email}},content:User.email}]}]},{name:"linkList",content:[{name:"link",param:{callback:function(){app.router("/profile")}},content:"View Profile"},{name:"link",param:{callback:function(){app.router("/people")}},content:"People"},{name:"link",param:{callback:function(){app.router("/manager")}},content:"Manager"},{name:"link",param:{callback:function(){location="/?logout=true"}},content:"Sign Out"}]}]},{mark:"active",mod:["long","bot","right"],stopEvent:!0})}:function(){location="/login?backurl="+location.href.replace(location.origin,"")}},content:[{name:"icon",param:{name:"user",mod:"gray",cover:!0}},{param:{class:"userboard__name"},content:User.auth?User.anyDefinition:"Sign In"},User.auth?{name:"iconArrow",param:{mod:["white","little","nohover"],style:{"margin-left":"4px"}}}:""]}]})},headerMain:function(t){var e=$('<div class="header__main"></div>').append(_({name:"container"}).append(_({name:"headerHeading",param:t.param})));return{dom:e,append:function(t){e.find(".container").append(t)}}},headerTools:function(t){return{dom:$('<div class="header__tools"></div>').append(_({name:"container"})),append:function(t){this.dom.find(".container").append(t)}}},headerPanel:function(t){var e=t.param||{},i=e.mod?[].concat(e.mod).map(function(t){return"header__panel--"+t}).join(" "):"";return $('<div class="header__panel '+i+'"></div>')},headerHeading:function(t){var e=t.param,i=$('<div class="header__heading"><div class="header__logo"><a href="/projects" class="js-internal"><img src="/app/img/logo.svg" alt="LOGO"></a></div>'+(e.avatar?'<div class="header__avatar"></div>':"")+vts(e.title,'<h1 class="header__title">'+e.title+"</h1>")+"</div>");return e.avatar&&i.find(".header__avatar").setBackground(e.avatar),i.on("click",".js-internal",function(t){t.preventDefault(),app.router($(this).attr("href"))}),e.hasOwnProperty("description")&&i.append($('<div class="header__description"></div>').append(e.description)),i},selectBar:function(t){var e=t.param||{};return _({param:{class:"page-selectbar"+_.clarify(e.mod,"page-selectbar")},content:{name:"container",param:{mod:["flex","fill"]},content:[{param:{class:"page-selectbar__info"},content:[{param:{class:"page-selectbar__num js-count"}},{param:{class:"page-selectbar__text js-text"}},{name:"buttonRow",content:[{name:"link",param:{class:"js-select"},content:"Select all"},{name:"link",param:{class:"js-deselect"},content:"Deselect all"}]}]},{param:{class:"page-selectbar__tools js-tools"},content:[]}]}})},page:function(t){var e=t.param||{},i=_.clarify(e.mod,"page");return $('<div class="page '+i+'">')},modal:function(t){var e=t.param||{};return _({param:{class:"modal "+_.clarify(e.mod,"modal")},content:{param:{class:"modal__overlay"},content:{param:{class:"modal__scroller"},content:{param:{class:"modal__wrapper"},content:{param:{class:"modal__inner",style:e.style},content:[{param:{class:"modal__content"}},{param:{class:"modal__close js-modal-close"},content:{name:"button",param:{mod:["gray","narrow","round"],icon:"uncheck"}}}]}}}}})},popover:function(t){var e=t.param||{},i=_.clarify(e.mod,"popover"),a=$('<div class="popover '+i+'"></div>');return e.width&&a.css("width",e.width),e.height&&a.css("height",e.height),e.style&&a.css(e.style),a},key:function(t){var e=t.param||{},i=e.type||"key",a=e.value||" ",n=" ",o=$('<div class="fm-key"></div>');switch(i){case"arrow":switch(n=_({name:"icon",param:{name:"arrow_key"}}),a){case"right":n.css("transform","rotate(270deg) translate( 0px, 1px)");break;case"top":n.css("transform","rotate(180deg) translate( 0px, 1px)");break;case"left":n.css("transform","rotate(90deg)  translate( 0px, 1px)");break;case"bottom":n.css("transform","rotate(0deg)   translate( 0px, 1px)")}break;case"meta":n=-1!=navigator.userAgent.indexOf("Mac OS X")?_({name:"icon",param:{name:"cmd"}}):"ctrl";break;default:n=a}return o.append(n),o},attachZone:{bindState:!1,callbacks:[],state:!1,bind:function(){var e=function(i){equals(i,this.state)||(this.state=i,this.callbacks=this.callbacks.reduce(function(t,e){return jQuery.contains(document.documentElement,e.dom.get(0))&&(e.callback(i),t.push(e)),t},[]))}.bind(this),i=0;$(document).on({dragover:function(t){return!1},dragenter:function(t){return e(!0),i++,!1},drop:function(t){if(e(!1),i=0,!$(t.target).is("input"))return!1},dragleave:function(t){0===--i&&e(!1)}}),this.bindState=!0},add:function(t,e){this.bindState||this.bind(),this.callbacks.push({dom:t,callback:e})},create:function(t){var e=t.param||{},i="boolean"==typeof e.multiple&&e.multiple,a=_.clarify(e.mod,"attach-zone"),n=_({param:{class:"attach-zone "+a},content:[{param:{class:"attach-zone__list"}},{param:{class:"attach-zone__actions"},content:[{param:{class:"attach-zone__description"},content:"Attachments (you can drag and drop here)"},{param:{class:"attach-zone__upload"},content:{param:{class:"c-input__file"},content:[{param:{tag:"input",attr:{multiple:i,type:"file",name:e.name||""},event:e.event||(e.callback?"input change":"input"),callback:e.callback||function(){!0===e.uploadPreview&&o(this)}}},{param:{class:"file__text"},content:[{name:"icon",param:{name:"attach",cover:!0,style:{"margin-right":5}}},"Upload file"+(i?"s":"")]}]}}]},{param:{class:"attach-zone__placeholder"},content:"Drop File Here"}]}),o=function(t){for(var e,i=n.find(".attach-zone__list"),a=0;a<t.files.length;a++)i.append((e=t.files[0],_({param:{class:"attach-zone__file attach-zone__file--upload"},content:[{name:"icon",param:{name:"attach",cover:!0,style:{"margin-right":5}}},{param:{class:"attach-zone__name"},content:{name:"link",content:ellipsis(e.name,[13,3],!0)}},{param:{class:"attach-zone__toolbar"},content:{param:{tag:"span",class:"light"},content:e.size.fileSize(!0)}}]})))};return this.add(n,function(t){n.toggleClass("attach-zone--drag",t)}),n}},uiElement:function(t){return{dom:$('<div class="ui"><div class="ui__title">'+t.param.title+'</div><div class="ui__content ui__content--column-'+(t.param.column||1)+'" style="display: none"></div></div>'),append:function(t){this.dom.find(".ui__content").append(t)}}},uiRow:function(t){var e=t.param,i=$('<div class="ui__row"><div class="ui__head"><div class="ui__heading">'+e.title+'</div><div class="ui__description">'+(e.description||"")+'</div></div><div class="ui__element"></div><textarea class="ui__shortcode" readonly></textarea>'),a=i.find(".ui__shortcode"),n=JSON.stringify(e.insert,function(t,e){return"function"==typeof e?"{function callback here}":e},"\t");return n=n.replace(/"/g,"'").replace(/'(.+)':/g,"$1:"),a.val(n).on("click",function(){this.select(),document.execCommand("copy")}).css("height",a.scrollHeight),i.find(".ui__element").append(_(e.insert)),i},table:function(t){var e=t.param||{},i=!!e.contentScroll,a=_.clarify(e.mod,"fm-table"),n=_({param:{class:"fm-table "+a+(e.class?" "+e.class:""),data:e.data,attr:e.attr,style:e.style,event:e.event,callback:e.callback,bind:e.bind},content:[e.heading?{param:{class:"fm-table__heading",attr:e.attrHeading},content:[].concat(e.heading).map(function(t){return{param:{class:"fm-table__col"},content:t}})}:"",{param:{class:"fm-table__content",style:!(i||!e.contentHeight)&&{height:e.contentHeight}}}]});return i&&(n.find(".fm-table__content").wrap('<div class="fm-table__scroller" style="'+vts(e.contentHeight," height: "+e.contentHeight)+'"></div>'),n.find(".fm-table__scroller").customScroll()),{dom:n,append:function(t){n.find(".fm-table__content").append(t)}}},row:function(t){var e=t.param||{},i=_.clarify(e.mod,"fm-table__row"),a=$('<div class="fm-table__row '+i+'"></div>');return _.appendAttr(a,e.attr),_.bind(a,e.bind),e.selected&&a.addClass("selected"),e.style&&a.css(e.style),e.class&&a.addClass(e.class),"function"==typeof e.callback&&a.on(e.event||"click",e.callback),{dom:a,append:function(t){t instanceof jQuery&&t.hasClass("fm-table__col")?a.append(t):a.append(_({param:{class:"fm-table__col"},content:t}))}}},rowIcon:function(t){var e=t.param||{};return _({param:Object.assign(e,{class:["fm-table__icon",e.addClass||"",e.class].join(" ").trim()}),content:{name:"icon",param:{name:e.name||e.icon}}})},board:function(t){var e=t.param||{},i=_.clarify(e.mod,"fm-board"),a=_({param:{class:"fm-board "+i,event:e.event,callback:e.callback}});return _.appendData(a,e.data),_.appendAttr(a,e.attr),_.appendStyle(a,e.style),_.bind(a,e.bind),{dom:a,append:function(t){t instanceof jQuery&&t.hasClass("fm-board__block")?a.append(t):a.append(_({param:{class:"fm-board__block"},content:t}))}}},linkList:function(t){var e=t.param||{},i=_.clarify(e.mod,"fm-linklist"),a=$('<div class="fm-linklist '+i+'"></div>');return{dom:a,append:function(t){a.append($('<div class="fm-linklist__item"></div>').append(t))}}},tab:function(t){var n=t.param||{},o=$('<div class="block__tabs"></div>'),s=!1;return o.on("click",".tab",function(){var t=$(this),e=t.index(),i=o.find(".tab.active"),a=i.length&&e<i.index()?"right":"left";t.removeClass("right left"),i.removeClass("right left"),t.addClass(a),i.addClass("right"==a?"left":"right"),t.addClass("active"),i.removeClass("active"),!s&&n.callback&&"function"==typeof n.callback&&n.callback.call(t,t.data("value"))}),n.controller&&n.controller(function(t,e){o.find(".tab").each(function(){$(this).data("value")==t&&($(this).hasClass("active")||(e&&(s=!0),$(this).trigger("click"),s=!1))})}),o},tabItem:function(t){var e=t.param||{},i=_.clarify(e.mod,"tab"),a=$('<div class="tab '+i+(e.state?" active":"")+'"><div class="tab__text" data-note="'+(e.note||"")+'"></div><div class="tab__bar"></div></div>');return _.appendData(a,e.data),{dom:a,append:function(t){a.find(".tab__text").append(t)}}},col:function(t){var e=t.param||{},i=_.clarify(e.mod,"fm-col");return _({param:Object.assign(e,{class:"fm-col "+i+(e.class?" "+e.class:"")})})},panel:function(t){var e=t.param||{},i=_.clarify(e.mod,"fm-panel"),a=_({param:{class:"fm-panel__content"}});return{dom:_({param:{class:"fm-panel "+i,data:e.data,attr:e.attr,style:e.style,bind:e.bind},content:[e.heading?{param:{class:"fm-panel__heading"},content:"string"==typeof e.heading?{param:{tag:"h4"},content:e.heading}:e.heading}:"",a]}),append:function(t){a.append(t)}}},panelSelectBar:function(t){t.param;return $('<div class="fm-panel__selectbar"></div>')},userAvatar:function(t){var i=t.param||{},e=_.clarify(i.mod,"fm-useravatar"),a=$('<div class="block__useravatar '+e+'"></div>').append('<div class="useravatar__avatar"'+vts(i.value,' style="background-image: url('+i.value+')"')+"></div>").append($('<div class="useravatar__upload"></div>').append("<label>Profile Photo</label>").append(_({name:"button",param:{mod:["white"],text:"Change photo",tag:"div"},content:{name:"input",param:{mod:["fill","invisiable"],attr:{accept:"image/jpeg,image/png"},type:"file"}}})).append('<p class="light">The image should be no larger than 500x500 pixels and 1Mb</p>')),n=a.find(".useravatar__avatar"),o=a.find("input");a.find(".button");return o.on("change",function(){var t=this.files[0];if(-1<["jpeg","jpg","png"].indexOf(t.name.split(".").pop())&&t.size<=105e4){var e=n.loader("cover");n.addClass("useravatar__avatar--loading");app.upload({file:t,url:"setuserPic",done:function(t){(t=JSON.parse(t)).status?(n.setBackground({url:t.file.filename,loader:e}),i.callback&&"function"==typeof i.callback&&i.callback(t.file.filename),n.removeClass("useravatar__avatar--loading")):e.done()},error:function(t){e.done(),n.removeClass("useravatar__avatar--loading")}})}else app.modules.get("alert",{type:"alert",heading:"Can't upload this file",content:"The image should be no larger than 500x500 pixels and 1Mb",buttons:["Ok"]},function(t){});$(this).val("")}),i.value&&a.find(".useravatar__avatar").setBackground(i.value),a},userBilling:function(t){var e=_({name:"link",content:"Payment setting"});e.attr('data-field="link"'),e.hide();var i=$('<div class="block__userbilling"></div>').append($('<div class="userbilling"></div>').append($('<div class="userbilling__info"></div>').append('<h4 data-field="tarif"></h4><p data-field="projects" class="light"></p><p data-field="file" class="light"></p>').append(e)).append('<div data-field="img" class="userbilling__img"></div>'));return app.serverRequest("fastSpringProfileLink").then(function(t){t.result&&(e.attr("href",t.url),e.show())}),i},heading:function(t){var e=t.param||{},i=_.clarify(e.mod,"fm-heading"),a=$('<h4 class="fm-heading '+i+'"></h4>');return e.style&&a.css(e.style),a},paragraph:function(t){var e=t.param||{},i=_.clarify(e.mod,"fm-paragraph");$('<p class="fm-paragraph '+i+'"></p>');return!0===e.hashParse&&(t.content=_.hashParse(t.content)),_({param:Object.assign({tag:"p"},e,{class:[].concat(["fm-paragraph",_.clarify(e.mod,"fm-paragraph"),e.class||""]).join(" ").trim()})})},invitePeople:function(t){var s,a=t.param||{},i=([].concat(a.mod||[]),a.list||[]),n=a.value||[],e=function(){var e=this.dom.find(".fm-invite-people__container").loader("blockLight");this.list=this.data.then(function(t){return n=n.concat(t.map(function(t){return{id:t.id,state:t.state}})),this.ready=!0,this.list=t.map(function(t){return new o(t)}),this.render(),e.done(),this.list}.bind(this)),this.button.addClass("disabled")};e.prototype={get orderList(){if(this.search){var s=new RegExp(this.search.split("").join(" ?"),"i");return this.list.forEach(function(t){var e=-1,i=t.data.name.search(s),a=t.data.email.search(s);t.field("name").html(-1<i?t.name.replace(s,'<span class="founded">$&</span>'):t.definition),t.field("email").html(-1<a?t.data.email.replace(s,'<span class="founded">$&</span>'):t.data.email);var n=Math.min(i,a),o=Math.max(i,a);-1<o&&(e=-1<n?n:o),t.display=-1<e,t.searchIndex=e}),this.list.sort(function(t,e){return t.searchIndex-e.searchIndex}),this.list}return this.list.forEach(function(t){t.display=!0,t.field("name").html(t.definition),t.field("email").html(t.data.email)}),this.list.sort(function(t,e){return t.data.lock?-1:e.data.lock?1:e.state-t.state})},render:function(){if(!this.ready)return!1;var e=0;this.orderList.forEach(function(t){t.display?(this.listContainer.append(t.dom),e++):t.dom.detach()}.bind(this)),this.viewLength=e},get request(){return a.hasOwnProperty("projectId")&&a.projectId?app.serverRequest("usersbyproject",{project_id:a.projectId}).then(function(t){return t.map(function(t){return{id:t.id,name:t.name,email:t.login,avatar:safetyObjectAccess(t,["img","filename"],!1),state:t.in_project,lock:t.id==User.id?"You":!!t.is_owner&&"Owner",invited:!parseInt(t.active)}})}):app.serverRequest("userlist").then(function(t){return t.map(function(t){return{id:t.id,name:[t.first_name,t.last_name].filter(function(t){return!!t}).join(" "),email:t.login,avatar:safetyObjectAccess(t,["img","filename"],!1),state:t.id==User.id,lock:t.id==User.id&&"You",invited:!parseInt(t.active)}})})},get data(){return new Promise(function(e,t){!0===a.request?this.request.then(function(t){e(t)},function(){e([])}):e(i)}.bind(this))},get search(){return this._search||!1},set search(e){if(!equals(e,this.search)){e=e.replace(/ /g,"")||!1,this._search=e,this.render();var t=!this.list.find(function(t){return t.data.email===e});if(t){t=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e)}this.button.toggleClass("disabled",!t)}},inviteLink:function(t){var e=_({param:{class:"fm-invite-people__invitelink"},content:{name:"input",param:{name:"invite",type:"text",mod:"button",attr:{readonly:!0},button:{name:"button",param:{mod:["blue","short"],text:"Copy",callback:function(){this.parents(".js-invite").find("input").inputFocus(!0),document.execCommand("copy"),this.addClass("button--green").removeClass("button--blue").find(".button__text").text("Copied")}}},value:"",placeholder:"Email"}}}),i=e.loader("blockLight"),a=e.find("input");a.inputFocus(),app.serverRequest("getInviteLink",{login:t}).then(function(t){t.status&&a.val(t.link).inputFocus(!0),i.done()});var n=e.clickOutside(o);function o(){n(),e.removeClass("active").onTransitionEnd(250).then(function(){e.remove()})}a.on("keydown",function(t){27==t.keyCode&&(a.blur(),o())}),this.dom.find(".js-invite").append(e),forceReflow(e),e.addClass("active")},serialize:function(){var t=[];return this.list.forEach(function(e){e.id?n.find(function(t){return t.id==e.id&&t.state==e.state})||t.push({id:e.id,state:e.state}):e.state&&t.push({email:e.data.email,state:!0})}),t},add:function(){var t=this.input.val();this.list.push(new o({id:!1,name:"",email:t,avatar:!1,state:!0,lock:!1,invited:!0})),this.render()},get selectedLength(){return this.list.reduce(function(t,e){return t+e.state},0)},checkLimit:function(){a.limit&&a.hasOwnProperty("limitMax")&&(this.selectedLength>=a.limitMax?this.list.forEach(function(t){!1!==t.state||t.lock||(t.lock=!0,t.lockReason="limitMax")}):this.list.forEach(function(t){t.lock&&"limitMax"===t.lockReason&&(t.lock=!1,t.lockReason=!1)}))},get input(){return this._input||(this._input=this.dom.find(".fm-invite-people__input input")),this._input},get button(){return this._button||(this._button=this.dom.find(".fm-invite-people__input button")),this._button},get listContainer(){return this._listContainer||(this._listContainer=this.dom.find(".js-list-container").removeClass("js-list-container")),this._listContainer},get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){var e=this,t=_.clarify(a.mod,"fm-invite-people"),i=_({param:{class:"fm-invite-people "+t,data:{value:function(){return e.serialize()}}},content:[{param:{class:"fm-invite-people__input"},content:{name:"input",param:{name:"search",type:"text",mod:"button",callback:function(t){e.search=t.value},button:{name:"button",param:{mod:["blue","short"],text:"Add",callback:function(){e.add()}}},value:"",label:"Add people",placeholder:"Email or Name"}}},{param:{class:"fm-invite-people__invite js-invite"}},{param:{class:"fm-invite-people__container"},content:{param:{class:"fm-invite-people__scroller"},content:{name:"table",param:{mod:["compact","white","hover"],contentScroll:!0,contentHeight:"100%"}}}}]});return i.find(".fm-invite-people__scroller").find(".fm-table__content").addClass("js-list-container"),a.hasOwnProperty("height")&&i.css("height",a.height),i}};var o=function(t){this.data=t};return o.prototype={get id(){return this.data.id},field:function(t){return this.dom.find('[data-field="'+t+'"]')},get dom(){return this._dom||(this._dom=this.template),this._dom},get state(){return void 0!==this._state?this._state:this.data.state},set state(t){equals(this.state,t)||(this._state=t,this.toggle.prop("checked",t))},get lock(){return this.data.lock},set lock(t){equals(this.lock,t)||(this.data.lock=t,this.toggle.attr("disabled",t))},get toggle(){return this._toggle||(this._toggle=this.dom.find("input")),this._toggle},get name(){return this.data.name+(this.data.lock?" <b>("+this.data.lock+")</b>":"")},get definition(){return this.invited?'<span class="invited">Invited</span>':this.name},get invited(){return this.data.invited},get template(){var e=this,t=_,i=$('<div class="fm-invite-people__designation"><div class="fm-invite-people__avatar"></div><div class="fm-invite-people__name" data-field="name">'+this.definition+'</div><div class="fm-invite-people__email" data-field="email">'+this.data.email+"</div></div>");this.data.avatar&&i.find(".fm-invite-people__avatar").setBackground(this.data.avatar);var a=$('<div class="fm-invite-people__toggle"></div>').append(_({name:"toggle",param:{checked:e.state,disabled:!!e.data.lock,name:"user",value:this.id,callback:function(t){e.state=t.state,e.data.changed="manual",s.checkLimit()}}})),n=_({name:"row",content:[i,a]});if(this.invited&&this.id){var o=t({param:{class:"fm-invite-people__invitation"},content:{param:{class:"text",callback:function(){setTimeout(function(){s.inviteLink(e.data.email)},10)}},content:[{name:"icon",param:{name:"link",cover:!0,style:{"margin-right":"5px"}}},"Invite link"]}});i.append(o),n.hover(function(){o.addClass("active")},function(){o.removeClass("active")})}return n}},(s=new e).dom.data("invitePeople",s),s.dom},projectMembers:function(t){var e,i,a=t.param||{},n=_.clarify(a.mod,"fm-members"),o=a.max||3,s=a.list.length,r=a.short,c=s-o,l=$('<div class="fm-members '+n+'"></div>'),d=$('<div class="fm-members__list"></div>').appendTo(l),h=$('<div class="fm-members__more"></div>').appendTo(l);_({name:"button",param:{mod:["doted","round","narrow"],icon:"plus"}}).appendTo(l),a.style&&l.css(a.style);for(var u=0;u<Math.min(o,s);u++)e=a.list[u],i=void 0,i=$('<div class="fm-members__item"></div>'),e.img&&i.setBackground(e.img),d.append(i);return 0<c?(h.show(),h.text("+"+c+(r?"":" user"+(1<c?"s":"")))):h.hide(),l.on("click",function(){app.modules.get("modalTemplates","invitePeople",a.id).then(function(t){t&&t.length&&(l.loader(a.cover||"cover"),app.serverRequest("switchmembers",{members:t}),app.projects.updateList(!0))})}),l},userFlowList:function(t){var a,n=t.param||{},o=n.callback;return _({param:{class:"userflow__list"},content:[{param:{class:"userflow__list"},content:{param:{class:"userflow-list__title",callback:function(){var t=n.value(),e=n.list(),i=_({name:"table",param:{mod:["background","hover","striped","pointer","iconflash"],style:{"max-height":"calc( 100vh - 249px )"},contentScroll:!0},content:e.map(function(e){return{name:"row",param:{selected:e.id==t,style:{"min-height":"50px"},callback:function(){a.close(),o("open",e.id)}},content:[e.title].concat(n.edit?[[{name:"buttonIcon",param:{name:"edit",title:"Change title",callback:function(t){t.stopPropagation(),a.close(),o("edit",e.id)}}},{name:"buttonIcon",param:{name:"duplicate",title:"Duplicate Userflow",callback:function(t){t.stopPropagation(),a.close(),o("duplicate",e.id)}}},{name:"buttonIcon",param:{name:"delete",title:"Delete Userflow",callback:function(t){t.stopPropagation(),a.close(),o("delete",e.id)}}}]]:[])}})});i.find(".fm-table__scroller .scroller").css("max-height","calc( 100vh - 249px )"),a=$(this).popover(_([i,n.edit?{name:"button",param:{mod:["blue","auto"],text:"Add User Flow",icon:"plus",style:{width:"calc(100% - 40px)",margin:"20px"},callback:function(){a.close(),o("create")}}}:""]),{mark:"active",mod:["huge","bot","left","white"]})}},content:[{name:"icon",param:{name:"userflow",cover:!0,style:{"margin-right":5}}},{param:{class:"userflow-list__text js-userflow-title"},content:n.title},{name:"iconArrow",param:{style:{"margin-left":5}}}]}},n.edit?{param:{class:"userflow-list__button",callback:function(){o("create")}},content:[{name:"button",param:{mod:["blue","narrow","round"],icon:"plus"}},{param:{class:"userflow-list__note"},content:"Add User Flow"}]}:""]})},notify:function(t){var e=t.param||{},i=!1;switch(e.mod){case"red":i=_({name:"icon",param:{name:"alert"}});break;case"green":i=_({name:"icon",param:{name:"success"}});break;case"yellow":i=_({name:"icon",param:{name:"warning"}})}var a=$('<div class="fm-notify fm-notify--'+e.mod+'"><div class="fm-notify__content"></div><div class="fm-notify__close js-close"></div></div>');a.find(".fm-notify__close").append(_({name:"icon",param:{name:"uncheck"}}));var n=a.find(".fm-notify__content");return i&&a.prepend(i),{dom:a,append:function(t){n.append(t)}}},custom:function(){},emptyPlaceholder:{templates:{projectsEmpty:{style:{"min-height":660},content:[{mod:"icon",style:{width:190,height:140},content:$('<img src="/app/img/emptystate/emptyprojects.png">')},{mod:"heading",content:{name:"heading",param:{mod:["big","light","center"]},content:"Create your first project"}},{mod:"description",content:{name:"paragraph",param:{mod:["center","gray"]},content:"Build interactive sitemaps for comfortable collaboration in real time. \n Effective interaction. Better teamwork."}},{mod:"action",content:{name:"button",param:{attr:{"data-empty-action":"create"},mod:["blue"],icon:"plus",text:"Create project"}}}]},projectsEmptyNoAction:{style:{"min-height":660},content:[{mod:"heading",content:{name:"heading",param:{mod:["light","center"]},content:"You don’t have Projects"}},{mod:"icon",style:{width:190,height:140},content:$('<img src="/app/img/emptystate/emptyprojects.png">')},{mod:"description",content:{name:"paragraph",param:{mod:["center","gray"]},content:{name:"link",param:{href:"/projects?event=create",internal:!0},content:"Create project"}}}]},projectsNotFound:{style:{"min-height":660},content:[{mod:"icon",style:{width:190,height:140},content:$('<img src="/app/img/emptystate/emptyprojects.png">')},{mod:"heading",content:{name:"heading",param:{mod:["big","light","center"]},content:"No results found"}},{mod:"description",content:{name:"paragraph",param:{mod:["center","gray"]},content:"Try adjusting your search or filter to find what you're looking for."}}]},flowmapEmpty:{style:{"min-height":660,background:"#f0f4f7"},content:[{mod:"icon",style:{width:211,height:129},content:$('<img src="/app/img/emptystate/emptyflowmap.png">')},{mod:"heading",content:{name:"heading",param:{mod:["big","light","center"]},content:"Create your first page"}},{mod:"action",content:{name:"button",param:{attr:{"data-empty-action":"create"},mod:["blue"],icon:"plus",text:"Create Page"}}}]},flowmapNotFound:{style:{"min-height":660,background:"#f0f4f7"},content:[{mod:"icon",style:{width:211,height:129},content:$('<img src="/app/img/emptystate/emptyflowmap.png">')},{mod:"heading",content:{name:"heading",param:{mod:["big","light","center"]},content:"No results found"}},{mod:"description",content:{name:"paragraph",param:{mod:["center","gray"]},content:"Try adjusting your search or filter to find what you're looking for."}}]},archiveEmpty:{style:{"min-height":660},content:[{mod:"icon",style:{width:190,height:140},content:$('<img src="/app/img/emptystate/emptyprojects.png">')},{mod:"heading",content:{name:"heading",param:{mod:["big","light","center"]},content:"You don’t have archieved Projects"}},{mod:"description",content:{name:"paragraph",param:{mod:["center","gray"]},content:["If you don't want to delete the project, you can archive it\non the ",{name:"link",param:{href:"/projects",internal:!0},content:"projects page"}]}}]},peopleEmpty:{style:{"min-height":660,background:"#f0f4f7"},content:[{mod:"icon",style:{width:173,height:173},content:$('<img src="/app/img/emptystate/emptypeople.png">')},{mod:"heading",content:{name:"heading",param:{mod:["big","light","center"]},content:"You do not collaborate with anyone yet."}},{mod:"description",content:{name:"paragraph",param:{mod:["center","gray"]},content:["Add people to projects ",{name:"link",param:{href:"/projects",internal:!0},content:"projects"}," and they will be displayed here."]}}]},peopleNotFound:{style:{"min-height":660,background:"#f0f4f7"},content:[{mod:"icon",style:{width:173,height:173},content:$('<img src="/app/img/emptystate/emptypeople.png">')},{mod:"heading",content:{name:"heading",param:{mod:["big","light","center"]},content:"No results found"}},{mod:"description",content:{name:"paragraph",param:{mod:["center","gray"]},content:"Try adjusting your search or filter to find what you're looking for."}}]},activityEmpty:{style:{"min-height":660},content:[{mod:"heading",content:{name:"heading",param:{mod:["light","center"]},content:"You have no notifications"}},{mod:"icon",style:{width:169,height:167,"margin-left":10},content:$('<img src="/app/img/emptystate/notifications.png">')},{mod:"description",content:{name:"link",param:{href:"/profile/notifications",callback:function(){app.activity.modal.modal.close()},internal:!0},content:"Notifications settings"}}]},activityNotFound:{style:{"min-height":660},content:[{mod:"heading",content:{name:"heading",param:{mod:["light","center"]},content:"No results found"}},{mod:"icon",style:{width:169,height:167,"margin-left":10},content:$('<img src="/app/img/emptystate/notifications.png">')},{mod:"description",content:{name:"paragraph",param:{mod:["center","gray"]},content:"Try adjusting your search or filter to find what you're looking for."}}]},historyEmpty:{style:{"min-height":660},content:[{mod:"heading",content:{name:"heading",param:{mod:["light","center"]},content:"You haven't made any purchases yet."}},{mod:"icon",style:{width:209,height:161,"margin-left":25},content:$('<img src="/app/img/emptystate/empty_invoice_history.png">')},{mod:"description",content:{name:"paragraph",param:{mod:["center","gray"]},content:{name:"link",param:{href:"/updateplan",internal:!0},content:"Upgrade Plan"}}}]},invoiceLoad:{style:{"padding-top":"50px"},content:[{mod:"icon",style:{width:209,height:161,"margin-left":25},content:$('<img src="/app/img/emptystate/empty_invoice_history.png">')},{mod:"description",content:{name:"button",param:{mod:["blue"],text:"Show invoice history",attr:{"data-empty-action":!0}}}}]},flowmapPageFilesEmpty:{style:{"min-height":660,"z-index":10},content:[{mod:"heading",content:{name:"heading",param:{mod:["light","center"]},content:"There are no files"}},{mod:"icon",style:{width:167,height:170},content:$('<img src="/app/img/emptystate/emptyfiles.png">')},{mod:"description",content:{name:"paragraph",param:{mod:["center","gray"]},content:{name:"link",param:{href:"#",callback:function(){},attr:{"data-empty-action":"toInfo"}},content:"Go to info"}}}]},userFlowEmpty:{style:{"min-height":660},content:[{mod:"icon",style:{width:172,height:151},content:$('<img src="/app/img/emptystate/emptyuserflow.png">')},{mod:"heading",content:{name:"heading",param:{mod:["big","light","center"]},content:"Let's User Flow begins"}},{mod:"description",content:{name:"paragraph",param:{mod:["center","gray"]},content:"Build interactive User Flows for comfortable collaboration in real time.\nEffective interaction. Better teamwork."}},{mod:"action",content:{name:"button",param:{attr:{"data-empty-action":"create"},mod:["blue"],icon:"plus",text:"Create User Flow"}}}]},userFlowEmptyShare:{style:{"min-height":660},content:[{mod:"icon",style:{width:172,height:151},content:$('<img src="/app/img/emptystate/emptyuserflow.png">')},{mod:"heading",content:{name:"heading",param:{mod:["big","light","center"]},content:"No any User Flow yet."}}]},projectBackupEmpty:{style:{"min-height":660},content:[{mod:"heading",content:{name:"heading",param:{mod:["light","center"]},content:"There are no Project's Backups"}},{mod:"icon",style:{width:119,height:132},content:$('<img src="/app/img/emptystate/empty_backup.png">')},{mod:"description",content:{name:"paragraph",param:{mod:["center","gray"]},content:"Backup allows you to save current state of the Project and restore it at any time."}},{mod:"action",content:{name:"button",param:{attr:{"data-empty-action":"create"},mod:["blue"],icon:"backup",text:"Create backup"}}}]},projectListBackupEmpty:{content:[{mod:"heading",content:{name:"heading",param:{mod:["light","center"]},content:"There are no Project's Backups"}},{mod:"icon",style:{width:119,height:132},content:$('<img src="/app/img/emptystate/empty_backup.png">')},{mod:"description",content:{name:"paragraph",param:{mod:["center","gray"]},content:"Backup allows you to save current state of the Project\n and restore it at any time."}},{mod:"action",content:{name:"button",param:{attr:{"data-empty-action":"upload"},mod:["blue"],tag:"div",icon:"backup",text:"Upload backup"},content:{name:"input",param:{mod:["fill","invisiable","pointer"],attr:{accept:".fmb"},type:"file"}}}}]},exportEmpty:{style:{width:"400px",height:"600px"},content:[{mod:"icon",style:{width:190,height:140},content:$('<img src="/app/img/emptystate/empty_img_uf.png">')},{mod:"description",content:{name:"paragraph",param:{mod:["center","gray"]},content:'Set parameters and click "Generate and Preview" button.'}},{mod:"action",content:{name:"button",param:{attr:{"data-empty-action":"create"},mod:["white"],text:"Generate and Preview"}}}]},labelsListEmpty:{style:{"min-height":660},content:[{mod:"icon",style:{width:147,height:80},content:$('<img src="/app/img/emptystate/empty_system_labels.png">')},{mod:"heading",content:{name:"heading",param:{mod:["big","light","center"]},content:"There are no System Labels!"}},{mod:"action",content:{name:"button",param:{attr:{"data-empty-action":"create"},mod:["blue"],icon:"plus",text:"Create System Labels"}}}]},pageCoversListEmpty:{style:{"min-height":660},content:[{mod:"icon",style:{width:138,height:109},content:$('<img src="/app/img/emptystate/empty_custom_page_covers.png">')},{mod:"heading",content:{name:"heading",param:{mod:["big","light","center"]},content:"There are no Page's Covers!"}},{mod:"action",content:{name:"button",param:{attr:{"data-empty-action":"create"},mod:["blue"],icon:"plus",text:"Create Page's Covers Set"}}}]}},create:function(t){var e=t.param||{},i=_.clarify(e.mod,"fm-empty"),a=e.template,n=$('<div class="fm-empty '+i+'"><div class="fm-empty__container"></div></div>'),o=n.find(".fm-empty__container");return((a=a?"object"==typeof a?{content:a}:this.templates.hasOwnProperty(a)?this.templates[a]:[]:[]).content||[]).forEach(function(t){var e=$('<div class="fm-empty__'+t.mod+'"></div>');e.append(_(t.content)),t.style&&e.css(t.style),o.append(e)}),a.style&&n.css(a.style),e.callback&&"function"==typeof e.callback&&n.on(e.event||"click","[data-empty-action]",function(t){e.callback($(this).data("emptyAction"),this)}),e.active&&n.addClass("open"),n}},flowmapTree:function(t){var e=t.param||{},i=e.flowmap,a="function"==typeof e.callback&&e.callback,s=_({param:{class:"fm-flowmap-tree__separator"},content:"Footer Pages"}),r=_({param:{class:"fm-flowmap-tree",style:{height:"auto"}},content:s}),c=_({param:{style:{width:"100%",height:e.height||"100%",background:"#ffffff"}},content:r}),l=(c=$('<div style="width: 100%; height: 100%; background: #ffffff"></div>'),r=$('<div class="fm-flowmap-tree" style="height: auto"></div>').appendTo(c),s=$('<div class="fm-flowmap-tree__separator">Footer Pages</div>').appendTo(r),[]),d=20,h=28,n=function(){var t,i=0,a=c.width(),n=l[0].group,o=!1;l.forEach(function(t){var e=10+(t.x+1)*d;n!==t.group&&(n=t.group,s.css({transform:"translate(0px, "+i*h+"px)",opacity:1}),i+=1,o=!0),t.display?(t.dom.css({width:"100%","padding-left":e,transform:"translate(0px, "+i*h+"px)",opacity:1,"z-index":i+2,"pointer-events":"auto"}),t.dom.toggleClass("even",!!(i%2)),i++,a=Math.max(e+t.dom.find(".js-title").width()+100,a)):t.dom.css({width:"0","padding-left":0,transform:"translate(0px, "+i*h+"px)","z-index":1,"pointer-events":"none",opacity:0})}),t=i*h,r.css({width:a,height:(i+.5)*h}),e.autoHeight&&c.height(Math.max(Math.min(t,e.maxHeight||1/0),e.minHeight||0)),s.toggle(o)},o=function(t,e){a&&a(t,e)},u=function(t,e,i){this.settings=i,this.card=t,this.x=e,this.display=!0,this.children=this.card.children.map(function(t){return new u(t,e+1,i)})};u.prototype={get height(){return this.spoiler?1:this.children.reduce(function(t,e){return t+e.height},1)},updateSpoiler:function(e){this.display=!e,e=e||this.spoiler,this.children.forEach(function(t){t.updateSpoiler(e)})},get spoiler(){return this._spoiler||!1},set spoiler(e){equals(this.spoiler,e)||(this._spoiler=e,this.dom.toggleClass("spoiler",e),this.children.forEach(function(t){t.updateSpoiler(e)}),n())},get group(){return this.card.group},get parent(){return!!this.card.children.length},get id(){return this.card.id},get title(){return this.card.get("title")},get dom(){return this._dom||("creator"===this.settings.mod?this._dom=_({param:{class:"fm-flowmap-tree__item fm-flowmap-tree__item--creator",callback:function(t){t.stopPropagation(),o("create",i.createNewCard(this.card.parent||!1,this.card.parent?this.card.parent.children.length:0,!1,this.group))}.bind(this)},content:[{param:{tag:"span",class:"plus"}},this.title]}):this._dom=_({param:{class:"fm-flowmap-tree__item"+(this.parent?" parent":""),style:{"padding-left":"30px",transform:"translate(0px, 0px)",opacity:"1","pointer-events":"auto"},callback:function(t){o("select",this.id)}.bind(this)},content:[{param:{class:"fm-flowmap-tree__spoiler ",callback:function(t){t.stopPropagation(),this.spoiler=!this.spoiler}.bind(this)}},{param:{class:"fm-flowmap-tree__title js-title"},content:this.title},e.create&&this.settings.createChild?{param:{class:"fm-flowmap-tree__create",callback:function(t){t.stopPropagation(),o("create",i.createNewCard(this.card,this.card.children.length,void 0,this.group))}.bind(this)}}:""]}),r.append(this._dom),this._dom.on("click",function(t){$(t.target).closest(".js-spoiler").length?this.spoiler=!this.spoiler:o(this.id)}.bind(this))),this._dom}};var p=function(t){l.push(t),t.children.forEach(p)},m=c.loader("coverLight");return convertToPromise(i).then(function(t){(i=t).cardTree.id?p(new u(i.cardTree,0,{createChild:!0})):p(new u(i.cardTree,0,{createChild:!1,mod:"creator"})),i.footerPages.children.forEach(function(t){t.id?l.push(new u(t,0,{createChild:!1})):e.create&&l.push(new u(t,0,{createChild:!1,mod:"creator"}))},0),setTimeout(function(){n(),m.done()},100)}),c.customScroll({drt:"bi"}),c},flowmapLabel:function(t){var r,c=t.param||{},l=function(){return c.list.map(function(t){return{color:t.color,value:t.id,text:t.text,editable:t.editable,project_id:t.project_id}}).sort(function(t,e){return e.project_id-t.project_id})},n=!!c.multitude,o=c.multitudeLimit||1/0,s=n?[].concat(c.value):c.value,d=c.defaultValue||"none",h=function(){b.toggleClass("fm-flowmap-labels--limited",s.length>=o)},u=function(e,i,a){var t=function(t){"boolean"==typeof i&&"function"==typeof c.input&&c.input(t||e,i)};if(n){if(h(),m(e))s=[e],t(e);else{if(!0===i&&s.length>=o)return!1;s.findAndRemove(function(t){return m(t)},!0),void 0===i?s=[].concat(e):(t(e),i&&!s.includes(e)?s.push(e):s.findAndRemove(function(t){return t===e}))}s.length||(s=[d]),h()}else s=e;a&&(a.find(".selected").removeClass("selected"),[].concat(s).forEach(function(t){a.find('[data-value="'+t+'"]').addClass("selected")})),v(),f()},p=function(t){return n?s.includes(t):s==t},m=function(t){return!!Array.isArray(c.lonerList)&&c.lonerList.includes(t)},f=function(){"function"==typeof c.callback&&c.callback(s.slice(0))},g=function(t){var e=t.color,i=t.value,a=t.text,n="none"===i?"fm-flowmap-labels__color--empty":"all"===i?"fm-flowmap-labels__color--all":isColorLight(e,210)?"fm-flowmap-labels__color--light":"";return _({param:{class:"fm-flowmap-labels__color "+n,attr:{"data-value":i},style:{background:e}},content:a})},v=function(){var t=b.find(".fm-flowmap-labels__result"),e="function"==typeof c.valueRender&&c.valueRender(s,t);if(e)t.insert(e);else{var i=[].concat(s).reduce(function(t,e){var i=l().find(function(t){return e==t.value});return i&&t.push(g(i)),t},[]);i=i.length?i:[d],t.insert(i),t.get(0).scrollWidth>(c["max-width"]?c["max-width"]-40:t.get(0).offsetWidth)&&t.find(".fm-flowmap-labels__color").text(function(){return $(this).text()[0]})}},b=_({param:{class:"fm-flowmap-labels"+(c.mod?" "+_.clarify(c.mod,"fm-flowmap-labels"):"")+(c.class?" "+c.class:"")},content:[c.label?{param:{class:"fm-flowmap-labels__label"},content:c.label}:"",{param:{class:"fm-flowmap-labels__result",style:{width:c.width||"auto","max-width":c["max-width"]||"none"},callback:function(){var e=function(){},o=function(t){a.trigger("slide",1),t&&t.color&&(i.find('input[name="color"]').val(t.color),e(t.color)),i.find('input[name="value"]').val(t?t.value:""),i.find('input[name="mod"]').val(t?"edit":"new"),i.find('input[name="title"]').val(t?t.text:"New Label").inputFocus(!0),i.find('[data-action="submit"]').attr("disabled",!!t)},s=_([{param:{class:"fm-flowmap-labels__container"},content:{param:{class:"fm-flowmap-labels__list"}}},{param:{class:"fm-flowmap-labels__actions"},content:{name:"button",param:{mod:["blue","narrow","long"],icon:"plus",text:"Create New Label",callback:function(){o()}}}}]),i=_({param:{class:"fm-flowmap-labels__edit"},content:[{param:{class:"fm-flowmap-labels__backward",callback:function(){a.trigger("slide",0)}},content:[{name:"icon",param:{name:"back"}},{name:"paragraph",param:{mod:["light","gray"],style:{"margin-left":"3px"}},content:"Back"}]},{param:{class:"fm-flowmap-labels__input"},content:[{name:"input",param:{name:"title",placeholder:"Label Title",mod:["narrow","full"],value:"New Label",callback:function(){i.find('[data-action="submit"]').attr("disabled",!$(this).val().replace(/ /g,"").length)}}},{name:"input",param:{type:"hidden",name:"value",mod:["hidden"],value:""}},{name:"input",param:{type:"hidden",mod:["hidden"],name:"color",value:""}},{name:"input",param:{type:"hidden",mod:["hidden"],name:"mod",value:""}}]},{param:{class:"fm-flowmap-labels__colorlist",call:{fn:function(){app.colorList($(this),{inline:!0,setValue:function(t){e=t},callback:{input:function(t){i.find('input[name="color"]').val(t),i.find('[data-action="submit"]').attr("disabled",!1)}}})}}}},{param:{class:"fm-flowmap-labels__actions"},content:{name:"button",param:{attr:{"data-action":"submit"},mod:["blue","narrow","long"],text:"Save",callback:function(){var t=$(this).loader("button");(function(e,i){if("new"===e.mod&&"function"==typeof c.newLabel)return c.newLabel({title:e.title,color:e.color}).then(function(t){r(),u(t.value,!0,i)});if("edit"===e.mod&&"function"==typeof c.changeLabel){var t=l().find(function(t){return t.value==e.value});return t.color=e.color,t.text=e.title,c.changeLabel({id:e.value,title:e.title,color:e.color,project_id:t.project_id||[]}).then(function(t){r(),v()})}})(i.serializeJson(),s).then(function(){a.trigger("slide",0),t.done()})}}}}]}),a=_({name:"slider",param:{items:[s,i]}});(r=function(){var a={sys:"System Labels",project:"Project Labels"},n="none";s.find(".fm-flowmap-labels__list").insert(_(l().map(function(i){var t=[],e=void 0===i.project_id?"none":i.project_id?"project":"sys";return n!==e&&(n=e,t.push({param:{class:"fm-flowmap-labels__separator"},content:a[e]})),t.push({param:{class:"fm-flowmap-labels__item "+(p(i.value)?"selected":"")+(m(i.value)?" loner":""),attr:{"data-value":i.value},callback:function(){u(i.value,!p(i.value),s)}},content:[g(i),{param:{class:"fm-flowmap-labels__indicator"}},i.editable?[{param:{class:"fm-flowmap-labels__icon",callback:function(t){t.stopPropagation(),o(i)}},content:{name:"icon",param:{name:"edit",style:{width:10,height:10},cover:!0}}},{param:{class:"fm-flowmap-labels__icon",callback:function(t){var e;t.stopPropagation(),e=i.value,"function"==typeof c.removeLabel&&c.removeLabel(e).then(function(){u(e,!1),r()})}},content:{name:"icon",param:{name:"bin_small"}}}]:""]}),t}))),forceReflow(s),"function"==typeof t&&t()})();var n=b.popover({param:{class:"fm-flowmap-labels__popover"},content:a},{mod:c.popoverMod||["right","bot"]});if(n){n.onClose(function(){b.find(".fm-flowmap-labels__result").removeClass("open"),setTimeout(function(){n.dom.find("[data-scroll]").baron().dispose()},500),f()}),n.dom.find(".fm-flowmap-labels__container").customScroll(),b.find(".fm-flowmap-labels__result").addClass("open");var t=function(){if(n){var t=n.dom.find(".fm-flowmap-labels__list"),e=t.find(".fm-flowmap-labels__color"),i=n.dom.find(".fm-flowmap-labels__container");i.css({width:Math.max.apply(Math,$.makeArray(e).map(function(t){return t.scrollWidth+68+30})),height:Math.min(350,t.outerHeight())}),forceReflow(t,i),n.dom.find("[data-scroll]").baron().update(),setTimeout(function(){n&&n.dom.find("[data-scroll]").baron().update()},100)}};t(),a.trigger("slide",0),app.modules.get("overflow",n.dom)}}}}]});return b.on("value",function(t,e){equals(s,e.value)||u(e.value)}),v(),h(),!0===c.rerender&&setTimeout(v,10),b},list:function(t){var e=t.param||{},i=_.clarify(e.mod,"fm-list"),a=$('<ul class="fm-list '+i+'"></ul>');return{dom:a,append:function(t){$('<li class="fm-list__item"></li>').append(t).appendTo(a)}}},colorPicker:function(t){var e=t.param||{},i=e.colors||["#76E27A","#FD6764","#FF7C43","#FFD663","#848DEA","#58A8F7","#50E3C2","#CC92F1"],a=e.value||i[0],n=e.settings||{},o=$('<div class="fm-colorpicker"><input type="text" name="color" value="'+a+'"><div class="fm-colorpicker__trigger"></div></div>'),s=o.find("input");return a&&o.css("background",a),o.on("click",".fm-colorpicker__trigger",function(){var t=$('<div class="fm-colorpicker__list">'+i.map(function(t){return'<div class="fm-colorpicker__color'+(t==a?" active":"")+'" data-value="'+t+'" style="background: '+t+'"></div>'}).join("")+"</div>"),e=o.popover(t,Object.assign({mod:["white","large","bot","right"]},n));t.on("click","[data-value]",function(){var t=$(this).data("value");$(this).addClass("active").siblings().removeClass("active"),a=t,o.css("background",t),s.val(t).trigger("change"),e.close()})}),o.on("update",function(t){t.stopPropagation(),a=s.val(),o.css("background",a)}),o},breadCrumb:function(t){var a=t.param||{},n=a.value,e=a.path.map(function(t){return"string"==typeof t?{name:t,value:t}:t});return _({param:{class:"fm-breadcrumb"},content:e.reduce(function(t,e,i){return 0<i&&t.push({param:{class:"fm-breadcrumb__separator"},content:{name:"icon",param:{name:"micro_arrow"}}}),t.push({param:{class:"fm-breadcrumb__item"+(e.value===n?" active":""),callback:function(){"function"==typeof a.callback&&a.callback(e.value)}},content:e.name}),t},[])})},slider:function(t){var e=vod(t.param,{},"object"),i=e.mod,s=(e.items||[]).map(function(t){return _({param:{class:"fm-slider__item"},content:t})}),r=_({param:{class:"fm-slider__container"},content:s}),a=_({param:{class:"fm-slider "+_.clarify(i,"fm-slider")},content:r}),c=!1,l=!1,d=!1;return a.on("slide",function(t,e){l!==e&&function(t){if(c)return;c=!0;var e="number"==typeof l?l<t?"right":"left":"none",i=s[l=t],a=d,n=_.clarify(["in","drt-"+e,"preanimate"],"fm-slider__item"),o=_.clarify(["out","drt-"+e,"preanimate"],"fm-slider__item");a&&(r.css({width:a.width(),height:a.height()}),a.addClass(o).removeClass("fm-slider__item--static")),i.addClass(n),forceReflow(r,i,d),i.addClass("animate active"),a&&a.addClass("animate").removeClass("active"),r.addClass("animate"),r.css({width:i.width(),height:i.height()}),setTimeout(function(){i.addClass("fm-slider__item--static").removeClass(n).removeClass("animate"),a&&a.removeClass(o).removeClass("close animate"),r.removeClass("animate"),r.css({width:"",height:""}),c=!1},250),d=i}(e)}),a},spoiler:function(t){var e=t.param||{},i=_.clarify(e.mod,"fm-spoiler"),a=e.state||!1,n=e.fixed||!1,o=!!e.strict,s=_({param:{class:"fm-spoiler__header"+(e.customHeader?" fm-spoiler__header--custom":""),callback:function(t){var e=$(t.target);(!o||e.is(s)||e.hasClass(".js-arrow"))&&l(!a)}},content:e.customHeader?e.customHeader:[{param:{class:"fm-spoiler__title"},content:e.header||""},{param:{class:"fm-spoiler__arrow js-arrow"+(a?" active":"")},content:{name:"iconArrow"}},e.hideline?{param:{class:"fm-spoiler__hideline"}}:""]}),r=_({param:{class:"fm-spoiler__content",style:!a&&{display:"none"}}}),c=_({param:{class:"fm-spoiler "+(a?"fm-spoiler--open ":"")+i},content:[s,r]}),l=function(t){n||(a=t,c.toggleClass("fm-spoiler--open",a),s.find(".js-arrow").toggleClass("active",a),r[a?"slideDown":"slideUp"](e.speed||300))};return c.on({"spoiler-open":function(t){l(!0)},"spoiler-close":function(t){l(!1)},"spoiler-toggle":function(t,e){l(void 0!==e?e:!a)},"spoiler-fix":function(t,e){n=void 0!==e?e:!n}}),_.appendAttr(c,e.attr),_.appendStyle(c,e.style),_.bind(c,e.bind),{dom:c,append:function(t){r.append(t)}}},colorPicker2:function(t){var e=t.param||{},i=e.value;return _({param:{style:{width:33,height:33,position:"relative","border-radius":"50%",cursor:"pointer",transition:".15s ease-out",background:i},callback:function(){app.colorList($(this),e||{})}}})},customTextarea:function(t){var e=t.param||{},i=function(){return"function"!=typeof e.callback||e.callback.apply(null,argsToArray({arguments:arguments}))},a={state:null,setState:function(t){var e=null!=t?t:!this.state;equals(this.state,e)||(this.state=e,this.dom.prop("contenteditable",e),this.dom.toggleClass("fm-textarea--edit",e),setTimeout(function(){this.state?this.focus():this.blur()}.bind(this),10))},setValue:function(t){this.oldValue=t,this.dom.html(t),this.scrollToBegin(),this.dom.toggleClass("fm-textarea--empty",!t.replace(/(<br>)| /g,"").length)},getValue:function(){return this.dom.html()},reset:function(t){if(!1===i(t,"reset",{value:this.oldValue}))return!1;this.setValue(this.oldValue),this.setState(!1)},change:function(t){if(!1===i(t,"change",{value:this.getValue()}))return!1;this.setValue(this.getValue()),this.setState(!1)},scrollToBegin:function(){this.dom.scrollTop(0),this.dom.scrollLeft(0)},focus:function(){this.nDom.focus(),this.nDom.select(),i(null,"focus",{})},blur:function(){this.nDom.blur(),this.scrollToBegin(),window.getSelection().removeAllRanges(),i(null,"blur",{})},bind:function(){this.dom.on("click",function(t){this.state||!1===i(t,"beforeFocus",{value:this.getValue()})||this.setState(!0)}.bind(this)).on("edit",function(t,e){this.setState(e)}.bind(this)).on("value",function(t,e){this.setValue(e)}.bind(this)).on("paste",function(t){var e=t.originalEvent;console.log(t,e),t.preventDefault(),t.stopPropagation();var i=e.clipboardData.getData("text/plain");document.execCommand("insertHTML",!1,i)}).on("keydown keyup",function(t){!0===e.stopPropagation&&t.stopPropagation(),13===t.keyCode?e.multiLine&&(t.shiftKey||t.metaKey||t.ctrlKey)||!1!==this.change(t)&&(t.preventDefault(),t.stopPropagation()):27===t.keyCode&&!1!==this.reset(t)&&(t.preventDefault(),t.stopPropagation())}.bind(this)).clickOutside(function(t){this.state&&!1!==i(t,"beforeBlur",{})&&this.change(t)}.bind(this))},get nDom(){return this.dom.get(0)},get dom(){return this._dom||(this._dom=_({param:{class:"fm-textarea "+_.clarify(e.mod,"fm-textarea")+" "+e.class||"",attr:{contenteditable:!1},style:Object.assign({},e.style||{})}})),this._dom}};return a.setState(null==e.state||e.state),a.setValue(removeHTMLfromString(e.value||"")),a.bind(),a.dom},backupList:function(t){var e=t.param||{},i="function"==typeof e.callback?e.callback:function(){};return _({name:"table",param:{heading:e.heading,class:"fm-backup",mod:["background","striped","hover"],contentHeight:e.height||!1,contentScroll:e.scroll||!1},content:[e.add?{name:"row",param:{mod:["nowrap"]},content:[_({param:{class:"fm-table__col fm-table__col--pointer",callback:function(){i("create")}},content:[{param:{class:"fm-backup__timeline fm-backup__timeline--short"},content:{param:{class:"fm-flowmap-addpagestructure__button",style:{margin:0}}}},{name:"buttonIcon",param:{name:"backup",active:!0}},{name:"paragraph",param:{mod:["blue","bold"]},content:"Backup Project"}]})]}:""].concat(e.list.map(function(t){var e=_({name:"row",param:{mod:["nowrap"]},content:[[{param:{class:"fm-backup__timeline"},content:{param:{class:"fm-backup__dot"}}},{name:"rowIcon",param:{name:"backup",mod:"static"}},t.displayName],{param:{class:"fm-backup__col"},content:[{name:"button",param:{mod:["narrow","blue"],text:"Restore",callback:function(){i("restore",t,e)}}},{name:"buttonIcon",param:{name:"download",tag:"a",attr:{download:t.fileName,href:t.fileLink}}},{name:"buttonIcon",param:{name:"delete",callback:function(){i("remove",t.id,e)}}}]}]});return e}))})},html:function(t){var e=t.param||{},i=e.tag||"div",a=$(document.createElement(i));if(_.appendData(a,e.data),_.appendAttr(a,e.attr),_.appendStyle(a,e.style),_.appendClass(a,e.class),e.count){for(var n=$(),o=0;o<e.count-1;o++)n=n.add(a.clone());a=a.add(n)}return e.callback&&a.on(e.event||"click",e.callback),_.bind(a,e.bind),[].concat(e.call||[]).forEach(function(t){"function"==typeof t?t.call(a):"object"==typeof t&&"function"==typeof e.call.fn&&t.fn.apply(a,e.call.args||[])}),a},htmlstr:function(t){var e=$();return t.content=t.content.map(function(t){return $(t)}),{dom:e,append:function(t){this.dom=this.dom.add(t)}}},layout:function(t){var e=t.param||{},i=_({param:{class:"fm-layout "+_.clarify(e.mod,"fm-layout")}});return _.appendData(i,e.data),_.appendAttr(i,e.attr),_.appendStyle(i,e.style),_.bind(i,e.bind),e.callback&&i.on(e.event||"click",e.callback),i},scroller:function(t){var e=t.param||{},i=_.clarify(e.mod,"fm-scroller"),a=_({param:{class:"fm-scroller "+i}}),n=null;if(e.real||e.baron)a.customScroll(e.real||e.baron),n=a.find(".scroller");else if(a.addClass("fm-scroller--fake"),n=_({param:{class:"fm-scroller__container",style:{padding:"0 "+systemScrollBarWidth+"px "+systemScrollBarWidth+"px 0"}}}).appendTo(a),e.scrollbar){var o=_({param:{class:"fm-scroller__scrollbar"}}),s=_({param:{class:"fm-scroller__rail"},content:o});a.append(s);var r=function(){var t=this.scrollTop(),e=this.height(),i=this.get(0).scrollHeight;e<i?(s.addClass("active"),o.css({height:e/i*100+"%",top:t/i*100+"%"})):s.removeClass("active")}.bind(n);n.on("scroll",r),n.on("update",r),setTimeout(r,10),setTimeout(r,100)}return{dom:a,append:$.fn.append.bind(n)}},default:function(t){return console.warn('Missing HTMLbuilder component "'+t.name+'"'),console.trace(),$('<div>Missing HTMLbuilder component "'+t.name+'"</div>')},pageCovers:function(t){var a=t.param||{},e={init:function(){this._sidebarState=toBoolean(User.getUserSettings(["projects","customCoverSideBar"],!1));var i=this.dom.loader("blockLight");this.loadPacks().then(function(){var t,e=this.packs.map(function(t){return t.id});a.value&&(t=this.packs.find(function(t){return!!t.list.find(function(t){return t.link===a.value})}))&&(t=t.id),t||(t=oneOfMany(User.getUserSettings(["flowmap",a.projectId,"customCoverPack"]),e,"default",function(t,e){return t==e})),this.openPack(t),i.done()}.bind(this))},loadPacks:function(){return app.pageCovers.getPacks(a.projectId).then(function(t){this.packs=t,this.renderPackList()}.bind(this)).catch(console.log)},getPackById:function(e){return this.packs.find(function(t){return t.id==e})},renderPackList:function(){var i=this;this.packs.forEach(function(t){t.dom=_({name:"row",param:{callback:function(){i.openPack(t.id)}},content:[[{name:"paragraph",param:{mod:["bold","unsetcolor"],style:{"line-height":"28px"}},content:t.title},{param:{tag:"span",class:"light gray",style:{"margin-left":"15px"}},content:LangHelp.plural.eng("cover",t.list.length,!0)}]]})}),this.packList.insert(_(this.packs.map(function(t){return t.dom}).concat({name:"row",content:{name:"button",param:{text:"Add New Cover Set",mod:["tablecol"],icon:"plus",style:{height:28},callback:function(){app.pageCovers.createPack(a.projectId).then(function(t){if(t){var e=i.dom.loader("blockLight");i.loadPacks().then(function(){i.openPack(t.pack.id),e.done()})}})}}}})))},openPack:function(t){this.selectedPack&&this.selectedPack.dom.removeClass("selected"),this.selectedPack=this.getPackById(t),this.selectedPack&&(this.selectedPack.dom.addClass("selected"),this.renderPack(this.selectedPack),User.setUserSettings(["flowmap",a.projectId,"customCoverPack"],this.selectedPack.id))},renderPack:function(n){var o=this;this.covers&&this.covers.forEach(function(t){t.dom.css({top:0,opacity:0}).onTransitionEnd(150).then(function(){t.dom.remove()})}),this.title.text(n.title),this.covers=n.list.map(function(t){return this.coverTemplate(t,n)},this),this.covers.some(function(t){if(t.link===this.value)return this.selectItem(t),!0},this),n.editable&&this.covers.push({dom:_({param:{class:"fm-pagecovers__cover fm-pagecovers__cover--creator"},content:{name:"button",param:{tag:"div",mod:["doted","round","narrow","coverage"],icon:"plus"},content:{name:"input",param:{mod:["fill","invisiable","pointer"],attr:{accept:"image/jpeg, image/png, image/svg+xml",multiple:"multiple"},containerStyle:{"z-index":100},name:"covers",type:"file",events:"change",callback:function(){var t=Array.prototype.slice.call(this.get(0).files).map(function(e){var i={},a={};return{file:e,onStart:function(t){i=t,n.list.push(i),(a=o.coverTemplate(i,n)).loader=a.dom.loader("coverLoad"),a.dom.addClass("uploading"),a.dom.find(".fm-pagecovers__image").css("background-image","url("+window.URL.createObjectURL(e)+")"),o.covers.push(a)},onProgress:function(t){a.loader.state(t)},onDone:function(t){a.loader.done(),a.id=t.id,a.link=safetyObjectAccess(t,["file","filename"],!1),a.dom.removeClass("uploading"),i.id=t.id,i.link=safetyObjectAccess(t,["file","filename"],!1)},onError:function(){o.covers.findAndRemove(a),n.list.findAndRemove(i),o.sortCovers(),o.updatePackView(),n.dom.find("span").text(LangHelp.plural.eng("cover",n.list.length,!0))}}});app.pageCovers.uploadCovers(t,n),o.sortCovers(),o.updatePackView(),n.dom.find("span").text(LangHelp.plural.eng("cover",n.list.length,!0))}}}}}),editable:!1,sortable:!1,title:"",searchTags:[]}),this.sortedCovers=this.covers.slice(0),this.scroller.off("scroll",$.proxy(this.scrollBind,this)),this.scroller.scrollTop(0),this.lastSavedScrollRow=0,this.scroller.on("scroll",$.proxy(this.scrollBind,this,this.scroller,this.gridParam)),this.sortCovers(),this.search&&!this.manualSelected&&this.selectItem(this.sortedCovers[0]),this.updatePackView(),this.scroller.trigger("update")},sortCovers:function(){if(this.search){var n=this.search,t=this.covers,e=t.length;t.forEach(function(a,t){a.founded=!1,a.sortable?a.searchIndex=a.searchTags.reduce(function(t,e){var i=e.indexOf(n);return-1<i?(a.founded=!0,Math.min(i,t)):t},9e3+t):a.searchIndex=9e3+e},this),this.sortedCovers.sort(function(t,e){if(this.manualSelected){if(t.selected)return-1;if(e.selected)return 1}return t.searchIndex<e.searchIndex?-1:t.searchIndex>e.searchIndex?1:t.searchTags[0]<e.searchTags[0]?-1:t.searchTags[0]>e.searchTags[0]?1:0}.bind(this))}else{var i=this.selectedPack&&this.selectedPack.editable;this.sortedCovers=this.covers.slice(0).sort(function(t,e){if(this.manualSelected){if(t.selected)return-1;if(e.selected)return 1}if(i){if(!t.editable)return 1;if(!e.selected)return-1}return 0}.bind(this))}return this.sortedCovers},updatePackView:function(){var t=this.sortedCovers,i=this.gridParam,e=Math.ceil(t.length/i.row),a=this.scroller.scrollTop();this.coversList.height(e*i.y+40),this.separator.css("width",i.row*i.x);var n=Math.max(0,Math.floor(a/i.y))*i.row-1,o=Math.min(n+1+3*i.row,t.length);t.forEach(function(t,e){n<e&&e<o?(t.attached||(t.attached=!0,t.dom.appendTo(this.coversList)),t.toRemove=!1):t.attached&&(t.toRemove=!0)}.bind(this));var s=this.search;window.requestAnimationFrame(function(){t.forEach(function(t,e){t.dom.setTransform({x:(e%i.row+i.shift)*i.x,y:Math.floor(e/i.row)*i.y,o:!s||t.founded?1:.9}).toggleClass("available",!!s&&t.founded),t.toRemove&&t.dom.onTransitionEnd(100).then(function(){t.toRemove&&(t.toRemove=!1,t.attached=!1,t.dom.detach())})})}.bind(this))},set search(t){t=t.replace(/ /g,"").toLowerCase(),equals(t,this.search)||(this._search=!!t.length&&t,this.sortCovers(),this.manualSelected||this.selectItem(this.sortedCovers[0]),this.scroller.scrollTop(0),this.updatePackView())},get search(){return this._search||!1},selectItem:function(t){this.selectedCover&&(this.selectedCover.selected=!1,this.selectedCover.dom.removeClass("selected")),t.selected=!0,t.dom.addClass("selected"),this.value=t.link,this.selectedCover=t},value:a.value||!1,packTemplate:function(t){},coverTemplate:function(r,t){var c=this,e=!1,l=function(t){return t.reduce(function(t,e){var i=e.toLowerCase(),a=e.replace(/ |-|_/g,"");return t.push(i),a!==i&&t.push(a),t},[])},d=Object.assign({dom:_({param:{class:"fm-pagecovers__cover"+(t.editable?" fm-pagecovers__cover--editable":""),style:{opacity:0},callback:function(){this.manualSelected=!0,this.selectItem(d)}.bind(this)},content:[{param:{class:"fm-pagecovers__image",call:!!r.link&&{fn:$.fn.setBackground,args:[r.link]}},content:[{param:{class:"fm-pagecovers__selector"}},t.editable?{param:{class:"fm-pagecovers__buttons",callback:function(t){t.stopPropagation()}},content:[{name:"buttonIcon",param:{name:"tag",callback:function(){var t=c.gridParam,e=_({name:"tags",param:{value:r.tags}}),i=c.scroller.scrollTop(),a=c.scroller.get(0).scrollHeight,n=d.dom.position().top,o=n+150<i+c.scroller.height()?{top:n+30}:{bottom:a-n},s=c.coversList.popover(e,{width:4===t.row?593:t.row*t.x+10,mod:["right","bottom","white"],style:Object.assign({right:4===t.row?37:48,padding:10},o)});s&&(c.scroller.css("overflow","hidden"),app.modules.get("modalList",!0).push(s),s.onClose(function(){var t=e.data("value");app.pageCovers.editCover(d.id,{tags:t}),r.tags=t.slice(0),d.tags=t,d.searchTags=l([r.title].concat(r.tags)),c.scroller.css("overflow",""),app.modules.get("modalList",!0).findAndRemove(s)}),setTimeout(function(){e.trigger("fmfocus")},50))}}},{name:"buttonIcon",param:{name:"edit",title:"Edit title",callback:function(){d.dom.find(".fm-pagecovers__name input").trigger("edittitle")}}},{name:"buttonIcon",param:{name:"delete",title:"Remove Cover",callback:function(){t.list.findAndRemove(function(t){return t.id===d.id}),c.covers.findAndRemove(function(t){return t.id===d.id}),d.dom.setTransform({o:0,p:!1}).onTransitionEnd(100).then(function(){d.dom.remove()}),app.pageCovers.removeCovers(d.id),c.sortCovers(),c.updatePackView()}}}]}:""]},{param:{class:"fm-pagecovers__name"},content:t.editable?{param:{tag:"input",attr:{readonly:!0,value:r.title},bind:{click:function(t){t.stopPropagation(),d.selected&&!e&&(e=!0,d.dom.addClass("edit"),$(this).attr("readonly",!1).inputFocus(!0))},edittitle:function(){e=!0,d.dom.addClass("edit"),$(this).attr("readonly",!1).inputFocus(!0)},"focusout change":function(){if(e){e=!1,d.dom.removeClass("edit"),$(this).blur(),$(this).attr("readonly",!0);var t=$(this).val();t.replace(/ /,"").length?(d.title=t,app.pageCovers.editCover(d.id,{title:t})):$(this).val(d.title)}}}}}:r.title}]}),editable:t.editable,attached:!1,selected:!1,sortable:!0,searchTags:l([r.title].concat(r.tags))},r);return d},scrollBind:function(t,e){var i=Math.floor(t.scrollTop()/e.y);i!==this.lastSavedScrollRow&&(this.lastSavedScrollRow=i,this.updatePackView())},get scroller(){return this.dom.find(".fm-pagecovers__container .fm-scroller .fm-scroller__container")},get gridParam(){return{x:142,y:168,shift:this.sidebarState?2:0,row:this.sidebarState?4:6}},set sidebarState(t){equals(this.sidebarState,t)||(this._sidebarState=t,User.setUserSettings(["projects","customCoverSideBar"],t),this.dom.toggleClass("fm-pagecovers--pick",t),this.updatePackView(),this.scroller.trigger("update"))},get sidebarState(){return this._sidebarState||!1},get separator(){return this._separator||(this._separator=this.dom.find(".fm-pagecovers__separator")),this._separator},get sidebar(){return this._sidebar||(this._sidebar=_({param:{class:"fm-pagecovers__sidebar"},content:{param:{class:"fm-pagecovers__packs"},content:{name:"panel",param:{mod:["stretch","fill","bordered"],heading:[{param:{tag:"h4"},content:"Project's Covers Set"}]},content:{name:"table",param:{mod:["pointer","stretch","hover"],contentScroll:!0}}}}})),this._sidebar},get hideBar(){return this._hidebar||(this._hidebar=_({param:{class:"fm-pagecovers__hidebar",callback:function(){this.sidebarState=!this.sidebarState}.bind(this)},content:[{param:{class:"fm-pagecovers__togglebutton"},content:{name:"buttonIcon",param:{name:"double_arrow"}}},{param:{class:"fm-pagecovers__hidenote"},content:"Hide bar"},{param:{class:"fm-pagecovers__shownote"},content:"Choose Project's Covers Set"}]})),this._hidebar},get coversList(){return this._coversList||(this._coversList=_({param:{class:"fm-pagecovers__list"}})),this._coversList},get title(){return this._title||(this._title=_({param:{class:"fm-pagecovers__title"}})),this._title},get packList(){return this._packList||(this._packList=this.sidebar.find(".fm-table__content")),this._packList},get dom(){return this._dom||(this._dom=_({param:{class:"fm-pagecovers"+(this.sidebarState?" fm-pagecovers--pick":"")},content:[this.sidebar,this.hideBar,{param:{class:"fm-pagecovers__container"},content:[{param:{class:"fm-pagecovers__separator"},content:this.title},{name:"scroller",param:{scrollbar:!0,mod:["nox","curtain"]},content:this.coversList}]}]}),this._dom.data("covers",this)),this._dom}};return e.init(),e.dom},tags:function(t){var e=t.param,i=!1,n=!1===e.limit?{letter:1/0,tags:1/0}:"object"==typeof e.limit?e.limit:{letter:30,tags:15},o=function(t){var e=_({param:{class:"fm-tags__item",attr:{"data-tag":t}},content:[{param:{class:"fm-tags__name"},content:t},{param:{class:"fm-tags__remove",callback:function(){a(t),e.remove(),s()}},content:{name:"icon",param:{name:"uncheck",cover:!0}}}]});return e},a=function(e){h.findAndRemove(function(t){return t===e}),d.data("value",h)},s=function(){h.length>n.tags?(r(),c.insert(""),d.find(".fm-tags__note").flash("active")):(i=!0,d.addClass("focus"),c.attr("contenteditable",!0),c.get(0).focus())},r=function(){i&&(i=!1,d.removeClass("focus"),c.attr("contenteditable",!1))},c=_({param:{class:"fm-tags__caret",bind:{keydown:function(t){if(13===t.keyCode)return t.preventDefault(),t.stopPropagation(),(e=c.text().toLowerCase()).replace(/ /,"").length&&(-1<h.indexOf(e)?(l.find('[data-tag="'+e+'"]').flash("active"),c.flash("active"),d.find(".fm-tags__note").flash("active")):(h.push(e),d.data("value",h),c.insert(""),o(e).insertBefore(c),setCaretPosition(c.get(0),0))),!1;var e,i=$(this).text();if(h.length>n.tags)r(),c.insert(""),d.find(".fm-tags__note").flash("active");else if(i.length>n.letter){var a=getCaretPosition(this);$(this).html(i.slice(0,n.letter)),setCaretPosition(this,a)}},keyup:function(t){var e=$(this).text();if(e.length>n.letter){var i=getCaretPosition(this);$(this).html(e.slice(0,n.letter)),setCaretPosition(this,i)}},paste:function(t){var e=t.originalEvent;t.preventDefault(),t.stopPropagation();var i=e.clipboardData.getData("text/plain");document.execCommand("insertHTML",!1,i)}}}}),l=_({param:{class:"fm-tags__container",callback:function(){if(!i)var t=d.clickOutside(function(){t(),r()});s()}},content:c}),d=_({param:{class:"fm-tags"},content:[{param:{class:"fm-tags__label"},content:"Tags:"},{param:{class:"fm-tags__wrap"},content:[l,{param:{class:"fm-tags__note",tag:"p"},content:["To add a new Tag press ",{param:{tag:"b"},content:"Enter"},". 15 unique tags are available. Tag's length is limited by 30 characters."]}]}]}),h=[].concat(e.value||[]);return d.data("value",h),h.forEach(function(t){o(t).insertBefore(c)}),d.on("fmfocus",function(){s()}),d}},function(){"use strict";var t=Quill.import("ui/icons");t.bold='<svg xmlns="http://www.w3.org/2000/svg" width="8" height="10" viewBox="0 0 8 10"><path d="M0,10 L0,0 L4.31982422,0 C6.5,0 7.5,1 7.5,2.5 C7.5,3.5 7,4.33333333 6,5 C7.33333333,5.66666667 8,6.5 8,7.5 C8,9 7,10 4.44970703,10 L0,10 Z M2,6 L2,8 L4.5,8 C5,8 5.5,7.5 5.5,7 C5.5,6.5 5,6 4.5,6 L2,6 Z M2,4 L4,4 C4.66666667,4 5,3.66666667 5,3 C5,2.33333333 4.66666667,2 4,2 L2,2 L2,4 Z"/> </svg>',t.italic='<svg xmlns="http://www.w3.org/2000/svg" width="8" height="10" viewBox="0 0 8 10"><path d="M5.66001028,2 L4.38467091,8 L7,8 L7,10 L0,10 L0,8 L2.33998972,8 L3.61532909,2 L1,2 L1,0 L8,0 L8,2 L5.66001028,2 Z"/> </svg>',t.underline='<svg xmlns="http://www.w3.org/2000/svg" width="8" height="10" viewBox="0 0 8 10"> <path d="M1.21325172e-12,5 L1.21325172e-12,-8.8817842e-16 L2,-8.8817842e-16 L2,5 C2,6.1045695 2.8954305,7 4,7 C5.1045695,7 6,6.1045695 6,5 L6,-8.8817842e-16 L8,-8.8817842e-16 L8,5 C8,7.209139 6.209139,9 4,9 C1.790861,9 1.21325172e-12,7.209139 1.21325172e-12,5 Z M0,9 L8,9 L8,10 L0,10 L0,9 Z"/> </svg>',t.blockquote='<svg xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8"> <path d="M2,0 L3,0 L3,8.8817842e-16 C4.1045695,6.85272294e-16 5,0.8954305 5,2 L5,4.39444872 C5,4.7892987 4.88312395,5.17531408 4.66410059,5.50384912 L3,8 L1,8 L2,5 C0.8954305,5 1.3527075e-16,4.1045695 0,3 L0,2 L0,2 C-1.3527075e-16,0.8954305 0.8954305,2.02906125e-16 2,0 L2,0 Z M9,0 L10,0 L10,8.8817842e-16 C11.1045695,6.85272294e-16 12,0.8954305 12,2 L12,4.39444872 C12,4.7892987 11.8831239,5.17531408 11.6641006,5.50384912 L10,8 L8,8 L9,5 C7.8954305,5 7,4.1045695 7,3 L7,2 L7,2 C7,0.8954305 7.8954305,2.02906125e-16 9,0 Z"/> </svg>',t["code-block"]='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="11" viewBox="0 0 16 11"> <path d="M0,4.5 L4,1 L5,2.5 L2,5.5 L5,8.5 L4,10 L0,6.5 L0,4.5 Z M16,4.5 L16,6.5 L12,10 L11,8.5 L14,5.5 L11,2.5 L12,1 L16,4.5 Z M8,0 L10,0.5 L8,11 L6,10.5 L8,0 Z"/> </svg>',t.link='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="10" viewBox="0 0 16 10"> <path d="M7.00009497,10.0029 L4.99369497,10.0029 C4.78309497,10.0002 4.57369497,9.9894 4.36469497,9.9628 C3.87389497,9.9004 3.39309497,9.7644 2.94239497,9.5605 C2.35699497,9.2957 1.82459497,8.9171 1.38129497,8.4522 C0.965194972,8.0157 0.628594972,7.5044 0.393594972,6.949 C0.167094972,6.4138 0.0358949719,5.8397 0.00649497187,5.2593 C-0.0213050281,4.7125 0.0401949719,4.1617 0.189894972,3.635 C0.377994972,2.9732 0.704794972,2.353 1.14269497,1.8225 C1.65399497,1.203 2.31399497,0.7097 3.05389497,0.3965 C3.47199497,0.2195 3.91419497,0.1003 4.36469497,0.043 C4.57369497,0.0164 4.78309497,0.0056 4.99369497,0.0029 L7.00009497,0.0029 L7.00009497,2.0029 C6.30749497,2.0029 5.61479497,1.9952 4.92229497,2.004 C4.84519497,2.0069 4.84579497,2.0069 4.76839497,2.0118 C4.39729497,2.0447 4.03719497,2.1363 3.70089497,2.2984 C2.91189497,2.6788 2.31309497,3.4044 2.09459497,4.2531 C2.01229497,4.5726 1.98389497,4.9056 2.00889497,5.2344 C2.03339497,5.5558 2.10999497,5.8727 2.23559497,6.1695 C2.37669497,6.503 2.57909497,6.8099 2.82889497,7.072 C3.09529497,7.3513 3.41509497,7.5791 3.76679497,7.7382 C4.03629497,7.8601 4.32379497,7.9413 4.61719497,7.9787 C4.74659497,7.9951 4.87609497,8.0012 5.00639497,8.0029 L7.00009497,8.0029 L7.00009497,10.0029 Z M9.00009497,10.0029 L9.00009497,8.0029 C9.69269497,8.0029 10.385295,8.0106 11.077895,8.0018 C11.477595,7.9866 11.868095,7.9034 12.233395,7.7382 C13.054095,7.3669 13.680795,6.6255 13.905595,5.7527 C13.987795,5.4332 14.016295,5.1002 13.991195,4.7714 C13.966695,4.45 13.890095,4.1331 13.764495,3.8363 C13.623395,3.5028 13.420995,3.1959 13.171195,2.9338 C12.904895,2.6545 12.584995,2.4267 12.233395,2.2676 C11.963895,2.1457 11.676395,2.0645 11.382995,2.0271 C11.253495,2.0107 11.123995,2.0046 10.993695,2.0029 L9.00009497,2.0029 L9.00009497,0.0029 C9.70959497,0.0029 10.419195,-0.0046 11.128595,0.0045 C11.340295,0.0125 11.550595,0.0284 11.760095,0.0604 C12.247695,0.135 12.723595,0.2826 13.167895,0.4968 C13.746095,0.7755 14.268795,1.1664 14.700495,1.6413 C15.106595,2.0881 15.430995,2.608 15.652695,3.1697 C15.850995,3.6723 15.966295,4.2068 15.993695,4.7465 C16.021395,5.2933 15.959895,5.8441 15.810195,6.3708 C15.622095,7.0326 15.295295,7.6528 14.857495,8.1833 C14.346095,8.8028 13.686195,9.2961 12.946295,9.6093 C12.528095,9.7863 12.085895,9.9055 11.635495,9.9628 C11.426395,9.9894 11.216995,10.0002 11.006395,10.0029 L9.00009497,10.0029 Z M11.000095,4.0029 L5.00009497,4.0029 C4.44779497,4.0029 4.00009497,4.4506 4.00009497,5.0029 C4.00009497,5.5552 4.44779497,6.0029 5.00009497,6.0029 L11.000095,6.0029 C11.552395,6.0029 12.000095,5.5552 12.000095,5.0029 C12.000095,4.4506 11.552395,4.0029 11.000095,4.0029 Z"/> </svg> ',t.list.ordered='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 14 14"><path d="M4 1h10v2h-10v-2zM4 6h10v2h-10v-2zM4 11h10v2h-10v-2zM0 2v-1h1v-1h1v4h-1v-2h-1zM0.553 7.724l1.447-0.724v-1h-1v1h-1v-1c0-0.552 0.448-1 1-1h1c0.552 0 1 0.448 1 1v0.586c0 0.265-0.105 0.52-0.293 0.707l-0.707 0.707h1v1h-3v-0.382c0-0.379 0.214-0.725 0.553-0.894zM0 10h2c0.552 0 1 0.448 1 1v0.5l-0.5 0.5 0.5 0.5v0.5c0 0.552-0.448 1-1 1h-2v-1h2v-0.5h-1v-1h1v-0.5h-2v-1z"></path></svg>',t.list.bullet='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="12" viewBox="0 0 14 12"><path d="M0 0h2v2h-2v-2zM0 5h2v2h-2v-2zM0 10h2v2h-2v-2zM4 0h10v2h-10v-2zM4 5h10v2h-10v-2zM4 10h10v2h-10v-2z"></path></svg>',Quill.import("formats/link").sanitize=function(t){return"//"==t.slice(0,2)||"http"==t.slice(0,4)?t:"//"+t}}(),app.modules.add("html",_)}(),function(){var t={get dom(){return $("#page_loader")},get bar(){return this.dom.find(".bar")},_step:0,get step(){return this._step},set step(t){this._step=t,this.bar.css("width",100*t+"%")},get random(){var t=this.step;return 0<=t&&t<.2?.1:.2<=t&&t<.5?.04:.5<=t&&t<.8?.02:.8<=t&&t<.99?.005:0},start:function(){if(1==this.inited)return!1;this.inited=!0,this.step=0,this.dom.removeClass("hide"),this.timer=setInterval(function(){this.step=this.step+this.random}.bind(this),150)},end:function(){if(0==this.inited)return!1;this.inited=!1,clearInterval(this.timer),this.step=1,setTimeout(function(){this.dom.addClass("hide"),setTimeout(function(){this.step=0}.bind(this),300)}.bind(this),200)}};app.modules.add("backstage",t)}(),function(){var i=function(t,e){this.defaultColors=e.colors||["#52565F","#76E27A","#FD6764","#FF7C43","#FFD663","#848DEA","#58A8F7","#50E3C2","#CC92F1","#FFFFFF","#A2CEF9","#4D9EF6"],this.target=t,this.customColors=(e.customColors||User.getUserSettings(["customColors"],[])).filter(function(t){return!this.defaultColors.includes(t.toUpperCase())},this).uniq(),this.direction=e.direction||{horizontal:"center",vertical:"bottom"},this.offset="object"==typeof e.offset?e.offset:"number"==typeof e.offset?{x:e.offset,y:e.offset}:{x:10,y:10},this.shift="object"==typeof e.shift?e.shift:"number"==typeof e.shift?{x:e.shift,y:e.shift}:{x:0,y:15},this.callback=e.callback||{},e.value&&(this.value=this.defaultValue=e.value),this.value||!1===e.autoSelectValue||(this.value=this.colorList[0].toUpperCase(),"function"==typeof this.callback.input&&setTimeout(function(){this.callback.input(this.value)}.bind(this),10)),!this.value||this.defaultColors.includes(this.value)||this.customColors.includes(this.value)||this.customColors.unshift(this.value),"function"==typeof e.setValue&&e.setValue(function(t){this.setValue(t)}.bind(this)),!0===e.inline?this.dom.addClass("fm-colorlist--inline"):(this.open(),this.bind(),this.target.data("ColorList",this))};i.prototype={get colorList(){return this.defaultColors.concat(this.customColors)},setValue:function(t){this.colorList.includes(t)||(this.customColors.unshift(t),this.dom.find(".js-custom").prepend(this.colorTemplate(t,!0)),"function"==typeof this.callback.newColor&&this.callback.newColor(t)),"milti"!==this.mod&&this.dom.find(".fm-colorlist__color--selected").removeClass("fm-colorlist__color--selected"),this.dom.find('[data-color="'+t+'"]').addClass("fm-colorlist__color--selected"),this.value=t,"function"==typeof this.callback.input&&this.callback.input(t)},calculatePosition:function(){var t=this.direction.horizontal,i=this.direction.vertical,a={left:0,top:0,shiftX:0,shiftY:0},e=function(){switch(t){case"auto":break;case"center":a.left=Math.round((this.target.outerWidth()-this.dom.outerWidth())/2),a.shiftX=this.shift.x;break;case"left":a.left=-1*Math.ceil(this.dom.outerWidth()+this.offset.x),a.shiftX=-1*this.shift.x;break;case"right":a.left=Math.ceil(this.target.outerWidth()+this.offset.x),a.shiftX=this.shift.x}}.bind(this),n=function(){switch(i){case"auto":var t=Math.ceil(this.target.outerHeight()+this.offset.y),e=this.target.offset();i=e.top+t+1.3*this.dom.outerHeight()<$(window).height()?"bottom":"top",n();break;case"center":a.top=Math.round((this.target.outerHeight()-this.dom.outerHeight())/2),a.shiftY=this.shift.y;break;case"top":a.top=-this.offset.y-this.dom.outerHeight(),a.shiftY=-1*this.shift.y;break;case"bot":case"bottom":a.top=Math.ceil(this.target.outerHeight()+this.offset.y),a.shiftY=this.shift.y}}.bind(this);e(),n(),this.position=a},bind:function(){app.modules.get("overflow",this.dom),this.clickOutSide=this.dom.clickOutside(function(){this.die()}.bind(this))},die:function(){this.clickOutSide&&this.clickOutSide(),this.close(),this.dom.onTransitionEnd(150).then(function(){this.dom.remove(),this.target.removeData("ColorList")}.bind(this)),"function"==typeof this.callback.change&&this.value!==this.defaultValue&&this.callback.change(this.value)},open:function(){this.calculatePosition(),this.dom.css({transform:"translate( "+(this.position.left+this.position.shiftX)+"px, "+(this.position.top+this.position.shiftY)+"px)"}),forceReflow(this.dom),this.dom.addClass("open"),this.dom.css({transform:"translate( "+this.position.left+"px, "+this.position.top+"px)"})},close:function(){this.dom.addClass("close"),this.dom.removeClass("open"),this.dom.css({transform:"translate( "+(this.position.left+this.position.shiftX)+"px, "+(this.position.top+this.position.shiftY)+"px)"})},saveColors:function(){User.setUserSettings(["customColors"],this.customColors)},removeColor:function(t){this.customColors.findAndRemove(t),this.dom.find('[data-color="'+t+'"]').remove(),"function"==typeof this.callback.removeColor&&this.callback.removeColor(t),this.saveColors()},get dom(){return this._dom||(this._dom=this.template.appendTo(this.target)),this._dom},colorTemplate:function(e,t){var i=this,a=app.modules.get("html",{param:{class:"fm-colorlist__color"+(isColorLight(e,210)?" fm-colorlist__color--light":"")+(e===i.value?" fm-colorlist__color--selected":""),attr:{"data-color":e},style:{background:e},callback:function(){i.setValue(e)},bind:[{event:"contextmenu",callback:function(){return!1}}]}});return t&&a.append(app.modules.get("html",{name:"menu",param:{mod:["fill","absolute","transparent","modest"],options:{remove:"Remove"},event:"mouseup",eventFilter:function(t){return 3===t.which},eventPropagation:!1,settings:{mouseleave:a,mouseleaveDelay:2500,width:79,mod:["white","large","bot","center"],clickOutside:{mouseButton:[1,2,3]}},callback:function(t){"remove"==t&&i.removeColor(e)}}})),a},get template(){var a=this,t=app.modules.get("html"),n=function(){return t({param:{class:"fm-colorlist__color fm-colorlist__add",callback:function(){var i=$(this);new Promise(function(e,t){new o(i,{input:function(t){i.css("background",t),i.toggleClass("fm-colorlist__color--light",isColorLight(t,210)),"function"==typeof a.callback.input&&a.callback.input(t)},submit:function(t){e(t)},open:function(){i.removeClass("fm-colorlist__add")},close:function(){"function"==typeof a.callback.input&&a.callback.input(a.value),e(a.value)}})}).then(function(t){var e=!!t&&a.colorList.includes(t);t&&!e?(i.off().on("click",function(){a.setValue(t)}).attr("data-color",t),setTimeout(function(){i.html("")},300),a.customColors.push(t),a.setValue(t),i.after(n()),a.saveColors(),"function"==typeof a.callback.newColor&&a.callback.newColor(t)):(e&&a.setValue(t),i.css("background",""),i.addClass("fm-colorlist__add"),i.removeClass("fm-colorlist__color--light"))})}},content:{name:"icon",param:{name:"plus",fill:"#58A8F7",style:{width:7,height:7}}}})};return t({param:{class:"fm-colorlist"},content:{param:{class:"fm-colorlist__container"},content:[{param:{class:"fm-colorlist__section"},content:this.defaultColors.map(function(t){return a.colorTemplate(t)})},{param:{class:"fm-colorlist__separator"},content:"Custom colors"},{param:{class:"fm-colorlist__section js-custom"},content:this.customColors.map(function(t){return a.colorTemplate(t,!0)}).concat(n())}]}})}};var o=function(t,e){if(this.target=t,this.options=e||{},this.target.data("colorPicker"))return!1;this.open(),this.bind(),this.hue=getRandomInt(360),this.platePosition={x:getRandomInt(100),y:getRandomInt(100)},this.target.data("colorPicker",this)};o.prototype={input:function(){"function"==typeof this.options.input&&this.options.input(this.color)},submit:function(){"function"==typeof this.options.submit&&this.options.submit(this.color),this.die()},updateColor:function(){this.dom.find(".js-platedot").css("background",this.color),this.dom.find("input").val(this.color.toUpperCase()),this.input()},get color(){return rgbToHex.apply(null,hsvToRgb(this.hue/360,this.platePosition.x/100,this.platePosition.y/100).map(function(t){return Math.round(t)})).toUpperCase()},set platePosition(t){equals(t,this.platePosition)||(this._platePosition=t,this.dom.find(".js-platedot").css({left:t.x+"%",bottom:t.y+"%"}),this.updateColor())},get platePosition(){return this._platePosition||{x:0,y:0}},dragState:function(t){this.dom.toggleClass("fm-colorpicker2--drag",t)},set hue(t){equals(this.hue,t)||(this._hue=t,this.dom.find(".js-huedot").css("left",t/360*100+"%"),this.plate.css("background","hsl("+this.hue+",100%,50%)"),this.updateColor())},get hue(){return this._hue||0},setColor:function(t){var e=hexToRgb(t),i=rgbToHsv(e.r,e.g,e.b);this.hue=360*i[0],this.platePosition={x:100*i[1],y:100*i[2]}},calculatePosition:function(){var t=0,e=6,i=0,a=15,n=this.dom.width(),o=this.dom.height(),s=this.target.offset(),r=this.target.width(),c=this.target.height(),l=$(window).width(),d=$(window).height(),h=n+s.left+t<l?"left":"right",u=o+s.top+c+e<d?"bottom":"top",p={left:0,top:0,shiftX:0,shiftY:0},m=function(){switch(h){case"left":p.left=0,p.shiftX=i;break;case"right":p.left=r-n,p.shiftX=i}}.bind(this),f=function(){switch(u){case"top":p.top=-1*(o+e),p.shiftY=-1*a;break;case"bottom":p.top=c+e,p.shiftY=a}}.bind(this);m(),f(),this.position=p},bind:function(){app.modules.get("overflow",this.dom),this.clickOutSide=this.dom.clickOutside(function(){this.die()}.bind(this))},die:function(){this.clickOutSide&&this.clickOutSide(),this.close(),this.dom.onTransitionEnd(150).then(function(){this.dom.remove(),this.target.removeData("colorPicker")}.bind(this))},open:function(){"function"==typeof this.options.open&&this.options.open(),this.calculatePosition(),this.dom.css({transform:"translate( "+(this.position.left+this.position.shiftX)+"px, "+(this.position.top+this.position.shiftY)+"px)"}),forceReflow(this.dom),this.dom.addClass("open"),this.dom.css({transform:"translate( "+this.position.left+"px, "+this.position.top+"px)"})},close:function(){this.dom.addClass("close"),this.dom.removeClass("open"),this.dom.css({transform:"translate( "+(this.position.left+this.position.shiftX)+"px, "+(this.position.top+this.position.shiftY)+"px)"}),"function"==typeof this.options.close&&this.options.close(!1)},get dom(){return this._dom||(this._dom=this.template.appendTo(this.target)),this._dom},get plate(){return this.dom.find(".fm-colorpicker2__plate")},get template(){var d=this;return app.modules.get("html",{param:{class:"fm-colorpicker2"},content:[{param:{class:"fm-colorpicker2__plate",attr:{draggable:!0},bind:[{event:"dragstart",callback:function(t){d.dragState(!0);var e=$(this),i=e.offset(),a=e.width(),n=e.height(),o=i.left,s=o+a,r=i.top,c=r+n,l=function(){var t=Math.min(Math.max(o,cursorX),s)-o,e=Math.min(Math.max(r,cursorY),c)-r;d.platePosition={x:t/a*100,y:100-e/n*100}};return $(document).on("mousemove",l),$(document).one("mouseup",function(){d.dragState(!1),$(document).off("mousemove",l)}),t.preventDefault(),!1}},{event:"click",callback:function(){var t=$(this),e=t.offset(),i=t.width(),a=t.height(),n=e.left,o=n+i,s=e.top,r=s+a,c=Math.min(Math.max(n,cursorX),o)-n,l=Math.min(Math.max(s,cursorY),r)-s;d.platePosition={x:c/i*100,y:100-l/a*100}}}]},content:{param:{class:"fm-colorpicker2__dot js-platedot"}}},{param:{class:"fm-colorpicker2__hue",attr:{draggable:!0},bind:[{event:"dragstart",callback:function(t){d.dragState(!0);var e=$(this),i=e.offset(),a=e.width(),n=i.left,o=n+a,s=function(){var t=Math.min(Math.max(n,cursorX),o);d.hue=(t-n)/a*360};return $(document).on("mousemove",s),$(document).one("mouseup",function(){d.dragState(!1),$(document).off("mousemove",s)}),t.preventDefault(),!1}},{event:"click",callback:function(){var t=$(this),e=t.offset(),i=t.width(),a=e.left,n=a+i,o=Math.min(Math.max(a,cursorX),n);d.hue=(o-a)/i*360}}]},content:{param:{class:"fm-colorpicker2__huedot  js-huedot"}}},{param:{class:"fm-colorpicker2__input"},content:{name:"input",param:{name:"color",type:"text",mod:["button","narrow","autobuttonwidth"],style:{padding:"0 67px 0 7px"},bind:[{event:"input",callback:function(){var t=$(this).val(),e=!1;7===t.length&&"#"===t[0]?e=t.slice(1):6===t.length&&(e=t),e&&isNumberValidByRadix(e,16)&&d.setColor(e)}},{event:"blur",callback:function(){}}],button:{name:"button",param:{mod:["blue","short"],text:"Add",style:{width:60},callback:function(){d.submit()}}},value:"",placeholder:"HEX"}}}]})}},app.colorList=function(t,e){return t.data("ColorList")?t.data("ColorList"):new i(t,e)}}(),function(){var i=function(){this.list=[]};i.prototype={add:function(t){Array.prototype.push.apply(this.list,[].concat(t))},exec:function(){this.list.forEach(function(t){t.fn.apply(t.ctx||window,t.arg||[])}),this.list.length=0}},app.modules.add("executingList",function(t){var e=new i;return"object"==typeof t&&e.add(t),e})}(),function(){var e=function(t){this.container=t.container,this.scroller=t.scroller};e.prototype={get scrollLeft(){return this.scroller.scrollLeft()},get scrollTop(){return this.scroller.scrollTop()},get maxScrollLeft(){return this.scroller.maxScrollLeft()},get maxScrollTop(){return this.scroller.maxScrollTop()},get coord(){return this._coord||{x:0,y:0}},set coord(t){equals(t,this.coord)||(this._coord=t,this.container.get(0).style.transform="translate3D("+this.coord.x+"px,"+this.coord.y+"px, 1px)")},move:function(t){var e={x:this.coord.x,y:this.coord.y};t.hasOwnProperty("x")&&(e.x-=t.x),t.hasOwnProperty("y")&&(e.y-=t.y),this.coord=e},compensate:function(){this.scroller.scrollLeft(this.scrollLeft-this.coord.x),this.scroller.scrollTop(this.scrollTop-this.coord.y),this.coord={x:0,y:0}},get api(){return{move:this.move.bind(this),compensate:this.compensate.bind(this)}}},app.modules.add("fakeScroll",function(t){return new e(t).api})}(),function(){var t=function(){};t.prototype={remove:function(){}}}(),function(){var n={},s=(n={list:[],add:function(t,e){this.list.unshift({id:t,removeMark:!1,form:e}),this.update()},remove:function(e){this.list.findAndRemove(function(t){return t.id===e}),this.update()},exist:function(t){return!!t.form&&(!!t.form.dom&&jQuery.contains(document.documentElement,form.dom.get(0)))},update:function(){this.list.forEach(function(t){this.exist(t)?t.removeMark=!1:t.removeMark?(t.form&&"function"===t.form.die&&t.form.die(),this.list.findAndRemove(t)):t.removeMark=!0},this)},createId:function(){return getRandom(this.list.map(function(t){return t.id}))}},{freezeDependencies:!1,freeze:!1,fixed:!1,disabled:!1,instantChangeValues:!0,selfFreeze:!0,fixedSelfFreeze:!0}),r=function(t,e,i){if(this.dom=e,this.actions=i,this.id=t.id||n.createId(),this.settings=t,this.fields={},n.add(this.id,n),Subscriber(this),this.settings.localSave){var a=this.getLocalSave;a&&setTimeout(function(){this.setValue(a,!0),this.focus()}.bind(this),this.settings.localSaveInitTime||100)}return this};r.prototype={get state(){},set state(t){equals(t,this.state)},get freeze(){return void 0!==this._freeze?this._freeze:this.settings.freeze},set freeze(e){equals(this.freeze,e)||(this._freeze=e,this.settings.freezeDependencies&&this.fieldsList.forEach(function(t){t.freeze=e}),this.subscriber("add",{event:"freeze",state:e}),e?this.unbind():this.bind())},setFreeze:function(t,e){var i="object"==typeof t?t:this.getFieldByIndex(),a="boolean"==typeof t?t:!!e;return!(this.disabled||this.settings.fixed||equals(this.freeze,a))&&(i&&!a&&(i.freeze=a,i.focus()),this.freeze=a,!0)},next:function(t){var e=t.index,i=this.fieldsList.find(function(t){return t.index>e});if(i)return t.blur(),i.focus(),!0},get disabled(){return this._disabled||this.settings.disabled},set disabled(t){equals(this.disabled,t)||(this._disabled=t)},focus:function(){this.freeze=!1,this.fieldsList[0]&&this.fieldsList[0].focus()},get fieldsList(){return null==this.fields&&app.log(this,n),Object.values(this.fields).sort(function(t,e){return t.index-e.index})},getFieldByIndex:function(e){return e=e||1,this.fieldsList.find(function(t){return t.index==e})},appendField:function(t){t instanceof e||(t=t.is(".quill")?new i(t,this):new e(t,this)),t&&t.name&&(this.fields[t.name]=t,this.settings.freeze&&(t.freeze=this.freeze)),t.index=Object.keys(this.fields).length},setValue:function(t,e){if(e)for(var i in t)o=this.fields[i],s=t[i],o&&(o.value=s);else for(var i in this.fields||(app.log("========SOME SHIT GOING ON======"),app.log(this.fields),console.trace()),t)a=this.fields[i],n=t[i],a&&a.setValue(n);var a,n,o,s},get api(){var e=this;return{serialize:this.serialize.bind(this),submit:this.submit.bind(this),reset:this.reset.bind(this),appendField:this.appendField.bind(this),get dom(){return e.dom},get subscriber(){return e.subscriber},focus:this.focus.bind(this),freeze:function(t){e.setFreeze(t)},setValue:e.setValue.bind(this),die:e.die.bind(this)}},endEdit:function(){this.settings.freeze&&(this.freeze=!0)},submit:function(){this.endEdit(),this.fieldsList.forEach(function(t){t.oldValue=t.value}),this.subscriber("add",{event:"submit",data:this.serialize()}),this.localSave(!0)},reset:function(){this.endEdit(),this.fieldsList.forEach(function(t){t.value=t.oldValue}),this.subscriber("add",{event:"reset",data:this.serialize()}),this.localSave(!0)},serialize:function(){var e={};return this.fieldsList.forEach(function(t){e[t.name]=t.value}),e},get getLocalSave(){return this.id?User.storage.get(["formLocalSave",this.id],null):null},localSave:function(t){if(this.id){this.localSaveTimeout&&clearTimeout(this.localSaveTimeout);var e=["formLocalSave",this.id];if(t)app.online().then(function(t){User.storage.set(e)});else if(!this.freeze){var i=this.serialize();this.localSaveTimeout=setTimeout(function(){User.storage.set(e,i)},1e3)}}return null},die:function(){n.remove(this.id),this.subscriber("die"),removeKeyFormObject(this.fields),this.fields=null,this.unbind(),this.dom.remove(),this.actions&&this.actions.remove(),removeKeyFormObject(this)},scroll:function(){app.log("scroll"),this.fieldsList.forEach(function(t){t instanceof i&&t.checkHead()})},bind:function(){var i=this;this.actions&&this.actions.on("click",'[data-form-role="actions"]',function(t){var e=$(this).attr("type");"submit"==e?i.submit():"reset"==e&&i.reset()}),this.settings.clickOutSide&&setTimeout(function(){this.clickOutside=this.dom.clickOutside(function(){i.submit()})}.bind(this),10),this.settings.escAction&&$(document).on("keydown",$.proxy(this.keyDownEsc,this))},unbind:function(){this.actions&&this.actions.off(),this.clickOutside&&(this.clickOutside(),this.clickOutside=!1),this.settings.scrollHead&&this.settings.scrollHead.off("scroll",this.scroll),this.settings.escAction&&$(document).off("keydown",$.proxy(this.keyDownEsc,this))},keyDownEsc:function(t){27==t.keyCode&&(t.stopImmediatePropagation(),this.reset())},get template(){return $()},set dom(t){this._dom=t},get dom(){return this._dom||(this._dom=this.template),this._dom}};var e=function(t,e){this.form=e,t instanceof jQuery&&(this.dom=t,this.data=this.parseDom()),this.oldValue=this.value,this.bind()};e.prototype={parseDom:function(){return this.dom.attr()},get name(){return this.data.name},get value(){return this.dom.val()},set value(t){equals(this.value,t)||(this.dom.val(t),this.dom.trigger("input"))},get oldValue(){return this._oldValue},set oldValue(t){equals(this.oldValue,t)||(this._oldValue=t)},focus:function(){this.dom.focus().get(0).select()},blur:function(){this.dom.blur()},get freeze(){return this._freeze||!1},set freeze(t){equals(this.freeze,t)||(this._freeze=t,this.dom.attr("readonly",t),t&&this.blur())},setValue:function(t){this.oldValue=t,(this.form.settings.instantChangeValues||this.freeze)&&(this.value=t)},bind:function(){var t=this.form.settings,e=this;if(t.selfFreeze){var i=t.easeEdit?"click":"dblclick";this.dom.on(i,function(){e.freeze&&e.form.setFreeze(e,!1)})}t.localSave&&this.dom.on("input change",function(){e.freeze||e.form.localSave()}),t.shortCut&&this.dom.on("keydown",function(t){13==t.keyCode?e.form.submit():27==t.keyCode?e.form.reset():9==t.keyCode&&e.form.next(e)&&t.preventDefault()})},unbind:function(){this.dom.off()},die:function(){this.unbind(),this.dom.remove(),this.form=null}};var i=function(t,e){this.form=e,t instanceof jQuery&&(this.dom=t,this.data=this.parseDom()),this.oldValue=this.value,this.bind()};i.prototype={parseDom:function(){return this.dom.data()},get head(){app.log(this.dom)},get name(){return this.data.name},get quill(){return this.data.quill},get value(){return JSON.parse(JSON.stringify(this.quill.getContents()))},set value(t){equals(this.value,t)||this.quill.setContents(t)},get oldValue(){return this._oldValue},set oldValue(t){equals(this.oldValue,t)||(this._oldValue=t)},blur:function(){this.quill.blur()},focus:function(){this.freeze||(this.quill.focus(),this.quill.blur(),this.quill.focus())},checkHead:function(){this.head},get freeze(){return this._freeze||!1},set freeze(t){equals(this.freeze,t)||((this._freeze=t)&&this.blur(),this.quill.enable(!t),this.dom.toggleClass("quill--freeze",t))},setValue:function(t){this.oldValue=t,(this.form.settings.instantChangeValues||this.freeze)&&(this.value=t)},bind:function(){var t=this.form.settings,a=this;if(t.selfFreeze){var e=t.easeEdit?"click":"dblclick";this.dom.on(e,function(t){$(t.target).is("a")||a.freeze&&a.form.setFreeze(a,!1)})}t.shortCut&&this.dom.on("quill-submit",function(){a.form.submit()}).on("quill-cancel",function(){a.form.reset()}),t.localSave&&this.quill.on("text-change",function(t,e,i){"user"!=i||a.freeze||a.form.localSave()})},unbind:function(){this.dom.off()},die:function(){this.unbind(),this.dom.remove(),this.form=null}};app.modules.add("form",function(t){var e=vod(t.form,!1,"object"),i=vod(t.actions,!1,"object"),a=vod(t.settings,{},"object"),n=vod(t.fields,{},"object");n=e.find(":input:not(button)").add(e.find('[data-form-role="input"]'));var o=new r(Object.assign({},s,t.settings),e,i);return n.each(function(){var t=$(this);(a.strict&&"input"==t.data("form-role")||!a.strict)&&o.appendField(t)}),o.api})}(),function(){var e=[{title:"Projects",link:"/projects",internal:!0},{title:"Help center",link:"http://flowmapp.com/help/",internal:!1},{title:"Archive",link:"/archive",internal:!0},{title:"Update plan",link:"/updateplan",internal:!0,intend:!0}],t={navigation:function(t){return app.modules.get("html",{name:"headerNavigation",param:Object.assign({},{links:e,userboard:!0},t.navigation||{})})},main:function(t){return app.modules.get("html",Object.assign({},{name:"headerMain"},t.main))},tools:function(t){return app.modules.get("html",{name:"headerTools",content:t.tools})},render:function(t){app.modules.get("html");return this.dom.find("*").off(),this.dom.html(""),this.dom.append(this.navigation(t)),t.main&&this.dom.append(this.main(t)),t.tools&&this.dom.append(this.tools(t)),this.setContentHeight(),this.dom},update:function(t){var e=this.dom.find(".header__navigation"),i=this.dom.find(".header__main"),a=this.dom.find(".header__tools"),n={};return t.navigation&&(e.find("*").off(),n=this.navigation(t),e.length?e.replaceWith(n):this.dom.prepend(n)),t.main&&(i.find("*").off(),n=this.main(t),i.length?i.replaceWith(n):e.length?e.after(n):this.dom.prepend(n)),t.tools&&(a.find("*").off(),n=this.tools(t),a.length?a.replaceWith(n):this.dom.append(n)),this.setContentHeight(),this.dom},clear:function(t){var e=this.dom.find(".header__"+t);e.length&&(e.find("*").off(),e.remove(),this.setContentHeight())},disable:function(t,e){var i=this.dom.find(".header__"+t);if(i.length){e=void 0===e?!i.hasClass("disabled"):!!e;i.toggleClass("disabled",e)}},setContentHeight:function(){$(".content").css({height:"calc(100vh - "+this.dom.outerHeight()+"px)"})},get dom(){return this._dom||($("header").length||$("body").append(app.modules.get("html")({name:"header"})),this._dom=$("header")),this._dom}};app.modules.add("header",t)}(),function(){var a={render:function(t){e.inject(),e.clear(),t.forEach(function(t){this.modules.hasOwnProperty(t.name)&&e.append(this.modules[t.name](t.data))}.bind(this))},remove:function(){e.dom.remove()},update:function(){},clear:function(){},modules:{shortCut:function(a){var n,o=!1;return{icon:"keyboard",callback:function(){(function t(e){if(!equals(o,e)){o=e;var i=this;i.toggleClass("active"),n&&n.close(),o&&((n=app.modules.get("popover",{insert:{name:"table",param:{mod:["striped","tall"],style:{"min-width":414}},content:a.map(function(t){return{name:"row",param:{mod:["nowrap",""]},content:[t.description,[].concat(t.value).map(function(t){return"string"==typeof t?"hold"===t?$('<span class="light" style="margin: 0 4px">Hold</span>'):"or"===t?$('<span class="light">or</span>'):"click"===t?$('<span class="strong" style="margin: 0 4px">Click</span>'):"plus"===t?$('<span class="strong" style="margin: 0 1px">+</span>'):$('<span class="strong" style="margin: 0 4px">'+t+"</span>"):t})]}})},clickOutside:!0,position:{position:"fixed",right:20,bottom:72},close:!0})).subscriber("on",{event:"close"},function(){setTimeout(function(){t.call(i,!1)},20)}),setTimeout(function(){n.open()},30))}}).call($(this),!o)}}},question:function(){return{icon:"question",callback:function(){window.open("https://flowmapp.com/help/","_blank").focus()}}}}},e={inject:function(){this._dom&&!jQuery.contains(document.documentElement,this.dom.get(0))&&(this.dom.off().remove(),this._open=!1,this._dom=this.template.appendTo(content))},clear:function(){this.row.html(""),this.open=!1},append:function(t){this.row.append(app.modules.get("html",{param:{class:"help-bar__button",callback:t.callback},content:{name:"icon",param:{name:t.icon,cover:!0}}}))},get open(){return this._open||!1},set open(t){if(!equals(this.open,t)){this._open=t;var e=this.row.children(),i=e.length;t?e.each(function(t){$(this).css({"transition-delay":50*(i-t)+"ms",transform:"translateX(-"+52*(t+1)+"px)",opacity:1})}):e.each(function(){$(this).css({"transition-delay":"",transform:"",opacity:0})}),this.toggle.toggleClass("active",t),this.row.toggleClass("active",t)}},get template(){var t=app.modules.get("html"),e=this;return t({param:{class:"help-bar"},content:[{param:{class:"help-bar__button help-bar__button--toggle js-toggle",callback:function(){e.open=!e.open}},content:[{name:"icon",param:{name:"help_normal",class:"i-normal"}},{name:"icon",param:{name:"help_hover",class:"i-hover"}}]},{param:{class:"help-bar__row"}}]})},get row(){return this.dom.find(".help-bar__row")},get toggle(){return this.dom.find(".js-toggle")},get dom(){return this._dom||(this._dom=this.template.appendTo("body")),this._dom}};app.modules.add("helpBar",function(t){var e=vod(t,"render","string"),i=vod(t,!1,"object")||vod(arguments[1],!1,"object");return a.hasOwnProperty(e)&&"function"==typeof a[e]&&a[e](i),a})}(),function(){var t=$("body"),a=[],e=function(t){Subscriber(this),this.settings=Object.assign({overlay:!0,esc:!0},"object"==typeof t?t:{}),this.inject(),this.bind(),this.fixed=!1,this.state=!1,this.id=getRandom(a.map(function(t){return t.id})),a.push(this)};e.prototype={setTransform:function(t,e){var i=this.inner.offset().left,a=this.inner.offset().top,n=(this.inner.outerWidth(),this.inner.outerHeight(),t?cursorX-i+"px":"50%"),o=t?cursorY-a+"px":"50%";this.inner.css("transform-origin",n+" "+o),e&&"function"==typeof e&&setTimeout(e.bind(this),100)},open:function(){if(this.state)return!1;this.state=!0,app.subscriber("add",{scope:app,event:"openModal"}),this.setTransform(!0,function(){this.dom.addClass("open"),this.dom.onTransitionEnd(300).then(function(){this.subscriber("add",{scope:this.api,event:"open"})}.bind(this))})},close:function(){if(this.fixed||!this.state)return!1;this.state=!1,this.subscriber("add",{scope:this.api,event:"close"}),this.dom.addClass("close"),setTimeout(this.die.bind(this),120)},bind:function(){this.settings.overlay&&setTimeout(function(){this.clickOutside=this.inner.clickOutside(function(){a.last().id===this.id&&setTimeout(function(){this.close()}.bind(this),50)}.bind(this))}.bind(this),150),this.dom.one("click",".js-modal-close",this.close.bind(this))},unbind:function(){this.clickOutside&&this.clickOutside(),this.dom.find("[data-scroll]").baron().dispose(),this.subscriber("die")},die:function(){var e=this;this.dom.off(),a.remove(a.findIndex(function(t){return t.id==e.id})),this.unbind(),this.dom.remove()},get inner(){return this.dom.find(".modal__inner")},get entryPoint(){return this.dom.find(".modal__content")},get dom(){return this._dom||(this._dom=app.modules.get("html")({name:"modal",param:{style:this.settings.style,mod:this.settings.mod}}),this.settings.insert&&this.insert(this.settings.insert)),this._dom},insert:function(t,e){e&&this.entryPoint.html(""),[].concat(t).forEach(function(t){t instanceof jQuery||(t=app.modules.get("html")(t)),this.entryPoint.append(t)}.bind(this))},get api(){var e=this;return{fixed:function(t){if("boolean"!=typeof t)return e.fixed;e.fixed=t},open:e.open.bind(this),close:e.close.bind(this),get content(){return e.inner},get dom(){return e.dom},insert:e.insert.bind(this),subscriber:this.subscriber}},inject:function(){this.dom.appendTo($('body'))}},$(document).on("keydown",function(i){27===i.keyCode&&a.length&&setTimeout(function(){var t=a.last(),e=$(i.target);t&&safetyObjectAccess(t,["settings","esc"],!0)&&!i.isPropagationStopped()&&!e.is(":input")&&0===e.closest(".input").length&&t.close()},10)}),app.modules.add("alert",function(e,i){e=Object.assign({},{type:"normal",heading:"",content:"",size:"small",buttons:[],wfc:!1},e);var a,n,o,s=!0;if(!Array.isArray(e.buttons)||!e.buttons.length)return!1;var r=function(t){13===t.keyCode&&($(document).off("keypress",r),c(!0,a.dom.find('[data-modal-button="yes"]')))},c=function(t,e){s&&(n(t),e.loader("button"))},t={normal:"blue",alert:"red"}[e.type]||"blue";1===e.buttons.length?e.buttons=[{name:"button",param:{mod:[t,"long"],attr:{"data-modal-button":"yes"},data:{value:!0},text:e.buttons[0],callback:c}}]:e.buttons=[{name:"button",param:{mod:[t],data:{value:!0},attr:{"data-modal-button":"yes"},text:e.buttons[0],callback:c}},{name:"link",param:{attr:{"data-modal-button":"no"},data:{value:!1},callback:function(t){s&&n(t)}},content:e.buttons[1]}];var l=e.icon?[{name:"icon",param:{name:e.icon}},e.heading]:e.heading,d={alert:[{name:"heading",param:{mod:"red"},content:[{name:"icon",param:{name:"alert"}},e.heading]}],denied:[{name:"heading",param:{mod:"red"},content:l}]}[e.type]||{name:"heading",content:l};return n=function(t){s=!1,a.subscriber("off",o),e.wfc?(a.fixed(!0),i(t,function(){a.fixed(!1),a.close(),e=a=i=n=o=s=null})):(i&&"function"==typeof i&&i(t),a.close(),e=a=i=n=o=s=null)},a=h({mod:[e.size],insert:{name:"board",param:{mod:e.mod},content:[d,[{name:"paragraph",content:e.content},{name:"buttonRow",content:e.buttons}]]}}),o=a.subscriber("on",{event:"close"},function(t){return s&&n(void 0),!1}),a.open(),$(document).on("keypress",r),a});var h=function(t){return new e(t).api};app.modules.add("modal",h),app.modules.add("modalList",function(t){return a})}(),function(){var i={project:function(c,l){var d=[{title:"Blank Project",icon:"/lib/app/img/illustration/blank_project.png",description:"Need to create something special?<br>Create and plan a new project from scratch.",value:"blank"},{title:"E-commerce Project",icon:"/lib/app/img/illustration/e-commerce_project.png",description:"Create online store structure in few minutes.",value:"ecommerce"},{title:"Corporate Project",icon:"/lib/app/img/illustration/corporate_project.png",description:"Optimal structure for the corporate website of a company.",value:"corporate"},{title:"News Portal Project",icon:"/lib/app/img/illustration/news_portal_project.png",description:"A lot of data? No problem, create a large portal structure<br>in a couple of clicks.",value:"portal"}],h="create"===c&&User.getUserSettings(["lastSelectedTeam"],!1),u=[];return new Promise(function(e,t){({init:function(){this.mod=c,this.value={},this.modal=app.modules.get("modal",{mod:["large","transparent","nostyle"]}),this.modal.insert(this.dom),this.bind(),"create"===c?this.flip(0):"edit"===c&&this.dom.addClass("static"),setTimeout(function(){this.modal.open()}.bind(this),50)},get chosenTemplate(){return this._chosenTemplate||"blank"},set chosenTemplate(t){equals(t)||(this._chosenTemplate=t,this.value.mod=t,this.flip(1))},flip:function(t){"create"==c&&(0==t?(this.dom.css("height",604),this.dom.removeClass("flip")):1==t&&(this.title.focus().get(0).select(),this.dom.css("height","auto"),this.dom.addClass("flip")))},submit:function(){this.form.submit();var t=Object.assign({},this.value,this.form.serialize(),{members:this.people().map(function(t){return Object.assign({state:t.state},t.hasOwnProperty("id")?{user:t.id}:{email:t.email})})});"create"===c&&h&&(t.team_id=h),e(t),this.modal.close()},close:function(){e(!1),this.modal.close()},bind:function(){var e=this;this.modal.subscriber("on",{event:"close"},function(){this.close()}.bind(this)),this.title.on("keydown",function(t){if(13==t.keyCode)return t.preventDefault(),$(this).blur(),e.submit(),!1;9==t.keyCode&&(t.preventDefault(),$(this).blur(),e.form.focus())})},get template(){var t,i,a,e,n,o=this,s=app.modules.get("html"),r=$('<div class="fm-project-create__container"></div>');return"create"===c&&r.append((t=$('<div class="fm-project-create__slide"><div class="fm-project-create__block"><div class="fm-project-create__heading"><div class="fm-heading fm-heading--center">Create new blank project or choose template</div></div><div class="fm-project-create__mods"></div></div></div>'),i=t.find(".fm-project-create__mods"),d.forEach(function(t){var e=$('<div class="fm-project-create__mod"><div class="fm-project-create__icon"></div><div class="fm-project-create__info"><div class="fm-project-create__title">'+t.title+'</div><div class="fm-project-create__description">'+t.description+"</div></div></div>");e.find(".fm-project-create__icon").setBackground(t.icon),e.find(".fm-project-create__info").append(s({name:"button",param:{mod:["narrow","blue"],text:"Choose"}})),e.on("click",function(){o.chosenTemplate=t.value}),i.append(e)}),t)),r.append((a=$('<div class="fm-project-create__slide"></div>'),e=s({name:"input",param:{name:"main",attr:{"data-form-role":"input","data-name":"title"},mod:["transperant","material","full"],value:"create"==c?"New Project":l.title,label:"Project Name",callback:function(t){o.value.title=t.value}}}),n=s({name:"invitePeople",param:{projectId:"create"!=c&&l.id,height:252,request:!0,mod:["white"]}}),a.append(s({param:{class:"fm-project-create__block fm-project-create__block--half"},content:[e,"create"===c?{param:{style:{display:"none"},class:"fm-project-create__team",call:{fn:function(){var i=function(t){h=!!toBoolean(t)&&t,User.setUserSettings(["lastSelectedTeam"],h),u=(h&&safetyObjectAccess(app.teams.lastListData.find(function(t){return t.id===h}),["users"],[])||[]).map(function(t){return t.user_id});var e=n.data("invitePeople");convertToPromise(e.list).then(function(t){t.forEach(function(t){"manual"!==t.data.changed&&(t.data.changed="system",t.state=u.includes(t.id))}),e.render()}).catch(app.log)};app.serverRequest("teamList").then(function(t){var e=app.teams.showTeamList;h=e.value,e.state&&(a.find(".fm-project-create__team").show(),a.find(".fm-invite-people").css("height",338)),this.append(s({name:"input",param:{placeholder:"Which Account?",label:"Create project in",type:"select",settings:{value:e.value,options:[{value:"false",text:"Add to my Subscription"}].concat(t.map(function(t){return{value:t.id,text:"Add to team «"+t.title+"»"}}))},callback:function(t){i(t.value)}}})),i(e.value)}.bind(this))}}}}:"",{param:{class:"fm-project-create__cover",call:!("edit"!==c||!l.img)&&{fn:function(){this.find(".button__text").text("Change cover"),this.find(".svg-icon").remove(),this.setBackground(l.img)}}},content:[{param:{class:"fm-project-create__upload"},content:{name:"button",param:{mod:["white","narrow"],text:"Add Cover",icon:"plus",tag:"div"},content:{name:"input",param:{mod:["fill","invisiable","pointer"],attr:{accept:"image/jpeg, image/png, image/svg+xml"},type:"file",events:"change",callback:function(t,e){var i=this.get(0),a=this.parents(".fm-project-create__cover");a.addClass("fm-project-create__cover"),a.setCover(i.files[0]).then(function(t){o.value.file_id=t.id,o.value.img=t.img,a.find(".button__text").text("Change cover"),a.find(".svg-icon").remove()},function(){o.value.file_id=!1}),$(this).val("")}}}}},{param:{class:"fm-project-create__notify"},content:{param:{tag:"p",class:"light"},content:"Use formats .jpg .png. The size of the file does not more 1Mb. Best resolution 278⨯184"}}]}]})),a.append($('<div class="fm-project-create__block"></div>').css("padding-bottom",15).append(n)),o.people=n.data("value"),a.append($('<div class="fm-project-create__block"></div>').append($('<div class="fm-project-create__textarea"></div>').append(s({name:"quill",param:{attr:{"data-form-role":"input","data-name":"description"},value:"create"!=c&&l.description,freezePlaceholder:"+ Add description",placeholder:"Write a description...",mod:["toggle","freeze-placeholder"]}})))),a.append($('<div class="fm-project-create__block"></div>').append(s({name:"buttonRow",content:[{name:"button",param:{attr:{type:"submit"},mod:["blue"],icon:"edit"!==c&&"plus",text:"edit"===c?"Save":"Create project",callback:function(){o.submit()}}},{name:"link",param:{callback:function(){o.close()}},content:"Cancel"},"create"===c?s({name:"button",param:{mod:["narrow","fake"],callback:function(){o.flip(0)},text:"Back",icon:"back"}}).css("margin-left","auto"):""]}))),o.title=e.find("input"),o.value.title=o.title.val(),o.form=app.modules.get("form",{form:a.find(".fm-project-create__textarea"),settings:{id:"projectCreateModalDescription"+User.id,fixed:!1,easeEdit:!0,localSave:"create"==c,strict:!0,instantChangeValues:!1,freeze:!0,freezeDependencies:!0,selfFreeze:!0}}),a)),r},get dom(){return this._dom||(this._dom=this.template),this._dom}}).init()})},switchProjects:function(h){return void 0!==h&&new Promise(function(t,e){var a=app.projects.userIncludes(h).map(function(t){return t.id}),n=app.modules.get("html"),i=app.projects.getBy({archive:!1,accessibility:!0}).map(function(i){var t=a.includes(i.id);return{id:i.id,img:i.img,title:i.title,state:t,defaultState:t,get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){var e=this,t=$('<div class="project-shortinfo"><div class="project-shortinfo__img"></div><div class="project-shortinfo__title" data-field="title">'+e.title+"</div></div>");return this.img&&t.find(".project-shortinfo__img").setBackground(this.img),n({name:"row",content:[t,{name:"toggle",param:{name:e.id,checked:e.state,disabled:h==i.owner_id,callback:function(t){e.state=t.state}}}]})}}}).sort(function(t,e){return e.state-t.state}),o=n({name:"table",param:{mod:"compact",contentHeight:"240px",contentScroll:!0},content:i.map(function(t){return t.dom})}),s=o.find(".fm-table__content"),r=app.modules.get("modal",{mod:["small"],insert:{name:"board",content:[{name:"input",param:{name:"search",type:"text",callback:function(t){l(t.value)},value:"",label:"Search project",placeholder:"Project name"}},o,{name:"buttonRow",content:[{name:"button",param:{mod:"blue",text:"Apply",callback:function(){var e;t((e=[],i.forEach(function(t){t.state!=t.defaultState&&e.push({state:t.state,projects:t.id,user:h})}),e)),c()}}},{name:"link",param:{callback:function(){c()}},content:"Close"}]}]}}),c=function(){e(),r.subscriber("off",d),r.close()},l=function(e){e=!!e.length&&new RegExp(e.split("").join(" ?"),"i"),s.html(""),e?(i.forEach(function(t){t.searchIndex=t.title.search(e)}),i.sort(function(t,e){return t.searchIndex-e.searchIndex}).forEach(function(t){-1<t.searchIndex&&(t.dom.find('[data-field="title"]').html(t.title.replace(e,'<span class="matched">$&</span>')),s.append(t.dom))})):i.sort(function(t,e){return e.state-t.state}).forEach(function(t){t.dom.find('[data-field="title"]').html(t.title),s.append(t.dom)})},d=r.subscriber("on",{event:"close"},c);r.open()})},invitePeople:function(o,s){return new Promise(function(t,e){var i=app.modules.get("modal",{mod:["medium"]}),a=app.modules.get("html"),n=a({name:"invitePeople",param:Object.assign({mod:"white",request:!0,projectId:o,height:440},s||{})});i.insert(a({name:"board",content:[n,{name:"buttonRow",content:[{name:"button",param:{attr:{type:"submit"},mod:["blue"],text:"Apply",callback:function(){t(n.data("value")()),i.close()}}},{name:"link",param:{callback:i.close},content:"Cancel"}]}]})),i.subscriber("on",{event:"close"},function(){e("close")}),i.open()}).then(function(t){return o?t.map(function(t){return Object.assign({projects:o,state:t.state},t.id?{user:t.id}:{email:t.email})}):t.map(function(t){return Object.assign({state:t.state},t.id&&{user:t.id}||t.email&&{email:t.id||t.email}||{user:!1})})},function(){})},shareProject:function(i){var a=app.modules.get("html");({init:function(){this.loaders=[],this.sended=[],this.popup.insert(this.template),this.view(),this.popup.open()},get link(){return this._link||(this._link=app.serverRequest("share",{id:i.id}).then(function(t){return t.data=[t.data].concat(i.path).join("/")+(i.hash?"#"+i.hash:""),t})),this._link},view:function(){if(this.loaders.forEach(function(t){t.done()}),this.loaders.length=0,this.button.removeClass("button--green").removeClass("disabled").addClass("button--blue"),"url"===this.mod){this.button.find(".button__text").text("Copy"),this.input.attr("readonly",!0),this.input.attr("placeholder","link"),this.input.val("");var e=this.input.loader();this.link.then(function(t){"url"===this.mod&&(t&&t.status?this.input.val(location.origin+"/share/"+t.data):this.input.val("Impossible to share this project")),e.done()}.bind(this)),this.loaders.push(e)}else"email"===this.mod&&(this.button.find(".button__text").text("Send"),this.input.attr("readonly",!1),this.input.attr("placeholder","Enter email address"),this.input.val(this.saveText()),this.validateEmail())},submit:function(){if("url"===this.mod){this.input.focus().get(0).select();try{document.execCommand("copy"),this.button.removeClass("button--blue").addClass("button--green").find(".button__text").text("Copied")}catch(t){}}else if("email"===this.mod){var e=this.button.loader("button");this.loaders.push(e),this.input.attr("readonly",!0),app.serverRequest("share",Object.assign({email:this.input.val()},i)).then(function(t){"email"===this.mod&&(this.button.removeClass("button--blue").addClass("button--green").find(".button__text").text("Sent"),this.input.attr("readonly",!1),this.sended.push(t.email),e.done())}.bind(this))}},validateEmail:function(){if("email"==this.mod){var t=this.input.val();this.button.toggleClass("disabled",!/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)&&this.sended.indexOf(t)<0)}},saveText:function(t){if(void 0===t)return this._saveText||"";"email"==this.mod&&(this.validateEmail(),this._saveText=t)},get mod(){return this._mod||"url"},set mod(t){equals(this.mod,t)||(this._mod=t,this.view())},get template(){var e=this,t=a({name:"input",param:{name:"main",type:"text",mod:"button",callback:function(t){e.saveText(t.value)},button:{name:"button",param:{mod:["blue","short"],text:"Submit",callback:function(){e.submit()}}},value:"",placeholder:"placeholder"}}),i=a({name:"buttonStack",param:{name:"mod",value:e.mod,callback:function(t){e.mod=t.value}},content:[{name:"button",param:{data:{value:"url"},mod:["white","short"],text:"URL"}},{name:"button",param:{data:{value:"email"},mod:["white","short"],text:"Email"}}]});return this.input=t.find("input"),this.button=t.find("button"),a({name:"board",content:[{name:"heading",content:"Share Project"},{name:"buttonRow",content:[i,t]}]})},popup:app.modules.get("modal",{mod:["medium"]})}).init()},createPage:function(n){return new Promise(function(i,t){var o=app.modules.get("html");({init:function(){this.popup.insert(this.template),this.bind(),this.popup.open()},submit:function(){if("create"===n.mod&&!this.title.val().replace(/ /g,"").length)return this.title.focus(),!1;var t=this,e={title:this.title.val(),cover:this.covers.value||app.root+"/img/prototips/empty.svg"};this.description&&(e=Object.assign(e,this.description.serialize())),this.labels&&(e.label=this.labels||[]),this.buttons.find('[type="submit"]').loader("button"),n.wfc?(this.popup.fixed(!0),i({data:e,callback:function(){t.popup.fixed(!1),t.popup.close()}})):(i(e),this.popup.fixed(!1),this.popup.close())},reset:function(){this.popup.close(),i(!1)},bind:function(){this.popup.subscriber("on",{event:"close"},function(){this.reset()}.bind(this))},get template(){var e=this,t=$('<div class="fm-flowmap-add"></div>');if(this.title=o({name:"input",param:{name:"main",mod:["transperant","material","full"],value:"create"===n.mod?"New Page":"",label:"create"===n.mod?"Page name":"Search cover",bind:{keydown:function(t){13===t.keyCode?(t.preventDefault(),e.submit()):9===t.keyCode&&(t.preventDefault(),$(this).blur(),e.description&&e.description.focus())},"input change":function(){e.covers.search=$(this).val()}}}}).appendTo(t).find("input"),setTimeout(function(){e.title.inputFocus(!0)},150),"create"===n.mod&&WorkPlace&&WorkPlace.getModule("flowmap").then(function(n){t.append(o({param:{class:"fm-flowmap-add__labels"},content:{name:"flowmapLabel",param:{get list(){return n.labelList.map(function(t){return Object.assign({editable:"none"!==t.id&&(!!t.project_id||WorkPlace.get("owner")===User.id)},t)})},"max-width":330,rerender:!0,multitudeLimit:6,multitude:!0,mod:"bordered",lonerList:["none"],defaultValue:"none",newLabel:function(e){return app.serverRequest("addLabel",Object.assign(e,{project_id:WorkPlace.id})).then(function(t){return n.change("labelList",n.labelList.concat(Object.assign(e,{id:t,project_id:WorkPlace.id,text:e.title}))),{value:t,project_id:WorkPlace.id}})},changeLabel:function(a){return app.serverRequest("updateLabel",a).then(function(t){var e=n.labelList.slice(0),i=e.find(function(t){return t.id==a.id});a.project_id=a.project_id.toString()?a.project_id:null,i?(i.color=a.color,i.text=a.title):e.push({color:a.color,text:a.title,id:a.id,project_id:a.project_id||null}),n.change("labelList",e)})},removeLabel:function(e){app.serverRequest("removeLabel",{id:e}),n.change("labelList",n.labelList.filter(function(t){return t.id!==e}))},callback:function(t){this.labels=t}.bind(this),value:[]}}}))}.bind(this)).catch(console.log),"create"===n.mod){var i=$('<div class="fm-flowmap-add__textarea"></div>').append(o({name:"quill",param:{attr:{"data-form-role":"input","data-name":"description"},freezePlaceholder:"+ Add description",placeholder:"Write a description...",mod:["toggle","freeze-placeholder"]}})).appendTo(t);this.description=app.modules.get("form",{form:i,settings:{easeEdit:!0,strict:!0,instantChangeValues:!1,freeze:!0,freezeDependencies:!0,selfFreeze:!0}}),this.description.subscriber("on",function(t){t.forEach(function(t){switch(t.event){case"freeze":t.state||i.toggleClass("fm-flowmap-add__textarea--edit",!0)}})})}var a=app.modules.get("html",{name:"pageCovers",param:{projectId:n.id,value:"create"!==n.mod&&n.cover}}).appendTo(t);return this.covers=a.data("covers"),this.buttons=o({name:"buttonRow",content:[{name:"button",param:{attr:{type:"submit"},mod:["blue"],icon:"create"===n.mod&&"plus",text:"create"===n.mod?"Add page":"Choose cover",callback:function(){e.submit()}}},{name:"link",param:{callback:function(){e.reset()}},content:"Cancel"}]}),o({name:"board",content:[t,e.buttons]})},popup:app.modules.get("modal")({mod:["large"],style:{width:902}})}).init()})},coverPack:function(o){return new Promise(function(t,e){var i=app.modules.get("html"),a=app.modules.get("modal")({mod:["small"]}),n=i({name:"board",content:[[{name:"input",param:{name:"title",mod:["transperant","material","full"],value:o.title||"New cover set",label:"Cover set name"}},o.showTeam?{name:"input",param:{placeholder:"Which Account?",label:"Add Cover Set to",name:"teamID",type:"select",containerStyle:{"margin-top":"10px"},settings:{value:"false",options:app.teams.list().then(function(t){return[{value:"false",text:"My Subscription"}].concat(t.map(function(t){return{value:t.id,text:"Team «"+t.title+"»"}}))}.bind(this))}}}:{param:{tag:"input",attr:{name:"teamID",type:"hidden",value:o.team}}},{name:"paragraph",param:{style:{"margin-top":"15px"}},content:["You can add Page Сovers in .jpg, .png or .svg formats. Perfect Cover's size is 180*224 px or 360*448 px for retina displays. The best way is to create new Cover from our free Library. Download Library for ",{name:"link",param:{href:app.root+"/custom_covers/FlowMapp_Page_Covers_Lib.sketch",attr:{download:"FlowMapp_Page_Covers_Lib.sketch"},mod:"icon"},content:[{name:"icon",param:{name:"sketch"}},"Sketch"]}," or ",{name:"link",param:{href:app.root+"/custom_covers/FlowMapp_Page_Covers_Lib.fig",attr:{download:"FlowMapp_Page_Covers_Lib.fig"},mod:"icon"},content:[{name:"icon",param:{name:"figma"}},"Figma"]}]},{name:"buttonRow",content:[{name:"button",param:{mod:"blue",text:"Create pack",callback:function(){if(!n.serializeJson().title.length)return n.find('input[name="title"]').inputFocus(!0),!1;t({result:!0,data:n.serializeJson()}),a.close()}}},{name:"link",param:{callback:function(){a.close(),t({result:!1})}},content:"Cancel"}]}]]});a.subscriber("on",{event:"close"},function(){t({result:!1})}),a.insert(n),a.open(),setTimeout(function(){n.find('input[name="title"]').inputFocus(!0)},10)})},restoreSession:function(){return new Promise(function(e,t){var i={login:User.login},a=app.modules.get("html"),n=app.modules.get("modal",{mod:["small"]}),o=a({name:"form",content:[{name:"input",param:{label:"Email",placeholder:"yourmail@email.com",value:User.login,type:"email",name:"login",attr:{readonly:!0}}},{name:"input",param:{label:"Password",mod:"disabled",placeholder:"Enter Your Password",type:"password",name:"password"}}]}),s=a({name:"button",param:{mod:["blue","long"],text:"Sign In",callback:function(){var t=Object.assign(o.serializeJson(),i);app.ajr("/site/auth/login",t,function(t){t.state},!0)}}});n.insert(a({name:"board",content:[{name:"heading",content:"Session lost"},o,{name:"buttonRow",content:[s]}]})),n.subscriber("on",{event:"close"},function(t){e(!1)}),n.open()})},projectQuotaExceeded:function(){app.modules.get("alert",{heading:"Project quota exceeded!",content:"This Project takes you over your ("+User.quota.projects+") project limit. It's time to upgrade. Let's do it!",buttons:["Upgrade subscription","Cancel"]},function(t){!0===t&&app.router("/updateplan")})},fileQuotaExceeded:function(){app.modules.get("alert",{heading:"File quota exceeded!",content:"This File takes you over your ("+User.quota.disc.fileSize(!0)+") disc limit. It's time to upgrade. Let's do it!",buttons:["Upgrade subscription","Cancel"]},function(t){!0===t&&app.router("/updateplan")})},slackNotificationSettings:function(l){return new Promise(function(e,t){var c=app.modules.get("html");({init:function(){this.popup.insert(this.dom),this.bind(),this.popup.open()},submit:function(){e(this.serialize),this.popup.close()},reset:function(t){e(!1),this.popup.close()},bind:function(){this.popup.subscriber("on",{event:"close"},function(){this.reset("abort")}.bind(this))},set state(t){equals(t,this.state)||(this._state=t,this.dom.find(".js-chanel-state input").prop("checked",t))},get state(){return!!this._state},get serialize(){var e={};return this.dom.find('.js-content input[type="checkbox"]').each(function(){var t=$(this);e[t.attr("name")]=t.prop("checked")}),{id:l.id,state:!!Object.values(e).some(function(t){return t})&&this.state,token_id:this.selectedTeam,settings:Object.assign({},e,{channel:this.selectedChannel,token_id:this.selectedTeam,state:!0})}},get savedSettings(){return app.serverRequest("slackSettings",{id:l.id})},get channels(){return this.selectedTeam?(this._channels||(this._channels=app.serverRequest("slackChannels",{token_id:this.selectedTeam}).then(function(t){return!0===t.ok?t.channels.filter(function(t){return!0!==t.is_archived}):[]})),this._channels):[]},get slackGroup(){return this.selectedTeam?(this._slackGroup||(this._slackGroup=app.serverRequest("slackGroups",{token_id:this.selectedTeam}).then(function(t){return!0===t.ok?t.groups.filter(function(t){return!0!==t.is_archived}):[]})),this._slackGroup):[]},get slackUsers(){return this.selectedTeam?(this._slackUsers||(this._slackUsers=app.serverRequest("slackUsers",{token_id:this.selectedTeam}).then(function(t){return!0===t.ok?t.members.filter(function(t){return!t.deleted}).map(function(t){var e=t.name,i=safetyObjectAccess(t,["profile","real_name"],!1),a="";return a=i?e===i?e:i+" ("+e+")":e,t.name=a,t}):[]})),this._slackUsers):[]},get slackEntity(){return Promise.all([this.slackGroup,this.channels,this.slackUsers]).then(function(t){return Array.prototype.concat.apply([],t)})},get slackTeams(){return this._slackTeams||(this._slackTeams=app.serverRequest("slackTeams").then(function(t){return t.forEach(function(t){t.team.name=t.team.name+" ("+t.team.domain+")"}),t})),this._slackTeams},setEntityName:function(){var i=function(t){var e=this.dom.find(".js-chanel"),i=this.dom.find(".js-chanel-choose");setTimeout(function(){t?(e.html("Selected channel: <b>"+t+"</b>").css("font-size",""),i.text("Change Channel")):(e.text("Select the Slack channel where you want to send the activity"),i.text("Select chanel"))},30)}.bind(this);return this.selectedChannel?this.slackEntity.then(function(t){var e=t.find(function(t){return t.id===this.selectedChannel}.bind(this));return e?(i(e.name),!0):(i(!1),!1)}.bind(this)):(i(!1),Promise.resolve(!1))},setTeamName:function(){var i=function(t){var e=this.dom.find(".js-team"),i=this.dom.find(".js-team-choose");setTimeout(function(){t?(e.html("Selected team: <b>"+t+"</b>"),i.text("Change team")):(e.text("Select a Slack team").css("font-size","14px"),i.text("Select team"))},30)}.bind(this);return this.selectedTeam?this.slackTeams.then(function(t){var e=t.find(function(t){return t.token_id==this.selectedTeam}.bind(this));return e?(i(e.team.name),!0):(i(!1),this.slackTeams=null,this.selectedTeam=!1)}.bind(this)):(i(),Promise.resolve(!1))},get settingList(){return this._settingList||(this._settingList=this.dom.find(".js-content")),this._settingList},get selectedChannel(){return this._selectedChannel||!1},set selectedChannel(t){equals(this.selectedChannel,t)||(this._selectedChannel=t,this.setEntityName().then(function(t){this.dom.find(".js-content").toggleClass("disabled",!t),t&&(this.state=!0)}.bind(this)))},get selectedTeam(){return this._selectedTeam||!1},set selectedTeam(t){equals(this.selectedTeam,t)||(this._selectedTeam=t,this.selectedChannel=!1,this._channels=!1,this._slackGroup=!1,this._slackUsers=!1,this.setTeamName().then(function(t){this.dom.find(".js-channel-row").toggleClass("disabled",!t)}.bind(this)))},get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){var o=this,t={name:"heading",content:[{name:"icon",param:{name:"slack_hover"}},"Send Activity to Slack",{name:"toggle",param:{class:"js-chanel-state",value:"true",state:this.state,name:"state",style:{"margin-left":"auto"},callback:function(t){o.state=t.state}}}]},e=c({name:"row",param:{mod:"compact"},content:[[{param:{tag:"p",class:"js-team strong"},content:"Choose a Slack team"},{name:"link",param:{mod:["static","centerflex"],class:"js-team-choose",style:{"margin-left":"20px",position:"relative","z-index":3},callback:function(){var t,e=!0,i=c([{param:{tag:"p",class:"big strong weight"},content:"Choose a Slack team"},{param:{class:"js-teams",style:{width:"100%",margin:"20px 0 0"}}},{name:"link",param:{style:{margin:"10px 0 20px"},mod:"bold",callback:function(){app.serverRequest("slackAuth",l).then(function(t){t.ok&&t.hasOwnProperty("auth_url")?location=t.auth_url:this.hide()}.bind(this))}},content:[{name:"icon",param:{name:"plus",style:{margin:"0 15px 0 5px"},fill:"#58A8F7"}},"Add Another Slack Team"]},{name:"buttonRow",content:[{name:"button",param:{text:"Save",mod:["blue","narrow"],callback:function(){t.close()}}},{name:"link",param:{callback:function(){e=!1,t.close()}},content:"Cancel"}]}]),a=(t=this.popover(i,{stopEvent:!0,mod:["center","white","padding","bot"],style:{width:" 250px",left:" 50%","margin-left":"-125px"}})).dom.loader("light"),n=t.dom.find(".js-teams");o.slackTeams.then(function(t){n.append(c({name:"formStack",content:t.map(function(t,e){var i=o.selectedTeam?t.token_id===o.selectedTeam:0==e,a=t.team;return{name:"input",param:{mod:["radio","lightlabel"],type:"radio",label:a.name,checked:i,name:"team",value:t.token_id,alt:a.name}}}).sort(function(t,e){return e.param.checked-t.param.checked})})),a.done()}),t.onClose(function(){e&&(o.selectedTeam=t.dom.serializeJson().team)})}},content:"Select Team"}]]}).css({position:"relative"}),i=c({name:"row",param:{mod:"compact",class:"js-channel-row  disabled"},content:[[{param:{tag:"p",class:"strong js-chanel"},content:"Send Activity to FM_Promo"},{name:"link",param:{mod:["static","centerflex"],class:"js-chanel-choose",style:{"margin-left":"20px",position:"relative","z-index":2},callback:function(){var t,e=!0,i=c([{param:{tag:"p",class:"big strong weight"},content:"Choose a channel"},{param:{class:"js-channels",style:{width:"100%",margin:"20px 0",height:"250px"}}},{name:"buttonRow",content:[{name:"button",param:{text:"Save",mod:["blue","narrow"],callback:function(){t.close()}}},{name:"link",param:{callback:function(){e=!1,t.close()}},content:"Cancel"}]}]),a=(t=this.popover(i,{stopEvent:!0,mod:["center","white","padding","bot"],style:{width:" 300px",left:" 50%","margin-left":"-150px"}})).dom.loader("light"),n=t.dom.find(".js-channels");Promise.all([o.slackGroup,o.channels,o.slackUsers]).then(function(t){var e=function(t,e){return{name:"formStack",param:{heading:e},content:t.map(function(t){return{name:"input",param:{mod:["radio","lightlabel"],type:"radio",label:t.name,checked:t.id===o.selectedChannel,name:"channel",value:t.id,alt:t.name}}}).sort(function(t,e){return e.param.checked-t.param.checked})}};n.append(c([e(t[1],"Channels"),e(t[0],"Private Channels"),e(t[2],"Direct Messages")])),n.customScroll(),n.css({position:"relative"}),a.done()}),t.onClose(function(){e&&(o.selectedChannel=t.dom.serializeJson().channel)})}},content:"Change Channel"}]]}).css({position:"relative"}),a=c({param:{style:{width:"100%",position:"relative",overflow:"auto",height:"430px",background:"#F0F4F7","z-index":1,margin:0}},content:{param:{class:"js-content disabled",style:{padding:"20px"}}}}),n={name:"buttonRow",content:[{name:"button",param:{mod:"blue",text:"Save",callback:this.submit.bind(this)}},{name:"link",param:{callback:this.reset.bind(this,"abort")},content:"Cancel"}]},s=c({name:"board",content:[t,[e,i],a,n]}),r=s.loader();return Promise.all([app.data("slackNotification"),this.savedSettings]).then(function(t){var e=t[0],i=t[1]||{};a.find(".js-content").append(c([{param:{class:"strong",tag:"p"},content:"Which type of prototype activity would you like to appear in Slack?"}].concat(e.map(function(t){return{name:"formStack",param:{heading:t.group},content:t.content.map(function(t){return{name:"input",param:{name:t.name,label:t.title,mod:["checkbox","lightlabel"],type:"checkbox",description:t.description,checked:!i.hasOwnProperty(t.name)||i[t.name]}}})}})))),this.state=!i.hasOwnProperty("state")||i.state,this.selectedTeam=i.token_id,this.setTeamName().then(function(){this.selectedChannel=i.channel,this.setEntityName().then(function(){r.done()})}.bind(this))}.bind(this)),a.customScroll(),a.css("position","relative"),this._settingList=a,s},popup:app.modules.get("modal")({mod:["medium"]})}).init()})},removeMyAccount:function(){return new Promise(function(t,e){var i,a,n,o=app.modules.get("html"),s=app.modules.get("modal")({mod:["medium"]});a=o({name:"formStack",param:{style:{margin:"20px 0"}},content:[{name:"input",param:{type:"checkbox",mod:["checkbox","strong","lightlabel"],name:"projects",value:!0,callback:n=function(){i.find("button").attr("disabled",!Array.apply(null,a.find("input")).every(function(t){return $(t).prop("checked")}))},label:"All your projects and uploaded files will be deleted"}},{name:"input",param:{type:"checkbox",mod:["checkbox","strong","lightlabel"],name:"links",value:!0,callback:n,label:"All share links to your projects will be inaccessible"}},{name:"input",param:{type:"checkbox",mod:["checkbox","strong","lightlabel"],name:"data",value:!0,callback:n,label:"All your personal data will be deleted"}},{name:"input",param:{type:"checkbox",mod:["checkbox","strong","lightlabel"],name:"subscription",value:!0,callback:n,label:"Subscription plan will be canceled"}}]}),i=o({name:"buttonRow",content:[{name:"button",param:{mod:"red",text:"Yes, Delete My Account",attr:{disabled:!0},callback:function(){s.fixed(!0),this.loader("button"),t(!0)}}},{name:"link",param:{callback:function(){s.close(),t(!1)}},content:"Cancel, keep account"}]}),s.insert(o({name:"board",content:[{name:"heading",param:{mod:"red"},content:[{name:"icon",param:{name:"alert"}},"Attention!"]},[{name:"paragraph",content:"By clicking «Yes, Delete My Account» you confirm that:"},a,{name:"paragraph",content:"But if you will sign in to FlowMapp during 10 (ten) days after this, we will revoke «Deleting Your Account»."},{name:"paragraph",content:"Are you sure?"}],i]})),s.open(),s.subscriber("on",{event:"close"},function(){t(!1)})})},removeMember:function(){return new Promise(function(t,e){var i,a,n=app.modules.get("html"),o=app.modules.get("modal")({mod:["small"]});a=n({name:"formStack",param:{style:{margin:"20px 0"}},content:[{name:"input",param:{type:"checkbox",mod:["checkbox","strong","lightlabel"],name:"dismiss",value:!0,label:"Remove member from all my projects"}}]}),i=n({name:"buttonRow",content:[{name:"button",param:{mod:"red",text:"Yes, remove from Team",callback:function(){t({result:!0,data:a.serializeJson()}),o.close()}}},{name:"link",param:{callback:function(){o.close(),t({result:!1})}},content:"Cancel"}]}),o.insert(n({name:"board",content:[{name:"heading",param:{mod:"red"},content:[{name:"icon",param:{name:"alert"}},"Remove team member"]},[{name:"paragraph",content:"You are about to remove this User from Team."},a],i]})),o.open(),o.subscriber("on",{event:"close"},function(){t(!1)})})},cancelSubscription:function(){return new Promise(function(a,n){var t=app.modules.get("html"),o=app.modules.get("modal")({mod:["medium"]}),s=t({name:"buttonRow",param:{style:{"margin-top":"30px"}},content:[{name:"button",param:{mod:["blue"],style:{width:200},class:"disabled",text:"Cancel Subscription",callback:function(){var t=r.serializeJson(),e={reason:t.reason,wishes:"Other"===t.reason?t.other_text:"Not enough functionality"===t.reason?t.functionality_text:""};"Other"===t.reason&&(e.is_others=!0);var i=$(this).loader("button");app.serverRequest("cancelSubscription",e).then(function(t){!0===t.state?(a(!0),o.close()):!1===t.state&&n(t.data.mapToArray(function(t,e){return e+": "+t}).join(", ")),i.done(),o.close()}).catch(n)}}},{name:"link",param:{callback:function(){a(!1),o.close()}},content:"I changed my mind"}]}),r=t({name:"form",param:{event:"input change",callback:function(t){var e=r.serializeJson(),i=r.find(".js-functionality_text").hide(),a=r.find(".js-other_text").hide(),n=!1;"Not enough functionality"===e.reason?(i.show(),n="functionality_text"):"Other"===e.reason&&(a.show(),n="other_text");var o=e.reason&&(!n||e[n].length);s.find("button").toggleClass("disabled",!o)}},content:{name:"formStack",content:[{name:"input",param:{name:"reason",type:"radio",mod:["radio","lightlabel","fullwidth"],value:"No longer work in company",label:"I no longer work in the company."}},{name:"input",param:{name:"reason",type:"radio",mod:["radio","lightlabel","fullwidth"],value:"Doesn't meet expectations",label:"Service doesn't meet my expectations."}},{name:"input",param:{name:"reason",type:"radio",mod:["radio","lightlabel","fullwidth"],value:"Integration into business processes",label:"Couldn't integrate it into our business processes or toolkit."}},{name:"input",param:{name:"reason",type:"radio",mod:["radio","lightlabel","fullwidth"],value:"Not enough functionality",label:"Service doesn’t contain needed functionality:"}},{name:"input",param:{name:"functionality_text",class:"js-functionality_text",containerStyle:{display:"none"},mod:["fullwidth"],placeholder:"Please, specify what features do you need"}},{name:"input",param:{name:"reason",type:"radio",mod:["radio","lightlabel","fullwidth"],value:"Other",label:"Other reason"}},{name:"input",param:{name:"other_text",class:"js-other_text",containerStyle:{display:"none"},mod:["fullwidth"],placeholder:"Please, fill in reason"}}]}});o.insert(t({name:"board",content:[{name:"heading",content:"Could you please tell us why you decided to cancel subscription?"},[r,s]]})),o.subscriber("on",{event:"close"},function(){a(!1)}),o.open()})},oneTitleModal:function(r){return r=vod(r,{},"object"),new Promise(function(a,t){var n,e=app.modules.get("html"),o=app.modules.get("modal")({mod:["small"]}),i=function(t){if(t){var e=n.val(),i={};e.replace(/ /g,"").length?(i[vod(r.name||"title")]=e,a(i),o.close()):n.focus()}else o.close(),a(!1)},s=e({name:"input",param:{name:"main",mod:["transperant","material","full"],value:vod(r.value,""),label:vod(r.label,"Label")}});n=s.find("input"),o.insert(e({name:"board",content:[[s,{name:"buttonRow",param:{style:{"margin-top":20}},content:[{name:"button",param:{mod:"blue",text:vod(r.buttonOK,"Save"),callback:function(){i(!0)}}},{name:"link",param:{callback:function(){i(!1)}},content:vod(r.buttonNO,"Cancel")}]}]]})),o.subscriber("on",{event:"close"},function(){i(!1)}),setTimeout(function(){n.focus().get(0).select()},20),s.on("keydown",function(t){13==t.keyCode&&(t.preventDefault(),i(!0)),27==t.keyCode&&(s.blur(),i(!1))}),o.open()})},upgradeSubscriptionModal:function(e){for(var t,i=app.modules.get("html"),a=app.modules.get("modal")({mod:["medium"]}),n=[{name:"professional",features:["pageLimit","userflowLimit","projectArchive","slack","transfer","pageCovers"]},{name:"team",features:["projectLimit","team","fileStorageTeam","projectBackup"]},{name:"agency",features:["unlimitedTeams","unlimitedUsers","support","fileStorageAgency"]}],o={projectLimit:{image:app.root+"/img/upgrade/big/project_limit.svg",title:"Upgrade to remove Projects limit",description:"Upgrade your plan to get an unlimited active Projects.",iconText:"No Projects limit",icon:app.root+"/img/upgrade/no_projects_limits.svg"},projectArchive:{image:app.root+"/img/upgrade/big/archive_project.svg",title:"Upgrade to archive Project",description:"You can archive Projects which are no longer necessary. Just easily unarchive it to get back to work again.",iconText:"Activate Projects Archive",icon:app.root+"/img/upgrade/archive.svg"},team:{image:app.root+"/img/upgrade/big/first_team.png",title:"Upgrade to create team",description:"It's a pleasure to work in a great team!",iconText:"Team up to 5 members",icon:app.root+"/img/upgrade/create_team.svg"},unlimitedTeams:{image:app.root+"/img/upgrade/big/to_create_one_more_team.svg",title:"Upgrade to create more teams",description:"A lot of Projects, hah? Excellent plan for agencies and studios.",iconText:"Unlimited Teams",icon:app.root+"/img/upgrade/unlimited_teams.svg"},unlimitedUsers:{image:app.root+"/img/upgrade/big/to_add_one_more_teammate.svg",title:"Upgrade to add more team members",description:"A couple of new professionals never hurt.",iconText:"Unlimited Users in Teams",icon:app.root+"/img/upgrade/unlimited_users_in_teams.svg"},slack:{image:app.root+"/img/upgrade/big/integration_with_slack.svg",title:"Upgrade to integrate with Slack",description:"Receive tactual Project notifications in one of the best messengers ever.",iconText:"Integration with Slack",icon:app.root+"/img/upgrade/integration_with_slack.svg"},pageLimit:{image:app.root+"/img/upgrade/big/page_limit.svg",title:"Upgrade to remove page limit",description:"Create sitemaps of any size without any limits. We know — all of your Projects need sitemap.",iconText:"Integration with Slack",icon:app.root+"/img/upgrade/page_limit.svg"},userflowLimit:{image:app.root+"/img/upgrade/big/user_flow_limit.svg",title:"Upgrade to remove User Flow limit",description:"Create unlimited User Flows inside your Project to manage every customer journey.",iconText:"Unlimited Userflow",icon:app.root+"/img/upgrade/user_flow_limit.svg"},support:{iconText:"Priority support",icon:app.root+"/img/upgrade/priority_support.svg"},transfer:{iconText:"Transfer Ownership",icon:app.root+"/img/upgrade/transfer_ownership.svg"},fileStorageTeam:{image:app.root+"/img/upgrade/big/increased_file_storage.svg",title:"Upgrade to increase file storage",description:"Upload and store all files directly into your Project — up to 25 Gb.",iconText:"25 GB file storage",icon:app.root+"/img/upgrade/increased_file_storage.svg"},fileStorageAgency:{image:app.root+"/img/upgrade/big/increased_file_storage.svg",title:"Upgrade to increase file storage",description:"Upload and store all files directly into your Project — up to 50 Gb.",iconText:"50 GB file storage",icon:app.root+"/img/upgrade/increased_file_storage.svg"},projectBackup:{image:app.root+"/img/upgrade/big/upgrade_for_project_backup.svg",title:"Upgrade for Project backup",description:"Never loose Project data in case of accidental editing.",iconText:"Project Backup",icon:app.root+"/img/upgrade/upgrade_for_project_backup.svg"},pageCovers:{image:app.root+"/img/upgrade/big/custom_page_covers.svg",title:"Upgrade to upload Custom Page Covers",description:"Create your own Cover sets with no limits. \n Page Covers helps your Project to be unique.",iconText:"Custom Page Covers",icon:app.root+"/img/upgrade/custom_page_covers.svg"}},s=User.tarif.split("-")[0],r=n.findIndex(function(t){return t.features.includes(e)})||1,c=n[r],l=o[e],d=c.features.exclude(e),h=r-1;0<=h&&d.length<4;h--)(t=n[h]).name!==s&&Array.prototype.push.apply(d,t.features.exclude(e).shuffle());return 4<d.length&&(d.length=4),app.serverRequest("metricCounter",{trigger:"upgradePopupOpen",value:e}),a.insert(i({param:{class:"fm-subscrupdate"},content:[{param:{class:"fm-subscrupdate__image"},content:{param:{tag:"img",attr:{src:l.image}}}},{param:{class:"fm-subscrupdate__title"},content:{name:"heading",param:{mod:"center"},content:l.title}},{param:{class:"fm-subscrupdate__description"},content:{name:"paragraph",param:{mod:"center"},content:l.description+"\n Upgrade to "+CFL(c.name)+" plan and get more features like:"}},{param:{class:"fm-subscrupdate__features"},content:d.map(function(t){var e=o[t];return{param:{class:"fm-subscrupdate__item"},content:[{param:{class:"fm-subscrupdate__icon",call:{fn:$.fn.setBackground,args:[e.icon]}}},{param:{class:"fm-subscrupdate__text"},content:{name:"paragraph",param:{mod:["big","center","bold"]},content:e.iconText}}]}})},{param:{class:"fm-subscrupdate__action"},content:{name:"buttonRow",content:[{name:"button",param:{mod:"green",style:{width:269},text:"Upgrade now",callback:function(){app.router("/updateplan?to="+c.name+"-month"),a.close(),app.serverRequest("metricCounter",{trigger:"upgradePopupAction",value:"upgradeplan"})}}},{name:"button",param:{mod:"white",style:{width:190},text:"View all Plans",callback:function(){app.router("/updateplan"),a.close(),app.serverRequest("metricCounter",{trigger:"upgradePopupAction",value:"viewallplan"})}}}]}}]})),a.open()},backup:function(t){var i=app.modules.get("html"),a=t.mod,n="false";t.team instanceof Promise&&t.team.then(function(t){n=t.value});var o={create:{title:"Backup Project",description:"Create and save a Backup copy of the Project for recovery purposes",action:"Create Backup",actionOnDone:i({name:"button",param:{mod:"blue",text:"Ok",callback:function(){e.close()}}}),done:"Backup was successfully created"},restore:{title:"Restore from Backup",description:"This copy will be restored as a new Project. Recovery will not affect the existing Project.",selectTeam:!0,action:"Restore Backup",actionOnDone:i({name:"button",param:{mod:"blue",text:"Ok",callback:function(){e.close()}}}),done:'Recovery was successfully completed! You can see the <a href="" class="js-project link">restored project</a> in the <a href="/projects" class="link">list of projects</a>.'},upload:{title:"Restore backup from local storage",description:"This copy will be restored from your local storage as a new project. Recovery will not affect the existing project.",selectTeam:!0,action:"Restore Backup",actionOnDone:i({name:"button",param:{mod:"blue",text:"Ok",callback:function(){e.close()}}}),done:'Recovery was successfully completed! You can see the <a href="" class="js-project link">restored project</a> in the <a href="/projects" class="link">list of projects</a>.'}},e={init:function(){this.popup.insert(this.dom),this.popup.open(),this.popup.subscriber("on",{event:"close"},function(){t.close()})},render:function(t,e){this.loadbar.find(".fm-help__count").text(t+"%"),this.loadbar.find(".fm-help__bar").css("transform","scaleX("+t/100+")"),this.text.html(e)},submit:function(){this.popup.fixed(!0),this.render(0,"Initializing"),this.body.prepend(this.loadbar);var i=this.actions.addClass("disabled").find('[data-action="true"]').loader("button");t.submit({onStep:this.render.bind(this),onDone:function(t,e){i.done(),this.render(t,safetyObjectAccess(o,[a,"done"],"Done!")),o[a].hasOwnProperty("actionOnDone")?this.actions.removeClass("disabled").insert(o[a].actionOnDone):setTimeout(this.close.bind(this),2e3),this.popup.fixed(!1),this.text.find(".js-project").attr("href",safetyObjectAccess(e,["data","nextUrl"],""))}.bind(this),onError:this.error.bind(this)},{team:n})},error:function(t){this.popup.dom.find(".fm-heading").addClass("fm-heading--red").prepend(i({name:"icon",param:{name:"alert"}})),this.loadbar.remove(),this.text.html("An error has occurred"+(t?': "'+t+'"':"")+'.Please try it again. If the error recurs, please contact our support at <a href="https://flowmapp.com/contact-us/" class="link">flowmapp.com/contact-us</a>'),this.popup.fixed(!1),this.actions.removeClass("disabled").insert(i({name:"button",param:{mod:"red",text:"Ok",callback:this.close.bind(this)}}))},close:function(){this.popup.close()},get text(){return this._text||(this._text=i({name:"paragraph",content:safetyObjectAccess(o,[a,"description"],"ERROR (DESCRIPTION IS LOST)")}),o[a].selectTeam&&app.serverRequest("teamList").then(function(t){var e=app.teams.showTeamList;n=e.value,e.state&&this._text.append(i({name:"input",param:{placeholder:"Which Account?",label:"Create project in",type:"select",style:{"margin-top":10},settings:{value:e.value,options:[{value:"false",text:"Add to my Subscription"}].concat(t.map(function(t){return{value:t.id,text:"Add to team «"+t.title+"»"}}))},callback:function(t){n=t.value}}}))}.bind(this))),this._text},get body(){return this._body||(this._body=i({param:{class:"fm-board__block",callback:function(t){$(t.target).is("a")&&this.close()}.bind(this)},content:[this.text,this.actions]})),this._body},get loadbar(){return this._loadbar||(this._loadbar=i({param:{class:"fm-help__progress"},content:[{param:{class:"fm-help__count"}},{param:{class:"fm-help__rail"},content:{param:{class:"fm-help__bar"}}}]})),this._loadbar},get actions(){return this._actions||(this._actions=i({name:"buttonRow",content:[{name:"button",param:{mod:"blue",attr:{"data-action":"true"},text:safetyObjectAccess(o,[a,"action"],"ERROR (DESCRIPTION IS LOST)"),callback:this.submit.bind(this)}},{name:"link",param:{callback:this.close.bind(this)},content:"Cancel"}]})),this._actions},get dom(){return i({name:"board",content:[{name:"heading",content:safetyObjectAccess(o,[a,"title"],"ERROR (TITLE MISSING)")},this.body]})},popup:app.modules.get("modal",{mod:["small"]})};e.init()},duplicateProject:function(n){return new Promise(function(t,e){var i=app.modules.get("modal",{mod:["small"]}),a=n.team||"false";i.insert(app.modules.get("html",{name:"board",content:[{name:"heading",content:"Duplicate project"},{name:"paragraph",content:["Duplicate Project will create a new Project. It will not affect the existing Project.",{name:"input",param:{placeholder:"Which Account?",label:"Create project in",type:"select",style:{"margin-top":10},settings:{value:a,options:app.teams.list().then(function(t){return[{value:a,text:"Add to my Subscription"}].concat(t.map(function(t){return{value:t.id,text:"Add to team «"+t.title+"»"}}))})},callback:function(t){a=t.value}}}]},{name:"buttonRow",content:[{name:"button",param:{mod:"blue",attr:{"data-action":"true"},text:"Duplicate",callback:function(){t({team:a}),i.close()}}},{name:"link",param:{callback:i.close},content:"Cancel"}]}]})),i.subscriber("on",{event:"close"},function(){i.close(),t(!1)}),i.open()}).catch(console.log)}};app.modules.add("modalTemplates",function(t){if(i.hasOwnProperty(t)){var e=Array.prototype.slice.call(arguments);return i[t].apply(this,e.slice(1,e.length))}})}(),function(){var e={list:[],add:function(t){var e=new i(t,getRandom(this.list.map(function(t){return t.id})));return this.dom.append(e.dom),this.list.push(e),this.view(),setTimeout(function(){e.show(!0)},20),e},remove:function(e){var t=this.list.findIndex(function(t){return e.id==t.id});0<=t&&this.list.remove(t),e.dom.css({"z-index":1}),e.show(!1),setTimeout(function(){e.dom.remove()},200),this.view()},get header(){return $("header.header")},view:function(){var i=this.list.length,a=0;this.list.forEach(function(t,e){t.dom.css({top:a,"z-index":i-e}),a+=t.dom.outerHeight()}),this.dom.css({top:0,"z-index":129})},get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){return $('<div class="fm-notify-container"></div>').appendTo("body")}},i=function(t,e){this.id=e,this.settings=t,this.bind()};i.prototype={show:function(t){this.dom.toggleClass("fm-notify--show",t)},bind:function(){var e=this;this.dom.on("click",".js-close",function(t){t.stopPropagation(),e.die()}),!1!==this.settings.timer&&(this.mouseLeaveTimer=this.dom.mouseLeaveTimer(function(){e.die()},this.settings.timer||5e3,!0)),this.settings.callback&&"function"==typeof this.settings.callback&&(this.dom.on("click",function(t){!1===e.settings.callback()&&e.die()}),this.dom.addClass("fm-notify--pointer"))},unbind:function(){this.mouseLeaveTimer&&this.mouseLeaveTimer(),this.dom.off()},get template(){return app.modules.get("html",{name:"notify",param:{mod:this.settings.mod||"blue"},content:this.settings.content||"Missing Message"})},get dom(){return this._dom||(this._dom=this.template),this._dom},die:function(){this.unbind(),e.remove(this)}},app.modules.add("notify",function(t){return e.add(t)}),app.getReady().then(function(){e.view()})}(),function(){var a=function(t,e,i){this.target=t,this.param=e||{},this.callback="function"==typeof i?i:function(){return!0},this.inject(),this.appear(!0),this.bind()};a.prototype={inject:function(){this.target.parent().prepend(this.dom),this.dom.css({"z-index":1*this.target.cssComputed("z-index")-1})},die:function(){this.unbind(),this.dom.remove(),this.target.removeData("overflow")},appear:function(t){this.dom.toggleClass("fm-overflow--appear",t)},bind:function(){this.dom.on("click",function(){!0===this.callback()&&this.die()}.bind(this))},unbind:function(){this.dom.off(),"function"==typeof this.clickOutside&&this.clickOutside()},get dom(){return this._dom||(this._dom=app.modules.get("html",{param:{class:"fm-overflow"}})),this._dom}},app.modules.add("overflow",function(t,e,i){return t.data("overflow")||t.data("overflow",new a(t,e,i)),t.data("overflow")})}(),function(){var e=function(t){this.settings=Object.assign({},this.defaultSettings,t||{}),this.pages=[],Subscriber(this)};e.prototype={get defaultSettings(){return{mod:[],fillWidth:!1,fillHeight:!1,applyDimensions:!1,scroller:!0,scroll:"v"}},getByIndex:function(t){},getByAnchor:function(t){},toAnchor:function(e){var t=this.pages.find(function(t){return t.anchor==e});t&&this.slide(t)},toIndex:function(t){var e=this.pages[t];e&&this.slide(e)},slide:function(t,e){if(this.currentPage){if(this.currentPage.anchor==t.anchor)return!1;e=this.currentPage.index>t.index?"left":"right",this.subscriber("add",{event:"leave",target:this.currentPage.anchor,data:this.currentPage})}else e="right";this.dom.addClass("animation");var i=this.currentPage||!1;t.dom.show(),t.dom.removeClass("right left close active"),t.dom.addClass(e),i&&(i.dom.removeClass("right left"),i.dom.addClass(e)),forceReflow(this.dom),$(window).trigger("resize"),this.currentPage=t,i&&i.dom.addClass("close"),t.dom.addClass("active"),!0===this.settings.applyDimensions&&this.pageContainer.css({width:Math.round(t.dom.outerWidth()),height:Math.round(t.dom.outerHeight())}),setTimeout(function(){i&&i.anchor!=this.currentPage.anchor&&i.dom.hide(),this.dom.removeClass("animation")}.bind(this),202),this.subscriber("add",{event:"slide",target:t.anchor,data:t})},redraw:function(t){!0===this.settings.applyDimensions&&this.pageContainer.css({width:Math.round(this.currentPage.dom.outerWidth()),height:Math.round(this.currentPage.dom.outerHeight())})},die:function(){this.dom.find("[data-scroll]").baron().dispose(),this.subscriber("die")},addPage:function(t,e){var i={index:safetyObjectAccess(t,["index"],this.pages.length),anchor:safetyObjectAccess(t,["anchor"],this.pages.length),dom:$('<div class="parallel-pages__page"></div>').append(e)};return this.pages.push(i),this.pageContainer.append(i.dom),this.pages.sort(function(t,e){return t.index-e.index}).forEach(function(t,e){t.index=e}),i},removePage:function(e){this.pages.findAndRemove(function(t){if(t.anchor===e)return t.dom.remove(),!0}),this.pages.sort(function(t,e){return t.index-e.index}).forEach(function(t,e){t.index=e})},get scroller(){return this.dom.find(".scroller")},get pageContainer(){return this.dom.find(".parallel-pages__container")},get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){var t=app.modules.get("html",{param:{class:["parallel-pages"].concat(this.settings.mod.map(function(t){return"parallel-pages--"+t})).join(" ")},content:{param:{class:"parallel-pages__container"}}});return!0===this.settings.fillWidth&&t.addClass("parallel-pages--fillwidth"),!0===this.settings.fillHeight&&t.addClass("parallel-pages--fillheight"),!0===this.settings.scroller&&t.customScroll({drt:this.settings.scroll}),t},get api(){var t=this;return{subscriber:this.subscriber,addPage:this.addPage.bind(this),removePage:this.removePage.bind(this),toAnchor:this.toAnchor.bind(this),toIndex:this.toIndex.bind(this),list:this.pages,die:this.die.bind(this),redraw:this.redraw.bind(this),get dom(){return t.dom}}}},app.modules.add("parallelPages",function(t){return new e(t).api})}(),function(){var i={interpolate:function(t,e,i,a){var n,o,s,r,c,l,d=Math.abs,h=[];for(n=t<i?1:-1,o=e<a?1:-1,c=(s=d(i-t))-(r=d(a-e));h.push([t,e]),t!==i||e!==a;)-r<(l=2*c)&&(c-=r,t+=n),l<s&&(c+=s,e+=o);return h},expandPath:function(t){var e,i,a,n,o,s,r=[],c=t.length,l=this.interpolate;if(c<2)return r;for(o=0;o<c-1;++o)for(e=t[o],i=t[o+1],n=(a=l(e[0],e[1],i[0],i[1])).length,s=0;s<n-1;++s)r.push(a[s]);return r.push(t[c-1]),r},compressPath:function(t){if(t.length<3)return t;var e,i,a,n,o,s,r=[],c=t[0][0],l=t[0][1],d=t[1][0],h=t[1][1],u=d-c,p=h-l;for(u/=o=Math.sqrt(u*u+p*p),p/=o,r.push([c,l]),s=2;s<t.length;s++)e=d,i=h,a=u,n=p,u=(d=t[s][0])-e,p=(h=t[s][1])-i,p/=o=Math.sqrt(u*u+p*p),(u/=o)===a&&p===n||r.push([e,i]);return r.push([d,h]),r},checkPath:function(t,e){return t.every(function(t){return e[t[0]]&&0===e[t[0]][t[1]]})},checkLine:function(t,e,i){var a=e[0]-t[0],n=e[1]-e[1],o=Math.sqrt(a*a+n*n);if(Math.round(o)!==o)return!1;if(!(0<o))return 0===i[t[0]][t[1]];for(var s=a/o,r=n/o,c=0;c<=o;c++)if(0!==i[t[0]+s*c][t[1]+r*c])return!1},findStraightPath:function(t,e,i){var a=this.expandPath([[t[0],t[1]],[e[0],t[1]],[e[0],e[1]]]),n=this.expandPath([[t[0],t[1]],[e[0],t[1]],[e[0],e[1]]]);return this.checkPath(a,i)?a:this.checkPath(n,i)?n:[]},findAnyPath:function(t,e,i){var a=new PF.Grid(transponse2d(i));return new PF.BreadthFirstFinder({allowDiagonal:!1}).findPath(t[0],t[1],e[0],e[1],a)},findPathBetweenPoints:function(t,e,i){var a=this.findStraightPath(t,e,i);return a.length?a:this.findAnyPath(t,e,i)},findPathByPoints:function(t,e){for(var n=e,o=cloneMatrix(e),s=this.findPathBetweenPoints.bind(this),r=[],i=0;i<t.length-1;i++)!function(t,e){var i=s(t,e,o);i.length||(i=s(t,e,n));for(var a=0;a<i.length-1;a++)o[i[a][0]][i[a][1]]=1;Array.prototype.push.apply(r,i)}(t[i],t[i+1]);return this.compressPath(r)}};app.modules.add("pathFinder",function(t,e){return arguments.length?i.findPathByPoints(t,e):i})}(),function(){var e={autoOpen:!0,mod:[]},i=function(t){Subscriber(this),this.settings=Object.assign(t),this.inject(),this.bind()};i.prototype={setTransform:function(){var t=this.dom.offset().left,e=this.dom.offset().top,i=2*this.dom.outerWidth(),a=2*this.dom.outerHeight(),n=cursorX-(t+i/2),o=cursorY-(e+a/2);this.dom.css("transform-origin",n+"px "+o+"px"),forceReflow(this.dom)},open:function(){if(this.state)return!1;this.state=!0,this.subscriber("add",{scope:this.api,event:"open"}),this.setTransform(),this.dom.addClass("open")},close:function(){if(this.fixed||!this.state)return!1;this.state=!1,this.subscriber("add",{scope:this.api,event:"close"}),this.setTransform(),this.dom.addClass("close"),this.unbind(),this.dom.onTransitionEnd(250).then(function(){this.dom.remove()}.bind(this))},bind:function(){this.settings.clickOutside&&(this.clickOutside=this.dom.clickOutside(this.close.bind(this)))},unbind:function(){this.clickOutside&&this.clickOutside(),this.subscriber("die")},insert:function(t,e){e&&this.entryPoint.html("");var i=app.modules.get("html");[].concat(t).forEach(function(t){this.entryPoint.append(i(t))}.bind(this))},inject:function(){this.dom.appendTo(this.settings.target||$("body")),forceReflow(this.dom)},get template(){var t=app.modules.get("html"),e=t({param:{class:"fm-popover"},content:{param:{class:"fm-popover__content"}}});return this.settings.close&&e.append(t({param:{class:"fm-popover__close ",callback:this.close.bind(this)},content:{name:"button",param:{mod:["narrow","gray","round"],icon:"uncheck"}}})),this.settings.position&&e.css(this.settings.position),e},get entryPoint(){return this._entryPoint||(this._entryPoint=this.dom.find(".fm-popover__content")),this._entryPoint},get dom(){return this._dom||(this._dom=this.template,this.settings.insert&&this.entryPoint.append(app.modules.get("html",this.settings.insert))),this._dom},get api(){var e=this;return{fixed:function(t){if("boolean"!=typeof t)return e.fixed;e.fixed=t},open:e.open.bind(this),close:e.close.bind(this),get dom(){return e.dom},insert:e.insert.bind(this),subscriber:this.subscriber}}},app.modules.add("popover",function(t){return new i(Object.assign({},e,t)).api})}(),function(){var t={count:function(t){if("number"==typeof t)this._count=t,this.view();else{if("boolean"!=typeof t)return this._count||0;this._count=0,this.view()}},set textTemplate(t){"function"==typeof t&&(this._textTemplate=t)},get textTemplate(){return this._textTemplate?this._textTemplate(this.count()):""},render:function(t){this.subscriber("clear");var e=this;t.textTemplate&&(this.textTemplate=t.textTemplate);var i={delete:{name:"button",param:{mod:["narrow","fake"],text:"Delete",callback:function(){e.subscriber("add",{event:"delete"})},icon:"trash"}},archive:{name:"button",param:{mod:["narrow","fake"],text:"Archive",callback:function(){e.subscriber("add",{event:"archive"})},icon:"archive"}},unarchive:{name:"button",param:{mod:["narrow","fake"],text:"Unarchive",callback:function(){e.subscriber("add",{event:"unarchive"})},icon:"archive"}},leave:{name:"button",param:{mod:["narrow","fake"],text:"Leave",callback:function(){e.subscriber("add",{event:"leave"})},icon:"leave"}}};this.dom.find(".js-tools").html(""),t.events.length&&t.events.forEach(function(t){var e;"string"==typeof t&&i.hasOwnProperty(t)?e=app.modules.get("html",i[t]):"object"==typeof t&&(e=app.modules.get("html",t)),this.dom.find(".js-tools").append(e)},this)},bind:function(){this.dom.on("click",".js-select",function(){this.subscriber("add",{event:"select"})}.bind(this)).on("click",".js-deselect",function(){this.subscriber("add",{event:"deselect"})}.bind(this))},view:function(){this.dom.find(".js-count").text(this.count()),this.dom.find(".js-text").text(this.textTemplate),this.dom.toggleClass("open",0<this.count())},get dom(){return this._dom||(this._dom=app.modules.get("html",{name:"selectBar"}),$("body").append(this.dom),this.bind()),this._dom},get api(){var t=this;return{get dom(){return t.dom},render:this.render.bind(this),count:this.count.bind(this),clear:function(){this.count(0)}.bind(this),subscriber:this.subscriber.bind(this)}}};Subscriber(t),app.modules.add("selectbar",function(){return t.api})}(),function(){var o={shortcut:function(e){return{icon:"keyboard",title:"Shortcuts",render:function(t){this.dom||(this.dom=app.modules.get("html",{name:"scroller",content:{name:"table",param:{mod:["bordered","tall"]},content:e.map(function(t){return{name:"row",param:{mod:["nowrap"]},content:[t.description,[].concat(t.value).map(function(t){return"string"==typeof t?"hold"===t?$('<span class="light" style="margin: 0 4px">Hold</span>'):"or"===t?$('<span class="light">or</span>'):"click"===t?$('<span class="strong" style="margin: 0 4px">Click</span>'):"plus"===t?$('<span class="strong" style="margin: 0 1px">+</span>'):$('<span class="strong" style="margin: 0 4px">'+t+"</span>"):t})]}})}})),t.append(this.dom)},dismiss:function(){this.dom&&this.dom.detach()}}},helpCenter:function(t){var l=app.modules.get("html"),n=function(t){var e=function(t){return t.map(function(t){return{title:t.title,icon:"hc_lamp",contentIcon:"hc_lamp",childs:e(t.childs||[]),wrap:!0,contentTitle:l({name:"layout",param:{mod:"landing"},content:{param:{tag:"h1"},content:t.title}}),get content(){return l({name:"layout",param:{mod:"landing"},content:$(t.content)})}}})};return e(t)},o=function(t){var e=function(t){return t.map(function(t){return{title:t.title,icon:"hc_help",contentIcon:"hc_help",childs:e(t.questions||[]),wrap:!0,contentTitle:l({name:"layout",param:{mod:"landing"},content:"<h1>"+t.title+"</h1>"}),get content(){return l({name:"layout",param:{mod:"landing"},content:t.content})}}})};return e(t.all_faq)},s=function(){var t=app.help.list.reduce(function(t,e){var i=e.group||"None";return t.hasOwnProperty(i)||(t[i]=[]),t[i].push(e),t},{});return t.mapToArray(function(t,i){return{title:i,childs:[],icon:"hc_tour",get content(){return l({name:"table",param:{mod:["bordered","tall"]},content:(e=i,app.help.list.filter(function(t){return t.group===e&&toBoolean(t.event)&&toBoolean(t.active)})).map(function(e){return{name:"row",content:[e.title,{name:"toggle",param:{checked:!toBoolean(User.getUserSettings(["help","readed",e.name],!1)),name:"",value:!0,callback:function(t){User.setUserSettings(["help","readed",e.name],!t.state),e.readed=!1}}}]}})});var e}}})},r=function(){var t=l({name:"buttonRow",param:{style:{"margin-top":20}},content:[{name:"button",param:{attr:{type:"submit"},mod:["blue"],icon:"send",text:"Send Your Feedback"}}]}),i=l({name:"emptyPlaceholder",param:{mod:["absolute","white"],template:[{mod:"icon",style:{width:120,height:79},content:$('<img src="/app/img/emptystate/empty_send_mail.png">')},{mod:"heading",content:{name:"heading",param:{mod:["big","light","center"]},content:"Thanks for your mail!"}},{mod:"description",content:{name:"paragraph",param:{mod:["center","gray"]},content:["We have received your email and our Customer Service team\nwill be responding to you soon."]}},{mod:"action",content:{name:"link",param:{attr:{"data-empty-action":"renew"}},content:"Send another feedback"}}],callback:function(){i.removeClass("open"),e()}}}),a=l({name:"board",content:[{name:"form",param:{validateStrict:!0,validateMod:"change",validation:function(t){return app.modules.get("validation",t,!0)},callback:function(){var t=a.loader("blockLight"),e=new Promise(function(e){$.ajax({url:"/sendmail",data:new FormData(a.find("form").get(0)),cache:!1,contentType:!1,processData:!1,method:"POST",success:function(t){e({status:!0})}})});return e.then(function(){t.done(),i.addClass("open")}),e},actions:t},content:[{name:"input",param:{name:"email",type:"email",mod:["required","full"],value:vts(User.login),data:{value:vts(User.login)},label:"E-mail",placeholder:"E-mail"}},{name:"input",param:{name:"topic",type:"select",mod:["required","full"],options:["Suggestions","Errors in app","Question","Partnership","Feedback"],value:"",label:"Feedback topic",data:{label:"Please select an option"},placeholder:"Please select an option"}},{name:"input",param:{name:"subject",mod:["required","full"],type:"text",value:"",data:{value:""},label:"Subject",placeholder:"Subject"}},{name:"input",param:{name:"full_text",type:"textarea",mod:["autoresize","required","full"],autoresize:!0,value:"",data:{value:""},label:"Full Description",placeholder:"Full Description"}},{name:"attachZone",param:{name:"userfile",mod:"light",uploadPreview:!0,multiple:!1}},t,i]}]}),e=function(){a.find(":input").each(function(){var t=$(this),e=$(this).attr("name");e&&(t.is("select")?t.flowmapSelect("value","",!0):"email"!==e&&t.val(""))})};return a};return{icon:"guide",get title(){return this._title||(this._title=l([{name:"heading",param:{mod:"sub",style:{"line-height":"inherit"}},content:"Help center"},this.navBar])),this._title},init:function(){this.container=app.modules.get("parallelPages",!0),this.container.subscriber("on",{event:"slide"},function(t){this.updateNav(t[0].data,this.container.list)}.bind(this));var a=this.dom.loader("blockLight");this.data.then(function(t){var e=t[0],i=t[1];this.list=[{title:"Knowledge Base",icon:"hc_lamp",childs:n(e)},{title:"FAQ",icon:"hc_help",childs:o(i)},{title:"Contact Customer Support",icon:"hc_support_msg",content:r(),childs:[]},{title:"Tour",icon:"hc_tour",displayMod:"pages",childs:s()}],this.createPage({anchor:"Main",childs:this.list}),this.container.toIndex(0),a.done()}.bind(this)).catch(app.log)},checkLinkExist:function(){},createPage:function(t){var e=this,a=["png","jpg","jpeg","svg","gif"],i=function(t){var e=$(t.target).closest("a");if(e.length){var i=e.get(0).pathname.split("/").pop().split(".").pop().toLowerCase();t.preventDefault(),a.includes(i)||openLinkInNewTab(e.attr("href"))}}.bind(this),n={pages:function(t){return l({name:"table",param:{mod:["bordered","tall","pointer"],callback:i},content:t.childs.map(function(t){return{name:"row",param:{param:{mod:["nowrap"]},callback:function(){e.slideTo(e.createPage(t).anchor)}},content:[[t.icon?{name:"buttonIcon",param:{name:t.icon,mod:["light","flexcenter"],style:{"margin-right":10}}}:"",{name:"paragraph",param:{mod:["big","bold"]},content:t.title},{name:"iconArrow",param:{style:{"margin-left":"auto",transform:"rotate(-90deg)"}}}]]}})})},list:function(t){return l({param:{style:{padding:"0 20px 29px"},callback:i},content:t.childs.map(function(t){return{name:"spoiler",param:{header:[t.icon?{name:"buttonIcon",param:{name:t.icon,mod:["light","flexcenter"],style:{"margin-right":10}}}:"",t.title],mod:["light"]},content:t.content}})})},content:function(t){var e=[t.contentIcon?{param:{class:"fm-sidetoolbar__titleicon"},content:{name:"buttonIcon",param:{name:t.contentIcon,mod:["light","flexcenter"]}}}:"",t.contentTitle||"",t.content];return t.wrap?l({param:{class:"fm-sidetoolbar__container",callback:i},content:e}):e}},o=t.childs||[],s=o.reduce(function(t,e){return t+!!(e.childs||[]).length},0),r=t.displayMod||(o.length?s?"pages":"list":"content"),c=n.hasOwnProperty(r)?n[r](t):t.content;return this.container.addPage({anchor:t.anchor||t.title},c)},slideTo:function(t){this.container.toAnchor(t)},updateNav:function(t,e){var i=[],a=t.index;e.slice(0).forEach(function(t){t.index>a?setTimeout(function(){"Contact Customer Support"===t.anchor&&t.dom.children().detach(),this.container.removePage(t.anchor)}.bind(this),300):i.push(t.anchor)},this),this.navBar.insert(l({name:"breadCrumb",param:{path:i,callback:this.slideTo.bind(this)}}))},get data(){return Promise.all([app.data("knowlegeBase"),app.data("faq")])},get dom(){return this._dom||(this._dom=this.container.dom),this._dom},get navBar(){return this._navBar||(this._navBar=l({param:{style:{display:"flex"}}})),this._navBar},render:function(t){this.dom.appendTo(t)},dismiss:function(){this.navBar.detach(),this.dom.detach()},die:function(){this.navBar.remove(),this.dom.remove()}}},news:function(t){var a=app.modules.get("html");return{icon:"news",title:"What's new",init:function(){this.data=app.data("release_notes").then(function(t){return t.map(function(t){return{title:t.full_title||t.title,date:t.publish_date,get content(){return a({name:"layout",param:{mod:["landing","nopadding"]},content:$(t.content)})}}})}),this.updateState()},updateState:function(){this.data.then(function(t){var e=User.getUserSettings(["lastReadNewsDate"],0),i=t[0].date;this._icon&&this._icon.toggleClass("noty",e<i)}.bind(this))},render:function(t){var i=this.dom.loader("blockLight");this.updateState(),this.data.then(function(t){var e=User.getUserSettings(["lastReadNewsDate"],0);this.dom.find(".fm-scroller__container").insert(a({param:{style:{padding:"0 20px 20px"}},content:t.map(function(t){return{name:"spoiler",param:{header:{content:[{param:{tag:"span",class:"light normal"},content:formatDate(1e3*t.date,"M dd, yyyy")},{name:"paragraph",param:{mod:"big"},content:t.title}]},mod:t.date>e?["light","lightblue"]:["light"],bind:t.date>e&&{mouseover:function(){$(this).removeClass("fm-spoiler--lightblue")}}},content:t.content}})})),i.done(),User.setUserSettings(["lastReadNewsDate"],t[0].date),this.updateState()}.bind(this)),this.dom.appendTo(t)},get dom(){return this._dom||(this._dom=a({name:"scroller",param:{mod:["absolute","curtain"]}})),this._dom},dismiss:function(){this.dom&&this.dom.detach(),this.updateState()}}}},e=["helpCenter","news"];(sideTools={init:function(){this.currentModules=[],this.activeModule=null,Subscriber(this)},update:function(t){this.removeModules().then(this.appendModules.bind(this,t)).then(this.initModules.bind(this)).then(this.render.bind(this))},initModules:function(){return Promise.all(this.currentModules.reduce(function(t,e){return e.hasOwnProperty("init")&&t.push(e.init()),t},[]))},appendModules:function(t){return Promise.all([].concat(t,e).reduce(function(t,e){if("string"==typeof e||Array.isArray(e)){var i=[].concat(e),a=i[0],n=i.slice(1);o.hasOwnProperty(a)&&t.push(o[a].apply(this,n))}else"object"==typeof e?t.push(e):"function"==typeof e&&t.push(e(this));return t}.bind(this),[])).then(function(t){return Array.prototype.push.apply(this.currentModules,t),this.currentModules}.bind(this))},removeModules:function(){return Promise.all(this.currentModules.reduce(function(t,e){return e.hasOwnProperty("die")?t.push(e.die()):e.hasOwnProperty("dismiss")&&t.push(e.dismiss()),t},[])).then(function(){this.activeModule=null,this.currentModules.length=0}.bind(this))},dismissModule:function(t){t.hasOwnProperty("_icon")&&t._icon.removeClass("active"),t.hasOwnProperty("dismiss")&&t.dismiss()},renderModule:function(t){this.activeModule&&this.dismissModule(this.activeModule),this.heading.html(t.title||""),t.hasOwnProperty("render")&&t.render(this.content),t.hasOwnProperty("_icon")&&t._icon.addClass("active"),this.activeModule=t},dismiss:function(){this.dom.detach()},die:function(){},render:function(){if(this.currentModules.length){var e=app.modules.get("html");this.close(),this.navbar.insert(e(this.currentModules.map(function(t){return t._icon=e({name:"buttonIcon",param:{name:t.icon,mod:"noty",callback:function(){this.open(),this.renderModule(t)}.bind(this)}}),t._icon},this))),$("body").append(this.dom)}else this.dom.remove()},open:function(){this.dom.addClass("active")},close:function(){this.dom.onTransitionEnd(300).then(function(){this.activeModule&&this.dismissModule(this.activeModule)}.bind(this)),this.dom.removeClass("active")},get heading(){return this.dom.children(".fm-sidetoolbar__heading")},get navbar(){return this.dom.children(".fm-sidetoolbar__nav")},get content(){return this.dom.children(".fm-sidetoolbar__content")},get template(){return app.modules.get("html")({param:{class:"fm-sidetoolbar"},content:[{param:{class:"fm-sidetoolbar__nav"}},{param:{class:"fm-sidetoolbar__heading"}},{param:{class:"fm-sidetoolbar__content"}},{param:{class:"fm-sidetoolbar__close"},content:{name:"buttonIcon",param:{name:"double_arrow",callback:this.close.bind(this)}}}]})},get dom(){return this._dom||(this._dom=this.template),this._dom}}).init(),app.modules.add("sideTools",function(t){return t?sideTools.update(t):sideTools.dismiss(),sideTools})}(),function(){var i=function(t){this.target=t.target,this.applySettings(t.settings||{}),this.bindFunctions=[],this.bind(),this.target.data("sideZoneScroll",this)};i.prototype={applySettings:function(t){this.settings={scroller:getValidValue([t.scroller,this.target],"object"),mouseListener:getValidValue([t.mouseListener,this.target,$(document)],"object"),triggerZoneLeft:getValidValue([t.triggerZoneLeft,t.triggerZone,.1],"number"),triggerZoneTop:getValidValue([t.triggerZoneTop,t.triggerZone,.1],"number"),triggerZoneRight:getValidValue([t.triggerZoneRight,t.triggerZone,.1],"number"),triggerZoneBottom:getValidValue([t.triggerZoneBottom,t.triggerZone,.1],"number"),maxSpeedLeft:getValidValue([t.maxSpeedLeft,t.maxSpeed,1.5],"number"),maxSpeedTop:getValidValue([t.maxSpeedTop,t.maxSpeed,1.5],"number"),maxSpeedRight:getValidValue([t.maxSpeedRight,t.maxSpeed,1.5],"number"),maxSpeedBottom:getValidValue([t.maxSpeedBottom,t.maxSpeed,1.5],"number"),minSpeedLeft:getValidValue([t.minSpeedLeft,t.minSpeed,.5],"number"),minSpeedTop:getValidValue([t.minSpeedTop,t.minSpeed,.5],"number"),minSpeedRight:getValidValue([t.minSpeedRight,t.minSpeed,.5],"number"),minSpeedBottom:getValidValue([t.minSpeedBottom,t.minSpeed,.5],"number"),speedLeft:getValidValue([t.speedLeft,t.speed,1],"number"),speedTop:getValidValue([t.speedTop,t.speed,1],"number"),speedRight:getValidValue([t.speedRight,t.speed,1],"number"),speedBottom:getValidValue([t.speedBottom,t.speed,1],"number"),adaptiveSpeed:getValidValue([t.adaptiveSpeed,!1],"boolean")}},update:function(t){this.unbind(),this.applySettings(t),this.bind(),this.mouseScrollZone=this.calcMouseScrollZone()},calcMouseScrollZone:function(){var t=this.settings.mouseListener.offset(),e=this.settings.mouseListener.outerWidth(),i=this.settings.mouseListener.outerHeight();return{x:{start:t.left,end:t.left+e,size:e},y:{start:t.top,end:t.top+i,size:i}}},get mouseScrollZone(){return this._mouseScrollZone||(this._mouseScrollZone=this.calcMouseScrollZone()),this._mouseScrollZone},set mouseScrollZone(t){equals(t,this._mouseScrollZone)||(this._mouseScrollZone=t,this.updateScrollState())},scrollMove:function(t){equals(this.scrollParam,t)||(this.scrollParam=t,this.settings.scroller.makeMeScroll(t))},updateScrollState:function(){var t=this.mouseScrollZone,e=t.x.size*this.settings.triggerZoneLeft,i=t.x.size*this.settings.triggerZoneRight,a=t.y.size*this.settings.triggerZoneTop,n=t.y.size*this.settings.triggerZoneBottom,o={x:!1,y:!1};cursorX<t.x.start+e?o.x={drt:0,speed:this.settings.adaptiveSpeed?(this.settings.maxSpeedLeft-this.settings.minSpeedLeft)*(1-e/(cursorX-t.x.start)):this.settings.speedLeft}:cursorX>t.x.end-i&&(o.x={drt:1,speed:this.settings.adaptiveSpeed?(this.settings.maxSpeedRight-this.settings.minSpeedRight)*(i/(cursorX-(t.x.end-i))):this.settings.speedRight}),cursorY<t.y.start+a?o.y={drt:0,speed:this.settings.adaptiveSpeed?(this.settings.maxSpeedTop-this.settings.minSpeedTop)*(1-a/(cursorY-t.y.start)):this.settings.speedTop}:cursorY>t.y.end-n&&(o.y={drt:1,speed:this.settings.adaptiveSpeed?(this.settings.maxSpeedBottom-this.settings.minSpeedBottom)*(n/(cursorY-(t.y.end-n))):this.settings.speedBottom}),this.scrollMove(o)},bind:function(){var t=this;this.bindFunctions=[{target:this.settings.mouseListener,event:"mousemove",callback:function(){t.updateScrollState()}},{target:$(window),event:"resize",callback:function(){t.calcMouseScrollZone()}}],this.bindFunctions.forEach(function(t){t.target.on(t.event,t.callback)})},unbind:function(){this.bindFunctions.forEach(function(t){t.target.off(t.event,t.callback)}),this.bindFunctions.length=0},die:function(){this.unbind(),this.scrollMove({x:!1,y:!1}),this.target.removeData("sideZoneScroll")}},app.modules.add("sideZoneScroll",function(t){if("object"!=typeof t)throw new Error('argument "receive" should be an object');if(!(t.target instanceof jQuery))throw new Error('argument "receive.target" should be instance of "jQuery", for some reason ;(');var e=t.target.data("sideZoneScroll");if(e){if("object"!=typeof t.settings)throw new Error('argument "receive.settings" should be an object while you update');e.update(t.settings)}else e=new i(t);return e})}(),function(){var e={},i=location.origin+":4000",a=!1,n=function(t){this.name=t,this.socket=io.connect(i+t+"?token="+User.token),a&&this.monitor()};n.prototype={join:function(t){return this.room=t,this.socket.emit("join",t),this},leave:function(t){this.socket.emit("leave",t),this.off(),a&&this.monitor()},on:function(t,e){return(t=Array.isArray(t)?t:[{event:t,callback:e}]).forEach(function(e){this.socket.on(e.event,function(t){e.callback.call(this,t)})}.bind(this)),this},off:function(t){return t?this.socket.off(t):this.socket.removeAllListeners(),this},trigger:function(t,e){return this.socket.emit(t,this.room,e),this},monitor:function(){var e=this;this.on([{event:"reconnecting",handler:function(){app.log("%c ("+e.name+")",console_styles.monitor),app.log("%c SYS: connecting...",console_styles.monitor),console.line()}},{event:"connect",handler:function(t){app.log("%c ("+e.name+")",console_styles.monitor),app.log("%c SYS: connected",console_styles.monitor),console.line()}},{event:"connection",handler:function(t){app.log("%c ("+e.name+")",console_styles.monitor),app.log("%c SYS: connection: "+t,console_styles.monitor),console.line()}},{event:"disconnect",handler:function(){app.log("%c ("+e.name+")",console_styles.monitor),app.log("%c SYS: disconnected",console_styles.monitor),console.line()}},{event:"message",handler:function(t){app.log("%c ("+e.name+")",console_styles.monitor),app.log("%c Message:",console_styles.monitor),app.log(t),console.line()}},{event:"join",handler:function(t){app.log("%c ("+e.name+")",console_styles.monitor),app.log("%c Join:",console_styles.monitor),app.log(t),console.line()}},{event:"leave",handler:function(t){app.log("%c ("+e.name+")",console_styles.monitor),app.log("%c Leave:",console_styles.monitor),app.log(t),console.line()}},{event:"pong",handler:function(t){app.log("%c ("+e.name+")",console_styles.monitor),app.log("%c PING: Still online. Latency: "+t,console_styles.monitor),console.line(),e.socket.emit("ping")}}])}},app.modules.add("socket",function(t){return e[t]||(e[t]=new n(t)),e[t]})}(),function(){var t=function(t,e){this.settings=Object.assign({size:{width:400,height:400},position:{left:"50%",top:"50%",transform:"translate(-50%, -50%)"},style:{}},e),this.index=0,this.list=[].concat(t),this.view()};t.prototype={view:function(){var t=new e(this.list[this.index],this);this.showSticker(t,this.currentSticker),this.currentSticker&&this.hideSticker(this.currentSticker,t),this.currentSticker=t},showSticker:function(t,e){$(t.settings.target||this.settings.target||content).append(t.dom),forceReflow(t.dom),e||t.show(!0)},hideSticker:function(t,e){t.show(!1)},next:function(){this.index+=1,this.index>=this.list.length?this.close():this.view()},close:function(){this.hideSticker(this.currentSticker),this.currentSticker.dom.onTransitionEnd(200).then(function(){this.currentSticker.dom.remove()}.bind(this))}};var e=function(t,e){this.controller=e,this.data=t,this.settings=Object.assign(this.controller.settings,t.settings)};e.prototype={show:function(t){t?this.dom.addClass("show"):this.dom.addClass("close")},get template(){var i=this,t=this.data;return app.modules.get("html",{param:{class:"fm-sticker",callback:function(t){var e=$(t.target);e.closest("[data-metric-counter]").length&&app.serverRequest("metricCounter",{trigger:e.closest("[data-metric-counter]").attr("data-metric-counter"),value:!0}),e.closest('[data-sticker="close"]').length&&i.controller.close(),e.closest('[data-sticker="next"]').length&&i.controller.next(),"function"==typeof i.settings.callback&&i.settings.callback.apply(this,argsToArray({arguments:arguments}))},style:Object.assign(this.settings.size,this.settings.position,this.settings.style)},content:[!1!==this.settings.close?{param:{class:"fm-sticker__close"},content:{name:"button",param:{mod:["gray","narrow","round"],icon:"uncheck",callback:function(){i.controller.close()}}}}:"",{param:{class:"fm-sticker__content"},content:[t.heading?{param:{class:"fm-sticker__heading"},content:t.heading}:"",t.body?{param:{class:"fm-sticker__body"},content:t.body}:"",t.actions?{param:{class:"fm-sticker__actions"},content:t.actions}:""]}]})},get dom(){return this._dom||(this._dom=this.template),this._dom}},app.modules.add("sticker",function(){return functionConstruct(t,argsToArray({arguments:arguments}))})}(),function(){var n=[{name:"userflow",type:"svg",url:app.root+"/img/uf_icons.svg",itemsDescription:{none:{name:"none",tags:[],index:1,designation:{searchIndex:-1}},yes:{name:"yes",tags:["yep","eh","huh","yea","yeh","yeah","indeed","agree","affirmative","positive answer","ok","okay","alright","well","huh","conspire"],index:1,section:"Main"},no:{name:"no",tags:["nay","nope","nowise","noone","negative","negativity","bad","adverse","unsuccessful","poor","abortive","unfortunate","fail","failure","wrong","mistake","error","incorrectly","false"],index:2,section:"Main"},warning:{name:"warning",tags:["caution","exclamation","alert","notice","warn","caveat","precaution","threat","risk","attention","alarm","notice"],index:3,section:"Main"},exclamation_mark:{name:"exclamation_mark",tags:["exclamation","interjection","attention","notice","alert","caution"],index:4,section:"Main"},question_mark:{name:"question_mark",tags:["interrogation","query","ask","inquire","enquire","request"],index:5,section:"Main"},person:{name:"person",tags:["user","customers","customer","client","consumer","buyer","shopper","purchaser","contractor","man","human","individual","people","subject","one","homo"],index:6,section:"Main"},lock:{name:"lock",tags:["padlock","latch","lockout","blocking","locking","blockage","block","fixation","retention","restriction","constraint","disable","close"],index:7,section:"Main"},key:{name:"key",tags:["clue","core","open"],index:8,section:"Main"},unlock:{name:"unlock",tags:["unlatch","break","unblock","enable","open","inaugurate","reveal","uncover","disclose","unveil"],index:9,section:"Main"},img:{name:"image",tags:["img","picture","photograph","photo","figure","clip art"],index:10,section:"Main"},pencil:{name:"pencil",tags:["pen","lead","editing","modify","redaction","editable","proofreading","correction","revision"],index:11,section:"Main"},photo:{name:"photo",tags:["img","picture","photograph","photo","figure","clip art"],index:12,section:"Main"},view:{name:"view",tags:["look","type","review","viewing","vision","examine","see","browse"],index:13,section:"Main"},invisible:{name:"invisible",tags:["unseen","stealth","invisibly","not visible","hide","hidden","secret","covert","concealed","stealthy","disguise"],index:14,section:"Main"},back:{name:"back",tags:["backward","backwards","rearwards","conversely","fro","back to","return"],index:15,section:"Main"},money:{name:"money",tags:["$","cash","means","finance","currency","wherewithal","coin","buck","pelf"],index:16,section:"Main"},wallet:{name:"wallet",tags:["purse","billfold","pocketbook","period of time","money","$","finance"],index:17,section:"Main"},time:{name:"time",tags:["period","moment","clock","timer","watch","timepiece"],index:18,section:"Main"},message:{name:"message",tags:["communication","msg","conversation","chat"],index:19,section:"Main"},calendar:{name:"calendar",tags:["schedule","chronology","date","term","interval"],index:20,section:"Main"},flame:{name:"flame",tags:["fire","light","heat","lights","blaze","fever","warmth","glow"],index:21,section:"Main"},lightning:{name:"lightning",tags:["thunderbolt","thunder","lightning discharge"],index:22,section:"Main"},heart:{name:"heart",tags:["cardiac","like","fancy","love","prefer","enjoy","want","wish","need"],index:23,section:"Main"},star:{name:"star",tags:["like","fancy","estimate","evaluate","assess","rate","appraise","gauge","rating","ranking","rank","top"],index:24,section:"Main"},bookmark:{name:"bookmark",tags:["tab","bookmarked","marker","favorite","label","tag","marker","flag"],index:25,section:"Main"},tag:{name:"tag",tags:["label","sign","tally"],index:26,section:"Main"},flag:{name:"flag",tags:["banner","ensign","pennant","standard","sign"],index:27,section:"Main"},idea:{name:"idea",tags:["concept","notion","thought","insight","bulb","lamp"],index:28,section:"Main"},mail:{name:"mail",tags:["letter","message","email","writing","epistle","missive","messaging","pastoral","msg","communication","report","notice","posting"],index:29,section:"Main"},send:{name:"send",tags:["sending","shipment","shipping","delivery","dispatch","mailing","submit","ship","posting","email","message","msg","notice"],index:30,section:"Main"},notification:{name:"notification",tags:["notice","announcement","alert","notify","warning","alarm"],index:31,section:"Main"},link:{name:"link",tags:["connection","relation","linking","links","reference","binding","connect","join","tie","refer","connectivity"],index:32,section:"Main"},cloud:{name:"cloud",tags:["puff","swarm","cloudlet","cloudiness","cloudy"],index:33,section:"Main"},credit_card:{name:"credit_card",tags:["credit card","credit-card","card","bank card","electronic money","ecash","e-money","electronic cash","money","$","finance"],index:34,section:"Main"},filter:{name:"filter",tags:["filtering","filtration","separation"],index:35,section:"Main"},exchange:{name:"exchange",tags:["replacement","substitution","substitute","swap","exchange","change","reversal","switching","changer","turn"],index:36,section:"Main"},reload:{name:"reload",tags:["recharge","overcharge","reboot","restart","reset","update","refresh","renew","renovate"],index:37,section:"Main"},clip:{name:"clip",tags:["clamp","bracket","paper clip","paperclip","holder"],index:38,section:"Main"},pin:{name:"pin",tags:["needle","spike","label","marker","location"],index:39,section:"Main"},pin2:{name:"pin2",tags:["needle","spike","label","marker","location"],index:40,section:"Main"},geoposition:{name:"geoposition",tags:["geolocation","gps","GPS system","location"],index:41,section:"Main"},search:{name:"search",tags:["searching","request","investigation","look","explore"],index:42,section:"Main"},like:{name:"like",tags:["like","fancy","love","prefer","enjoy","like it","taste"],index:43,section:"Main"},dislike:{name:"dislike",tags:["hostility","antipathy","distaste","not love","hate","displease","not like it","objection","distaste","antipathy"],index:44,section:"Main"},settings1:{name:"settings1",tags:["set","configure","installation","configuration option","adjustment","tweak","tune","customize","attune","setup"],index:45,section:"Main"},settings2:{name:"settings2",tags:["set","configure","installation","configuration option","adjustment","tweak","tune","customize","attune","setup"],index:46,section:"Main"},report:{name:"report",tags:["reporting","presentation","lecture","message","msg","communication","statement","notice","notification","announcement","news","messaging"],index:47,section:"Main"},camera:{name:"camera",tags:["camcorder","camera-recorder","video camera","video","film","movie","telefilm","cinema","motion picture","cinematography","moving pictures"],index:48,section:"Main"},news:{name:"news",tags:["news story","news item","news article","news report","headline","tidings","current events","press"],index:49,section:"Main"},radio:{name:"radio",tags:["wireless","news","radio station","broadcast station","broadcast","radiobroadcasting"],index:50,section:"Main"},goal:{name:"goal",tags:["purpose","objective","aim","destination","end","mission","purport","target"],index:51,section:"Main"},chart:{name:"chart",tags:["graph","diagram","graphic","curve"],index:52,section:"Main"},presentation:{name:"presentation",tags:["report","representation","submission","presentation","vision","idea","concept","conception","performance","show","introduction","picture","present"],index:53,section:"Main"},print:{name:"print",tags:["printing","press","impression","printout","hardcopy","print output"],index:54,section:"Main"},merge:{name:"merge",tags:["absorb","pour","join","unite","connect","blend","incorporate","commit"],index:55,section:"Main"},cart1:{name:"cart1",tags:["wagon","basket","carriage","wheelchair","shopping cart","shopping basket","bag"],index:56,section:"Main"},gift:{name:"gift",tags:["souvenir","present","prize","boon","bounty","fairing"],index:57,section:"Main"},folder:{name:"folder",tags:["file","directory","location","directoire"],index:58,section:"Main"},fingerprint:{name:"fingerprint",tags:["digital fingerprint","dactyloscopic","security","safety","secure","unlock","unblock","access","admission","entrance"],index:59,section:"Main"},globus:{name:"globus",tags:["earth","territory","planet","globe","world","sphere","our planet","worldwide","global","international","universal","around the world"],index:60,section:"Main"},dribbble:{name:"dribbble",tags:["social","internet","web","network","social network","social-network","design","shots"],index:61,section:"Social"},fb:{name:"fb",tags:["social","internet","web","network","social network","social-network","blog"],index:62,section:"Social"},instagram:{name:"instagram",tags:["social","internet","web","network","social network","social-network","design","blog"],index:63,section:"Social"},linkedIn:{name:"linkedIn",tags:["social","internet","web","network","social network","social-network"],index:64,section:"Social"},medium:{name:"medium",tags:["social","internet","web","network","social network","social-network","news","blog"],index:65,section:"Social"},share:{name:"share",tags:["social","internet","web","network","social network","social-network"],index:66,section:"Social"},telegram:{name:"telegram",tags:["social","internet","web","network","social network","social-network","blog","messenger"],index:67,section:"Social"},twitter:{name:"twitter",tags:["social","internet","web","network","social network","social-network","blog","short"],index:68,section:"Social"},youtube:{name:"youtube",tags:["social","internet","web","network","social network","social-network","blog","cinema","motion picture","cinematography","moving pictures","video"],index:69,section:"Social"}}}],o={svg:function(t,e){var i=Snap(e.node.firstElementChild),s=t.itemsDescription;t.data=i,t.list=i.children().filter(function(t){return"svg"===t.type}).map(function(t,e){var i=t.node.id,a=s[i]||{},n=a.name||i,o={id:i,name:n,searchArray:(a.tags||[]).concat(n).map(function(t){return t.toUpperCase()}),index:a.index||e,get dom(){return t.clone().remove()}};return a.hasOwnProperty("designation")&&Object.assign(o,a.designation),o})}};app.modules.add("sprites",function(t,e){return(a=t,new Promise(function(e,t){var i=n.find(function(t){return t.name===a});i?i.loaded?e(i):Snap.load(i.url+"?v="+app.version,function(t){i.loaded=!0,o[i.type](i,t),e(i)}):t("Сan not download the file!")})).then(function(t){return e?!0===e?t.list:t.list.find(function(t){return t.id===e}):t});var a})}(),function(t){var l=[{name:["default"],rules:{empty:!0}},{name:["company","userfile"],rules:{}},{name:["email","login"],rules:{empty:!0,regExp:/[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/},errorText:{regExp:"Please enter a valid email address"}},{name:["first_name","name","last_name"],rules:{empty:!0}},{name:["new_password","password"],rules:{empty:!0,minLength:6},errorText:{minLength:"Your password must be at least 6 characters long"}},{name:["repeat_new_password"],rules:{empty:!0,compare:"new_password"},errorText:{compare:"Your new password does not match your confirmation password"}},{name:["old_password"],rules:{empty:!0},errorText:{empty:"Please provide your current password."}}],d={empty:"You can’t leave this field empty",maxLength:"Too long",minLength:"Too short",regExp:"Not valid",compare:"Do not match"},h={empty:function(t){return null!=t&&("object"==typeof t?0<Object.keys(t).length:0<t.length)},maxLength:function(t,e){return t.length<e},minLength:function(t,e){return t.length>=e},regExp:function(t,e){return e.test(t)},compare:function(t,e,i){return t==i[e]}};app.modules.add("validation",function(){return function(s,r){var c={result:!0,reason:[]};for(var t in s)!function(t,e){var i=l.find(function(t){return-1<t.name.indexOf(e)})||!!r&&l.find(function(t){return-1<t.name.indexOf("default")}),a=!0,n=[];if(i)if(i.rules.empty&&!h.empty(t,!0))a=!1,n.push(i.errorText&&i.errorText.empty||d.empty);else for(var o in i.rules)h[o](t,i.rules[o],s)||(a=!1,n.push(i.errorText&&i.errorText[o]||d[o]||"Undefined error"));a||(c.result=!1,c.reason.push({name:e,text:n}))}(s[t],t);return c}.apply(this,argsToArray({arguments:arguments}))}),t.fn.validateForm=function(){}}(jQuery),function(){var o={size:function(t,e){return t.size<=e},type:function(t,e){return!(!t.type||!t.type.length)&&0<=e.indexOf(t.type)}};app.validateFile=function(t,e){var i=!0;if(t instanceof FileList){for(var a=0;a<t.length;a++)if(!app.validateFile(t[a],e)){i=!1;break}}else for(var n in e)if(o[n]&&!o[n](t,e[n])){i=!1;break}return i}}(),app.pages.add({name:"404",title:"Page not found",backstage:!0,auth:null,expired:null,urlMatch:/\/404($|\/$)/,get:function(){return flowmap},controller:function(t){var e=t&&"object"==typeof t?t.param:{};app.modules.get("header").render({navigation:{}});var i=app.modules.get("html",{name:"page",content:[{name:"container",param:{mod:["fill","flex","center"]},content:{param:{class:"page-not-found"},content:[{name:"heading",param:{mod:["light","big"],style:{"margin-bottom":"70px"}},content:e.title||"Page not found"},{param:{tag:"img",attr:{width:"736",height:"429",src:app.root+"/img/staff/404.png"}}},{name:"paragraph",param:{mod:["gray","center"],style:{"margin-top":"60px"}},content:["Visit the ",{name:"link",content:"homepage"}," or ",{name:"link",content:"contact us"}," about the problem"]}]}}]});return i.customScroll(),$(".content").insert(i),app.modules.get("html",{}),Promise.resolve()}}),function(){var o={init:function(t,e,i){var a=app.url().param;app.log(a),a.hasOwnProperty("tariff")&&a.hasOwnProperty("projects")&&a.hasOwnProperty("space")&&(app.log("here"),this.fit=a,this.fit.space*=1),this.header(),this.projectList.init(),this.filesList.init(),this.render(),this.renderHeading(),e()},header:function(){app.modules.get("header").render({navigation:{},main:{param:{title:"Manager"}}})},projectList:{init:function(){this.render(),this.bind()},bind:function(){this.subscriberKey=app.projects.subscriber("on",function(){this.render()}.bind(this))},set count(t){if(!equals(this.count,t)&&0<=t){this._count=t;var e=this.dom.find('[data-field="active"]');1==this.count?e.text(this.count+" active project now"):1<this.count?e.text(this.count+" active projects now"):e.text("No active projects now"),o.renderHeading()}},get count(){return this._count||0},render:function(){var t=this.table,i=app.modules.get("html"),a=this;t.html(""),this.count=0,app.projects.get().filter(function(t){return t.owner_id==User.id&&(this.count+=!t.archive,!0)},this).forEach(function(e){t.append(i({name:"row",content:[e.title,{name:"toggle",param:{checked:!e.archive,callback:function(t){t.state?(a.count++,app.serverRequest("unarchiveproject",{id:e.id})):(a.count--,app.serverRequest("archiveproject",{id:e.id}))}}}]}))},this)},get table(){return this.dom.find(".fm-table__content")},get dom(){return this._dom||(this._dom=app.modules.get("html",{name:"panel",param:{heading:$('<h4>Set active projects</h4> <p class="light" data-field="active" style="margin: 0 auto 0 15px"></p>'),mod:"stretch"},content:{name:"table",param:{mod:["striped","hover","stretch"],contentHeight:"100%",contentScroll:!0}}})),this._dom},die:function(){this.dom.find("[data-scroll]").baron().dispose(),this._count=0,this._dom=null,app.projects.subscriber("off",this.subscriberKey)}},filesList:{init:function(){app.log("manager"),this.list=this.controller();var e=this.dom.find(".fm-panel__content").loader();app.serverRequest("getMyFiles").then(function(t){var e=[];if(t.hasOwnProperty("na")&&e.push({title:"None project",description:"Unused files",files:t.na,id:"noneProject"}),t.hasOwnProperty("system")&&(t.system=(t.system.covers?t.system.covers.mapToArray(function(t){return t}):[]).concat(t.system.userpic||[]),t.system.length&&e.push({title:"System files",description:"Here are project covers and userpics. Deleting these files here will cause there deleting from your projects!",files:t.system,id:"system"})),t.hasOwnProperty("attaches")&&"object"==typeof t.attaches&&Object.keys(t.attaches).length)for(var i in t.attaches){var a=app.projects.get(i);a&&e.push({title:a.title,description:!1,files:t.attaches[i],id:i})}return e}).then(function(t){this.list.update(t),e.done()}.bind(this))},controller:function(t){var a=app.modules.get("html"),e=function(t){this.list={},app.log("manager"),this.define()};e.prototype={removeGroup:function(t){this.list.hasOwnProperty(t)&&(this.list[t].dom.remove(),delete this.list[t])},update:function(t){t.forEach(function(t){this.list[t.id]=new i(t,this)},this),this.view()},get:function(t){return void 0!==t?this.list[t]:this.list.mapToArray()},get sort(){return this._sort||{key:"time",drt:-1}},set sort(t){equals(t,this.sort)||(this._sort=t,this.view())},get orderList(){var i=this.sort;return this.get().sort(function(t,e){if(t=t[i.key],e=e[i.key],"string"==typeof t&&"string"==typeof e){if(t=t.toUpperCase(),e=e.toUpperCase(),!t.length&&!e.length)return 0;if(!t.length)return 1*i.drt;if(!e.length)return-1*i.drt}return e<t?1*i.drt:t<e?-1*i.drt:0})},view:function(){var e=0;this.orderList.forEach(function(t){t.dom.detach(),t.view(this.sort),this.table.append(t.dom),e+=t.size},this),this.updateHead(e),this.size=e},updateHead:function(t){this.size=t=t||this.get().reduce(function(t,e){return t+e.size},0),this.head.find(".js-size").text(t.fileSize(!0)),o.renderHeading()},updateSelect:function(){var t=this.get().reduce(function(t,e){return t+e.selectedlength},0);this.selectBar.find(".js-select .button__text").text("Delete "+t+" Selected"),this.selectBar.toggleClass("open",0<t)},define:function(){var e=this;this.dom=app.modules.get("html",{name:"panel",param:{heading:$("<h4>Manage files</h4>").add('<p class="light js-size" style="margin: 0 auto 0 15px"></p>').add(app.modules.get("html",{name:"input",param:{type:"select",name:"select",mod:["narrow","short","horizontal"],options:[{text:"Recent",value:"time,-1"},{text:"Alphanumeric",value:"name,1"},{text:"Size",value:"size,-1"},{text:"Extension",value:"extension,1"}],callback:function(t){t=t.value.split(","),e.sort={key:t[0],drt:1*t[1]}},label:"Sort by",value:e.sort.key+","+e.sort.drt,placeholder:"date_activity"}})),mod:"stretch"},content:{name:"table",param:{mod:["stretch"],contentHeight:"100%",contentScroll:!0}}}),this.dom.css({overflow:"hidden"}),this.table=this.dom.find(".fm-table__content"),this.head=this.dom.find(".fm-panel__heading"),this.selectBar=a({name:"panelSelectBar",content:{name:"buttonRow",content:[a({name:"button",param:{mod:"blue",text:"Delete selected",callback:function(){e.deleteSelected()}}}).addClass("js-select"),{name:"link",param:{callback:function(){e.get().forEach(function(t){t.selectFile(!1)})}},content:"Deselect"}]}}).insertAfter(this.head)},deleteSelected:function(){this.get().forEach(function(t){t.removeFile(t.selected)})},die:function(){this.dom.find("[data-scroll]").baron().dispose(),this.get().forEach(function(t){t.controller=null,t.get().forEach(function(t){t.group=null}),t.list=null}),this.list=null}};var i=function(t,e){this.controller=e,this.id=t.id,this.name=t.title,this.description=t.description||"",this.list={},t.files.forEach(function(t){this.list[t.id]=new n(t,this)},this)};i.prototype={get:function(t){return void 0!==t?this.list[t]:this.list.mapToArray()},get size(){return this.get().reduce(function(t,e){return t+e.size},0)},get time(){return Math.max.apply(window,this.get().map(function(t){return t.time}))},get sort(){return this._sort||{key:"time",drt:-1}},set sort(t){equals(t,this.sort)||(this._sort=t)},get spoiler(){return this._spoiler||!1},set spoiler(t){equals(t,this.spoiler)||(this._spoiler=t,this.head.find(".js-spoiler").toggleClass("active",t),this.table.css("display",t?"none":"block"))},removeFile:function(t){if(!(t=[].concat(t)).length)return!1;this.selectFile(!1,t),app.serverRequest("flowmapUnAttach",{file_id:t}),t.forEach(function(t){this.list.hasOwnProperty(t)&&(this.list[t].dom.remove(),delete this.list[t])},this),this.updateHead(),this.get().length||this.controller.removeGroup(this.id)},selectFile:function(e,t){if(!(t=void 0===t?this.get():[].concat(t).map(function(t){return this.get(t)},this)).length)return!1;t.forEach(function(t){t.select=e}),this.select=this.get().length==this.selectedlength,this.controller.updateSelect()},get selected(){return this.get().reduce(function(t,e){return e.select&&t.push(e.id),t},[])},get selectedlength(){return this.get().reduce(function(t,e){return t+e.select},0)},get select(){return this._select||!1},set select(t){equals(this.select,t)||(this._select=t,this.selectInput.prop("checked",t))},get head(){return this.dom.find(".fm-table__heading")},get selectInput(){return this.head.find('input[name="select"]')},get table(){return this.dom.find(".fm-table__content")},get dom(){if(!this._dom){var t=this,e={mod:["striped","hover"],heading:[[{name:"input",param:{mod:["checkbox","auto"],type:"checkbox",name:"select",checked:!1,callback:function(){t.selectFile(!t.select)}}},{param:{tag:"h4",style:{"margin-left":10}},content:this.name},{param:{class:"light js-size",tag:"p",style:{"margin-left":15}},content:"0kb"}],{name:"button",param:{mod:["round","border","narrow"],addClass:"js-spoiler",callback:function(){t.spoiler=!t.spoiler}},content:{name:"iconArrow"}}]};this.description&&(e.attrHeading={"data-description-red":this.description}),this._dom=a({name:"table",param:e})}return this._dom},get orderList(){var i=this.sort;return this.get().sort(function(t,e){if(t=t[i.key],e=e[i.key],"string"==typeof t&&"string"==typeof e){if(t=t.toUpperCase(),e=e.toUpperCase(),!t.length&&!e.length)return 0;if(!t.length)return 1*i.drt;if(!e.length)return-1*i.drt}return e<t?1*i.drt:t<e?-1*i.drt:0})},view:function(t){var e=this.table;t&&(this.sort=t),this.orderList.forEach(function(t){t.dom.detach(),e.append(t.dom)}),this.updateHead()},updateHead:function(){this.head.find(".js-size").text(this.size.fileSize(!0)),this.controller.updateHead()}};var n=function(t,e){this.id=t.id,this.size=1*t.size||0,this.name=t.origin_name||"Unnamed",this.link=t.filename,this.date=t.mtime,this.group=e,this.bind()};return n.prototype={get extension(){return this.name.split(".").last()},get normolizeName(){return 41<this.name.length?this.name.substring(0,31)+"..."+this.name.substring(this.name.length-6,this.name.length):this.name},get select(){return this._select||!1},set select(t){equals(this.select,t)||(this._select=t,this.dom.toggleClass("selected",t),this.selectInput.prop("checked",t))},bind:function(){this.dom.on("click",function(t){var e=$(t.target);e.is(":input")||e.is("a")||!t.shiftKey||this.group.selectFile(!this.select,this.id)}.bind(this))},get template(){var i=this;return a({name:"row",param:{mod:["nowrap"]},content:[a({name:"input",param:{mod:["checkbox","auto"],type:"checkbox",checked:!1,name:"select",callback:function(t,e){return e.preventDefault(),e.stopPropagation(),i.group.selectFile(!i.select,i.id),!1}}}).add(a({name:"fileExtension",param:{extension:i.extension}}).css("margin-left","20px")).add('<p class="strong" style="margin-left: 10px" title="'+i.name+'">'+i.normolizeName+"</p>").add('<p class="light" style="margin-left: 15px">'+i.size.fileSize(!0)+"</p>"),a({name:"buttonIcon",param:{name:"delete",callback:function(t){t.stopPropagation(),i.group.removeFile(i.id)}}}).addClass("js-delete").add(a({name:"link",param:{href:i.link},content:{name:"buttonIcon",param:{name:"download"}}}))]})},get selectInput(){return this.dom.find('input[name="select"]')},get dom(){return this._dom||(this._dom=this.template),this._dom}},new e(t)},get dom(){return this.list.dom},die:function(){this.list.die(),this.list=null}},render:function(){var t=app.modules.get("html");this.dom=t({name:"page",content:{name:"container",param:{mod:["flex","between","stretch","wrap"]},content:[{name:"col",param:{mod:"stretch"},content:this.projectList.dom},{name:"col",param:{mod:"stretch"},content:this.filesList.dom}]}}),this.fit&&(this.fit.footer=t({param:{class:"fm-manager__footer"},content:[{name:"button",param:{mod:"blue",text:"Continue",addClass:"js-continue",callback:function(){app.router("/updateplan")}}},{name:"button",param:{mod:["narrow","fake"],icon:"back",text:"Back to choose plan",callback:function(){app.router("/updateplan")}}}]}),this.dom.css("padding-bottom",100).children(".container").append(this.fit.footer)),$(".content").insert(this.dom)},renderHeading:function(){if(this.fit){var t=this.projectList.count>this.fit.projects,e="<b"+(t?' class="red" ':"")+">"+(this.projectList.count||"x")+" of "+this.fit.projects+"</b> active project",i=safetyObjectAccess(this,["filesList","list","size"],0),a=i>this.fit.space,n="<b"+(a?' class="red" ':"")+">"+i.fileSize(1)+" of "+this.fit.space.fileSize(1)+"</b> space";app.modules.get("header").update({main:{param:{title:"Manager",description:"To select <b>"+CFL(this.fit.tariff)+"</b> plan, please complete the following requirements —  "+e+" and "+n}}}),this.fit.footer&&this.fit.footer.find(".js-continue").toggleClass("disabled",t||a)}},die:function(){this.dom.remove(),this.projectList.die(),this.filesList.die()}};app.pages.add({name:"manger",title:"Manager",backstage:!0,auth:!0,expired:null,urlMatch:/\/manager(.+|)/,required:["modules/header"],die:function(){o.die()},controller:function(i){return new Promise(function(t,e){o.init(i,t,e)})}})}(),function(){var a,n=function(){};n.prototype={init:function(t,e,i){this.list=[],this.defineSettings(),this.header();var a=this.dom.loader("coverLight");this.updateLoop=timeLoop(function(){this.update().then(function(){a.done()})},6e3,this),e()},defineSettings:function(){this._sort={key:"fullName",drt:1}},get gridParams(){return{width:400,height:121,row:3}},get request(){return app.serverRequest("userlist")},update:function(){return Promise.all([app.serverRequest("userlist"),app.serverRequest("teamList")]).then(function(t){var a=t[0].map(function(t){return{accessibility:!0,active:!!(1*t.active),id:t.id,first_name:t.first_name,last_name:t.last_name,login:t.login,avatar:safetyObjectAccess(t,["img","filename"],!1),loginDate:t.last_enter_date,projects:app.projects.userIncludes(t.id).filter(function(t){return!t.archive&&t.accessibility}).length}}).concat({accessibility:!1,active:!0,id:User.id,first_name:User.first_name,last_name:User.last_name,loginDate:User.last_enter_date,login:User.login,avatar:User.avatar,projects:app.projects.getBy({archive:!1}).length}),e=t[1].map(function(t){var e=t.users.map(function(t){return t.user_id}),i=User.id===t.owner_id;return{id:t.id,title:t.title,accessibility:i,owner_id:t.owner_id,ability:i?["edit","leave"]:["edit"],list:a.filter(function(t){return e.includes(t.id)})}}).concat({id:"all",title:"All People",owner:!1,ability:["edit","delete"],list:a.slice()});this.users=a,this.list.forEach(function(t){t.markToDelete=!0}),e.forEach(function(e){var t=this.list.find(function(t){return t.id===e.id});t?t.update(e):(t=new i(e,this),this.list.push(t)),t.markToDelete=!1},this),this.view()}.bind(this))},getById:function(e){return this.list.find(function(t){return t.id==e})},add:function(t){this.list.forEach(function(t){t.markToDelete=!0}),[].concat(t).forEach(function(t){var e=this.getById(t.id);e?(e.update(t),e.markToDelete=!1):(t=new o(t,this),this.list.push(t),this.grid.append(t.dom))}.bind(this)),this.view()},get sort(){return this._sort||!1},set sort(t){equals(t,this.sort)||(this._sort=t,this.view())},get search(){return this._search||!1},set search(t){if(!equals(t,this.search)){var e=!!(this._search=t)&&new RegExp(this.search.split("").join(" ?"),"i");this.list.forEach(function(t){t.visibility=!e});var i=this.getById("all");i.search=!!e,i.visibility=!0,i.list.forEach(function(t){t.index(e)}),this.view()}},orderList:function(){this.sort;return this.list.sort(function(t,e){return(1*e.id||-1/0)-(1*t.id||-1/0)})},get itemListLength(){return this.list.reduce(function(t,e){return t+e.list.length},0)},view:function(){var i=0,a=[],n=0;this.orderList().forEach(function(t,e){n+=t.view(),t.markToDelete?(a.push(t),t.dom.transform({y:i,o:0,z:1,p:!1})):t.visibility?(t.dom.transform({y:i,z:e+2}),i+=t.height+60,0):t.dom.transform({y:i,z:1,o:0,p:!1})}),a.forEach(function(e){this.list.findAndRemove(function(t){return e.id===t.id}),setTimeout(function(){e.die()},150)},this),this.grid.css("height",i-60),0<n?this.emptyState=0:0<this.itemListLength?this.emptyState=2:this.emptyState=1},header:function(){var e=this;app.modules.get("header").render({navigation:{},main:{param:{title:"People"},content:[{name:"headerPanel",param:{mod:"right"},content:{name:"button",param:{mod:["blue","narrow"],icon:"plus",text:"Create New Team",callback:function(){var t=this.loader("button");app.teams.createTeam().then(function(){t.done()},function(){t.done()})}}}}]},tools:[{name:"headerPanel",content:[{name:"input",param:{mod:["narrow","shortest","horizontal","round"],name:"search",value:"",placeholder:"",icon:"search",callback:function(t){t.value=t.value.replace(/ /g,""),e.search=!!t.value.length&&t.value}}}]}]})},get grid(){return this.dom.find(".people__grid")},get dom(){return this._dom||(this._dom=app.modules.get("html",{name:"page",content:[{name:"container",content:[$('<div class="people__grid"></div>')]}]}),this.dom.customScroll(),$(".content").insert(this.dom)),this._dom},get emptyState(){return this._emptyState||0},set emptyState(t){if(!equals(this.emptyState,t)){if(this._emptyState=t,this.placeholder){var e=this.placeholder;e.removeClass("open"),setTimeout(function(){e.remove()},150),this.placeholder=null}switch(t){case 1:this.placeholder=app.modules.get("html",{name:"emptyPlaceholder",param:{template:"peopleEmpty",mod:"absolute"}}).appendTo(this.grid),setTimeout(function(){this.placeholder.addClass("open")}.bind(this),20);break;case 2:this.placeholder=app.modules.get("html",{name:"emptyPlaceholder",param:{template:"peopleNotFound",mod:"absolute"}}).appendTo(this.grid),setTimeout(function(){this.placeholder.addClass("open")}.bind(this),20)}}},die:function(){this.list.forEach(function(t){t.controller=null}),this.list.length=0,clearInterval(this.updateLoop)}};var i=function(t,e){this.list=[],this.visibility=!0,this.controller=e,this.update(t),"all"!==this.id&&this.accessibility&&this.list.push(s(this))};i.prototype={get title(){return this._title||!1},set title(t){equals(this.title,t)||(this._title=t)},get height(){return this._height||0},set height(t){equals(t,this.height)||(this._height=t,this.dom.css("height",t))},addUsers:function(){app.modules.get("modalTemplates","invitePeople",!1,{request:!1,limit:"TeamPlan"===User.tarifName,limitMax:5,list:this.controller.users.map(function(e){return{id:e.id,email:e.login,avatar:e.avatar,invited:!e.active,name:User.fullName.call(e),lock:this.owner_id===e.id?"admin":e.id===User.id&&"you",state:!!this.list.find(function(t){return e.id===t.id})}},this)}).then(function(t){if(t){t.forEach(function(t){t.hasOwnProperty("user")&&(t.id=t.user,delete t.user)});var e={team_id:this.id,dismiss:"false",users:t};app.serverRequest("switchUser",e).then(function(t){t.status?this.controller.update():app.teams.generateError(t.message)}.bind(this))}}.bind(this))},orderList:function(){return this.search?(this.list.forEach(function(t){t.visibility=-1<t.searchIndex}),this.list.sort(function(t,e){return t.searchIndex-e.searchIndex})):(this.list.forEach(function(t){t.visibility=!0}),this.list.sort(function(t,e){return t.sortable?e.sortable?t.owner?-1:e.owner?1:t.fullName===e.fullName?1*t.id-1*e.id:t.fullName?e.fullName?t.fullName>e.fullName?1:t.fullName<e.fullName?-1:0:-1:1:-1:1}))},view:function(){var a=0,n=this.controller.gridParams,o=[];return this.orderList().forEach(function(t){var e=a%n.row,i=Math.floor(a/n.row);t.markToDelete?(o.push(t),t.dom.transform({x:e*n.width,y:i*n.height,z:1,o:0,p:!1})):t.visibility?(t.dom.transform({x:e*n.width,y:i*n.height,o:t.active?1:.7,z:a+2}),a++):t.dom.transform({x:e*n.width,y:i*n.height,z:1,o:0,p:!1})}),o.forEach(function(e){this.list.findAndRemove(function(t){return e.id===t.id}),setTimeout(function(){e.die()},150)},this),this.height=Math.ceil(a/3)*n.height+61,a},update:function(t){this.id=t.id,this.owner_id=t.owner_id,this.accessibility=t.accessibility,this.ability=t.ability,this.title=t.title;var e=t.list;"all"===this.id&&e.findAndRemove(function(t){return t.id===User.id}),this.list.forEach(function(t){t.markToDelete=!0}),e.forEach(function(e){e.owner=e.id===this.owner_id;var t=this.list.find(function(t){return t.id===e.id});t?t.update(e):(t=new o(e,this),this.list.push(t)),t.markToDelete=!1},this)},showRemoveState:function(){this.dom.find(".people__wrap").addClass("disabled"),this.dom.loader("coverLight")},die:function(){this.dom.remove(),this.list.forEach(function(t){t.die()}),this.list.length=0,this.controller=null},get template(){var i=this;return app.modules.get("html",{param:{class:"people__section"},content:[{param:{class:"people__title"},content:[{name:"input",param:{mod:["transperant","biggest","bold","autowidth"],type:"autowidth",attr:{disabled:!this.accessibility,readonly:!0},value:this.title,events:"change",callback:function(t){var e=t.value;$(this).attr("readonly",!0),equals(i.title,e)||app.serverRequest("setTeam",{id:i.id,title:e})},bind:[{event:"click",callback:function(){var t=$(this);!t.attr("disabled")&&t.attr("readonly")&&(t.attr("readonly",!1),t.inputFocus(!0))}},{event:"blur",callback:function(){$(this).attr("readonly",!0)}}]}},"all"!==this.id?{name:"menu",param:{settings:{get mouseleave(){return i.dom},mouseleaveDelay:150},options:this.accessibility?[{name:"Manage Team",value:"edit"},{name:"Rename Team",value:"rename"},{name:"Delete Team",value:"delete"}]:[{name:"Leave Team",value:"leave"}],callback:function(t){"edit"===t?this.addUsers():"rename"===t?this.dom.find(".people__title input").attr("readonly",!1).inputFocus(!0):"leave"===t?app.modules.get("alert",{heading:"Leave this team?",type:"alert",content:"By leaving this Team, you will also be removed from all Team projects.",buttons:["Leave Team","Cancel"]},function(t){!0===t&&(this.showRemoveState(),app.serverRequest("leaveTeam",{id:this.id}).catch(function(){console.log("LeaveTeam request: Internal server Error or Answer is empty")}))}.bind(this)):"delete"===t&&app.modules.get("alert",{heading:"Delete Team",type:"alert",content:"Are you sure you wish to delete this team? By delete the Team, you will delete all users from all team projects.",buttons:["Yes, Delete this Team","Cancel"]},function(t){!0===t&&(i.showRemoveState(),app.serverRequest("removeTeam",{id:i.id}).catch(app.error))})}.bind(this)}}:""]},{param:{class:"people__wrap"}}]})},get grid(){return this._grid||(this._grid=this.dom.find(".people__wrap")),this._grid},get dom(){return this._dom||(this._dom=this.template.appendTo(this.controller.grid)),this._dom}};var o=function(t,e){this.controller=e,this.searchIndex=-1,this.sortable=!0,this.data={},this.update(t),this.bind()};o.prototype={update:function(t){this.data=Object.assign(this.data,t),this.avatar=t.avatar,this.login=t.login,this.projects=t.projects,this.loginDate=t.loginDate,this.searchIndex<0&&this.dom.find('[data-field="fullname"]').html(this.fullNameComposite()),this.loader&&(this.loader.done(),this.loader=null)},get id(){return this.data.id},get active(){return this.data.active||!1},get owner(){return this.data.owner},get login(){return this.data.login||""},set login(t){equals(t,this._login)||(this._login=t,this.data.login=t,this.dom.find('[data-field="login"]').html(t))},get loginDate(){return this.data.loginDate||0},set loginDate(t){this.data.loginDate=t,this.dom.find('[data-field="date"]').html(this.loginDate?"Last login date "+formatDate(this.loginDate,"M dd.yyyy"):"")},get first_name(){return this.data.first_name||""},get last_name(){return this.data.last_name||""},get fullName(){var t="";return this.first_name.length&&(t+=this.first_name),this.last_name.length&&(t.length&&(t+=" "),t+=this.last_name),t},fullNameComposite:function(t){var e=t||this.fullName;return this.active||(e='<span class="label">Invited</span> '+e),this.id===User.id&&(e+=' <span class="strong extra">(You)</span>'),this.data.owner&&(e+=' <span class="label">Admin</span>'),e},get avatar(){return this.data.avatar||!1},set avatar(t){equals(t,this._avatar)||(this._avatar=t,(this.data.avatar=t)?this.dom.find('[data-field="avatar"]').setBackground(t):this.dom.find('[data-field="avatar"]').css("background-image",""))},activeProjectsWord:function(t){return 0<t?"You collaborate in "+t+" project"+(1<t?"s":""):"You don’t collaborate yet"},get projects(){return this.data.projects||0},set projects(t){equals(t,this._projects)||(this._projects=t,this.dom.find('[data-field="projects"]').html(this.activeProjectsWord(t)))},index:function(t){var e=this.dom.find('[data-field="fullname"]'),i=this.dom.find('[data-field="login"]');if(t){var a=t?this.fullName.search(t):-1,n=t?this.login.search(t):-1;return-1<a?e.html(this.fullNameComposite(this.fullName.replace(t,'<span class="matched">$&</span>'))):e.html(this.fullNameComposite()),-1<n?i.html(this.login.replace(t,'<span class="matched">$&</span>')):i.html(this.login),this.searchIndex=a+n+2==0?-1:-1<a&&-1<n?Math.min(a,n):Math.max(a,n),this.searchIndex}e.html(this.fullNameComposite()),i.html(this.login),this.searchIndex=-1},die:function(){this.controller=null,this.dom.remove()},get template(){var t,e={fake:{param:{class:"people__button people__button--fake"}},edit:{param:{class:"people__button  js-edit",attr:{title:"edit collaborator's projects"}},content:{name:"icon",param:{name:"edit"}}},delete:{param:{class:"people__button  js-delete",attr:{title:"remove collaborator"}},content:{name:"icon",param:{name:"delete"}}},leave:{param:{class:"people__button  js-leave",attr:{title:"remove collaborator"}},content:{name:"icon",param:{name:"leave"}}}};if(this.id===User.id||this.owner)t=["fake","fake","fake"];else for(var i=(t=this.controller.ability).length;i<3;i++)t.unshift("fake");return app.modules.get("html",{param:{class:"people__item"},content:[{param:{class:"people__avatar",attr:{"data-field":"avatar"}}},{param:{class:"people__info"},content:[{param:{tag:"h4",class:"people__name",attr:{"data-field":"fullname"}}},{param:{tag:"p",attr:{"data-field":"login"}}},{param:{class:"people__date",attr:{"data-field":"date"}},content:this.loginDate?"Last login date "+formatDate(this.loginDate,"M dd.yyyy"):""},{param:{tag:"p",class:"people__projects",attr:{"data-field":"projects"}}}]},{param:{class:"people__buttons"},content:t.map(function(t){return e.hasOwnProperty(t)?e[t]:""})}]})},get dom(){return this._dom||(this._dom=this.template.appendTo(this.controller.grid)),this._dom},bind:function(){var e=this;this.dom.on("click",".js-edit",function(){app.modules.get("modalTemplates","switchProjects",e.id).then(function(t){t.length&&(e.loader=e.dom.loader("cover"),app.serverRequest("switchmembers",{members:t}))},function(t){app.log(t)})}).on("click",".js-delete",function(){app.modules.get("alert",{heading:"Remove Collaborator",type:"alert",content:"You are about to remove this collaborator. Removing the collaborator, you will no longer see this in the list of collaborator.",buttons:["Remove Collaborator","Cancel"]},function(t){t&&(e.dom.loader("cover"),app.serverRequest("removeMember",{user:e.id}).then(function(){e.controller.update()}))})}).on("click",".js-leave",function(){app.modules.get("modalTemplates","removeMember").then(function(t){t&&t.result&&(e.dom.loader("cover"),app.serverRequest("switchUser",Object.assign({team_id:e.controller.id,users:[{id:e.id,state:!1}]},t.data)).then(app.log))})})}};var s=function(t){var e=app.modules.get("html",{param:{class:"people__item people__item--creator"},content:[{name:"button",param:{mod:["doted","round","narrow","coverage"],icon:"plus"}},{param:{tag:"h4",style:{"margin-left":"19px"}},content:"Add People To Team"}]});return e.appendTo(t.grid).on("hover",function(){$(this).find("button").addClass("hover")},function(){$(this).find("button").removeClass("hover")}).on("click",function(){t.addUsers()}),{get markToDelete(){return!1},set markToDelete(t){},get visibility(){return!0},set visibility(t){},index:function(){return this.searchIndex=9999999999,this.searchIndex},die:function(){e.remove()},sortable:!1,dom:e}};app.pages.add({name:"people",title:"People",backstage:!0,auth:!0,expired:null,urlMatch:/\/people(.+|)/,required:["modules/header","modules/selectbar"],die:function(){a&&(a.die(),a=null)},controller:function(i){return new Promise(function(t,e){(a=new n).init(i,t,e)})}})}(),function(){var a,t=[function(){var t=app.modules.get("html"),e=t({name:"userAvatar",param:{value:User.avatar,callback:function(t){User.avatar=t,$("header.header").find(".header__avatar").setBackground(t),app.modules.get("notify",{mod:"green",content:"Your profile has been updated!"})}}}),i=t({name:"buttonRow",content:[{name:"button",param:{mod:"blue",text:"Save Changes",attr:{type:"submit"}}},{name:"link",content:"cancel",param:{attr:{type:"reset"}}},{name:"button",param:{mod:["white","auto"],style:{"margin-left":"auto"},text:"Delete My Account",callback:function(){User.remove()}}}]}),a=t({name:"col",content:[{name:"panel",param:{heading:"Basic Info"},content:[{name:"board",content:[e,t({name:"form",param:{validateStrict:!1,validateMod:"change",validation:function(t){return app.modules.get("validation",t)},callback:function(i){return new Promise(function(e,t){app.serverRequest("userUpdate",i).then(function(t){t.status?(User.update(i),$("header.header").find(".userboard__name").text(User.anyDefinition),app.modules.get("notify",{mod:"green",content:"Your profile has been updated!"})):app.modules.get("notify",{mod:"red",content:"Please revalidate fields"}),e(t)}).catch(function(){e(!0)})})},actions:i},content:[{name:"input",param:{name:"first_name",type:"text",mod:"required",value:vts(User.first_name),data:{value:vts(User.first_name)},label:"First Name",placeholder:"First Name"}},{name:"input",param:{name:"last_name",type:"text",mod:"required",value:vts(User.last_name),data:{value:vts(User.last_name)},label:"Last Name",placeholder:"Last Name"}},{name:"input",param:{name:"login",type:"text",mod:"required",value:vts(User.login),data:{value:vts(User.login)},label:"E-mail",placeholder:"E-mail"}},{name:"input",param:{name:"company",type:"text",value:vts(User.company),data:{value:vts(User.company)},label:"Company",placeholder:"Company"}},{name:"input",param:{name:"country",type:"select",settings:{options:app.serverRequest("countryList").then(function(t){return t.map(function(t){return{value:t.id,text:t.name}})}),scroll:!0,search:!0,height:300,placeholder:"Select country",value:safetyObjectAccess(User,["country","id"],!1)},value:safetyObjectAccess(User,["country","id"],!1),label:"Country",data:{label:"Country"},placeholder:"Country"}},{name:"input",param:{name:"city",type:"text",value:vts(User.city),data:{value:vts(User.city)},label:"City",placeholder:"City"}}]}),i]}]}]}),n=t({name:"buttonRow",content:[{name:"button",param:{mod:"blue",text:"Save Changes",attr:{type:"submit"}}},{name:"link",content:"cancel",param:{attr:{type:"reset"}}}]}),o=t({name:"col",content:[{name:"panel",param:{heading:"Password"},content:[{name:"board",content:[{name:"form",param:{validation:function(t){return app.modules.get("validation",t)},callback:function(i){return new Promise(function(e,t){app.serverRequest("setPassword",i).then(function(t){t.status?app.modules.get("notify",{mod:"green",content:"Your profile has been updated!"}):app.modules.get("notify",{mod:"red",content:"Please revalidate fields"}),e(t)}).catch(function(){e(!0)})})},actions:n},content:[{name:"input",param:{name:"old_password",type:"password",value:"",label:"Current Password",placeholder:"Current Password"}},{name:"input",param:{name:"new_password",type:"password",value:"",label:"New Password",placeholder:"New password"}},{name:"input",param:{name:"repeat_new_password",type:"password",value:"",label:"Confirm New Password",placeholder:"Confirm New Password"}}]},n]}]}]});this.container.addPage({anchor:"profile"},t({name:"container",param:{mod:["flex","between","top"]},content:[a,o]}))},function(){var a=app.modules.get("html"),n=a({name:"userBilling"}),o=a({name:"table",param:{mod:["striped","left"],heading:["Date","Plan","Amount",""],contentHeight:"460px",contentScroll:!0}});this.container.addPage({anchor:"billing"},a({name:"container",param:{mod:["flex","between","top"]},content:[{name:"col",content:{name:"panel",param:{heading:"Your Plan"},content:{name:"board",content:[n,{name:"buttonRow",content:{name:"button",param:{mod:"blue",text:"Change plan",callback:function(){app.router("/updateplan")}}}}]}}},{name:"col",content:{name:"panel",param:{heading:"Invoice"},content:o}}]}));var s=n.loader("blockLight");this.data.then(function(t){var e="No available data";t=t.billing||{},n.find('[data-field="tarif"]').text(t.tarif_title.replace("FlowMapp: ","")||e),n.find('[data-field="projects"]').text(vts([t.total_projects,t.max_projects],function(){return t.total_projects+" of "+("inf"==t.max_projects?"Unlimited":t.max_projects)+" Active projects"})||e),n.find('[data-field="file"]').text(vts([t.disc_usage,t.disc_quota],function(){return t.disc_usage.fileSize(1)+" of "+t.disc_quota.fileSize(1)})||e),s.done();var i=n.find('[data-field="img"]');t.img&&(s=i.loader("cover"),app.img(t.img).then(function(){i.css("background-image","url("+t.img+")"),s.done()}))}),o.css("height","357px");var t=a({name:"emptyPlaceholder",param:{mod:["absolute","white","open"],template:"invoiceLoad",callback:function(){var e=o.loader("blockLight",{fastInject:!0});t.remove(),app.serverRequest("getOrders").then(function(t){if(Array.isArray(t)&&t.length){var i=o.find(".fm-table__content");t.forEach(function(t){var e=currencySymbol(t.currency)+t.totalInPayoutCurrency;i.append(a({name:"row",content:[formatDate(t.changed,"M d,yyyy"),Array.isArray(t.items)&&t.items.length?t.items.map(function(t){return t.display}).join(", "):"Unknown",0<t.totalInPayoutCurrency?e:'<p class="green">'+e+"</p>",'<a class="link" href="'+t.invoiceUrl+'/pdf" target="_blank">Download PDF</a>']}))})}else o.append(a({name:"emptyPlaceholder",param:{template:"historyEmpty",mod:["absolute","open","little","white"]}}));o.css("height",""),e.done()})}}});o.append(t)},function(){var t=app.modules.get("html"),e=t({name:"board",content:[{name:"input",param:{mod:["checkbox","auto","strong"],type:"checkbox",label:"",description:t([{param:{tag:"b"},content:"Subscribe me to emails from FlowMapp"}," (including promotional offers and updates). Collected information will not be shared with any third party and complies with our stated ",{name:"link",param:{href:"//flowmapp.com/privacy/",target:"_blank"},content:"Privacy Policy"}]),value:"true",checked:!1,name:"notifications",callback:function(t,e){e.stopPropagation(),app.serverRequest("setUserEmailNotifications",{notifications:t.state}).then(function(t){app.log(t),app.modules.get("notify",{mod:"green",content:"Your profile has been updated!"})})}}},{name:"input",param:{mod:["radio","auto"],type:"radio",label:"Standard",description:"You'll get an email whenever someone @mentions you or assigns you to a project. You'll also be notified about all new comments on items that you're subscribed to.",value:"S",checked:!1,name:"notification_mod"}},{name:"input",param:{mod:["radio","auto"],type:"radio",label:"Minimum",description:"You'll only get an email when someone @mentions you or assigns you to a project - but not about new comments.",value:"M",checked:!1,name:"notification_mod"}},{name:"input",param:{mod:["radio","auto"],type:"radio",label:"Off",description:"You won't get any notification emails about your projects, but you'll still be able to see updates on the \"Activity\" modal.",value:"false",checked:!1,name:"notification_mod"}}]});e.on("change",function(){app.serverRequest("setNotificationMod",e.serializeJson()).then(function(){app.modules.get("notify",{mod:"green",content:"Notifications settings has been updated!"})})});var n=t({name:"table",param:{mod:["striped"],contentHeight:"460px",contentScroll:!0}});n.on("change","input",function(){var t=$(this),e=t.val(),i=t.prop("checked");setTimeout(function(){i==t.prop("checked")&&app.serverRequest("setProjectNotice",{projectID:e,state:i}).then(function(){app.modules.get("notify",{mod:"green",content:"Notifications settings has been updated!"})})},500)}),this.container.addPage({anchor:"notifications"},t({name:"container",param:{mod:["flex","between","top"]},content:[{name:"col",content:[{name:"panel",param:{heading:"Projects"},content:[n]},{param:{style:{display:"none",width:"100%",height:"50px","border-radius":"3px",margin:"20px 0 0",padding:"0 20px","justify-content":"space-between","align-items":"center",background:"rgba(253,103,100,0.15)"},call:{fn:function(){app.serverRequest("slackIntegrationTest").then(function(t){t.status&&this.css("display","flex")}.bind(this))}}},content:[{name:"paragraph",param:{mod:"strong"},content:"Stop sending FlowMapp notifications to Slack"},{name:"button",param:{mod:["narrow","red"],text:"Delete",callback:function(){app.modules.get("alert",{type:"alert",heading:"Remove Slack integration?",content:"Would you like to clear your personal settings (e.g. authorizations) for this Integration? \nAll Channels with Slack notifications will be disconnected.",buttons:["Yes, remove integration with Slack","Cancel"]},function(t){!0===t&&app.serverRequest("slackRemoveAuth").then(location.reload.bind(location))})}}}]}]},{name:"col",content:[{name:"panel",param:{heading:"Frequency of notifications"},content:[e]}]}]}));var o=e.loader("blockLight"),s=n.loader("blockLight"),r=function(e){app.modules.get("modalTemplates","slackNotificationSettings",e).then(function(t){t&&($('[data-slack-id="'+e.id+'"]').toggleClass("active",t.state),app.serverRequest("slackSettings",t).then(function(t){app.modules.get("notify",{mod:"green",content:"Slack notifications settings has been updated!"})}))},app.errorTracker)},c=function(i){var a=function(t){"string"==typeof t?app.modules.get("notify",{mod:"red",content:"Error: "+t}):app.modules.get("notify",{mod:"red",content:"Error: Couldn't connect with Slack servers!"})},n=app.serverRequest("slackTeams").then(function(t){return t.length});app.modules.get("alert",{mod:"blue",icon:"slack_hover",heading:"Send Activity to Slack",content:"Connect your Slack account with FlowMapp to send activity updates for this project to a selected Slack channel.",buttons:["Connect to Slack","Cancel"],wfc:!0},function(t,e){!0===t?n.then(function(t){t?(e(),r(i)):app.serverRequest("slackAuth",i||{}).then(function(t){!0===t.ok?t.hasOwnProperty("auth_url")?location=t.auth_url:i?r(i):app.modules.get("notify",{mod:"blue",content:"You account already connected with slack! Click here to see more info!",callback:function(){alert("link to slack help")}}):a(),e()},function(){e(),a()})}):e()})},i=safetyObjectAccess(app.url.get(),["param","auth"],!1);i&&("slack"===i&&c(),app.url.removeParam("auth"));var a=safetyObjectAccess(app.url.get(),["param","slack"],!1);a&&(app.url.set({param:{slack:!1}},!0),r({id:a}),app.url.removeParam("slack")),safetyObjectAccess(app.url.get(),["param","slack_auth"],!1)&&("true"===safetyObjectAccess(app.url.get(),["param","slack_auth"],!1)&&app.modules.get("alert",{heading:"Congratulations!",content:'You have successfully connected your account with the slack!<br>Now you can configure notifications for each project!<br>More in detail about it you can read in our <a class="link" href="https://flowmapp.com/help/integration-with-slack/">help center</a>.',buttons:["Nice!"]},function(t){}),app.url.removeParam("slack_auth")),this.data.then(function(t){t=t.notifications,e.find('input[value="'+t.frequency+'"]').prop("checked",!0),e.find('input[name="notifications"]').prop("checked",!!t.notifications),o.done();var i=n.find(".fm-table__content"),a=app.modules.get("html");"object"==typeof t.projects?Array.isArray(t.projects)||(t.projects=t.projects.mapToArray()):t.projects=[],t.projects.length?t.projects.forEach(function(e){i.append(a({name:"row",content:[e.title,[{name:"toggle",param:{name:"notify",value:e.id,checked:e.notify}},{name:"compositeIcon",param:{fixed:!safetyObjectAccess(app.projects.get(e.id),["accessibility"],!1),normal:"slack_normal",active:"slack_hover",state:!!safetyObjectAccess(app.projects.get(e.id),["services","Slack"],!1),alt:"Send Activity to Slack",attr:{"data-slack-id":e.id},style:{padding:"5px","margin-left":"15px",cursor:"pointer",opacity:1*safetyObjectAccess(app.projects.get(e.id),["accessibility"],!1)},callback:function(){var t=[1,16677].includes(1*User.id);User.tarif&&"free"!==User.tarif||t?this.hasClass("active")?r({id:e.id}):c({id:e.id}):app.modules.get("modalTemplates","upgradeSubscriptionModal","slack")}}}]]}))}):i.append(a({name:"emptyPlaceholder",param:{template:"projectsEmptyNoAction",mod:["absolute","open","little"]}})),s.done()})},function(){var d=app.modules.get("html"),h=this,i={},t=[{name:"systemLabels",title:"System Label",icon:"labels",render:function(){var a=d({param:{class:"fm-label-create__container"}}),t=d({name:"scroller",param:{scrollbar:!0,mod:["curtain","nox","absolute"]},content:a}),n=d({param:{class:"fm-label-create"},content:t}),o=n.loader("blockLight");return h.data.then(function(r){var c=r.settings.labels.filter(function(t){return!t.project_id}),e=function(i,t){var e,a=!1,n=function(t){a=t,s.toggleClass("fm-label-create__item--edit",t),a?e=s.clickOutside(function(){a&&o()}):e&&(e(),e=null)},o=function(){var e=s.serializeJson();if(!e.title.replace(/ /g,"").length)return!1;(i.id?Promise.resolve(!0):app.serverRequest("addLabel").then(function(t){e.id=t,r.settings.labels.push(e),c.push(e)})).then(function(){Object.assign(i,e),app.serverRequest("updateLabel",{id:i.id,color:i.color,title:i.title}),l()}),n(!1)},s=d({param:{class:"fm-label-create__item"},content:[{param:{class:"fm-label-create__action"},content:{name:"buttonRow",content:[{name:"button",param:{mod:["blue","narrow","auto"],text:"Save",callback:function(){o()}}},{name:"link",param:{attr:{type:"reset"},callback:function(){s.find('input[name="title"]').val(i.title).blur(),s.find("fm-label-create__color").css("background",i.color).val(i.color),n(!1),i.id||(s.remove(),l())}},content:"cancel"}]}},{param:{class:"fm-label-create__form"},content:[{name:"input",param:{name:"title",bind:{focus:function(){n(!0)}},value:i.title}},{param:{class:"fm-label-create__color",style:{background:i.color},callback:function(){n(!0),app.colorList($(this),{direction:{horizontal:"left",vertical:"auto"},offset:{x:-34,y:5},value:i.color,callback:{input:function(t){$(this).css("background",t)}.bind(this),change:function(t){h.data.color=t,$(this).css("background",t).find("input").val(t).trigger("change")}.bind(this)}})}},content:{name:"input",param:{name:"color",type:"hidden",value:i.color}}},{name:"buttonIcon",param:{name:"delete",callback:function(){s.remove(),i.id&&(r.settings.labels.findAndRemove(function(t){return t.id===i.id}),c.findAndRemove(function(t){return t.id===i.id}),app.serverRequest("removeLabel",{id:i.id})),l()}}}]}]});return setTimeout(function(){t&&n(!0)},10),s},i=d({name:"emptyPlaceholder",param:{callback:function(t){"create"===t&&(n.find(".fm-flowmap-addpagestructure").before(e({color:"#"+Math.random().toString(16).slice(2,8),title:"New Label"},!0)),l(!1))},template:"labelsListEmpty",mod:["absolute","white"]}}).appendTo(a),l=function(t){void 0===t&&(t=!c.length),i.toggleClass("open",t)};c.forEach(function(t){a.append(e(t))}),a.append(d({param:{class:"fm-flowmap-addpagestructure",style:{height:"30px",padding:"0 0 0 10px",margin:"10px 0 0 0"},callback:function(){$(this).before(e({color:"#"+Math.random().toString(16).slice(2,8),title:"New Label"},!0)),l(!1)}},content:[{param:{class:"fm-flowmap-addpagestructure__button"}},{param:{class:"fm-flowmap-addpagestructure__text"},content:"Add new Label"}]})),o.done(),l()}),n}},{name:"backups",icon:"backup",title:"Project's Backups",render:function(){var t=d({name:"scroller",param:{baron:{mod:"ease"}}}),n=t.find(".scroller"),o=($(this),function(){var e=t.loader("blockLight"),a=function(){var t=this.files[0];t&&"fmb"===t.name.split(".").pop()&&app.backup.upload(t)};i.backup||(i.backup=app.backup.list(!0)),i.backup.then(function(t){var i={};(t=t.reduce(function(t,e){return e.project_id&&(i.hasOwnProperty(e.project_id)?i[e.project_id].date<e.date&&(i[e.project_id].date=e.date,i[e.project_id].title=e.project_name):(i[e.project_id]={mod:"group",date:e.date_create,title:safetyObjectAccess(app.projects.get(e.project_id),["title"],e.project_name),content:[]},t.push(i[e.project_id])),i[e.project_id].content.push(e)),t},[])).length?n.insert(d([{name:"button",param:{mod:["tablerow"],tag:"div",icon:"upload",text:"Upload Backup"},content:{param:{tag:"input",attr:{type:"file",accept:".fmb"},event:"change",callback:a}}}].concat(t.map(function(t){return{name:"spoiler",param:{header:[{name:"paragraph",param:{mod:["bold","uppercase","nowrap"],style:{"letter-spacing":.8,"max-width":"380px"}},content:t.title},{name:"paragraph",param:{mod:["light","gray"],style:{margin:"0 0 0 15px"}},content:t.content.length+LangHelp.plural.eng(" Backup",t.content.length)}],mod:"tablelight",hideline:!0,state:!1},content:{name:"backupList",param:{list:t.content,callback:function(t,e,n){switch(t){case"restore":app.backup.restore(e).then(function(){popover.fixed(!1)});break;case"remove":app.backup.remove(e).then(function(t){if(popover.fixed(!1),t){var e=n.closest(".fm-spoiler"),i=e.find(".fm-table__row").length-1;if(i)e.find(".fm-spoiler__header .fm-paragraph.fm-paragraph--light.fm-paragraph--gray").text(i+LangHelp.plural.eng(" Backup",i)),n.remove();else{var a=e.closest(".popover").find(".fm-spoiler").length-1;e.remove(),a||o()}}})}}}}}})))):n.insert(d({name:"emptyPlaceholder",param:{template:"projectListBackupEmpty",active:!0,mod:["absolute","center","nopadding"],event:"change",callback:function(t,e){"upload"===t&&a.call($(e).find("input").get(0))}}})),e.done()}).catch(console.log)});return o(),t}},{name:"covers",icon:"covers",title:"Custom Page Covers",render:function(){var r={init:function(){this.mod="list",this.list=[];var e=this.dom.loader("blockLight");app.pageCovers.getPacks().then(function(t){this.list=t.filter(function(t){return"default"!==t.id}).map(function(t){return this.pack(t,this)},this),this.render(),e.done()}.bind(this)).catch(console.log)},emptyState:function(t){void 0===t&&(t=!this.list.length),this.emptyDom.toggleClass("open",t)},createNewPack:function(){app.pageCovers.createPack().then(function(t){if(t.status){var e=this.dom.find(".fm-pagecovers-create__creator").closest(".fm-table__row"),i=this.pack(t.pack,this);this.list.push(i),e.before(i.render()),i.dom.trigger("spoiler-open"),this.emptyState()}}.bind(this))},render:function(){var t=this;this.list.forEach(function(t){this.container.append(t.render())},this),this.container.append(d({name:"row",param:{style:{"margin-top":"10px"},mod:"pointer",callback:function(){t.createNewPack()}},content:[[{name:"rowIcon",param:{name:"plus",style:{"margin-right":10}}},{param:{class:"fm-pagecovers-create__creator"},content:"Add New Cover Set"}]]})),this.emptyState()},updateSelectState:function(){var i=0,t=this.list.reduce(function(t,e){return i+=e.selectState,t+e.selectedLength},0),e=0<t+i;this.selectBar.toggleClass("open",e),this.selectBar.find(".button .button__text").text("Delete selected: "+(i?LangHelp.plural.eng("Pack",i,!0)+" and ":"")+LangHelp.plural.eng("Cover",t,!0)),this.dom.find(".fm-pagecovers-create__container").css("padding",e?"0 0 100px":"")},removeSelected:function(){var i=[],a=[],n=0,t=this.list.reduce(function(t,e){return n+=e.selectState,t+e.selectedLength},0);this.list.forEach(function(t){if(t.selectState)i.push(t);else{var e=t.list.reduce(function(t,e){return e.selectState&&t.push(e.id),t},[]);e.length&&a.push({pack:t,list:e})}}),app.modules.get("alert",{type:"alert",heading:"Delete Selected?",content:"Are you sure to delete "+(n?LangHelp.plural.eng("Pack",n,!0)+" and ":"")+LangHelp.plural.eng("Cover",t,!0)+"? This action will delete everything without the possibility of recovery.",buttons:["Delete Selected","Cancel"]},function(t){t&&(i.forEach(function(t){t.deletePack()}),a.forEach(function(t){t.pack.deleteCovers(t.list)}),this.updateSelectState())}.bind(this)),this.emptyState()},cover:function(t,e){return{id:t.id,file_id:t.file_id,title:t.title,index:t.index,link:t.link,tags:t.tags.slice(0),pack:e,editState:!1,edit:function(t){if(!equals(t,this.editState)){this.editState=t;var e=this.dom.find(".fm-pagecovers-create__title"),i=e.find("input"),a=this.dom.find(".fm-pagecovers-create__placeholder"),n=i.val();t?(e.addClass("edit"),i.inputFocus(!0)):(e.removeClass("edit"),i.blur(),a.text(n),this.title!==n&&(this.title=n,app.pageCovers.editCover(this.id,{title:n})))}},showCoverState:!1,showCover:function(t){equals(t,this.showCoverState)||(this.showCoverState=t,this.showCoverState?(this.showCoverDom=d({param:{class:"fm-pagecovers-create__preview",call:{fn:$.fn.setBackground,args:[this.link]}}}),this.dom.find(".js-popover-zone").append(this.showCoverDom),this.showCoverTimer=setTimeout(function(){this.showCoverDom.addClass("show fm-pagecovers-create__preview--"+calculateWhichSideByYAxisToExpand(this.dom,185,r.dom.children(".scroller"),"top"))}.bind(this),300)):(this.showCoverTimer&&(clearTimeout(this.showCoverTimer),this.showCoverTimer=!1),this.showCoverDom&&(this.showCoverDom.remove(),this.showCoverDom=null)))},delete:function(){this.pack.deleteCovers(this.id)},die:function(){for(var t in this.dom.remove(),this)delete this[t]},render:function(){var i=this;return this.dom&&this.dom.remove(),this.dom=d({name:"row",param:{mod:"relative",bind:{mouseenter:function(){i.showCover(!0)},mouseleave:function(){i.showCover(!1)}}},content:[[{name:"input",param:{bind:{click:function(t){t.stopPropagation()}},type:"checkbox",name:"selected",mod:["auto"],callback:function(){i.select(!i.selectState),i.pack.updateSelectState()},containerStyle:{"margin-right":10}}},{name:"rowIcon",param:{name:"covers",style:{"margin-right":10}}},{param:{class:"fm-pagecovers-create__title"},content:[{param:{class:"fm-pagecovers-create__placeholder",callback:function(){i.edit(!0)}},content:i.title},{param:{tag:"input",attr:{value:i.title},bind:{focusout:function(){i.edit(!1)},keydown:function(t){13===t.keyCode?i.edit(!1):27===t.keyCode&&($(this).val(i.title),i.edit(!1))}}}}]}],{param:{class:"fm-table__col js-popover-zone",style:{position:"static",width:0}}},[{name:"buttonIcon",param:{name:"tag",callback:function(){var e=d({name:"tags",param:{value:i.tags}}),t=i.dom.find(".js-popover-zone").popover(e,{style:{padding:10,left:15,right:15},mod:["right",calculateWhichSideByYAxisToExpand(i.dom,150,r.dom.children(".scroller")),"white"]});t&&(app.modules.get("modalList",!0).push(t),t.onClose(function(){var t=e.data("value");app.pageCovers.editCover(i.id,{tags:t}),i.tags=t.slice(0)}),setTimeout(function(){e.trigger("fmfocus")},50))}}},{name:"buttonIcon",param:{name:"edit",callback:function(){i.edit(!0)}}},{name:"buttonIcon",param:{name:"delete",callback:function(){i.delete()}}}]]}),this.dom},selectState:!1,select:function(t){equals(this.selectState,t)||(this.selectState=t,this.dom&&(this.dom.toggleClass("selected",t),this.dom.find('input[name="selected"]').prop("checked",t)))}}},pack:function(t,e){var s={id:t.id,editable:t.editable,owner:t.owner,title:t.title,controller:e,updateSelectState:function(t){var e=this.list.length?this.selectedLength===this.list.length:!!t;this.dom&&(this.dom.toggleClass("selected",e),this.dom.find('.fm-spoiler__header input[name="selected"]').prop("checked",e)),equals(this.selectState,e)||(this.selectState=e),this.controller.updateSelectState()},updateHeading:function(){this.dom.find(".fm-spoiler__header .js-count").text(LangHelp.plural.eng("Cover",this.list.length,!0))},editState:!1,edit:function(t){if(!equals(t,this.editState)){this.editState=t;var e=this.dom.find(".fm-spoiler__header .fm-pagecovers-create__title"),i=e.find("input"),a=e.find(".fm-pagecovers-create__placeholder"),n=i.val();t?(e.addClass("edit"),i.inputFocus(!0)):(e.removeClass("edit"),i.blur(),a.text(n),this.title!==n&&(this.title=n,app.pageCovers.editPack(this.id,{title:n})))}},deletePack:function(){app.pageCovers.removePack(this.id),this.die()},die:function(){for(var t in this.controller.list.findAndRemove(this),this.list.forEach(function(t){t.die()}),this.list.length=0,this.dom.remove(),this.controller.emptyState(),this)delete this[t]},deleteCovers:function(t){app.pageCovers.removeCovers(t),this.removeCovers(t)},removeCovers:function(t){[].concat(t).forEach(function(e){this.list.findAndRemove(function(t){return t.id===e&&(t.die(),!0)})},this),this.updateSelectState(),this.updateHeading()},selectState:!1,select:function(e){this.list.forEach(function(t){t.select(e)}),this.updateSelectState(e)},get selectedLength(){return this.list.reduce(function(t,e){return e.selectState+t},0)},render:function(){var o=this;return this.dom&&this.dom.remove(),this.dom=d({name:"spoiler",param:{header:[{name:"input",param:{bind:{click:function(t){t.stopPropagation()}},type:"checkbox",name:"selected",callback:function(){o.select(!o.selectState),o.controller.updateSelectState()},mod:["auto","fieldbold"],containerStyle:{"margin-right":10}}},{param:{class:"fm-pagecovers-create__title",callback:function(t){t.stopPropagation()}},content:[{param:{class:"fm-pagecovers-create__placeholder",callback:function(){o.edit(!0)}},content:this.title},{param:{tag:"input",attr:{value:this.title},bind:{focusout:function(){o.edit(!1)},keydown:function(t){13===t.keyCode?o.edit(!1):27===t.keyCode&&($(this).val(o.title),o.edit(!1))}}}}]},{name:"paragraph",param:{class:"js-count",mod:["light","gray"],style:{"margin-left":10}},content:LangHelp.plural.eng("Cover",this.list.length,!0)},{name:"menu",param:{options:{edit:"Edit",delete:"Delete"},settings:{get mouseleave(){return o.dom},mouseleaveDelay:3e3,width:92},eventPropagation:!1,style:{"margin-right":0},callback:function(t){switch(t){case"edit":o.edit(!0);break;case"delete":app.pageCovers.removePack(o.id,!0).then(function(t){t&&o.die()})}}}}],mod:["tablelight"],hideline:!0},content:{name:"table",param:{mod:["hover","striped","iconflash"]},content:this.list.map(function(t){return t.render()}).concat({name:"row",param:{mod:"pointer"},content:[[{name:"rowIcon",param:{name:"plus",style:{"margin-right":10}}},{param:{class:"fm-pagecovers-create__creator"},content:"Add Page Covers"},{param:{class:"fm-pagecovers-create__input",tag:"input",attr:{type:"file",accept:"image/jpeg, image/png, image/svg+xml",multiple:"multiple"},event:"change",callback:function(){var n=$(this).closest(".fm-table__row"),t=Array.prototype.slice.call(this.files).map(function(i){var a={};return{file:i,onStart:function(t){var e=window.URL.createObjectURL(i);a=r.cover(Object.assign({},t,{id:getRandom(),file_id:!1,link:e}),s),o.list.push(a),n.before(a.render()),a.loader=a.dom.loader("coverLoad")},onProgress:function(t){a.loader.state(t)},onDone:function(t){a.loader.done(),a.id=t.id,a.link=safetyObjectAccess(t,["file","filename"],!1)},onError:function(){o.list.findAndRemove(a),a.die()}}});app.pageCovers.uploadCovers(t,o.id),o.updateSelectState()}}}]]})}}),this.dom}};return s.list=(t.list||[]).map(function(t){var e=this.cover(t,s);return e.render(),e},this),s},get container(){return this._container||(this._container=this.dom.find(".fm-pagecovers-create__container")),this._container},get selectBar(){if(!this._selectBar){var t=this;this._selectBar=d({param:{class:"fm-panel__selectbar"},content:{name:"buttonRow",content:[{name:"button",param:{mod:"blue",text:"10 Covers Selected & 2 Packs Selected",callback:function(){t.removeSelected()}}},{name:"link",param:{callback:function(){t.list.forEach(function(t){t.select(!1)})}},content:"Deselect All"}]}}),this.dom.closest(".fm-panel").append(this._selectBar)}return this._selectBar},get emptyDom(){return this._emptyDom||(this._emptyDom=d({name:"emptyPlaceholder",param:{callback:function(t){"create"===t&&this.createNewPack()}.bind(this),template:"pageCoversListEmpty",mod:["absolute","white"]}})),this._emptyDom},get dom(){return this._dom||(this._dom=d({param:{class:"fm-pagecovers-create"},content:{param:{class:"fm-pagecovers-create__container"}}}),this._dom.customScroll(),this._dom.append(this.emptyDom)),this._dom}};return r.init(),r.dom}}],e={init:function(){this.defineDom(),this.settingsModulesList=t,this.renderSettingsList(),this.renderViewPanel(t[0])},renderSettingsList:function(){var e=this;this.settingsModulesList.forEach(function(t){t.heading=d({name:"row",param:{callback:function(){e.renderViewPanel(t)}},content:[[{name:"rowIcon",param:{name:t.icon}},t.title]]})}),this.settingsPanelDomContent.insert(d({name:"table",param:{mod:["striped","hover","pointer","iconflash"]},content:this.settingsModulesList.map(function(t){return t.heading})}))},renderViewPanel:function(t){this.currentModule&&("function"==typeof this.currentModule.die&&this.currentModule.die(),this.currentModule.heading,this.currentModule.heading.removeClass("selected")),this.currentModule=t,this.viewPanelDomHeading.insert(d({param:{tag:"h4"},content:this.currentModule.title})),this.currentModule.heading.addClass("selected"),"function"==typeof this.currentModule.render&&this.viewPanelDomContent.insert(this.currentModule.render(this))},defineDom:function(){this.settingsPanelDom=d({name:"panel",param:{heading:"Settings List",mod:"stretch"}}),this.settingsPanelDomHeading=this.settingsPanelDom.find(".fm-panel__heading"),this.settingsPanelDomContent=this.settingsPanelDom.find(".fm-panel__content"),this.viewPanelDom=d({name:"panel",param:{heading:"View Panel",mod:"stretch"}}),this.viewPanelDomHeading=this.viewPanelDom.find(".fm-panel__heading"),this.viewPanelDomContent=this.viewPanelDom.find(".fm-panel__content"),this.dom=d({name:"container",param:{mod:["flex","between","top"],style:{height:"calc( 100vh - 100px )"}},content:[{name:"col",param:{mod:"stretch"},content:this.settingsPanelDom},{name:"col",param:{mod:"stretch"},content:this.viewPanelDom}]})}};e.init(),this.data.then(function(t){i.systemLabels=t.settings.labels.filter(function(t){return!t.project_id})}),this.container.addPage({anchor:"settings"},e.dom)}],n=function(t,e,i){this.startAnchor=t.url.path.split("/").last(),this.onDieExecutingList=[],this.header(),this.inject(),this.modules(),this.container.toAnchor(this.startAnchor),e()};n.prototype={modules:function(){t.forEach(function(t){t.call(this)}.bind(this))},update:function(t){var e=t.url.path.split("/").last();this.container.toAnchor(e),this.tabController(e)},header:function(){var e=this;app.modules.get("header").render({navigation:{},main:{param:{title:"Profile",avatar:!!User.avatar&&User.avatar},content:[{name:"headerPanel",param:{mod:["absolute","center"]},content:[{name:"tab",param:{controller:function(t){e.tabController=t},callback:function(t){e.container.toAnchor(t),t="/"+("profile"==t?t:"profile/"+t),app.url.set({path:t},!0)}},content:[{name:"tabItem",param:{data:{value:"profile"},state:"profile"==e.startAnchor},content:"Profile"},{name:"tabItem",param:{data:{value:"billing"},state:"billing"==e.startAnchor},content:"Billing"},{name:"tabItem",param:{data:{value:"notifications"},state:"notifications"==e.startAnchor},content:"Notifications"},{name:"tabItem",param:{data:{value:"settings"},state:"settings"==e.startAnchor},content:"Project Settings"}]}]},{name:"headerPanel",param:{mod:"right"},content:{name:"button",param:{mod:["white","auto","narrow"],text:"Export Personal Data",callback:function(){User.exportPersonalData()}}}}]}})},inject:function(){this.container=app.modules.get("parallelPages",{}),$(".content").insert(this.container.dom)},get data(){return this._data||(this._data=new Promise(function(e,t){app.serverRequest("userinfo").then(function(t){e(t)})})),this._data},die:function(){this.container.die(),this.onDieExecutingList.forEach(function(t){"function"==typeof t.fn&&t.fn.apply(t.context||this,t.fn.args||[])})}},app.pages.add({name:"profile",title:"Profile",backstage:function(){return!a},auth:!0,expired:null,urlMatch:/\/profile(.+|)/,get:a,canUpdate:!0,required:["modules/header","modules/selectbar"],die:function(){a.die(),a=null},controller:function(i){var t=new Promise(function(t,e){a?a.update(i):a=new n(i,t,e)});return t.catch(function(t){console.log(t),app.log(t)}),t}})}(),function(){var o,a=function(){};a.prototype={init:function(t,e,i){this.status="initialize",this.method=t.param.method,this.list=[],this._select={},this.defineSettings(t.param),"projects"===this.method&&this.list.push(new n),this.header(),this.helpBar(),this.dragMod(),setTimeout(function(){this.addExecuting(app.projects.getBy(this.filterProjectList)),this.bind()}.bind(this),50),e()},isQuotaAllows:function(t){return!!app.teams.lastListData.length||app.projects.getBy({accessibility:!0,archive:!1}).length+(t||1)<=User.quota.projects},defineSettings:function(t){this.settings={},this.settings.mod=User.getUserSettings(["projects","mod"],"tile");var e=User.getUserSettings(["projects","sort"],{key:"date_update",drt:-1});e=["date_update,-1","custom_index,1","title,1","date_create,-1"].includes(e.key+","+e.drt)?e:{key:"date_update",drt:-1},this.settings.sort=e},get filterProjectList(){return"projects"==this.method?{archive:!1}:"archive"==this.method?{archive:!0,accessibility:!0}:void 0},getById:function(e){return this.list.find(function(t){return t.id==e})},checkSensitive:function(){return!0},update:function(t,e){var i=this.getById(t);e.hasOwnProperty("archive")&&e.archive!=this.filterProjectList.archive&&i?this.removeExecuting(t):i?(i.update(e),this.view()):this.addExecuting(e)},add:function(t){},addExecuting:function(t){(t=[].concat(t)).filter(function(t){for(var e in this.filterProjectList)if(t[e]!=this.filterProjectList[e])return!1;return!0},this).forEach(function(t){var e=this.getById(t.id);e?this.update(e.id,t):(e=new i(t),this.list.push(e),e.dom.appendTo(this.grid))},this),this.view()},remove:function(e){var t=(e=[].concat(e)).length,i=1<t?t+" Projects":"Project";app.modules.get("alert",{type:"alert",heading:"Delete "+i,content:"Are you sure you wish to delete "+i+"? \nThis will remove all comments and files associated with your project.",buttons:["Yes, Delete "+i,"Cancel"]},function(t){t&&(app.serverRequest("removeproject",{id:e}),app.projects.updateList(!0),this.removeExecuting(e))}.bind(this))},removeById:function(t){for(var e=0;e<this.list.length;e++)if(this.list[e].id==t){this.list.remove(e);break}},removeExecuting:function(t){(t=[].concat(t)).forEach(function(t){var e=this.getById(t);e&&(this.removeById(t),e.remove())},this),this.view()},archive:function(e){var t=(e=[].concat(e)).length,i=1<t?t+" projects":"project";("free"===User.tarif||!User.tarif)&&1536591411989<app.serverTime()&&![].concat(e).every(function(id){ return app.teams.getAccessibilityByProject(id)})?app.modules.get("modalTemplates","upgradeSubscriptionModal","projectArchive"):app.modules.get("alert",{heading:"Archive "+CFL(i),content:"You are about to move this "+i+" to the Projects Archive. \nAll data in the "+i+" will be saved and will be available after unarchive.",buttons:["Yes, Archive "+CFL(i),"Cancel"]},function(t){!0===t&&(app.projects.changeProjectProperties(e,{archive:!0}),app.serverRequest("archiveproject",{id:e}).then(function(){app.projects.updateList(!0)}),this.removeExecuting(e))}.bind(this))},unarchive:function(e){var t=(e=[].concat(e)).length,i=1<t?t+" projects":"project";this.isQuotaAllows(t)?app.modules.get("alert",{heading:"Activate "+CFL(i),content:"You are about to activate "+i+". \n",buttons:["Yes, Activate "+CFL(i),"Cancel"]},function(t){t&&(app.serverRequest("unarchiveproject",{id:e}).then(function(t){t.status||(loaderArray.forEach(function(t){t.done()}),app.modules.get("modalTemplates","projectQuotaExceeded"))}),app.projects.updateList(!0),this.removeExecuting(e),app.projects.changeProjectProperties(e,{archive:!1}))}.bind(this)):app.modules.get("modalTemplates","projectQuotaExceeded")},leave:function(e){var t=(e=[].concat(e)).length,i=1<t?t+" projects":"project";app.modules.get("alert",{type:"alert",heading:"Leave "+CFL(i),content:"You are about to leave this "+i+". \nLeaving the "+i+", you will no longer see it in the list of projects, but all your files and comments will be saved.",buttons:["Yes, Leave "+CFL(i),"Cancel"]},function(t){t&&(app.serverRequest("leaveproject",{id:e}),app.projects.updateList(!0),this.removeExecuting(e))}.bind(this))},bind:function(){this.shortCut.bind(),this.subscribeKey=app.projects.subscriber("on",function(t){t.forEach(function(t){switch(t.event){case"add":this.addExecuting(t.data);break;case"remove":this.removeExecuting(t.scope,t.data);break;case"update":this.update(t.scope,t.data)}}.bind(this))}.bind(this))},unbind:function(){this.shortCut.unbind(),app.projects.subscriber("off",this.subscribeKey)},get mod(){return this.settings.mod},set mod(t){if("boolean"==typeof t&&(t="tile"===this.mod?"list":"tile"),["tile","list"].includes(t)&&t!==this.mod){this.settings.mod=t,this.grid.addClass("projects__grid--notransitions").toggleClass("projects__grid--tile","tile"==t).toggleClass("projects__grid--list","list"==t);var e=this.grid.loader("backstage",{mod:"instantly"});this.view(),forceReflow(this.grid),this.grid.removeClass("projects__grid--notransitions"),setTimeout(function(){e.done()}.bind(this),150),User.setUserSettings(["projects","mod"],t)}},dragMod:function(){this.grid.toggleClass("projects__grid--drag","custom_index"===this.sort.key)},get sort(){return this.settings.sort},set sort(t){this.sort.equals(t)||(this.settings.sort=t,this.view(),User.setUserSettings(["projects","sort"],t),this.dragMod())},get filter(){return this._filter||!1},set filter(t){equals(t,this.filter)||(this._filter=t,this.view())},get search(){return this._search||!1},set search(t){equals(t,this.search)||((this._search=t)||this.list.forEach(function(t){t.sortable&&t.indexTitle(!1)}),this.view())},orderList:function(){var i=this.sort,a=this.filter;this.search;if(this.search){var e=new RegExp(this.search.split("").join(" ?"),"i");this.list.forEach(function(t){t.sortable&&(t.visibility=-1<t.indexTitle(e))}),this.list.sort(function(t,e){return t.sortable?e.sortable?t.searchIndex-e.searchIndex:-1:1})}else this.list.sort(function(t,e){return t.sortable?e.sortable?(t="string"==typeof t[i.key]?t[i.key].toUpperCase():t[i.key],(e="string"==typeof e[i.key]?e[i.key].toUpperCase():e[i.key])<t?1*i.drt:t<e?-1*i.drt:0):-1:1}).forEach(function(t,e){a&&t.sortable?t.visibility=t[a.key]==a.value:t.visibility=!0});return this.list},view:function(){var i=this.param,a=0,n=0,o="tile"===this.mod?4:1,s=0;this.orderList().forEach(function(t,e){t.position={x:a*i.x,y:n*i.y,z:e+2,o:t.visibility?t.disable?.4:1:0,p:t.visibility&&!t.disable},t.drag?t.shadow.setTransform(t.position):t.dom.setTransform(t.position),t.visibility&&(s++,++a>=o&&(a=0,n++))}),this.grid.css({height:("tile"==this.mod?Math.ceil(s/4):s)*i.y});var t="projects"===this.method?1:0,e=t<s?0:this.list.length>t&&(this.search||this.filter)?2:1;if(0<e){this.grid.css("height","");var r=this.list.find(function(t){return"createnew"===t.id});r&&r.dom.transform({x:0,y:0,z:0,o:0,p:!1})}this.emptyState=e,"projects"===this.method&&2<s&&setTimeout(function(){app.subscriber("add",{scope:app,event:"manyProjects"})},300)},get param(){return{list:{x:0,y:120},tile:{x:300,y:244}}[this.mod]},drag:function(n){if("custom_index"!=this.sort.key)return!1;var o=this;n.drag=!0,this.view();var s=this.param,r="tile"==this.mod?4:1,c=n.custom_index,l=n.position.x,d=n.position.y,h=cursorX,u=cursorY,i={start:content.offset().top,end:content.offset().top+content.outerHeight(),zone:.1},a=this.scroller,e=a.scrollLeft(),p=a.scrollTop(),m={x:0,y:0},f=function(t){var e=l-h+cursorX+m.x,i=d-u+cursorY+m.y,a=0;"list"==o.mod?a=i<0?-.5:Math.ceil(i/s.y-.5):(a=Math.max(e,0)/s.x,a=Math.ceil(a+.5)-1,r-1<a&&(a=r-1),a<0&&(a=0),a+=Math.ceil(i/s.y-.5)*r),a<c&&(a-=.5),c<=a&&(a+=.5),n.dom.transform(Object.assign({},n.position,{x:e,y:i,z:1e3})),n.custom_index!=a&&(n.custom_index=a,o.view())},t=function(t){m.x=a.scrollLeft()-e,m.y=a.scrollTop()-p,f()},g=function(){f();var t=(i.end-i.start)*i.zone,e=!1;cursorY<i.start+t?e={y:{drt:0,speed:1}}:cursorY>i.end-t&&(e={y:{drt:1,speed:1}}),e?a.makeMeScroll(e):a.stop()};$(document).on("mousemove",g),a.on("scroll",t),$(document).one("mouseup",function(){$(document).off("mousemove",g),a.off("scroll",t),o.updateCustomIndex(),setTimeout(function(){n.drag=!1,setTimeout(function(){o.view();var t=n.shadow;n._shadow=null,t.transform(Object.assign({},n.position,{s:0})),setTimeout(function(){t.remove()},160)},20)},20)}.bind(this))},updateCustomIndex:function(){User.setUserSettings(["projects","customSort"],this.list.reduce(function(t,e,i){return e.sortable&&e.id&&(e.custom_index=i),t[e.id]=i,t},{}))},header:function(){var e=this;if("projects"===this.method){var r,t=e.settings.sort.key+","+e.settings.sort.drt;app.modules.get("header").render({navigation:{current:"/projects"},main:{param:{title:"All projects"},content:[{name:"headerPanel",param:{mod:"right"},content:[{name:"button",param:{mod:["white","square"],tag:"div",icon:"backup",callback:function(){if(!r){var n=app.modules.get("html"),t=n({name:"scroller",param:{baron:{mod:"ease"}}}),o=t.find(".scroller"),e=$(this);(r=e.popover(t,{width:450,height:442,mod:["white","large","bot","right"],style:{right:-140}})).onClose(function(){r=null});var s=function(){var e=t.loader("blockLight"),a=function(){var t=this.files[0];t&&"fmb"===t.name.split(".").pop()&&(r.fixed(!0),app.backup.upload(t).then(function(){r.fixed(!1)}))};app.backup.list(!0).then(function(t){var i={};(t=t.reduce(function(t,e){return e.project_id&&(i.hasOwnProperty(e.project_id)?i[e.project_id].date<e.date&&(i[e.project_id].date=e.date,i[e.project_id].title=e.project_name):(i[e.project_id]={mod:"group",date:e.date_create,title:safetyObjectAccess(app.projects.get(e.project_id),["title"],e.project_name),content:[]},t.push(i[e.project_id])),i[e.project_id].content.push(e)),t},[])).length?o.insert(n([{name:"button",param:{mod:["tablerow"],tag:"div",icon:"upload",text:"Upload Backup"},content:{param:{tag:"input",attr:{type:"file",accept:".fmb"},event:"change",callback:a}}}].concat(t.map(function(t){return{name:"spoiler",param:{header:[{name:"paragraph",param:{mod:["bold","uppercase","nowrap"],style:{"letter-spacing":.8,"max-width":280}},content:t.title},{name:"paragraph",param:{mod:["light","gray"],style:{margin:"0 0 0 15px","min-width":80}},content:t.content.length+LangHelp.plural.eng(" Backup",t.content.length)}],mod:"table",state:!1},content:{name:"backupList",param:{list:t.content,callback:function(t,e,n){switch(r.fixed(!0),t){case"restore":app.backup.restore(e).then(function(){r.fixed(!1)});break;case"remove":app.backup.remove(e).then(function(t){if(r.fixed(!1),t){var e=n.closest(".fm-spoiler"),i=e.find(".fm-table__row").length-1;if(i)e.find(".fm-spoiler__header .fm-paragraph.fm-paragraph--light.fm-paragraph--gray").text(i+LangHelp.plural.eng(" Backup",i)),n.remove();else{var a=e.closest(".popover").find(".fm-spoiler").length-1;e.remove(),a||s()}}})}}}}}})))):o.insert(n({name:"emptyPlaceholder",param:{template:"projectListBackupEmpty",active:!0,mod:["absolute","center","nopadding"],event:"change",callback:function(t,e){"upload"===t&&a.call($(e).find("input").get(0))}}})),e.done()}).catch(console.log)};s()}}}},{name:"button",param:{text:"Create Project",mod:["blue","narrow"],icon:"plus",callback:function(){e.createProject()}}}]}]},tools:[{name:"headerPanel",content:[{name:"input",param:{mod:["narrow","shortest","horizontal","round"],name:"search",value:"",placeholder:"",icon:"search",callback:function(t){t.value=t.value.replace(/ /g,""),e.search=!!t.value.length&&t.value}}}]},{name:"headerPanel",param:{mod:"right"},content:[{name:"input",param:{type:"select",name:"sort",mod:["narrow","short","horizontal"],options:[{text:"Recent activity",value:"date_update,-1"},{text:"Custom (Drag&amp;Drop)",value:"custom_index,1"},{text:"Alphanumeric",value:"title,1"},{text:"Creation date",value:"date_create,-1"}],callback:function(t){t=t.value.split(","),e.sort={key:t[0],drt:1*t[1]}},label:"Sort by",class:"js-sort",value:t}},{name:"input",param:{type:"select",name:"filter",mod:["narrow","short","horizontal"],options:[{text:"All projects",value:"false"},{text:"My projects",value:"accessibility,true"},{text:"Other projects",value:"accessibility,false"}],callback:function(t){1==(t=t.value.split(",")).length?e.filter=!1:e.filter={key:t[0],value:"true"==t[1]||"false"!=t[1]&&t[1]}},label:"Show",class:"js-filter",value:"false"}},{name:"buttonStack",param:{name:"mod",value:e.settings.mod,mod:"compact",callback:function(t){e.mod=t.value}},content:[{name:"button",param:{data:{value:"tile"},mod:["white","square"],icon:"tile"}},{name:"button",param:{data:{value:"list"},mod:["white","square"],icon:"list"}}]}]}]})}else app.modules.get("header").render({navigation:{current:"/archive"},main:{param:{title:"Archive"}},tools:[{name:"headerPanel",content:[{name:"input",param:{mod:["narrow","shortest","horizontal","round"],name:"search",value:"",placeholder:"",icon:"search",callback:function(t){t.value=t.value.replace(/ /g,""),e.search=!!t.value.length&&t.value}}}]},{name:"headerPanel",param:{mod:"right"},content:[{name:"input",param:{type:"select",name:"sort",mod:["narrow","short","horizontal"],options:[{text:"Recent activity",value:"date_update,-1"},{text:"Alphanumeric",value:"title,1"},{text:"Creation date",value:"date_create,-1"}],callback:function(t){t=t.value.split(","),e.sort={key:t[0],drt:1*t[1]}},label:"Sort by",value:e.settings.sort.key+","+e.settings.sort.drt}},{name:"buttonStack",param:{name:"mod",value:e.settings.mod,mod:"compact",callback:function(t){e.mod=t.value}},content:[{name:"button",param:{data:{value:"tile"},mod:["white","square"],icon:"tile"}},{name:"button",param:{data:{value:"list"},mod:["white","square"],icon:"list"}}]}]}]});app.modules.get("header").disable("tools",1===this.emptyState)},helpBar:function(){app.modules.get("sideTools",[["shortcut",[{description:"Select Project",value:["hold",{name:"key",param:{value:"Shift"}},"plus","click"]},{description:"Deselect",value:{name:"key",param:{value:"Esc"}}}]]])},get scroller(){return this._scroller||(this._scroller=this.dom.children(".scroller")),this._scroller},get grid(){return this._grid||(this._grid=this.dom.find(".projects__grid")),this._grid},get dom(){return this._dom||(this._dom=app.modules.get("html",{name:"page",content:[{name:"container",content:[$('<div class="projects__grid projects__grid--'+this.mod+'"></div>')]}]}),this.dom.customScroll(),$(".content").insert(this.dom)),this._dom},selectBarTemplates:{projects:{accessibilitytrue:["delete","archive"],accessibilityfalse:["leave"]},archive:{accessibilitytrue:["delete","unarchive"]}},selectFilter:function(t){var i=this;if(void 0===t)return this._selectFilter||!1;if(!equals(this.selectFilter(),t)&&(this._selectFilter=t,this.highlight(t),t)){this.selectBarBindKey&&this.selectBar.subscriber("off",this.selectBarBindKey);var e=Object.entries(t).map(function(t){return t.join("")}).join("");"accessibilitytrue"===e&&app.subscriber("add",{scope:app,event:"projectSelectbar"}),this.selectBar.render({textTemplate:function(t){return 1<t?"Projects selected":"Project selected"},events:this.selectBarTemplates[this.method][e]}),this.selectBarBindKey=this.selectBar.subscriber("on",function(t){var e=Object.keys(i.select());t.forEach(function(t){switch(t.event){case"select":i.selectAll(!0);break;case"deselect":i.selectAll(!1);break;case"delete":i.remove(e);break;case"archive":i.archive(e);break;case"unarchive":i.unarchive(e);break;case"leave":i.leave(e)}})})}},select:function(t,e){if(arguments.length){var i=t.id,a=this.selectFilter();if(e){if(a)for(var n in a)if(t[n]!=a[n])return!1;this._select[i]=!0}else this._select.hasOwnProperty(i)&&delete this._select[i];var o=Object.keys(this._select).length;return 0<o?this.selectFilter({accessibility:t.accessibility}):(this.selectFilter(!1),app.subscriber("add",{scope:app,event:"selectBarClose"})),this.selectBar.count(o),!0}return this._select},selectAll:function(i){var a=this.selectFilter();this.list.forEach(function(t){for(var e in a)if(a[e]!==t[e])return!1;i?t.visibility&&(t.select=i):t.select=i})},get selectBar(){return this._selectBar||(this._selectBar=app.modules.get("selectbar","")),this._selectBar},shortCut:{keycode:{27:{event:"deselect"}},event:{do:function(t,e){this[t.event]&&this[t.event]&&("object"==typeof this[t.event]?this[t.event].init(t.args,e):"function"==typeof this[t.event]&&this[t.event](t.args,e))},die:function(t,e){this[t.event]&&this[t.event]&&"object"==typeof this[t.event]&&this[t.event].die(t.args,e)},deselect:function(){o.selectAll(!1)}},find:function(t){for(var e in this.keycode)if(t.keyCode==e||t.key==e)return this.keycode[e];return!1},keyup:function(t){var e=$(t.target);if(!e.is("input")&&!e.is("textarea")){var i=this.find(t);return i?(t.preventDefault(),this.event.die(i,t),!1):void 0}},keydown:function(t){var e=$(t.target);if(!(e.is("input")||e.is("textarea")||app.modules.get("modalList",!0).length)){var i=this.find(t);return i?(t.preventDefault(),this.event.do(i,t),!1):void 0}},bind:function(){$(document).on("keyup",$.proxy(this.keyup,this)),$(document).on("keydown",$.proxy(this.keydown,this))},unbind:function(){$(document).off("keyup",$.proxy(this.keyup,this)),$(document).off("keydown",$.proxy(this.keydown,this))}},highlight:function(i){i?this.list.forEach(function(t){for(var e in i)if(i[e]!==t[e])return!(t.disable=!0);t.disable=!1}):this.list.forEach(function(t){t.disable=!1}),this.view()},duplicateProject:function(a){this.isQuotaAllows()?(app.teams.lastListData.length?app.modules.get("modalTemplates","duplicateProject",{value:"false"}):Promise.resolve({team:"false"})).then(function(t){if(t){var e=t.team;if("false"===e&&app.projects.getBy({accessibility:!0,archive:!1}).length+1>User.quota.projects)app.modules.get("modalTemplates","upgradeSubscriptionModal","projectLimit");else{var i=a.dom.loader("cover");app.serverRequest("duplicateProject",{id:a.id,team:e}).then(function(){app.projects.updateList(!0),i.done()},function(){app.log("duplicate error"),i.done()})}}}.bind(this)):app.modules.get("modalTemplates","upgradeSubscriptionModal","projectLimit")},createProject:function(){this.isQuotaAllows()?app.modules.get("modalTemplates","project","create").then(function(t){if(!t)return!1;app.modules.get("backstage").start(),app.serverRequest("addproject",t).then(function(t){if(t.id)return app.router("/projects/"+t.id);app.modules.get("backstage").end(),app.modules.get("modalTemplates","upgradeSubscriptionModal","projectLimit")})}):app.modules.get("modalTemplates","upgradeSubscriptionModal","projectLimit")},get emptyState(){return this._emptyState||0},set emptyState(t){var e=this;if(!equals(this.emptyState,t)){if(this._emptyState=t,this.placeholder){var i=this.placeholder;i.removeClass("open"),setTimeout(function(){i.remove()},150),this.placeholder=null}switch(app.modules.get("header").disable("tools",1===t),t){case 1:this.placeholder=app.modules.get("html",{name:"emptyPlaceholder",param:{template:"projects"===this.method?"projectsEmpty":"archiveEmpty",callback:function(t){"create"===t&&e.createProject()}}}).appendTo(this.grid),setTimeout(function(){this.placeholder&&this.placeholder.addClass("open")}.bind(this),20);break;case 2:this.placeholder=app.modules.get("html",{name:"emptyPlaceholder",param:{template:"projectsNotFound"}}).appendTo(this.grid),setTimeout(function(){this.placeholder&&this.placeholder.addClass("open")}.bind(this),20)}}},die:function(){this.unbind(),this.selectBar.clear(),this.dom.find("[data-scroll]").baron().dispose(),this.dom.remove(),app.modules.get("sideTools",!1)}};var i=function(t){this.data={},this.data.owner_id=t.owner_id,this.accessibility=t.accessibility,this.archive=t.archive,this.sortable=!0,this._visibility=!0,this.update(t)};i.prototype={get custom_index(){return 1*(void 0!==this._custom_index?this._custom_index:this.id?User.getUserSettings(["projects","customSort",this.id],1/0):1/0)},set custom_index(t){this._custom_index=t},get accessibility(){return this.data.accessibility},set accessibility(t){equals(this.data.accessibility,t)||(this.data.accessibility=t)},get archive(){return this.data.archive},set archive(t){equals(this.data.archive,t)||(this.data.archive=t)},get attaches(){return this.data.attaches||null},set attaches(t){equals(this.data.attaches,t)||(this.data.attaches=t)},get date_create(){return this.data.date_create||null},set date_create(t){equals(this.data.date_create,t)||(this.data.date_create=t,this.dom.find('[data-field="date_create"]').text(formatDate(t,"M d, yyyy")))},get date_update(){return this.data.date_update||null},set date_update(t){equals(this.data.date_update,t)||(this.data.date_update=t)},get time_ago(){return this.data.time_ago||null},set time_ago(t){equals(this.time_ago,t)||(this.data.time_ago=t,this.dom.find('[data-field="time_ago"]').text(t))},get description(){return this.data.description||null},set description(t){equals(this.data.description,t)||(this.data.description=t)},get id(){return this.data.id||null},set id(t){equals(this.data.id,t)||(this.data.id=t)},get img(){return this.data.img||!1},set img(t){equals(this.data.img,t)||((this.data.img=t)?this.dom.find('[data-field="img"]').setBackground(t):this.dom.find('[data-field="img"]').css("background-image",""))},get owner_id(){return this.data.owner_id||null},set owner_id(t){equals(this.data.owner_id,t)||(this.data.owner_id=t)},get title(){return this.data.title||null},set title(t){equals(this.data.title,t)||(this.data.title=t,this.dom.find('[data-field="title"]').text(t))},get users(){return this.data.users||null},set users(t){equals(this.data.users,t)||(this.data.users=t,"projects"==o.method&&this.dom.find('[data-field="users"]').insert(app.modules.get("html",{name:"projectMembers",param:{id:this.id,list:t}})))},get visibility(){return this._visibility},set visibility(t){t!=this.visibility&&((this._visibility=t)||(this.select=!1))},get select(){return!!this._select},set select(t){t!=this.select&&(this._select=t,this.dom.toggleClass("selected",t),this.dom.find(".js-select").toggleClass("checked",t),o.select(this,t))},get disable(){return!!this._disable},set disable(t){this._disable!=t&&(this._disable=t)},get drag(){return this._drag||!1},set drag(t){equals(this.drag,t)||(this._drag=t,this.dom.toggleClass("projects__item--drag",t))},indexTitle:function(t){var e=this.dom.find('[ data-field="title"]');return this.searchIndex=t?this.title.search(t):-1,-1<this.searchIndex?e.html(this.title.replace(t,'<span class="matched">$&</span>')):e.html(this.title),this.searchIndex},update:function(t){for(var e in t)"function"!=typeof this[e]&&(this[e]=t[e])},edit:function(){app.modules.get("modalTemplates","project","edit",this.data).then(function(t){if(!t)return!1;app.serverRequest("updateproject",Object.assign({id:this.id},t)),t.hasOwnProperty("img")&&(this.img=t.img),t.hasOwnProperty("title")&&(this.title=t.title),t.hasOwnProperty("members")&&t.members.length&&app.serverRequest("switchmembers",{members:t.members.map(function(t){return Object.assign(t,{projects:this.id})},this)}),app.projects.updateList(!0)}.bind(this))},remove:function(){this.select=!1,this.dom.css({opacity:0,"z-index":0,"pointer-events":"none"}),setTimeout(function(){this.dom.remove()}.bind(this),160)},bind:function(){var e=this;this.dom.on("click",function(t){var e=$(t.target);switch(!0){case 0<e.closest(".js-select").length||t.shiftKey:this.select=!this.select;break;case 0<e.closest(".js-invite").length:break;default:this.drag||"projects"!==o.method||app.router("/projects/"+this.id)}}.bind(this)),this.dom.on("dragstart",function(t){return t.preventDefault(),o.drag(e),!1})},get shadow(){return this._shadow||(this._shadow=$('<div class="projects__item projects__item--shadow"></div>'),this.dom.before(this._shadow)),this._shadow},get template(){var e=this,i={fake:{mod:"fake"},share:{icon:"share",title:"Share project",callback:function(t){t.stopPropagation(),app.modules.get("modalTemplates","shareProject",{id:e.id})}},delete:{icon:"delete",title:"Delete project",callback:function(t){t.stopPropagation(),o.remove(e.id)}},leave:{icon:"leave",title:"Leave project",callback:function(t){t.stopPropagation(),o.leave(e.id)}},archive:{icon:"archive",title:"Archive project",callback:function(t){t.stopPropagation(),o.archive(e.id)}},unarchive:{icon:"unarchive",title:"Unarchive project",callback:function(t){t.stopPropagation(),o.unarchive(e.id)}},edit:{icon:"edit",title:"Edit project",callback:function(t){t.stopPropagation(),e.edit()}},duplicate:{icon:"duplicate",title:"Create duplicate",callback:function(t){t.stopPropagation(),o.duplicateProject(e)}},backup:{icon:"backup",title:"Create backup",callback:function(t){t.stopPropagation(),app.backup.create(e.id)}}},t=[],a=app.teams.lastListData.find(function(t){return t.owner_id===this.data.owner_id},this);t=this.archive?["fake","delete","unarchive"]:User.expired?this.accessibility?["fake","delete","archive"]:["fake","leave","archive"]:this.accessibility||a?["share","edit","duplicate",["backup","archive","delete"]]:["fake","share","leave"];var n=app.modules.get("html");return n({param:{class:"projects__item",attr:{draggable:"true"}},content:[{param:{class:"projects__selection",attr:{title:"Select Project"}},content:{param:{class:"c-input__checkbox c-input__checkbox--round js-select"},content:{param:{class:"checkbox"}}}},{param:{class:"projects__preview",attr:{"data-field":"img"}}},{param:{class:"projects__info"},content:[this.accessibility&&{param:{class:"projects__belong projects__belong--self"},content:"My Project"}||a&&{param:{class:"projects__belong projects__belong--team"},content:a.title}||"",{param:{class:"projects__heading",attr:{"data-field":"title"},tag:"h4"}},{param:{class:"projects__date",attr:{"data-field":"time_ago"}}},{param:{class:"projects__activities",attr:{"data-field":"date_create"}}}]},{param:{class:"projects__userteam userteam js-invite",attr:{"data-field":"users"}}},{param:{class:"projects__buttons"},content:t.map(function(t){var a;return Array.isArray(t)?{param:{class:"projects__button projects__button--nowrap",attr:"More options"},content:{name:"menu",param:{options:(a=t.map(function(t){return i[t]})).map(function(t){return{name:n([{param:{style:{width:"20px",height:"29px",display:"flex","margin-right":"5px","justify-content":"center","align-items":"center"}},content:{name:"icon",param:{name:t.icon}}},{name:"paragraph",content:t.title}]),value:t.title}}),callback:function(e,t){var i=a.find(function(t){return t.title===e});i&&"function"==typeof i.callback&&i.callback(t)},eventPropagation:!1,settings:{get mouseleave(){return e.dom},mouseleaveDelay:2e3,mod:["white","large","bot","center","static"],width:150,style:{left:-76}},onOpen:function(){e.dom.addClass("projects__item--hover")},onClose:function(){e.dom.removeClass("projects__item--hover")}}}}:{param:{class:["projects__button"].concat([].concat((a=i[t]).mod).map(function(t){return"projects__button--"+t})).join(" "),attr:!!a.title&&{title:a.title},callback:a.callback||!1},content:!!a.icon&&{name:"icon",param:{name:a.icon}}}})},{param:{class:"projects__drag-zone"},content:{name:"icon",param:{name:"dragzone"}}}]})},get dom(){return this._dom||(this._dom=this.template,this.bind()),this._dom}};var n=function(){this.id="createnew",this.sortable=!1};n.prototype={bind:function(){this.dom.hover(function(){this.button.addClass("hover")}.bind(this),function(){this.button.removeClass("hover")}.bind(this)),this.dom.on("click",function(){o.createProject()})},get button(){return this.dom.find("button")},get dom(){return this._dom||(this._dom=this.template,o.grid.append(this._dom),this.bind()),this._dom},get template(){var t=$('<div class="projects__item projects__item--createnew"><div class="projects__info"><h4 class="projects__heading">Create Project</h4></div><div class="projects__preview"></div></div>');return t.find(".projects__preview").append(app.modules.get("html",{name:"button",param:{mod:["doted","round","narrow","coverage"],icon:"plus"}})),t}},app.pages.add({name:"projects",title:"All projects",backstage:!0,auth:!0,expired:null,urlApply:{path:"/projects"},urlMatch:[{test:/^\/$|(\/projects($|\/$))/,title:"All Projects",method:"projects",urlApply:{path:"/projects"}},{test:/\/archive($|\/$)/,title:"Archive",method:"archive",urlApply:{path:"/archive"}}],required:["modules/header","modules/selectbar"],die:function(){o&&o.die()},get:function(){return o},controller:function(i){return new Promise(function(t,e){o&&o.method==i.method?t(o):(o=new a).init(i,t,e)})}})}();var WorkPlace,flowmap,ufController,userflow,userflowClass,ctx,onFSPopupClosed=function(){};function findIssueSQL(t){return t.filter(function(e){return!t.find(function(t){return t.id===e.parent_id})})}!function(){var i,d={init:function(t,e,i){app.sourceLoader({link:"https://d1f8f9xcsvx3ha.cloudfront.net/sbl/0.7.4/fastspring-builder.min.js",attributes:{id:"fsc-api","data-storefront":"flowmapp.onfastspring.com/popup-flowmapp","data-popup-closed":"onFSPopupClosed"}}).then(e),this.header(),this.render(),this.coupon=safetyObjectAccess(app.url(),["param","coupon"],!1),console.log(this.coupon)},get data(){return Promise.all([app.serverRequest("getTarifs").then(function(t){var n={};return t.products.forEach(function(t){var e=t.product.split("-")[0],i={fullName:t.product,totalPrice:t.pricing.price.USD,perMonth:t.pricing.price.USD,period:t.pricing.interval,attributes:{space:1e9*t.attributes.disc,projects:infinityOrNumber(t.attributes.projects),teams:infinityOrNumber(t.attributes.team)||!1,members:infinityOrNumber(t.attributes.members)||!1,collaborators:"∞"}};if("year"==t.pricing.interval&&(i.perMonth=Math.round(i.totalPrice/12)),n.hasOwnProperty(e))n[e].mods[i.period]=i;else{var a={};a[i.period]=i,n[e]={name:e,image:t.image,mods:a}}}),n.mapToArray().sort(function(t,e){return t.mods.month.totalPrice-e.mods.month.totalPrice})}),app.serverRequest("getQuota")])},mainPage:function(){var t=app.modules.get("html"),l=this,e=t({name:"container",param:{mod:["flex","column"]}});e.append(t({name:"heading",param:{mod:["light","big"]},content:"Choose the plan for which you want to continue working"}).css("margin-top","47px")),e.append(t({name:"paragraph",param:{mod:["gray","center"]},content:["You can toggle the status of the subscription is not more than 1 time per day and no \nmore than 4 times a month ",{name:"link",param:{href:"https://flowmapp.com/help/",target:"_blank"},content:"More info"}]}));var i=function(){this.tarif="",this.list=[];var i=this.dom.loader({background:"#f0f4f7"});l.data.then(function(t){var e=t[0];this.quota=t[1],User.expired||(e=e.filter(function(t){return"free"!=t.name})),this.list=e.map(function(t){return t=new a(t,this),this.container.append(t.dom),t},this),this.mod=User.tarif?User.tarif.split("-")[1]||"month":"year",i.done()}.bind(this))};i.prototype={get mod(){return this._mod||!1},set mod(t){equals(t,this.mod)||(this._mod=t,this.dom.find('.plans__heading input[name="period"]').prop("checked","year"==t),this.view())},get currentSpace(){return this.quota.disc_usage},get currentProjects(){return this.quota.projects_usage},get tarif(){return User.tarif||!1},get tarifDetail(){return this.quota.tarif},view:function(){this.dom.find(".js-month").toggleClass("fm-paragraph--blue","month"==this.mod),this.dom.find(".js-year").toggleClass("fm-paragraph--blue","year"==this.mod),this.list.forEach(function(t){t.view()})},get container(){return this.dom.find(".plans__container")},get dom(){if(!this._dom){var t=app.modules.get("html"),e=this;this._dom=$('<div class="plans"><div class="plans__heading"></div><div class="plans__container"></div></div>'),this.dom.find(".plans__heading").append(t({name:"paragraph",param:{mod:"right"},content:"Billed monthly"}).addClass("js-month").css("width","200px")).append(t({name:"toggle",param:{mod:"simple",checked:!0,name:"period",callback:function(t){e.mod=t.state?"year":"month"}}})).append(t({name:"paragraph",param:{mod:"blue"},content:"Billed annually (Saving 15%)"}).addClass("js-year").css("width","200px"))}return this._dom}};var a=function(t,e){this.controller=e,this.data=t};return a.prototype={view:function(){this.dom.find('[data-mod="month"]').toggleClass("show","month"===this.controller.mod),this.dom.find('[data-mod="year"]').toggleClass("show","year"===this.controller.mod),this.dom.toggleClass("active",this.data.mods[1===Object.keys(this.data.mods).length?"month":this.controller.mod].fullName==this.controller.tarif)},get getSaveYearly(){return 12*this.data.mods.month.totalPrice-this.data.mods.year.totalPrice},get available(){return this.maxProjects>=this.controller.currentProjects&&this.maxSpace>=this.controller.currentSpace},get maxProjects(){return this.data.mods.month.attributes.projects},get maxSpace(){return this.data.mods.month.attributes.space},get template(){var s=this,r=app.modules.get("html"),c=this.controller;return r({param:{class:["plan",this.available?"":" unavailable"]},content:[{param:{class:"plan__heading"},content:[{param:{class:"plan__image",call:{fn:$.fn.setBackground,args:[this.data.image]}}},{param:{class:"plan__title"},content:this.data.name}]}].concat(this.data.mods.mapToArray(function(i,t){var e="professional-year"===i.fullName?2:0,a="professional-year"===i.fullName?2:0,n="professional-year"===i.fullName?2:0,o=r([{param:{class:"plan__billing",attr:{"data-mod":t}},content:[{param:{class:"plan__price"},content:[{param:{tag:"span",class:"currency"},content:currencySymbol("USD")},i.perMonth]},{param:{class:"plan__period"},content:0===i.totalPrice?"Cost Free Forever":"year"===t?"Per month":"Billed per month"}]},{param:{class:"plan__description",attr:{"data-mod":t}},content:["year"===t?{name:"paragraph",content:{param:{tag:"b"},content:"Pay $"+i.totalPrice+"/year save $"+this.getSaveYearly+" a year"}}:"",{name:"paragraph",param:{class:this.controller.currentSpace>this.maxSpace?"fm-paragraph--red":""},content:"<b>"+(e?i.attributes.space.fileSize(!0).split(" ").join('<span class="green">+'+e+"</span> "):i.attributes.space.fileSize(!0))+"</b> space"},{name:"paragraph",param:{class:this.controller.currentProjects>this.maxProjects?"fm-paragraph--red":""},content:"<b>"+(i.attributes.projects==1/0?"Unlimited":i.attributes.projects+(a?'<span class="green">+'+a+"</span>":""))+"</b> active projects"},{name:"paragraph",content:n?"<b>"+i.attributes.collaborators+'<span class="green">+'+n+"</span></b> collaborators":"<b>"+i.attributes.collaborators+"</b> collaborators"},i.attributes.teams&&i.attributes.members?{name:"paragraph",content:numberMultiCompareEquals(i.attributes.teams,i.attributes.members,1/0)?"<b>Unlimited</b> Teams and Members":LangHelp.plural.eng("Team",i.attributes.teams)+" up to <b>"+LangHelp.plural.eng("Member",i.attributes.members,!0)+"</b>"}:""]},{param:{class:"plan__action",attr:{"data-mod":t}},content:i.fullName!==c.tarif||1*User.is_trial||!["canceled","active"].includes(c.tarifDetail.subscription_state)?this.available?User.hasOwnProperty("api_user_id")&&User.api_user_id?{name:"button",param:{mod:"blue",text:"Choose "+this.data.name,callback:function(){app.log(i,s),app.modules.get("alert",{heading:"Change subscription?",content:["<p><b>Your Order:</b> "+CFL(s.data.name)+" plan ("+i.period+")</p>","<p><b>You will be charged now:</b> $"+i.totalPrice+"</p>","<p><b>Subscription renews:</b> every 1 "+i.period+".</p>","<p><b>Next charge:</b> "+formatDate(+new Date(app.clientTime()).addMonths("year"==i.period?12:1),"m/d/yy")+" (USD "+i.totalPrice.toFixed(2)+").</p>","<p><br>Do you confirm your order?</p>"],buttons:["Yes, change subscription","Cancel"],wfc:!0},function(t,e){!0===t?d.submit({plan:i.fullName},i.fullName,e):e()})}}}:{name:"button",param:{mod:"blue",text:"Purchase "+CFL(this.data.name),callback:function(){l.container.toAnchor("form"),l.form.setTarif(s,t)}}}:{name:"button",param:{mod:"blue",text:"Manage projects",callback:function(){app.log(i),app.router({path:"/manager",param:{projects:i.attributes.projects,space:i.attributes.space,tariff:s.data.name}})}}}:"free"===i.fullName?"":"canceled"===c.tarifDetail.subscription_state?{name:"button",param:{mod:"blue",text:"Renew the subscription",callback:function(){app.serverRequest("continueSubscription").then(function(t){app.modules.get("notify",{mod:"green",content:"The subscription was successfully renew"}),setTimeout(function(){location.reload()},800)})}}}:"active"===c.tarifDetail.subscription_state?{name:"link",content:"Cancel subscription",param:{callback:function(){app.modules.get("modalTemplates","cancelSubscription").then(function(t){!0===t&&(app.modules.get("notify",{mod:"green",content:"The subscription was successfully canceled"}),setTimeout(function(){location.reload()},800))},function(t){app.modules.get("notify",{mod:"red",content:"Error: "+t}),app.log(t)})}}}:""}]);return safetyObjectAccess(app.url(),["param","tarif"],!1)!==s.data.name+"-"+t||!(i.fullName!==c.tarif||1*User.is_trial)||!this.available||User.hasOwnProperty("api_user_id")&&User.api_user_id||setTimeout(function(){o.closest(".plan__action").children().click()},10),o}.bind(this)))})},get dom(){return this._dom||(this._dom=this.template),this._dom}},this.plans=new i,e.append(this.plans.dom),e},formPage:function(){var i=this,t=function(){};return t.prototype={setTarif:function(t,e){var i=t.data,a=i.mods[e];this.tarif=a,this.tarifContainer.insert(app.modules.get("html",{param:{class:"plan",style:"width: 100%; border: none; box-shadow: none;"},content:[{param:{class:"plan__heading"},content:[{param:{class:"plan__image"},content:{param:{tag:"img",attr:{src:t.data.image,alt:t.data.name}}}},{param:{class:"plan__title"},content:"Your choice: "+CFL(i.name)+" plan"}]},{param:{class:"plan__billing show",attr:{"data-mod":"year"}},content:[{param:{class:"plan__price",style:{"font-size":"50px"}},content:"Your pay: $"+a.totalPrice+"/"+a.period},"year"===e?{param:{class:"plan__period"},content:"save $"+t.getSaveYearly+" a year"}:""]},{param:{class:"plan__description show",attr:{"data-mod":"year"}},content:[vts(a.attributes.space,{name:"paragraph",content:[a.attributes.space.fileSize(!0),"<b> space</b>"]}),vts(a.attributes.projects,{name:"paragraph",content:[a.attributes.projects===1/0?"Unlimited":a.attributes.projects,LangHelp.plural.eng(" active project",a.attributes.projects)]}),vts(a.attributes.collaborators,{name:"paragraph",content:[a.attributes.collaborators," collaborators"]}),a.attributes.teams&&a.attributes.members?{name:"paragraph",content:numberMultiCompareEquals(a.attributes.teams,a.attributes.members,1/0)?"<b>Unlimited</b> Teams and Members":LangHelp.plural.eng("Team",a.attributes.teams)+" up to <b>"+LangHelp.plural.eng("Member",a.attributes.members,!0)+"</b>"}:""]}]}))},get template(){var a=this,t=app.modules.get("html"),e=t({name:"buttonRow",content:[{name:"button",param:{mod:"blue",text:"Proceed buying",attr:{type:"submit"}}},{name:"button",param:{mod:["narrow","fake"],callback:function(){i.container.toAnchor("main")},style:{"margin-left":"auto"},text:"Back to all plans",icon:"back"}}]});return t({name:"container",param:{mod:["flex","between","stretch"],style:{"padding-bottom":"100px"}},content:[{name:"col",content:[{name:"panel",param:{heading:"Confirm the following information"},content:[{name:"board",content:[t({name:"form",param:{validateMod:"change",activeActions:!0,validation:function(t){return app.modules.get("validation",t,!0)},callback:function(i){return new Promise(function(t,e){d.submit(Object.assign(i,{plan:a.tarif.fullName}),a.tarif.fullName,t)})},actions:e},content:[{name:"input",param:{name:"first_name",type:"text",callback:function(){},value:vts(User.first_name),label:"First Name",placeholder:"First Name"}},{name:"input",param:{name:"last_name",type:"text",callback:function(){},value:vts(User.last_name),label:"Last Name",placeholder:"Last Name"}},{name:"input",param:{name:"login",type:"text",callback:function(){},value:vts(User.login),label:"E-mail",placeholder:"E-mail"}},{name:"input",param:{name:"company",type:"text",callback:function(){},value:vts(User.company),label:"Company",placeholder:"Company"}},{name:"input",param:{name:"country",type:"select",settings:{options:app.serverRequest("countryList").then(function(t){return t.map(function(t){return{value:t.id,text:t.name}})}),scroll:!0,search:!0,height:300,placeholder:"Select country",value:safetyObjectAccess(User,["country","id"],!1)},value:safetyObjectAccess(User,["country","id"],!1),label:"Country",data:{label:"Country"},placeholder:"Country"}},{name:"input",param:{name:"city",type:"text",callback:function(){},value:vts(User.city),label:"City",placeholder:"City"}}]}),e]}]}]},{name:"col",content:[{name:"panel",param:{heading:"Chosen plan"}}]}]})},get tarifContainer(){return this.dom.find(".fm-col ").eq(1).find(".fm-panel__content")},get dom(){return this._dom||(this._dom=this.template),this._dom}},this.form=new t,this.form.dom},submit:function(t,a,n){app.log("submit",t),i=a,app.serverRequest("changePlan",t).then(function(t){if(app.log("changePlan",t),"function"==typeof n&&n(),t){var e=safetyObjectAccess(t,["data","id"],!1);if(!!t.status&&e)fastspring.builder.checkout(e);else if("success"===safetyObjectAccess(t,["subscriptions","0","result"],!1))User.tarif=a,app.modules.get("notify",{mod:"green",content:"Your plan was successfully changed"}),d.render(),User.refreshData();else if(t.hasOwnProperty("subscriptions")){var i=[];t.subscriptions.forEach(function(t){if("error"===t.result&&t.hasOwnProperty("error"))for(var e in t.error)i.push(t.error[e])}),i.length?app.modules.get("notify",{mod:"red",content:i.join("; ")+";"}):app.modules.get("notify",{mod:"red",content:"Something going wrong! Please, try again later"})}else app.modules.get("notify",{mod:"red",content:"FastSpring error:"+JSON.stringify(t)})}else app.modules.get("notify",{mod:"red",content:"Something going wrong! Please, try again later"})})},render:function(){this.container=app.modules.get("parallelPages",!0),this.container.addPage({anchor:"main"},this.mainPage()),this.container.addPage({anchor:"form"},this.formPage()),this.container.toAnchor("main"),$(".content").insert(this.container.dom)},header:function(){app.modules.get("header").render({navigation:{current:"/updateplan"},main:{param:{title:"Update Plan"}}})},action:function(){},die:function(){},onFSPopupClosed:function(t){if(app.log("orderReference",t),t){var e=promiseSerialExecute([app.serverRequest("subscribe",t),User.refreshData()]);i?(User.tarif=i,this.render(),app.modules.get("notify",{mod:"green",content:"Your plan was successfully changed!"}),i=null):(app.modules.get("backstage").start(),e.then(function(){this.render(),app.modules.get("notify",{mod:"green",content:"Your plan was successfully changed!"}),app.modules.get("backstage").end()}.bind(this)))}}};onFSPopupClosed=d.onFSPopupClosed.bind(d),app.pages.add({name:"updatePlan",title:"Update Plan",backstage:!0,auth:!0,expired:null,urlMatch:[/\/updateplan(\/|)/,/\/upgradeplan(\/|)/],required:["modules/header"],die:function(){},controller:function(i){return new Promise(function(t,e){d.init(i,t,e)})}})}(),function(){WorkPlace={init:function(t){var i=this;return this.method=t.param.method,this.id=app.url().path.split("/")[2],this.slashUrl="/"+("default"===this.method?"projects":"share"),Subscriber(this),this.loadData.then(function(t){if(!t||!1===t.status)return app.log("exit"),app.pages("404").init({title:"The project no longer exists"}),!1;"share"===this.method&&(t=safetyObjectAccess(t,["data","project"],{}),app.log(t)),this.data={title:safetyObjectAccess(t,["title"],"Unnamed"),description:deltaDefine(safetyObjectAccess(t,["description"],null)),date_create:app.clientTime(safetyObjectAccess(t,["date_create"],+new Date)),date_update:app.clientTime(safetyObjectAccess(t,["date_update"],+new Date)),cover:safetyObjectAccess(t,["file","filename"],!1),owner:safetyObjectAccess(t,["owner_id"],!1),owner_title:safetyObjectAccess(t,["owner_title"],!1),users:t.users||[],attaches_desc:safetyObjectAccess(t,["attaches_desc"],!1)||[]},this.data.attaches_desc=parseBadJson(t.attaches,[])||[],this.data.discussion=this.Discussion(this,0,{requestData:{pid:this.id},requestUrl:"flowmapDiscussionGet"}),this.data.attaches=this.Attaches(this,safetyObjectAccess(t,["files"],!1)||[],{get sendData(){return{pid:i.id}}}),this.socket=app.modules.get("socket","/flowmap"),this.socket.join(this.id),this.header(),this.bind(),Object.values(this.modules).forEach(function(t){t.api.init(this)}.bind(this)),this.inject();var e=this.defineModuleByUrl;"flowmap"!==e||app.url().hash||(e=User.getUserSettings(["flowmap",this.id,"lastOpenedTool"],"flowmap")),e?this.implementModule(e,!0):app.pages("404").init({title:"The project no longer exists"})}.bind(this))},update:function(e){var i=this.inProjectUrl,t=this.defineModuleByUrl;this.modal&&(this.modalRequest.hash=!1,this.modal.close()),this.modules[t]===this.currentModule?this.getModule(t).then(function(t){t.update(e,i)}):this.implementModule(t),"info"===i.hash&&this.openSelfModal()},get:function(t){return this.data[t]},set:function(t,e){var i={};for(var a in"object"==typeof t?i=t:i[t]=e,i)(function(t,e){if(!equals(this.data[t],e)){switch(t){case"title":this.subscriber("add",{event:t,data:{title:e}}),$("header.header").find(".header__heading .header__title").text(e),app.title(e);break;case"cover":e=e.filename,this.subscriber("add",{event:t,data:e});break;case"discussion":return this.get("discussion")[e.event](e.target,e.data),this.subscriber("add",{event:t,data:e}),!1;case"description":this.subscriber("add",{event:t,data:e});break;case"attaches":return Array.isArray(e)||(this.get("attaches")[e.event](e.target,e.data),this.subscriber("add",{event:t,data:e})),!1;case"users":$("header").find(".fm-members").replaceWith(app.modules.get("html",{name:"projectMembers",param:{style:{"margin-right":"40px"},id:this.id,list:e,short:!0,cover:"coverLight"}}));break;case"attaches_desc":this.subscriber("add",{event:t,data:e})}this.data[t]=e}}).bind(this)(a,i[a])},change:function(t,e){var i={};for(var a in"object"==typeof t?i=t:i[t]=e,i)(function(t,e){if(this.set(t,e),"default"===flowmap.method){switch(t){case"title":app.serverRequest("updateproject",{id:this.id,title:e});break;case"cover":app.serverRequest("updateproject",{id:this.id,file_id:e.id});break;case"description":app.serverRequest("updateproject",{id:this.id,description:e});break;case"attaches_desc":app.serverRequest("updateproject",{id:this.id,attaches:e})}var i={event:t,target:"project",data:e};this.socket.trigger("change",i)}}).bind(this)(a,i[a])},get ownerName(){return User.fullName.call(app.projects.getUser(this.get("owner")))||this.get("owner_title")||"DELETED USER"},get loadData(){return"default"==this.method?this.loadedData=app.serverRequest("getproject",{id:this.id}):"share"==this.method?this.loadedData=app.serverRequest("getShareData",{id:this.id}):this.loadedData=Promise.resolve(!1),this.loadedData},get inProjectUrl(){var t=app.url();return"default"===this.method?t.path=t.path.replace(/\/projects\/\d+/,"").split("/").filter(function(t){return t.length}):"share"===this.method&&(t.path=t.path.replace(/\/share\/(\S+?)(\/|$)+/,"").split("/").filter(function(t){return t.length})),t},get defineModuleByUrl(){return ObjectFindKey(this.modules,function(t){return t.descriptor.urlMatch(this.inProjectUrl)},this)},get modules(){return safetyObjectAccess(app,["workplace","modules"],{})},getModule:function(t){return safetyObjectAccess(this,["modules",t,"api","get"],function(){return Promise.reject("404")})()},get accessibility(){var e=this.get("owner");return"default"===this.method&&(e===User.id||!!app.teams.lastListData.find(function(t){return t.owner_id===e}))},implementModule:function(t,e){this.pages.toAnchor(t),this.tabController(t,!0);var i=this.modules[t],a=this.currentModule;if(i==a)return!1;var n=$("body").loader("backstage",{autoLoader:!0,fastInject:!0,loaderInterval:50,style:{top:"98px",bottom:0,height:"auto"}});a&&a.api.get().then(function(){a.api.implement(!1)}),this.currentModule=i,this.getModule(t).then(function(){app.subscriber("add",{scope:app,event:"workplaceToolChange"}),i.api.implement(!0,!!e).then(function(){setTimeout(n.done.bind(n),300)}),User.setUserSettings(["flowmap",this.id,"lastOpenedTool"],t)}.bind(this))},bind:function(){var e=this;this.projectSubscriberKey=app.projects.subscriber("on",{scope:this.id},function(t){t.forEach(function(t){"update"===t.event&&e.set(t.data)})})},unbind:function(){app.projects.subscriber("off",this.projectSubscriberKey)},header:function(){var e=this,t=[{name:"button",param:{text:"Project info",title:"Project info",mod:["blue","narrow"],icon:"project_info",callback:this.openSelfModal.bind(this)}}];"default"===this.method&&(t.unshift({name:"projectMembers",param:{style:{"margin-right":"40px"},id:this.id,list:this.get("users"),short:!0,cover:"coverLight"}}),t.push({name:"button",param:{addClass:"js-export",title:"Export",mod:["white","narrow","square"],icon:"export",callback:this.export.bind(this)}},{name:"button",param:{addClass:"js-share",title:"Share",mod:["white","narrow","square"],icon:"share",callback:function(){e.share()}}})),app.modules.get("header").render({navigation:{},main:{param:{title:e.get("title")},content:[{name:"headerPanel",param:{mod:["absolute","center"]},content:[{name:"tab",param:{controller:function(t){e.tabController=t},callback:function(t){e.implementModule(t)}},content:this.modules.mapToArray(function(t,e){var i=t.descriptor;return{name:"tabItem",param:{mod:valueOrFunction(i.active,[this])?"":"disabled",note:valueOrFunction(i.description,[this]),data:{value:e},state:!1},content:i.name}})}]},{name:"headerPanel",param:{mod:"right"},content:t}]}})},share:function(){var t=app.url();app.modules.get("modalTemplates","shareProject",{id:this.id,path:t.path.split("/").slice(3),hash:t.hash})},export:function(){var e,d=this,t=app.modules.get("modal",{mod:["side","small","right","transparent"]}),i=app.modules.get("executingList")(),a=app.modules.get("parallelPages")(),h=app.modules.get("html"),n=[],u="",p=h({name:"button",param:{tag:"a",mod:["white","long"],text:"Generate and Preview"}}),m=h({name:"button",param:{tag:"a",mod:["blue","long"],text:"Export as ...",icon:"export",class:"disabled",callback:function(){}}}),f=h({param:{class:"fm-preview",event:"mouseup mousedown click",callback:function(t){t.stopPropagation()}},content:{param:{class:"fm-preview__placeholder",callback:function(t){p.click()}},content:{name:"emptyPlaceholder",param:{template:"exportEmpty",active:!0}}}}),g=function(t){t&&!e?e=m.loader("button"):!t&&e&&(e.done(),e=null)},v=function(t){m.find(".button__text").text(t)},b=function(t,e,i){m.attr("href",t),m.attr("download",i||WorkPlace.get("title")+"."+e)},_=WorkPlace.getModule("userflow").then(function(t){return t.list.map(function(t){return{value:t.id,text:t.title}})}),y=_.then(function(){return WorkPlace.getModule("userflow").then(function(t){return t.currentId||safetyObjectAccess(t,["list",0,"id"],!1)||!1})});[{name:"Pdf",content:function(n){var e,t=function(){var i=f.children(),a=f.loader("blockLight"),t=e.serializeJson();g(!0),s.pdf(t,console.log).then(function(t){if(u===n){i.remove();var e=$("<iframe>");f.append(e),b(t,"pdf"),e.get(0).onload=function(){m.removeClass("disabled"),setTimeout(function(){a.done(),g(!1)},100)},e.attr("src",t)}}).catch(function(t){app.log(t),i.remove(),a.done(),g(!1)})},i=function(){m.addClass("disabled"),e.find('input[name="page_descr"]').prop("checked")||e.find('input[name="page_structure"]').prop("checked")?e.find('input[name="empty_pages"]').parents(".input").removeClass("disabled"):e.find('input[name="empty_pages"]').prop("checked",!0).parents(".input").addClass("disabled")};return e=h({name:"board",param:{style:{"padding-bottom":0}},content:[{name:"form",param:{style:{"margin-bottom":0},callback:function(t){t.preventDefault()}},content:[{name:"formStack",param:{mod:"wide",heading:"Document Layout"},content:[{name:"input",param:{name:"project_descr",label:"Add Project Description",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:i}},{name:"input",param:{name:"project_structure",label:"Add Project Structure",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:i}},{name:"input",param:{name:"project_name",label:"Add Project Name",description:"Adds the project name to the upper-left corner of the document",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:i}},{name:"input",param:{name:"page_numbers",label:"Add Page Numbers",description:"Adds page numbers to the lower left corner of the page",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:i}},{name:"input",param:{name:"date",label:"Add Document Creation Date",description:"Adds to the upper left corner of the document the current date of the project export",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:i}},{name:"input",param:{name:"landscape",label:"Landscape orientation",checked:!1,value:"true",mod:["checkbox"],type:"checkbox",callback:i}},{name:"input",param:{name:"size",label:"A4 Page format",checked:!0,value:"A4",mod:["radio"],type:"radio",callback:i}},{name:"input",param:{name:"size",label:"A3 Page format",checked:!1,value:"A3",mod:["radio"],type:"radio",callback:i}}]},{name:"formPanel",param:{title:"Include Sitemap",checked:!0,name:"sitemap",mod:["paddingbig"],style:{"margin-left":"-20px","margin-right":"-20px"},value:!0},content:[{name:"formStack",param:{mod:"wide"},content:[{name:"input",param:{name:"sitemap_image",label:"Add Sitemap Image",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",button:{name:"buttonStack",param:{name:"angle",mod:"compact",value:0,callback:function(t){e.find(".js-sitemap-rotation input").val(t.value),i()}},content:[{name:"button",param:{mod:["square","white"],icon:"sitemap_horisontal",data:{value:0},callback:function(t,e,i){i.preventDefault()}}},{name:"button",param:{mod:["square","white"],icon:"sitemap_vertical",data:{value:1},callback:function(t,e,i){i.preventDefault()}}}]},callback:function(){i()}}},{name:"input",param:{mod:["hidden"],type:"hidden",class:"js-sitemap-rotation",name:"sitemap_image_rotation",value:"0"}},{name:"input",param:{name:"page_descr",label:"Add Pages Description",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:function(){i()}}},{name:"input",param:{name:"page_structure",label:"Add Pages Structure",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:i}},{name:"input",param:{name:"empty_pages",label:"Include Empty Pages",checked:!1,value:!0,mod:["checkbox"],type:"checkbox",callback:i}}]}]},{name:"formPanel",param:{title:"Include User FLow",checked:!1,name:"userflow",mod:["paddingbig"],style:{"margin-left":"-20px","margin-right":"-20px"},value:!0},content:[{name:"formStack",param:{mod:"wide"},content:[{name:"input",param:{class:"",type:"select",name:"userflow_id",callback:i,placeholder:"Select Userflow",value:_.then(function(t){return t.map(function(t){return t.value})}),settings:{placeholder:"Select Userflow",multiple:!0,options:_}}},{name:"input",param:{name:"userflow_image",label:"Add User Flow Image",checked:!0,value:!0,mod:["checkbox"],type:"checkbox",button:{name:"buttonStack",param:{mod:"compact",value:0,name:"angle",callback:function(t){e.find(".js-useflow-rotation input").val(t.value),i()}},content:[{name:"button",param:{mod:["square","white"],icon:"sitemap_horisontal",data:{value:0},callback:function(t,e,i){i.preventDefault()}}},{name:"button",param:{mod:["square","white"],icon:"sitemap_vertical",data:{value:1},callback:function(t,e,i){i.preventDefault()}}}]},callback:i}},{name:"input",param:{mod:["hidden"],type:"hidden",class:"js-useflow-rotation",name:"useflow_image_rotation",value:0}},{name:"input",param:{name:"userflow_descr",label:"Add User Flow Description",checked:!0,value:!0,mod:["checkbox"],type:"checkbox",callback:i}}]}]}]}]}),a.subscriber("on",{event:"slide",target:n},function(){f.addClass("active"),u=n,p.off("click").on("click",t).removeClass("disabled"),m.addClass("disabled"),v("Export as .pdf")}),e}},{name:"Image",content:function(o){var s,t=function(){var i=f.children(),a=f.loader("blockLight"),n=s.serializeJson();n.hasOwnProperty("width")&&(n.width=1*n.width.replace(/\D/g,"")),n.hasOwnProperty("height")&&(n.height=1*n.height.replace(/\D/g,"")),g(!0),d.getModule(n.entity).then(function(t){return t.export(n.extension,n,console.log)}).then(function(t){if(u===o){var e=new Image;f.append(e),b(t.img,n.extension),e.onload=e.onerror=function(){m.removeClass("disabled"),setTimeout(function(){i.remove(),a.done(),g(!1)},100)},e.src=t.img,"false"===n.size&&(s.find(".realsize .input__description").text(t.width+"x"+t.height+" px"),s.find(".js-custom-size-input").data("ready",!0),s.find('.js-custom-size input[name="width"]').data({max:1/0,k:t.width/t.height}),s.find('.js-custom-size input[name="height"]').data({max:1/0,k:t.height/t.width}),s.find(".js-custom-size-input").toggleClass("disabled",!("png"===n.extension&&s.find(".js-custom-size-input").data("ready"))),s.find(".js-custom-size").toggleClass("disabled",!(toBoolean(n.size)&&"png"===n.extension&&s.find(".js-custom-size input").data().hasOwnProperty("k"))))}}).catch(function(t){app.log(t),i.remove(),a.done(),g(!1)})},r=function(){m.addClass("disabled");var t=s.serializeJson();s.find(".js-userflow_id").toggleClass("disabled","flowmap"===t.entity),s.find(".js-export-flowmap-only").toggleClass("disabled",!("flowmap"===t.entity)),"svg"===t.extension&&s.find('input[name="size"][value="false"]').prop("checked",!0),s.find(".js-custom-size-input").toggleClass("disabled",!("png"===t.extension&&s.find(".js-custom-size-input").data("ready"))),s.find(".js-custom-size").toggleClass("disabled",!(toBoolean(t.size)&&"png"===t.extension&&s.find(".js-custom-size input").data().hasOwnProperty("k")))};function c(t){var e=0;if(document.selection){t.focus();var i=document.selection.createRange();i.moveStart("character",-t.value.length),e=i.text.length}else(t.selectionStart||"0"==t.selectionStart)&&(e=t.selectionStart);return e}function l(t,e){if(null!=t)if(t.createTextRange){var i=t.createTextRange();i.move("character",e),i.select()}else t.selectionStart?(t.focus(),t.setSelectionRange(e,e)):t.focus()}var e=function(t){if(!(t.metaKey||t.shiftKey||t.ctrlKey)&&(t.charCode<48||57<t.charCode)&&[8,13,9].indexOf(t.charCode)<0&&0!=t.charCode)return t.preventDefault(),!1;var e=c($(this).get(0)),i=$(this).val().replace(/\D/g,"").length;i<e&&l($(this).get(0),i)};return s=h({name:"board",content:[{name:"heading",content:"Export as image"},{name:"form",content:[{name:"formStack",param:{},content:[{name:"input",param:{name:"entity",label:"Sitemap",checked:"flowmap"===WorkPlace.currentModule.key,value:"flowmap",mod:["radio"],type:"radio",events:"change",callback:r}},{name:"input",param:{name:"entity",label:"Userflow",checked:"userflow"===WorkPlace.currentModule.key,value:"userflow",mod:["radio"],type:"radio",events:"change",callback:r}},{name:"input",param:{class:"js-userflow_id"+("userflow"===WorkPlace.currentModule.key?"":" disabled"),type:"select",name:"id",mod:["narrow","short"],callback:r,placeholder:"Select Userflow",value:y,settings:{options:_}}}]},{name:"formStack",param:{heading:"Format"},content:[{name:"input",param:{name:"extension",class:"js-export-ext-svg",label:"SVG",checked:!0,value:"svg",mod:["radio"],type:"radio",events:"change",callback:function(){v("Export as .svg"),r()}}},{name:"input",param:{name:"extension",class:"js-export-ext-png",label:"PNG",checked:!1,value:"png",mod:["radio"],type:"radio",events:"change",callback:function(){v("Export as .png"),r()}}}]},{name:"formStack",param:{heading:"Settings"},content:[{name:"input",param:{name:"transparent",label:"Transparent Background",checked:!1,value:"true",mod:["checkbox"],type:"checkbox",callback:r}},{name:"input",param:{name:"title",label:"Project Title",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:r}},{name:"input",param:{name:"date",label:"Document Creation Date",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:r}},{name:"input",param:{name:"cover",label:"Page Cover",class:"js-export-flowmap-only",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:r}},{name:"input",param:{name:"labels",label:"Page Labels",class:"js-export-flowmap-only",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:r}}]},{name:"formStack",param:{heading:"Image size"},content:[{name:"input",param:{name:"size",label:"Original size",description:"",class:"realsize",checked:!0,value:"false",mod:["radio"],type:"radio",callback:r}},{name:"input",param:{name:"size",label:"Custom size",class:"js-custom-size-input",checked:!1,value:"true",mod:["radio"],type:"radio",callback:r}},{name:"inputStack",param:{class:"js-custom-size disabled",separator:"lock",event:"input change",callback:function(t){var e=Math.min($(this).val().replace(/\D/g,""),$(this).data("max")),i=(e+"").length,a=$(this).attr("name"),n=s.find('input[name="'+("width"===a?"height":"width")+'"]');($(this).val(e+(i?" px":"")),i)?(i<c($(this).get(0))&&l($(this).get(0),i),n.val(Math.round(e*n.data("k"))+" px")):n.val("");r()}},content:[{name:"input",param:{name:"width",label:"Width",checked:!1,mod:["narrow"],event:"keypress",callback:e}},{name:"input",param:{name:"height",label:"Height",checked:!1,mod:["narrow"],event:"keypress",callback:e}}]}]}]}]}),a.subscriber("on",{event:"slide",target:o},function(){f.addClass("active"),u=o,p.off("click").on("click",t).removeClass("disabled"),s.find(".js-custom-size-input").addClass("disabled"),r(),v("Export as ."+s.find('input[name="extension"]').serializeArray()[0].value)}),s}},{name:"Doc",content:function(t){var i,e=function(){var t=i.serializeJson();t.id=d.id;var e="/flowmapp/export/doc?"+t.mapToArray(function(t,e){return e+"="+t}).join("&");b(e,"docx")};return i=h({name:"board",content:[{name:"heading",content:"Export to .docx"},{name:"form",content:[{name:"formStack",param:{heading:"Description"},content:[{name:"input",param:{name:"project_descr",label:"Add Project Description",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:function(){e()}}},{name:"input",param:{name:"page_descr",label:"Add Pages Description",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:function(){e()}}}]},{name:"formStack",param:{heading:"Document Layout"},content:[{name:"input",param:{name:"project_name",label:"Project Name",description:"Adds the project name to the upper-left corner of the document",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:function(){e()}}},{name:"input",param:{name:"page_numbers",label:"Page Numbers",description:"Adds page numbers to the lower left corner of the page",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:function(){e()}}},{name:"input",param:{name:"date",label:"Document Creation Date",description:"Adds to the upper left corner of the document the current date of the project export",checked:!0,value:"true",mod:["checkbox"],type:"checkbox",callback:function(){e()}}}]}]}]}),a.subscriber("on",{event:"slide",target:t},function(){f.removeClass("active"),p.addClass("disabled"),m.removeClass("disabled"),u=t,v("Export as .docx"),e()}),i}}].forEach(function(t,e){a.addPage({anchor:t.name},t.content(t.name)),n.push({name:"tabItem",param:{data:{value:t.name},state:1==e},content:t.name})});var o=h([{param:{class:"fm-flowmap-heading fm-flowmap-heading--transperant"},content:{name:"heading",param:{mod:"sub"},content:"Export"}},{param:{class:"fm-flowmap-content fm-flowmap-content--inside",style:{"padding-bottom":143}},content:[{name:"panel",param:{heading:h({name:"tab",param:{callback:function(t){a.toAnchor(t)}},content:n}),mod:["stretch","white"]},content:a.dom},{param:{class:"fm-flowmap-content__action"},content:[p,m]}]}]);t.dom.append(f),a.toIndex(1),i.add({fn:a.die}),t.insert(o),t.open(),t.subscriber("on",{event:"close"},function(){f.removeClass("active")})},openSelfModal:function(){var n=this;this.openModal({hash:"info",heading:{edit:this.accessibility,value:this.get("title"),callback:function(t){n.change(t)},change:function(e){var t=n.subscriber("on",{event:"title"},function(t){t.map(function(t){return t.data}).forEach(e)});return{ctx:n.subscriber,fn:n.subscriber,arg:["off",t]}}},content:[{name:"Info",modules:[{name:"description",data:{cover:this.get("cover"),attaches:this.get("attaches"),attachesList:this.get("attaches_desc"),description:this.get("description"),owner:this.ownerName,creationDate:formatDate(this.get("date_create"),"M d.yyyy")},settings:{formIdPrefix:["project",this.id,"info"].join("/"),editable:this.accessibility,cover:!0,coverSize:[140,92],coverEditMod:"file",coverEdit:function(t,a){return new Promise(function(e,i){-1<["jpeg","jpg","png"].indexOf(t.name.split(".").pop())&&t.size<=105e4?app.upload({file:t,url:"setcover",progress:function(t){a.state(t)},done:function(t){(t=JSON.parse(t)).status&&(n.change("cover",t.file),e()),i()},error:function(t){i()}}):(app.modules.get("alert",{type:"alert",heading:"Can't upload this file",content:"Use formats .jpg .png. The size of the file does not more 1Mb. Best resolution 278⨯184",buttons:["Ok"]},function(t){}),i())})},change:function(t,e){return{ctx:n.subscriber,fn:n.subscriber,arg:["off",n.subscriber("on",{event:e},t)]}},callback:function(t){n.change.apply(n,t)}}},"default"===this.method&&{name:"discussion",data:{edit:"default"===this.method,get:function(){return n.get("discussion").get.then(function(t){return t.forEach(function(t){t.accessibility=n.get("owner")==User.id||t.from_id==User.id}),t}.bind(n))},formIdPrefix:["sitemap",flowmap.id,"info"].join("/")},settings:{change:function(t){return{ctx:n.subscriber,fn:n.subscriber,arg:["off",n.subscriber("on",{event:"discussion"},t)]}},remove:function(t){return app.serverRequest("flowmapDiscussionDelete",Object.assign({},t,{pid:n.id}))},edit:function(t){return app.serverRequest("flowmapDiscussionEdit",Object.assign({},t,{pid:n.id}))},post:function(t){return app.serverRequest("flowmapDiscussionSend",Object.assign({},t,{pid:n.id}))},callback:function(t){n.change("discussion",t)}}}]},"default"===this.method?{name:"Files",modules:[{name:"files",data:{list:function(){return n.getModule("flowmap").then(function(t){var i=[];t.cardsList.forEach(function(t){var e=t.get("attaches").list;e.length&&i.push({id:t.id,title:t.get("title"),list:e})});var e=n.get("attaches").list;return e.length&&i.push({id:"project",title:n.get("title"),list:e}),i})}},settings:{mod:"group",remove:function(t){app.serverRequest("flowmapUnAttach",{file_id:t})},callback:function(t){n.change.apply(n,t)},change:function(t){return{ctx:n.subscriber,fn:n.subscriber,arg:["off",n.subscriber("on",{event:"pageStructure"},t)]}}}}]}:"",this.accessibility?{name:"Backup",modules:[{name:"backup",data:{},settings:{remove:function(t){app.serverRequest("flowmapUnAttach",{file_id:t})},callback:function(t){n.change.apply(n,t)},change:function(t){return{ctx:n.subscriber,fn:n.subscriber,arg:["off",n.subscriber("on",{event:"pageStructure"},t)]}}}}]}:""]})},openModal:function(t){if(this.modal)return!1;var c=this,l=app.modules.get("html"),d=function(){return Promise.all([c.getModule("flowmap"),c.getModule("userflow")]).then(function(t){var e=t[0],i=t[1],a={list:[]},n=function(t){};return a.list.push({title:"Sitemap",content:l({name:"flowmapTree",param:{flowmap:e,autoHeight:!0,maxHeight:256,height:256,callback:function(t,e){"select"===t&&e&&n([location.origin,"projects",c.id+"#"+e].join("/"))}}})}),i.list.length&&a.list.push({title:"User Flows",content:{name:"table",param:{mod:["striped","pointer","hover"]},content:i.list.map(function(t){return{name:"row",param:{callback:function(){n([location.origin,"projects",c.id,"userflow",t.id].join("/"))}},content:[[{name:"icon",param:{name:"userflow",style:{"margin-right":10}}},{name:"paragraph",content:t.title}]]}})}}),a.interface=function(t){"function"==typeof t&&(n=t)},a})},e=app.modules.get("modal",{mod:["side","right","transparent","loader","durable"]}),o=app.modules.get("parallelPages")(),h=app.modules.get("executingList",!0),i=e.dom.loader("modal"),n={heading:function(e){var i,a=!1,n=l({param:{class:"fm-flowmap-heading"},content:[{param:{class:"fm-flowmap-heading__title"},content:{name:"input",param:{mod:["autowidth","transperant","biggest","black"],type:"autowidth",name:"title",value:e.value||"Unnamed",bind:e.edit?[{event:"focusout",callback:function(){setTimeout(function(){a&&i.submit()},100)}},{event:"keydown",callback:function(t){13===t.keyCode?i.submit():27===t.keyCode&&($(this).blur(),i.reset())}}]:[]}}},{param:{class:"fm-flowmap-heading__tools"},content:{name:"buttonStack",param:{fixed:!0},content:{name:"button",param:{mod:["white","square"],alt:"share",icon:"share",callback:function(){c.share()}}}}},{param:{class:"fm-flowmap-heading__actions"},content:{name:"buttonRow",content:[{name:"link",param:{attr:{type:"reset","data-form-role":"actions"},callback:function(){i.reset()}},content:"Cancel"}]}}]});i=app.modules.get("form",{form:n,settings:{fixed:!e.edit,easeEdit:!0,instantChangeValues:!1,freeze:!0,selfFreeze:!0,freezeDependencies:!0}});var o={title:e.value};return e.edit&&i.subscriber("on",function(t){t.forEach(function(t){switch(t.event){case"freeze":a=!t.state,n.toggleClass("edit",!t.state);break;case"submit":"function"==typeof e.callback&&(equals(o,t.data)||(o=t.data,e.callback(t.data)))}})}),"function"==typeof e.change&&h.add(e.change(i.setValue)),n},description:function(a,n){var e=function(){"function"==typeof n.callback&&n.callback(1===arguments.length?[arguments[0]]:Array.apply(null,arguments))},o={init:function(){return this.bind(),this.dom},bind:function(){var e=this;"function"==typeof n.change&&h.add(n.change(function(t){t.forEach(function(t){e.dom.find(".cover").setBackground(t.data)})},"cover"))},get template(){var t=l({param:{class:"fm-flowmap-block__cover"},content:{param:{class:"cover",style:{width:n.coverSize[0],height:n.coverSize[1]}},content:{param:{class:"cover__button",style:!n.editable&&{display:"none"}},content:{name:"button",param:{mod:["narrow","white"],text:"Change",tag:"div",callback:"internal"===n.coverEditMod&&n.coverEdit},content:"file"===n.coverEditMod?{name:"input",param:{mod:["fill","invisiable","pointer"],attr:{accept:"image/jpeg,image/png"},type:"file",events:"change",callback:function(){var t=this.get(0),e=$(this).parents(".cover"),i=t.files[0],a=e.loader("coverLoad");e.addClass("cover--loading"),n.coverEdit(i,a).then(function(){a.done()},function(){a.done()}),$(t).val("")}}}:[]}}}});return a.cover&&t.find(".cover").setBackground(a.cover),t},get dom(){return this._dom||(this._dom=this.template),this._dom}},s={init:function(){return this.bind(),this.dom},bind:function(){var e=this;"function"==typeof n.change&&h.add(n.change(function(t){t.forEach(function(t){e.dom.trigger("value",{value:t.data})})},"label"))},get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){return l({name:"flowmapLabel",param:{get list(){return a.labelList.map(function(t){return Object.assign({editable:"none"!=t.id&&(!!t.project_id||c.get("owner")===User.id)},t)})},"max-width":430,rerender:!0,multitudeLimit:6,multitude:!0,lonerList:["none"],defaultValue:"none",newLabel:function(i){return app.serverRequest("addLabel",Object.assign(i,{project_id:c.id})).then(function(e){return c.getModule("flowmap").then(function(t){return t.change("labelList",t.labelList.concat(Object.assign(i,{id:e,project_id:c.id,text:i.title}))),{value:e,project_id:c.id}})})},changeLabel:function(a){return app.serverRequest("updateLabel",a).then(function(t){return c.getModule("flowmap").then(function(t){var e=flowmap.labelList.slice(0),i=e.find(function(t){return t.id==a.id});a.project_id=a.project_id.toString()?a.project_id:null,i?(i.color=a.color,i.text=a.title):e.push({color:a.color,text:a.title,id:a.id,project_id:a.project_id||null}),flowmap.change("labelList",e)})})},removeLabel:function(e){return c.getModule("flowmap").then(function(t){app.serverRequest("removeLabel",{id:e}),t.change("labelList",t.labelList.filter(function(t){return t.id!==e}))})},callback:function(t){e("label",t)},value:a.label}}).css({"margin-left":"auto","z-index":20})}},r={init:function(){return this._value=n.externalLink,setTimeout(function(){this.applyFavicon()}.bind(this),100),this.dom},validUrl:function(t){return l.getExternalLink(t||this.value)},applyFavicon:function(){var e=this.link.get(0).origin;this.favicon.css("background-image",""),this.favicon.removeClass("active"),app.img(e+"/favicon.ico").then(function(t){equals(e,this.link.get(0).origin)&&this.favicon.addClass("active").setBackground(t)}.bind(this))},set editState(t){equals(this._editState,t)||(this._editState=t,this.container.toggleClass("fm-flowmap-block__externallink--edit",t),this.dom.toggleClass("edit",t),t?this.input.val(this.value).inputFocus(!0):this.container.toggleClass("fm-flowmap-block__externallink--empty",this.empty))},get editState(){return this._editState||!1},get empty(){return 0===this.value.length},get value(){return this._value||""},set value(t){equals(this._value,t)||(this._value=t,this.link.attr("href",this.validUrl(t)).text(t),this.applyFavicon(),e(n.externalLinkKey||"externalLink",t))},get favicon(){return this.dom.find(".externallink__favicon")},get input(){return this.dom.find(".externallink__input input")},get container(){return this.dom.find(".fm-flowmap-block__externallink")},get link(){return this.dom.find(".externallink__link")},get template(){var e=this;return l({param:{class:"fm-flowmap-block__heading fm-flowmap-block__heading--independent"},content:{param:{class:"fm-flowmap-block__externallink"+(this.empty?" fm-flowmap-block__externallink--empty":"")},content:[{param:{class:"externallink__icon",callback:function(){e.editState||(e.editState=!0)}},content:{name:"icon",param:{name:"link",cover:!0}}},{param:{class:"externallink__block externallink__block--edit"},content:[{param:{class:"externallink__input",callback:function(){}},content:{name:"input",param:{mod:["transperant","fullwidth","nopadding"],placeholder:"Add Page Card Main Link",bind:{keydown:function(t){13===t.keyCode?(e.value=$(this).val(),e.editState=!1):27===t.keyCode&&(e.editState=!1)},focusout:function(){e.editState&&(e.value=$(this).val(),e.editState=!1)}}}}},{name:"link",param:{class:"externallink__action",callback:function(){e.editState=!1}},content:"Cancel"}]},{param:{class:"externallink__block externallink__block--view"},content:[{param:{class:"externallink__favicon",callback:function(){e.link.click()}}},{name:"link",param:{class:"externallink__link",target:"_blank",href:this.validUrl(this.value)},content:this.value},{name:"button",param:{class:"externallink__edit",mod:["fake","square"],icon:"edit",callback:function(){e.editState=!0}}}]},{param:{class:"externallink__placeholder",callback:function(){e.editState=!0}},content:"Add Main Link"}]}})},get dom(){return this._dom||(this._dom=this.template),this._dom}};return{init:function(){return this.attachMod=a.attaches&&a.attachesList,this.attachMod&&(this.attachZone=new u(a.attaches,a.attachesList,{id:n.formIdPrefix+"descriptionattach",localSave:!0})),this.form=app.modules.get("form",{form:this.dom.find(".fm-flowmap-block"),actions:this.dom.find(".fm-flowmap-block__actions"),settings:{id:n.formIdPrefix+"description",clickOutSide:!0,fixed:!n.editable,easeEdit:!0,escAction:!0,localSave:"default"==c.method,strict:!0,shortCut:!0,instantChangeValues:!1,freeze:!0,freezeDependencies:!0,selfFreeze:!0}}),this.bind(),this.oldValue=this.serialize,this.dom},get edit(){return this._edit||!1},set edit(t){equals(t,this.edit)||(this._edit=t,this.dom.find(".fm-flowmap-block").toggleClass("fm-flowmap-block--edit",t),this.form.freeze(!t),this.attachZone&&(this.attachZone.edit=t),t&&app.subscriber("add",{scope:app,event:"sitemapModalEdit"}))},get serialize(){var t={};return t.description=this.form.serialize().description,this.attachZone&&(this.attachZone.save(),t.attaches_desc=this.attachZone.value.slice()),t},submit:function(){var t=this.serialize;equals(t,this.oldValue)||(this.oldValue=t,e(t))},bind:function(){var e=this;"function"==typeof n.change&&(h.add(n.change(function(t){t.map(function(t){return t.data}).forEach(function(t){e.form.setValue({description:t}),e.oldValue=e.serialize})},"description")),h.add(n.change(function(t){t.map(function(t){return t.data}).forEach(function(t){e.attachZone&&(e.attachZone.setValue(t),e.oldValue=e.serialize)})},"attaches_desc"))),this.form.subscriber("on",function(t){t.forEach(function(t){switch(t.event){case"freeze":e.edit=!t.state;break;case"submit":e.submit()}})}),this.attachZone&&(this.attachZone.subscriber("on",{event:"upload"},function(){e.edit=!0}),this.attachZone.subscriber("on",{event:"edit"},function(t){t.forEach(function(t){t.data&&(e.edit=!0)})}))},get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){var e=this,t=l({param:{class:"fm-flowmap-block__content",attr:!(!a.owner||!a.creationDate)&&{"data-footnote":"Created by "+a.owner+" on "+a.creationDate}},content:[{param:{class:"fm-flowmap-block__row"},content:[{name:"quill",param:{value:a.description,attr:{"data-form-role":"input","data-name":"description"},style:{"max-width":n.cover&&safetyObjectAccess(n,["coverSize",0],!1)?"calc( 100% - "+(n.coverSize[0]+10)+"px )":""},freezePlaceholder:!!n.editable&&"+ Add description",placeholder:n.editable?"Write a description...":"No description",mod:"toggle",param:["file"],internalLink:d}},n.cover?o.init():""]},this.attachZone?this.attachZone.dom:""]}),i=l({param:{class:"fm-flowmap-block"},content:[{param:{class:"fm-flowmap-block__actions"},content:{name:"buttonRow",content:[{name:"button",param:{mod:["blue","narrow"],attr:{type:"submit","data-form-role":"actions"},text:"Save"}},{name:"link",param:{attr:{type:"reset","data-form-role":"actions"},callback:function(){}},content:"Cancel"}]}},void 0!==n.externalLink?r.init():"",t]});return l({param:{class:"fm-flowmap-section"},content:[{param:{class:"fm-flowmap-section__head"},content:[{param:{class:"fm-flowmap-section__title",tag:"h4"},content:"Description"},n.editable?{name:"menu",param:{options:{edit:"Edit"},settings:{get mouseleave(){return e.dom},mouseleaveDelay:3e3,width:92},callback:function(t){switch(t){case"edit":e.edit=!0}}}}:"",n.labels?s.init():""]},{param:{class:"fm-flowmap-section__content"},content:i}]})}}.init()},structure:function(a,o){var i=function(){"function"==typeof o.callback&&o.callback(1===arguments.length?[arguments[0]]:Array.apply(null,arguments))},t=function(t){var e=this;this.list=t.map(function(t){return new n(e,t)}),this.view(),this.bind()};t.prototype={view:function(){var i=this;this.list.forEach(function(t,e){t.index=e,i.container.append(t.dom)})},drag:function(a){a.drag=!0,forceReflow(a.dom);var t=function(t){var e=10;t?(this.list.forEach(function(t){t.top=e,t.height=t.dom.outerHeight()+(t.edit?50:0),t.center=Math.ceil(t.top+t.height/2),e+=t.height+10}),this.container.css({position:"relative",height:e-10}),this.list.forEach(function(t){t.dom.find(".js-index").addClass("hide"),t.dom.css({position:"absolute",left:0,width:"100%",margin:0,top:0,transform:"translate(0px, "+t.top+"px)",transition:"none","z-index":10})}),forceReflow(this.container),this.list.forEach(function(t){t.drag?a.dom.css({transition:"none","z-index":100}):t.dom.css("transition","")})):(a.dom.css("transition",""),forceReflow(a.dom),a.drag=!1,h.css({opacity:0}),this.list.forEach(function(t){t.dom.css({left:0,top:0,transform:"translate(0px, "+e+"px)","z-index":10}),e+=t.height+10,delete t.height,delete t.top,delete t.center}),this.container.css({position:"relative",height:e-10}),setTimeout(function(){h.remove(),this.list.forEach(function(t){t.dom.css({position:"",left:"",width:"",margin:"",top:"","z-index":"",transform:"",transition:"none"})}),this.container.removeAttr("style"),this.view(),forceReflow(this.container),this.list.forEach(function(t){t.dom.find(".js-index").removeClass("hide"),t.dom.removeAttr("style")})}.bind(this),160))}.bind(this);t(!0);var n=this.list,o=cursorX,s=cursorY,r=a.top,c=0,l=0,d=(a.index,a.index),h=$('<div class="fm-flowmap-block fm-flowmap-block--shadow"></div>').css({position:"absolute",left:0,top:0,width:"100%",height:a.height,margin:0,transform:"translate(0px, "+r+"px)","z-index":5}).appendTo(this.container),u=function(){var i=10;n.forEach(function(t,e){t.index=e,t.top=i,t.center=Math.ceil(t.top+t.height/2),t.drag?h.css("transform","translate(0px, "+t.top+"px)"):t.dom.css("transform","translate(0px, "+t.top+"px)"),i+=t.height+10})}.bind(this),e=function(){c=0+(cursorX-o),l=r+(cursorY-s),a.dom.css({transform:"translate("+c+"px, "+l+"px) rotate(2deg)"});var t=l,e=d;if(t>n.last.center)e=n.length;else for(var i=0;i<n.length;i++){if(t<n[i].center){e=i;break}}d!=e&&(n.move(d,e),u(),d=a.index)};$(document).on("mousemove",e),$(document).one("mouseup",function(){setTimeout(function(){$(document).off("mousemove",e),t(!1)},20),setTimeout(function(){i("pageStructure",{event:"move",target:a.id,data:d})},250)})},bind:function(){var n=this;"function"==typeof o.change&&h.add(o.change(function(t){(t=t.map(function(t){return t.data})).forEach(function(t){switch(t.event){case"add":break;case"change":if(i=n.getStructure(t.target)){var e=t.data;i.attachZone.setValue(e.attaches),i.form.setValue(e)}break;case"remove":break;case"move":var i;if(i=n.getStructure(t.target)){var a=n.list.findIndex(function(t){return t.id==i.id});a!=t.data&&(n.list.move(a,t.data),n.view())}}})}))},getStructure:function(e){return this.list.find(function(t){return t.id==e})},createStructure:function(){var t={attaches:[],content:deltaDefine(),id:getRandom(this.list.map(function(t){return t.id})),title:"New Section"},e=new n(this,t,!0);this.list.push(e),this.view(),forceReflow(e.dom),e.edit=!0},deleteStructure:function(t){this.removeStructure(t);var e=this.getStructure(t);e&&!e.new&&i("pageStructure",{event:"remove",target:t})},removeStructure:function(t){setTimeout(function(){[].concat(t).forEach(function(t){var e=this.getStructure(t);e&&(this.list.findAndRemove(function(t){return t.id==e.id}),e.dom.remove(),e.die())}.bind(this)),this.view()}.bind(this),20)},get serialize(){return this.list.map(function(t){return t.data})},get container(){return this.dom.find(".fm-flowmap-section__content")},die:function(){this.list.forEach(function(t){t.die()})},get dom(){if(!this._dom&&(this._dom=$('<div class="fm-flowmap-section js-pagestructure-container"><div class="fm-flowmap-section__head"><h4 class="fm-flowmap-section__title">Page structure</h4></div><div class="fm-flowmap-section__content"></div></div>'),o.editable)){var t=function(){setTimeout(function(){this.createStructure(),1<this.list.length&&app.subscriber("add",{scope:app,event:"sitemapMultiplePageStructure"})}.bind(this),20)}.bind(this),e=app.modules.get("html",{param:{class:"fm-flowmap-addpagestructure"},content:[{param:{class:"fm-flowmap-addpagestructure__button",callback:t}},{param:{class:"fm-flowmap-addpagestructure__text",callback:t},content:"Create section"}]});this._dom.append(e)}return this._dom}};var n=function(t,e,i){this.parent=t,this.new=!!i,this.data=e,Object.assign(this,e),this.attachZone=new u(a.attaches,this.attaches,{id:o.formIdPrefix+"structures/"+this.id+"attach",localSave:!0}),this.form=app.modules.get("form",{form:this.dom,actions:this.dom.find(".js-actions"),settings:{id:o.formIdPrefix+"structures/"+this.id,clickOutSide:!0,fixed:!o.editable,easeEdit:!0,shortCut:!0,strict:!0,escAction:!0,instantChangeValues:!1,freeze:!0,freezeDependencies:!0,selfFreeze:!0,localSave:!0}}),this.bind()};n.prototype={get spoiler(){return void 0===this._spoiler||this._spoiler},set spoiler(t){if(!equals(this.spoiler,t)){if(t&&this.edit||this.drag)return!1;this._spoiler=t,this.dom.toggleClass("fm-flowmap-block--collapsed",t),this.dom.find(".js-spoiler").toggleClass("active",!t),t?this.container.slideUp(300):this.container.slideDown(300)}},get index(){return void 0!==this._index?this._index:-1},set index(t){equals(this.index,t)||(this._index=t,this.dom.find(".js-index").text(t+1))},get edit(){return this._edit||!1},set edit(t){equals(this.edit,t)||(this._edit=t,this.form.freeze(!t),this.attachZone.edit=t,this.dom.toggleClass("fm-flowmap-block--edit",t),t&&(this.spoiler=!1),t&&app.subscriber("add",{scope:app,event:"sitemapModalEdit"}))},get drag(){return this._drag||!1},set drag(t){equals(t,this.drag)||(this._drag=t,this.dom.toggleClass("fm-flowmap-block--drag",t))},get dragAvaliable(){return this._dragAvaliable||!1},set dragAvaliable(t){equals(this.dragAvaliable,t)||(this._dragAvaliable=t,this.dom.find(".js-heading").attr("draggable",t))},submit:function(t){this.attachZone.save(),t=Object.assign({},t,{attaches:this.attachZone.value}),equals(this.data,t)||(this.data=t,i("pageStructure",{event:this.new?"add":"change",target:this.id,data:t})),this.new=!1},reset:function(t){this.attachZone.reset(),this.new&&this.parent.removeStructure(this.id)},bind:function(){var i=this;this.dom.find(".js-heading").on("click",function(t){$(this).is(t.target)&&(i.spoiler=!i.spoiler)}).on("click",".js-spoiler",function(){i.edit&&!i.spoiler&&i.form.submit(),i.spoiler=!i.spoiler}).on("mousedown",function(t){var e=$(t.target);i.dragAvaliable=e.hasClass("js-heading")||e.hasClass("js-index")||!!e.closest(".js-drag").length||!!e.closest(".js-spoiler").length}).on("dragstart",function(t){i.dragAvaliable&&o.editable&&(t.preventDefault(),i.parent.drag(i))}),this.form.subscriber("on",function(t){t.forEach(function(t){switch(t.event){case"freeze":i.edit=!t.state;break;case"reset":i.reset();break;case"submit":i.submit(t.data)}})}),this.attachZone.subscriber("on",{event:"upload"},function(){i.edit=!0}),this.attachZone.subscriber("on",{event:"edit"},function(t){t.forEach(function(t){t.data&&(i.edit=!0)})})},get container(){return this.dom.find(".fm-flowmap-block__content")},get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){var e=this,t=l({param:{class:"fm-flowmap-block fm-flowmap-block--collapsed"},content:[{param:{class:"fm-flowmap-block__actions js-actions"},content:{name:"buttonRow",content:[{name:"button",param:{mod:["blue","narrow"],attr:{type:"submit","data-form-role":"actions"},text:"Save"}},{name:"link",param:{attr:{type:"reset","data-form-role":"actions"},callback:function(){}},content:"Cancel"}]}},{param:{class:"fm-flowmap-block__heading js-heading"},content:[{param:{class:"fm-flowmap-block__index js-index"}},{param:{class:"fm-flowmap-block__title"},content:{name:"input",param:{attr:{"data-form-role":"input"},mod:["autowidth","transperant","big","bold"],type:"autowidth",name:"title",value:e.title}}},o.editable?{name:"menu",param:{options:{edit:"Edit",delete:"Delete"},settings:{get mouseleave(){return t},mouseleaveDelay:3e3,width:92},callback:function(t){switch(t){case"edit":e.edit=!0;break;case"delete":e.parent.deleteStructure(e.id)}}}}:"",{name:"button",param:{class:"js-spoiler",mod:["narrow","round","fake"],style:{"margin-left":"auto"}},content:{name:"iconArrow"}},o.editable?{name:"buttonIcon",param:{name:"dragzone",style:{"margin-right":"-15px"},class:"js-drag",mod:"drag"}}:""]},{param:{class:"fm-flowmap-block__content",style:{display:"none"}},content:[{name:"quill",param:{value:e.content,attr:{"data-form-role":"input","data-name":"content"},freezePlaceholder:"+ Add description",placeholder:"Write a description...",mod:["toggle","freeze-placeholder"],param:["file"],bounds:this.parent.container.get(0),internalLink:d}},e.attachZone.dom]}]});return t},die:function(){this.form.die(),this.attachZone.die()}};var e=new t(a.list);return h.add({fn:e.die,ctx:e}),e.dom},discussion:function(n,o){var t={init:function(){this.list=[];var e=this.listContainer.loader("block");n.get().then(function(t){this.list=this.list.concat(t.map(function(t){return new i(t)})),this.render(),this.bind(),e.done()}.bind(this))},die:function(){this.form&&this.form.die(),this.list.forEach(function(t){t.die()}),this.list.length=0},pageCount:10,get showLength(){return this._showLength||Math.min(this.list.length,this.pageCount)},set showLength(t){this._showLength=Math.min(this.showLength+t,this.list.length),this.render()},render:function(){for(var t=0;t<this.showLength;t++){var e=this.list[t];e.show||(this.listContainer.append(e.dom),e.show=!0)}this.showLength>=this.list.length?this.button.hide():this.button.find("a").text("Load more comments")},getById:function(e){return this.list.find(function(t){return t.id==e})},add:function(t){var e=new i(t);this.list.unshift(e),this._showLength++,this.listContainer.prepend(e.dom),e.show=!0},remove:function(e){if(e=this.getById(e)){var t=this.list.findIndex(function(t){return t.id==e.id});0<=t&&this.list.remove(t),e.show&&(setTimeout(function(){e.dom.remove()},20),this._showLength--)}},edit:function(t,e){(t=this.getById(t))&&(t.data=Object.assign(t.data,e),t.show&&t.form.setValue(e))},post:function(t){var e={},i=[];t.message.ops.forEach(function(t){var e=safetyObjectAccess(t,["insert","mention","id"],!1);e&&i.push(e)}),e.text=t.message,i.length&&(e.to=i);var a=this.form.dom.find(".fm-flowmap-comments__content").loader("block");o.post(e).then(function(t){t.status&&(t.message.message=deltaDefine(t.message.message),"function"==typeof o.callback&&o.callback({event:"add",target:t.message}),this.form.setValue({message:deltaDefine()})),a.done()}.bind(this))},bind:function(){var i=this;this.form&&this.form.subscriber("on",function(t){t.forEach(function(t){switch(t.event){case"freeze":i.form.dom.toggleClass("fm-flowmap-comments__item--edit",!t.state),t.state||app.subscriber("add",{scope:app,event:"sitemapModalStartDiscussion"});break;case"submit":i.post(t.data)}})}),"function"==typeof o.change&&h.add(o.change(function(t){t.map(function(t){return t.data}).forEach(function(t){switch(t.event){case"add":i.add(t.target);break;case"edit":i.edit(t.target,t.data);break;case"remove":i.remove(t.target)}})}));var t=setInterval(function(){for(var t=0;t<i.list.length;t++){var e=i.list[t];if(!e._dom)break;e.dom.find(".js-time-ago").text(e.timeAgo)}},6e4);e.subscriber("on",{event:"close"},function(){clearInterval(t)})},get newMessage(){return this._newMessage||(this._newMessage=this.dom.find(".js-new-message")),this._newMessage},get dom(){return this._dom||(this._dom=this.template),this._dom},get listContainer(){return this._listContainer||(this._listContainer=this.dom.find(".js-list")),this._listContainer},get button(){return this._button||(this._button=this.dom.find(".js-show-more")),this._button},get template(){var a=this,t=$('<div class="fm-flowmap-section"><div class="fm-flowmap-section__head"><h4 class="fm-flowmap-section__title">Discussion</h4></div><div class="fm-flowmap-section__content"><div class="fm-flowmap-block fm-flowmap-block--auto"><div class="fm-flowmap-block__content"><div class="fm-flowmap-comments"><div class="fm-flowmap-comments__list js-list"></div></div></div></div></div></div>');return t.find(".fm-flowmap-comments").prepend(function(){if(n.edit){var t=$('<div class="fm-flowmap-comments__item fm-flowmap-comments__item--new"></div>');$('<div class="fm-flowmap-comments__avatar"></div>').setBackground(User.avatar).appendTo(t);var e=$('<div class="fm-flowmap-comments__content"></div>').appendTo(t),i=$('<div class="fm-flowmap-comments__actions"></div>').append(l([{name:"buttonRow",param:{style:{width:"100%"}},content:[{name:"button",param:{mod:["blue","narrow"],attr:{type:"submit","data-form-role":"actions"},text:"Send Comment"}},{name:"link",param:{attr:{type:"reset","data-form-role":"actions"},callback:function(){}},content:"Cancel"}]},{param:{class:"fm-flowmap-comments__tip",tag:"p"},content:"Press <b>Shift+Enter</b> to send or <b>Enter</b> to add new line"}])).appendTo(e);return $('<div class="fm-flowmap-comments__message"></div>').append(l({name:"quill",param:{attr:{"data-form-role":"input","data-name":"message"},placeholder:"Write a comment",mod:"toggle",mentions:function(){return app.projects.get(flowmap.id).users.map(function(t){return{avatar:t.img,name:User.fullName.call(t.account),login:t.login,id:t.id}})},internalLink:d}})).appendTo(e),a.form=app.modules.get("form",{form:t,actions:i,settings:{id:n.formIdPrefix+"/discussion/newmessage",localSave:!0,localSaveInitTime:1e3,fixed:!n.edit,shortCut:!0,strict:!0,instantChangeValues:!1,freeze:!0,easeEdit:!0,freezeDependencies:!0,selfFreeze:!0}}),t}return""}).append($('<div class="fm-flowmap-comments__show js-show-more"></div>').append(l({name:"link",param:{callback:function(){a.showLength+=a.pageCount}},content:"Load more comments"}))),t}},i=function(t){this.id=t.id,this.data=t,this.show=!1};return i.prototype={die:function(){this.form.die(),this.data=null,this.dom.remove()},get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){var t,e,i=this,a=this.data,n=$('<div class="fm-flowmap-comments__item"><div class="fm-flowmap-comments__avatar"></div><div class="fm-flowmap-comments__content"><div class="fm-flowmap-comments__heading"><h4 class="name">'+this.from+'</h4><p class="light js-time-ago">'+this.timeAgo+'</p></div><div class="fm-flowmap-comments__message"></div></div></div>');return n.find(".fm-flowmap-comments__avatar").setBackground(a.from.avatar),n.find(".fm-flowmap-comments__message").append(l({name:"quill",param:{value:a.message,attr:{"data-form-role":"input","data-name":"message"},placeholder:"Write a comment",mod:"toggle",mentions:function(){return app.projects.get(flowmap.id).users.map(function(t){return{avatar:t.img,name:User.fullName.call(t.account),login:t.login,id:t.id}})}}})),this.accessibility&&(n.find(".fm-flowmap-comments__heading").append($('<div class="fm-flowmap-comments__option js-edit">Edit</div>').on("click",function(){t.focus()})).append($('<div class="fm-flowmap-comments__option js-delete">Delete</div>').on("click",function(){var t={};t.message=i.id,o.remove(t),"function"==typeof o.callback&&o.callback({event:"remove",target:i.id})})),e=$('<div class="fm-flowmap-comments__actions"></div>').append(l([{name:"buttonRow",content:[{name:"button",param:{mod:["blue","narrow"],attr:{type:"submit","data-form-role":"actions"},text:"Save"}},{name:"link",param:{attr:{type:"reset","data-form-role":"actions"},callback:function(){}},content:"Cancel"}]},{param:{class:"fm-flowmap-comments__tip",tag:"p"},content:"Press <b>Enter</b> to send or <b>Shift+Enter</b> to move line"}])),n.find(".fm-flowmap-comments__content").prepend(e)),this.form=t=app.modules.get("form",{form:n,actions:e,settings:{fixed:!(flowmap.accessibility||this.accessibility),strict:!0,instantChangeValues:!1,freeze:!0,shortCut:!0,freezeDependencies:!0,selfFreeze:!1,internalLink:d}}),t.subscriber("on",function(t){t.forEach(function(t){switch(t.event){case"freeze":n.toggleClass("fm-flowmap-comments__item--edit",!t.state);break;case"submit":var e={};e.text=t.data.message,e.message=i.id,o.edit(e),"function"==typeof o.callback&&o.callback({event:"edit",target:i.id,data:t.data})}})}),n},get timeAgo(){return timeAgo(this.data.date_create)},get accessibility(){return c.accessibility||"default"===c.method&&this.data.from_id===User.id},get from(){return User.fullName.call(this.data.from)}},t.init(),t.dom},files:function(t,a){var e=l({param:{class:"fm-flowmap-section"},content:[{param:{class:"fm-flowmap-section__head"},content:{param:{tag:"h4",class:"fm-flowmap-section__title"},content:"Files"}},{param:{class:"fm-flowmap-section__content",style:{height:"calc(100vh - 150px)",overflow:"hidden"}}}]}),i={init:function(t){this.attaches=t,this.list=[]},update:function(){convertToPromise(this.loadData).then(function(t){var e,i=this;"list"===a.mod?(e=this.file(t,this)).forEach(function(t){var e=i.getById(t.id);e&&(t.selected=e.selected)}):"group"===a.mod&&(e=this.group(t,this)),this.clearList(),this.list=e,this.view()}.bind(this))},get loadData(){return t.list()},file:function(t,e){var i=function(t,e){this.type="item",this.parent=e,this.extension=t.extension,this.id=t.id,this.link=t.link,this.time=t.time,this.name=t.name,this.size=t.size};return i.prototype={get selected(){return this._selected||!1},set selected(t){equals(this.selected,t)||(this._selected=t,this.dom.find("input[name=select]").prop("checked",t),this.dom.toggleClass("selected",t))},get selectedLength(){return 1*this.selected},get selectedFiles(){return this.selected?this:[]},get normolizeName(){var t=this.name;return 41<t.length?t.substring(0,31)+"..."+t.substring(t.length-6,t.length):t},get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){var i=this;return l({name:"row",param:{mod:["nowrap"]},content:[l({name:"input",param:{mod:["checkbox","auto"],type:"checkbox",checked:!1,name:"select",callback:function(t,e){return e.preventDefault(),e.stopPropagation(),i.selected=!i.selected,i.parent.updateSelected(),!1}}}).add(l({name:"fileExtension",param:{extension:i.extension}}).css("margin-left","20px")).add('<p class="strong" style="margin-left: 10px" title="'+i.name+'">'+i.normolizeName+"</p>").add('<p class="light" style="margin-left: 15px">'+i.size.fileSize(!0)+"</p>"),l({name:"buttonIcon",param:{name:"delete",callback:function(t){t.stopPropagation(),i.parent.removeFiles(i)}}}).addClass("js-delete").add(l({name:"link",param:{href:i.link,attr:{download:i.name}},content:{name:"buttonIcon",param:{name:"download"}}}))]})},get length(){return 1},view:function(){},die:function(){this.parent=null,this.dom.off().remove(),this._dom=null},getById:function(t){if(this.id==t)return this}},[].concat(t).map(function(t){return new i(t,e)})},group:function(t,e){var i=this,a=function(t,e){this.type="group",this.parent=e,this.id=t.id,this.name=t.title,this.list=i.file(t.list,this),this.spoiler=!0};return a.prototype={getById:function(t){for(var e,i=0;i<this.list.length&&!(e=this.getById(t));i++);return e},selectItem:function(t,e){this.getById(t).selected=e},get selected(){return this._selected||!1},set selected(t){equals(this.selected,t)||(this._selected=t,this.heading.find('input[name="select"]').prop("checked",t))},get normolizeName(){var t=this.name;return 36<t.length?t.substring(0,26)+"..."+t.substring(t.length-6,t.length):t},get selectedFiles(){return this.list.reduce(function(t,e){return t.concat(e.selectedFiles)},[])},get selectedLength(){return this.list.reduce(function(t,e){return t+e.selectedLength},0)},get length(){return this.list.reduce(function(t,e){return t+e.length},0)},selectAll:function(e){this.list.forEach(function(t){t.hasOwnProperty("selectAll")?t.selectAll(e):t.selected=e}),this.updateSelected()},updateSelected:function(){var t=this.length;this.selected=0<t&&t==this.selectedLength,this.parent.updateSelected()},deleteSelected:function(){this.removeFiles(this.selectedFiles)},removeFiles:function(t){var e="project"==this.id?flowmap:flowmap.getCard(this.id),i=(t=[].concat(t)).map(function(t){return t.id});e.change("attaches",{event:"remove",target:i}),app.serverRequest("flowmapUnAttach",{file_id:i}),t.forEach(function(e){var t=this.list.findIndex(function(t){return e.id==t.id});-1<t&&this.list.remove(t),e.die()}.bind(this)),this.parent.view()},die:function(t){this.clearList(),t&&this.parent.list.remove(this.parent.list.findIndex(function(t){return this.id==t.id}.bind(this))),this.parent=null,this.dom.off().remove()},clearList:function(){this.list.forEach(function(t){t.die()}),this.list.length=0},get spoiler(){return this._spoiler||!1},set spoiler(t){equals(this.spoiler,t)||(this._spoiler=t,this.heading.find(".js-spoiler").toggleClass("active",t),this.container.css("display",t?"none":"block"))},get extension(){return-1*this.list.length},get time(){return Math.max.apply(Math,this.list.map(function(t){return t.time}))},get size(){return this.list.reduce(function(t,e){return t+e.size},0)},get sort(){return this._sort||{key:"time",drt:-1}},set sort(t){equals(this.sort,t)||(this._sort=t)},get orderList(){var i=this.sort;return this.list.sort(function(t,e){if(t=t[i.key],e=e[i.key],"string"==typeof t&&"string"==typeof e){if(t=t.toUpperCase(),e=e.toUpperCase(),!t.length&&!e.length)return 0;if(!t.length)return 1*i.drt;if(!e.length)return-1*i.drt}return e<t?1*i.drt:t<e?-1*i.drt:0})},view:function(){var e=this;if(!this.list.length)return this.die(!0),!1;this.orderList.forEach(function(t){t.dom.detach(),e.container.append(t.dom)}),this.heading.find(".js-size").text(this.size.fileSize(!0))},get heading(){return this._heading||(this._heading=this.dom.find(".fm-table__heading")),this._heading},get container(){return this._container||(this._container=this.dom.find(".fm-table__content")),this._container},get dom(){return this._dom||(this._dom=this.template),this._dom},get template(){var t=this;return l({name:"table",param:{mod:["striped","hover"],heading:[[{name:"input",param:{mod:["checkbox","auto"],type:"checkbox",name:"select",checked:!1,callback:function(){t.selectAll(!t.selected)}}},{param:{tag:"h4",style:{"margin-left":10,"white-space":"nowrap"}},content:this.normolizeName},{param:{class:"light js-size",tag:"p",style:{"margin-left":15,"white-space":"nowrap"}},content:"0kb"}],{name:"button",param:{mod:["round","border","narrow"],callback:function(){t.spoiler=!t.spoiler},addClass:"js-spoiler"},content:{name:"iconArrow"}}]}})}},[].concat(t).map(function(t){return new a(t,e)})},getById:function(t){for(var e,i=0;i<this.list.length&&!(e=this.list[i].getById(t));i++);return e},selectAll:function(e){this.list.forEach(function(t){"group"==t.type?t.selectAll(e):t.selected=e}),this.updateSelected()},updateSelected:function(){var t=this.selectedLength;this.selected=this.length==t,this.selectBar.find(".js-select .button__text").text("Delete "+t+" Selected"),this.selectBar.toggleClass("open",0<t)},deleteSelected:function(){"list"===a.mod?this.removeFiles(this.selectedFiles):"group"===a.mod&&this.list.forEach(function(t){t.deleteSelected()}),this.view()},removeFiles:function(t){var e=(t=[].concat(t)).map(function(t){return t.id});!function(){"function"==typeof a.callback&&a.callback(1===arguments.length?[arguments[0]]:Array.apply(null,arguments))}("attaches",{event:"remove",target:e}),"function"==typeof a.remove&&a.remove(e),t.forEach(function(e){var t=this.list.findIndex(function(t){return e.id==t.id});-1<t&&this.list.remove(t),e.die()}.bind(this))},get selected(){return this._selected||!1},set selected(t){equals(this.selected,t)||(this._selected=t,this.heading.find('input[name="select"]').prop("checked",t))},get selectedFiles(){return this.list.reduce(function(t,e){return t.concat(e.selectedFiles)},[])},get selectedLength(){return this.list.reduce(function(t,e){return t+e.selectedLength},0)},get length(){return this.list.reduce(function(t,e){return t+e.length},0)},get sort(){return this._sort||{key:"time",drt:-1}},set sort(t){equals(this.sort,t)||(this._sort=t,this.view())},get orderList(){var i=this.sort;return this.list.sort(function(t,e){if(t=t[i.key],e=e[i.key],"string"==typeof t&&"string"==typeof e){if(t=t.toUpperCase(),e=e.toUpperCase(),!t.length&&!e.length)return 0;if(!t.length)return 1*i.drt;if(!e.length)return-1*i.drt}return e<t?1*i.drt:t<e?-1*i.drt:0})},view:function(){var e=this,t=this.orderList;t.forEach(function(t){e.container.append(t.dom),t.sort&&(t.sort=e.sort,t.view())}),e.emptyState=1*!t.length,this.updateSelected()},die:function(){this.clearList()},clearList:function(){this.list.forEach(function(t){t.die()}),this.list.length=0},get emptyState(){return this._emptyState||0},set emptyState(t){if(!equals(this.emptyState,t)){if(this._emptyState=t,this.placeholder){var e=this.placeholder;e.removeClass("open"),setTimeout(function(){e.remove()},150),this.placeholder=null}switch(t){case 1:this.placeholder=app.modules.get("html",{name:"emptyPlaceholder",param:{mod:["absolute","white"],template:"flowmapPageFilesEmpty",callback:function(t){}}}).appendTo(this.dom),setTimeout(function(){this.placeholder&&this.placeholder.addClass("open")}.bind(this),20)}}},get heading(){return this._heading||(this._heading=this.dom.find(".fm-panel__heading")),this._heading},get container(){return this._container||(this._container=this.dom.find(".fm-table__content")),this._container},get selectBar(){if(!this._selectBar){var t=this;this._selectBar=l({name:"panelSelectBar",content:{name:"buttonRow",content:[l({name:"button",param:{mod:"blue",text:"Delete selected",callback:function(){t.deleteSelected()}}}).addClass("js-select"),{name:"link",param:{callback:function(){t.selectAll(!1)}},content:"Deselect"}]}}).insertAfter(this.heading)}return this._selectBar},get dom(){return this._dom||(this._dom=this.template.appendTo(e.find(".fm-flowmap-section__content"))),this._dom},get template(){var i=this;return l({name:"panel",param:{heading:[l({name:"input",param:{mod:["checkbox","auto"],type:"checkbox",checked:!1,name:"select",callback:function(t,e){return e.preventDefault(),e.stopPropagation(),i.selectAll(!i.selected),!1}}}).add(l({name:"paragraph",param:{mod:["big","bold"]},content:"All files"}).css("margin-left",10)).add('<p class="light js-size" style="margin: 0 auto 0 15px"></p>'),l({name:"input",param:{type:"select",name:"select",mod:["narrow","short","horizontal"],options:[{text:"Recent",value:"time,-1"},{text:"Alphanumeric",value:"name,1"},{text:"Size",value:"size,-1"},{text:"Extension",value:"extension,1"}],callback:function(t){t=t.value.split(","),i.sort={key:t[0],drt:1*t[1]}},label:"Sort by",value:i.sort.key+","+i.sort.drt,placeholder:"date_activity"}})],mod:["stretch","fill"]},content:{name:"table",param:{mod:["stretch","background","hover"],contentHeight:"100%",contentScroll:!0}}})}};return i.init(),h.add({fn:i.die,ctx:i}),o.subscriber("on",function(t){t.forEach(function(t){"slide"===t.event&&"Files"===t.target?i.update():"leave"===t.event&&"Files"===t.target&&i.clearList()})}),e},backup:function(t,e){var n={init:function(){this.list=Promise.resolve(t),this.state=!1},suspend:function(){this.state=!1,setTimeout(function(){this.state||this.container.insert()}.bind(this),300)},resume:function(){this.state=!0,this.render()},render:function(t){var a=this.dom.loader("blockLight");app.backup.list(t).then(function(t){var e=t.filter(function(t){return t.project_id==c.id}).sort(function(t,e){return e.date_create-t.date_create});if(e.length)this.container.insert(app.modules.get("html",{name:"backupList",param:{scroll:!0,height:"100%",add:!0,list:e,callback:function(t,e){switch(t){case"create":app.backup.create(c.id).then(function(t){n.render(!0)});break;case"restore":app.backup.restore(e).then();break;case"remove":app.backup.remove(e).then(function(t){n.render(!0)})}}}}));else{var i=app.modules.get("html",{name:"emptyPlaceholder",param:{template:"projectBackupEmpty",mod:["absolute","white"],active:!0,callback:function(t){"create"===t&&app.backup.create(c.id).then(function(t){n.render(!0)})}}});this.container.insert(i)}a.done()}.bind(this))},die:function(){},get container(){return this._container||(this._container=this.dom.find(".fm-panel__content")),this._container},get template(){return l({name:"panel",param:{mod:["stretch","fill"]}})},get dom(){return this._dom||(this._dom=this.template),this._dom}};return n.init(),o.subscriber("on",function(t){t.forEach(function(t){"Backup"===t.target&&("slide"===t.event?n.resume():"leave"===t.event&&n.suspend())})}),l({param:{class:"fm-flowmap-section"},content:[{param:{class:"fm-flowmap-section__head"},content:{param:{class:"fm-flowmap-section__title"},content:"Backup"}},{param:{class:"fm-flowmap-section__content",style:{height:"calc(100vh - 150px)",overflow:"hidden"}},content:n.dom}]})}};e.insert(function(t){var e=[];t.hasOwnProperty("heading")&&e.push(n.heading(t.heading));var i=[];t.content.forEach(function(t){t&&i.push({name:t.name,content:t.modules.reduce(function(t,e){return e&&n.hasOwnProperty(e.name)&&t.push(n[e.name](e.data,e.settings)),t},[])})});var a=[];return i.forEach(function(t,e){o.addPage({anchor:t.name},t.content),a.push({name:"tabItem",param:{data:{value:t.name},state:!e},content:t.name})}),o.toIndex(0),h.add({fn:o.die,ctx:o}),e.push(l({param:{class:"fm-flowmap-content"},content:[{param:{class:"fm-flowmap-navigation"},content:{name:"tab",param:{callback:o.toAnchor},content:a}},o.dom]})),e}(t)),setTimeout(function(){e.open(),i.done()},300),t.hash&&app.url.set({hash:t.hash},!0),e.subscriber("on",{event:"open"},function(){1*t.hash&&app.subscriber("add",{scope:app,event:"sitemapModal"})}.bind(this)),e.subscriber("on",{event:"close"},function(){e.dom.find(".parallel-pages").loader("backstage",{mod:"instantly"}),"function"==typeof t.onClose&&t.onClose(e),h.exec(),this.modal=null,t.hash&&app.url.set({hash:""},!0),this.modal=null,this.modalRequest=null}.bind(this)),this.modal=e,this.modalRequest=t},inject:function(){content.insert(this.dom)},get scroller(){return this._scroller||(this._scroller=this.dom.find(".scroller")),this._scroller},get template(){var i=app.modules.get("parallelPages",{scroll:"bi"});return this.pages=i,this.modules.mapToArray(function(t,e){i.addPage({anchor:e},t.api.dom())}),app.modules.get("html",{name:"page",content:i.dom})},get dom(){return this._dom||(this._dom=this.template),this._dom},Discussion:function(){return t.apply(t,argsToArray({arguments:arguments}))},PageStructure:function(){return e.apply(Object.create(e.prototype),argsToArray({arguments:arguments}))},Attaches:function(){return i.apply(Object.create(i.prototype),argsToArray({arguments:arguments}))},AttachZone:function(){return u.apply(Object.create(u.prototype),argsToArray({arguments:arguments}))},die:function(){this.modal&&this.modal.close(),Object.values(this.modules).forEach(function(t){t.api.die()}),this.data={},this.subscriber("die"),tryExecute(this.socket,"leave",[this.id]),this.socket=null,tryExecute(this.pages,"die"),this._dom=null,this.currentModule=null,this._scroller=null}};var t=function(t,e,a){return{add:function(e){this.list&&this.list.then(function(t){t.unshift(e),this.count=t.length}.bind(this)),this.count++},edit:function(t,e){this.list&&this.getById(t).then(function(t){t&&(t.message=e.message)})},remove:function(i){this.list&&this.list.then(function(t){var e=t.findIndex(function(t){return t.id==i});0<=e&&t.remove(e),this.count=t.length}.bind(this)),this.count--},getById:function(e){if(this.list)return this.list.then(function(t){return t.find(function(t){return t.id==e})})},get get(){var i=this;return this.list||(this.list=app.serverRequest(a.requestUrl,a.requestData).then(function(t){var e=t.messages?t.messages.map(function(t){return t.message=deltaDefine(t.message),t}):[];return i.count=e.length,e})),this.list},get count(){return this._count||1*e||0},set count(t){this._count=t},die:function(){this.list.then(function(t){t.length=0})}}},e=function(t,e){if(this.parent=t,"object"!=typeof e)try{e=JSON.parse(e)}catch(t){e=[]}return this.list=e.length&&e.some(function(t){return!t.id})?this.migrate(e):this.Structure(e),this};e.prototype={Structure:function(t){return[].concat(t).map(function(t){return{id:t.id,title:t.title,content:deltaDefine(t.content),attaches:t.attaches||[]}})},get:function(e){return void 0!==e?this.list.find(function(t){return t.id==e}):this.list},add:function(t,e){this.list=this.list.concat(this.Structure(Object.assign({id:t},e)))},remove:function(t){[].concat(t).forEach(function(e){this.list.findAndRemove(function(t){return t.id==e})}.bind(this))},change:function(t,e){var i=this.get(t);if(i)for(var a in e)i[a]=e[a]},move:function(t,e){var i=this.get(t),a=this.list.findIndex(function(t){return t.id==i.id});this.list.move(a,e)},set:function(t,e){this.list=e},migrate:function(t){var i=[];return t.forEach(function(t){var e=getRandom(i);i.push(e),t.id=e}),setTimeout(function(){this.parent.change("pageStructure",{event:"set",target:"self",data:t})}.bind(this),150),[]}};var i=function(t,e,i){return this.parent=t,this.settings=i,this.list=this.File(e),this.zoneList=[],this};i.prototype={File:function(t,e){var i=this,a=function(t){Object.assign(this,e?t:i.formateData(t))};return a.prototype={},[].concat(t).map(function(t){return new a(t)})},get count(){return this.list.length},get sendData(){return this.settings.sendData},get sendUrl(){return this.settings.url||"flowmapAttach"},formateData:function(t){return{id:t.id,link:t.filename,name:t.origin_name,size:1*t.size,time:t.mtime,extension:t.filename.split(".").pop()}},add:function(t){var e=[].concat(t).filter(function(t){return!this.get(t.id)}.bind(this));this.list.push.apply(this.list,e)},remove:function(t){[].concat(t).forEach(function(e){var t=this.list.findIndex(function(t){return t.id==e});0<=t&&this.list.remove(t)}.bind(this)),this.updateZone()},get:function(e){return void 0!==e?this.list.find(function(t){return t.id==e}):this.list},updateZone:function(){this.zoneList.forEach(function(t){t.view()})},clearZone:function(){this.zoneList.forEach(function(t){t.die()}),this.zoneList.length=0}};var u=function(t,e,i){if(this.attaches=t,this.settings=i||{},this.id=this.settings.id||getRandom(this.attaches.zoneList.map(function(t){return t.id})),e=e?this.removeExpired(e):[],this.loadingFiles={},this.newUploaded=[],this.markToDelete=[],Subscriber(this),this.oldValue=this.value=e,this.bind(),this.settings.localSave){var a=this.getLocalSave;a&&setTimeout(function(){this.setValue(a,!0),this.edit=!0}.bind(this),200)}return this.attaches.zoneList.push(this),this};u.prototype={view:function(){this.container.html(""),this.value.forEach(function(t){if(t){var e=this.attaches.get(t);e&&this.container.append(this.file(e))}}.bind(this))},get value(){return this._value||!1},set value(t){equals(this.value,t)||(this._value=[].concat(t),this.view())},get oldValue(){return this._oldValue||[]},set oldValue(t){equals(this.oldValue,t)||(this._oldValue=[].concat(t))},setValue:function(t){this.edit?this.oldValue=t:this.value=t},get edit(){return this._edit||!1},set edit(t){equals(this.edit,t)||(this._edit=t,this.dom.toggleClass("attach-zone--edit",t),this.subscriber("add",{event:"edit",data:t}))},get readyState(){return 0==Object.keys(this.loadingFiles).length},save:function(){var e=this,t=this.value.concat(this.oldValue.filter(function(t){return e.markToDelete.indexOf(t)<0&&e.value.indexOf(t)<0}));this.markToDelete.length&&(this.removeFile(this.markToDelete),this.markToDelete.length=0),this.newUploaded.length=0,this.oldValue=this._value=t,this.localSave(!0)},removeFile:function(t){this.attaches.parent.change("attaches",{event:"remove",target:t}),app.serverRequest("flowmapUnAttach",{file_id:t})},reset:function(){this.abortUpload(),this.newUploaded.length&&(this.removeFile(this.newUploaded.map(function(t){return t.id})),this.newUploaded.length=0),this.value=this.oldValue},abortUpload:function(){for(var t in this.loadingFiles)this.loadingFiles[t].abort(),delete this.loadingFiles[t]},file:function(e){var u=$('<div class="attach-zone__file" data-file-id="'+e.id+'"><div class="attach-zone__name"><a href="'+e.link+'" class="link" target="_blank" title="'+e.name+'">'+ellipsis(e.name,[13,3],!0)+'</a></div><div class="attach-zone__toolbar"><a class="attach-zone__button attach-zone__button--download js-download" href="'+e.link+'" title="download:'+e.name+'" download="'+e.name+'"></a><div class="attach-zone__button attach-zone__button--delete js-delete"></div><span class="light">'+e.size.fileSize(!0)+"</span></div></div>");return u.prepend(app.modules.get("html",{name:"icon",param:{name:"attach",cover:!0}}).css("margin-right","5px")),u.find(".js-download").append(app.modules.get("html",{name:"icon",param:{name:"download",cover:!0}})),u.find(".js-delete").append(app.modules.get("html",{name:"icon",param:{name:"delete",cover:!0}})),0<=["png","jpg","jpeg","svg","gif","ico","bmp"].indexOf(e.extension.toLowerCase())&&{get state(){return this._state||!1},set state(t){equals(t,this.state)||((this._state=t)&&this.calcPosition(),this.preview.toggleClass("hide",!t))},calcPosition:function(){var t=Math.max(this.properties.width,50),e=Math.max(this.properties.height,50),i=u.find(".attach-zone__toolbar"),a=i.offset().left,n=i.outerWidth(),o=u.parent(),s=o.offset().left,r=u.offset().left,c=a+n/2-(r+u.outerWidth()/2),l=s+(a-r)-r,d=s+o.outerWidth()-t-r+c,h=(n-t)/2-c;h=Math.min(d,Math.max(l,h)),this.preview.css({width:t,height:e,left:h})},properties:{width:100,height:100},get preview(){if(!this._preview){var n=this,o=this._preview=$('<div class="attach-zone__preview"></div>');o.css({width:this.properties.width,height:this.properties.height});var s=o.loader("cover");u.append(o),app.img(e.link,!0).then(function(t){t.width=t.width||50,t.height=t.height||50;var e=Math.min(280/t.width,280/t.height,1),i=Math.floor(t.width*e),a=Math.floor(t.height*e);o.append('<img src="'+t.src+'" width="'+i+'" height="'+a+'">'),n.properties={width:i,height:a},n.calcPosition(),s.done()},function(){s.done()})}return this._preview},bind:function(){var t=this,e=t.state;u.hover(function(){e=!0,setTimeout(function(){e&&(t.state=!0)},600)},function(){t.state=e=!1})}}.bind(),u.on("click",".js-delete",function(){u.off(),setTimeout(function(){u.remove()},130),this.value.remove(this.value.findIndex(function(t){return t==e.id})),this.markToDelete.push(e.id),this.localSave()}.bind(this)),u},new:function(t){var i,a=getRandom(Object.keys(this.loadingFiles)),n=$('<div class="attach-zone__file attach-zone__file--loading" data-file-id="'+a+'"><div class="attach-zone__name"><a href="javascript:void(0);" class="link" title="'+t.name+'">'+ellipsis(t.name,[13,3],!0)+'</a></div><div class="attach-zone__toolbar"><div class="attach-zone__button attach-zone__button js-delete"></div><span class="light">'+t.size.fileSize(!0)+'</span></div><div class="attach-zone__loader"><svg width="200" height="200" viewPort="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg"><circle r="90" cx="100" cy="100" fill="transparent" stroke-dasharray="565.48" stroke-dashoffset="0"></circle></svg></div></div>').prepend(app.modules.get("html",{name:"icon",param:{name:"attach",cover:!0}}).css("margin-right","5px")),e=n.find(".attach-zone__loader svg circle");return i=app.upload({file:t,data:this.attaches.sendData,url:this.attaches.sendUrl,progress:function(t){e.css({strokeDashoffset:(100-t)/100*Math.PI*(2*e.attr("r"))})},done:function(e){e=JSON.parse(e),n.find(".attach-zone__loader").css({opacity:0,"margin-left":-12}),setTimeout(function(){if(e.status){var t=this.attaches.formateData(e.file);this.newUploaded.push(t),this.value.push(t.id),n.off().replaceWith(this.file(t)),delete this.loadingFiles[a],this.attaches.parent.change("attaches",{event:"add",target:t}),this.localSave(),app.subscriber("add",{scope:app,event:"sitemapModalFileUpload"})}else!function(t){"MAX_QUOTA_EXCEED"===t&&("team"===User.tarifShort?app.modules.get("modalTemplates","upgradeSubscriptionModal","fileStorageAgency"):app.modules.get("modalTemplates","upgradeSubscriptionModal","fileStorageTeam")),n.remove(),delete this.loadingFiles[a],i&&i.abort()}(e.error)}.bind(this),160)}.bind(this),error:function(){n.remove(),delete this.loadingFiles[a]}}),this.loadingFiles[a]=i,n.find(".js-delete").append(app.modules.get("html",{name:"icon",param:{name:"delete",cover:!0}})),n.on("click",".js-delete",function(){i.abort(),n.off().remove(),delete this.loadingFiles[a]}.bind(this)),this.container.append(n),n},removeExpired:function(t){var e=this;return t.filter(function(t){return e.attaches.get(t)})},bind:function(){var e=this;"default"==flowmap.method&&this.dom.on("change",'input[type="file"]',function(){e.subscriber("add",{event:"upload"});for(var t=0;t<this.files.length;t++)e.new(this.files[t]);this.value=[]})},get container(){return this.dom.find(".attach-zone__list")},get dom(){return this._dom||(this._dom=app.modules.get("html",{name:"attachZone",param:{mod:"default"!==flowmap.method?"fixed":"",multiple:!0}})),this._dom},get getLocalSave(){return this.id?User.storage.get(["formLocalSave",this.id],null):null},localSave:function(t){if(this.id&&this.settings.localSave){this.localSaveTimeout&&clearTimeout(this.localSaveTimeout);var e=["formLocalSave",this.id];if(t)User.storage.set(e);else{var i=this.value;this.localSaveTimeout=setTimeout(function(){User.storage.set(e,i)},1500)}}return null},die:function(){this.dom.off(),this.subscriber("die");var e=this.id;this.attaches.zoneList.findAndRemove(function(t){return t.id==e}),this.attaches=null}};var s={pdf:function(d,t){var s=0,h={content:[{style:"documentHeading",stack:[{text:"Project name:"},{text:WorkPlace.get("title")}]}],pageMargins:[76,120.46,76,60],styles:{documentHeading:{fontSize:24,bold:!0,alignment:"left",margin:"A4"===d.size?d.landscape?[0,150,0,1e3]:[0,200,0,1e3]:d.landscape?[0,200,0,1e3]:[0,300,0,1e3]},subDocumentHeading:{fontSize:14,bold:!1,alignment:"left"},block:{margin:[0,0,0,4e3]},header:{fontSize:18,bold:!0,margin:[0,0,0,20]},subHeader:{fontSize:14,bold:!0,margin:[0,40,0,0]},litHeader:{fontSize:12,bold:!0,margin:[0,15,0,5]},contentHeader:{fontSize:14,bold:!1,margin:[0,15,0,5]},plainText:{fontSize:12},colontitle:{fontSize:10,color:"#696969"}},pageSize:d.size,pageOrientation:d.landscape?"landscape":"portrait"},n=function(t,e,i,a){var n={w:595,h:842},o={w:842,h:1191},s="A4"===d.size?d.landscape?n.h-76-60:n.w-76-60:d.landscape?o.h-76-60:o.w-76-60,r="A4"===d.size?d.landscape?n.w-120-60:n.h-120-60:d.landscape?o.w-120-60:o.h-120-60,c=0,l=-44;e<s&&(c=(s-e)/2,s=e),i<r&&(l=(r-l-i)/2,r=i),(a||h.content).push({image:t,fit:[s,r],alignment:"center",margin:[c,l,0,0],pageBreak:"after"})};return Promise.resolve().then(function(){if(d.project_name||d.date){var t=[];d.project_name&&t.push("Project: ",{text:WorkPlace.get("title")+" \n",style:{bold:!0}}),d.date&&t.push("Date: ",{text:formatDate(app.clientTime(),"dd MM yyyy"),style:{bold:!0}}),h.header={text:t,style:"colontitle",margin:[76,47.5,0,0]}}if(d.page_numbers&&(h.footer=function(t,e){return{text:t.toString()+" of "+e,style:"colontitle",margin:[76,0,0,0]}}),d.project_descr){var e=WorkPlace.get("description");isDeltaLength(e)&&h.content.push({stack:[{text:"Project description",style:"header"},{text:deltaParse(e),style:"plainText"}],style:"block"})}return Promise.all([WorkPlace.getModule("flowmap"),WorkPlace.getModule("userflow")]).then(function(t){var e=t[0],i=t[1],a=[];if(d.sitemap){var o=function(t,e,a){e+=1;var i={text:t.get("title"),anchor:"sm"+t.id,counter:e};if(t.children&&t.children.length){var n=0;a=a+e+".",i=[i,{ol:t.children.reduce(function(t,e,i){return e.ignore||(t.push(o(e,n,a)),n++),t},[]),separator:[a,"."]}]}return i},n=[e.cardTree];1<e.footerPages.children.length&&n.push(e.footerPages),n.length&&(a.push({text:"Project structure:",style:"header"}),a.push({ol:n.map(function(t,e){return o(t,e,"")}),separator:["","."]})),s+=n.length}d.userflow&&d.userflow_id.length&&(a.push({text:"Userflow:",style:"contentHeader"}),a.push({stack:i.list.filter(function(t){return d.userflow_id.includes(t.id)}).map(function(t,e){return{text:e+1+s+". "+t.title,anchor:"uf"+t.id}})})),d.project_structure&&a.length&&h.content.push({stack:a,style:"block"})})}).then(function(){if(toBoolean(d.sitemap))return WorkPlace.getModule("flowmap").then(function(t){return(d.sitemap_image?t.export("png",{transparent:!0,cover:!0,label:!0}).then().then(function(e){var i=1*d.sitemap_image_rotation;return canvasFlipImage(e.img,i).then(function(t){n(t,e[i%2?"height":"width"],e[i%2?"width":"height"])})}):Promise.resolve(!0)).then(function(){if(d.page_descr||d.page_structure||d.empty_pages){var s=function(t,e,i){var a=i+(e+1)+".",n=[];if(d.page_descr&&isDeltaLength(t.get("description"))&&n.push({text:deltaParse(t.get("description")),style:"plainText"}),d.page_structure&&Array.isArray(t.get("pageStructure").list)){var o=[];t.get("pageStructure").list.forEach(function(t){o.push({text:t.title,style:"litHeader"}),o.push({text:deltaParse(t.content),style:"plainText"})}),o.length&&(o.unshift({text:"Page structure:",style:"subHeader"}),n.push(o))}return(n.length||d.empty_pages)&&(n.unshift({text:a+" "+t.get("title"),name:"sm"+t.id,style:"header"}),h.content.push({stack:n,style:"block"})),t.children&&t.children.length&&t.children.forEach(function(t,e){t.ignore||s(t,e,a)}),d};[t.cardTree,t.footerPages].forEach(function(t,e){s(t,e,"")})}})})}).then(function(){if(toBoolean(d.userflow))return WorkPlace.getModule("userflow").then(function(i){var e=d.userflow_id,t=i.list.filter(function(t){return e.includes(t.id)});if(t.length)return onAllPromiseExecute(t.map(function(t,e){var a=[];return a.push({style:"block",stack:[{text:e+1+s+" "+t.title,name:"uf"+t.id,style:"header"},isDeltaLength(t.description)&&d.userflow_descr?{text:deltaParse(t.description),style:"plainText"}:""]}),d.userflow_image?i.export("png",{id:t.id,transparent:!0}).then(function(e){var i=1*d.useflow_image_rotation;return canvasFlipImage(e.img,i).then(function(t){return n(t,e[i%2?"height":"width"],e[i%2?"width":"height"],a),a})}):a})).then(function(t){t.forEach(function(t){Array.prototype.push.apply(h.content,t)})}).catch(console.log)})}).then(function(){return new Promise(function(t,e){app.log(h),pdfMake.createPdf(h).getDataUrl(t)})})}};app.pages.add({name:"workplace",title:"Project",backstage:!0,auth:!0,expired:!1,urlMatch:[{test:/\/projects\/.+/,method:"default",auth:!0,expired:!1},{test:/\/share\/.+/,method:"share",auth:null,expired:null}],canUpdate:function(t){return!!WorkPlace&&t.url.path.split("/")[2]==WorkPlace.id&&t.param.method===WorkPlace.method},get:function(){return WorkPlace},die:function(){WorkPlace.die()},controller:function(t){return"init"===t.state?WorkPlace.init(t):"update"===t.state?WorkPlace.update(t):void 0}})}(),function(){var e={default:{x:200,y:280,ox:20,oy:60},minimal:{x:200,y:160,ox:20,oy:60}},x=function(t,e,i){if(!t.length)return"";t.last().x,t.first().x;var a=t.length,n=(Math.ceil((t.length-1)/2),""),o=Math.round(i.oy/2/3);t.forEach(function(t,e){n+="M"+(t.x+i.o+-.5)+" "+(t.y+.5),0===e&&2<a?(n+="L"+(t.x+i.o+-.5)+" "+(t.y-i.oy/2+.5+o),n+="Q"+(t.x+i.o+-.5)+" "+(t.y-i.oy/2+.5)+" "+(t.x+i.o+o+-.5)+" "+(t.y-i.oy/2+.5)):e===a-1&&1<a?(n+="L"+(t.x+i.o+-.5)+" "+(t.y-i.oy/2+.5+o),n+="Q"+(t.x+i.o+-.5)+" "+(t.y-i.oy/2+.5)+" "+(t.x+i.o-o-.5)+" "+(t.y-i.oy/2+.5)):n+="L"+(t.x+i.o+-.5)+" "+(t.y-i.oy/2+.5)}),n+="M"+(e.x+i.o+-.5)+" "+(e.y+i.y-i.oy+.5),n+="L"+(e.x+i.o+-.5)+" "+(e.y+i.y-i.oy/2+.5);var s=t.first().x+i.o+-.5;return n+="M"+(s=2<a?s+o:s)+" "+(t.first().y-i.oy/2+.5),s=t.last().x+i.o+-.5,n+="L"+(s=1<a?s-o:s)+" "+(t.last().y-i.oy/2+.5)},i=function(t){this.controller=t,this.readyCallbacks=app.modules.get("executingList")(),this.selected=[],this.params={},this.data={},Subscriber(this),this.loadData.then(function(t){var e=t.data;t.status?(this.data.discussion=this.workplace.Discussion(this),this.data.attaches=this.workplace.Attaches(this,safetyObjectAccess(e,["project","attaches"],!1)||[]),this.set({title:safetyObjectAccess(e,["project","title"],"Unnamed"),description:deltaDefine(safetyObjectAccess(e,["project","description"],null)),date_create:safetyObjectAccess(e,["project","date_create"],0),date_update:safetyObjectAccess(e,["project","date_update"],0),cover:safetyObjectAccess(e,["project","file"],!1),owner:safetyObjectAccess(e,["project","owner_id"],!1),users:e.users||[],attaches_desc:safetyObjectAccess(e,["project","attaches_desc"],!1)||[]}),this.labelList=[{id:"none",text:"No label",color:"#ffffff"}].concat(e.hasOwnProperty("labels")&&Object.keys(e.labels).length?e.labels.mapToArray(function(t){return{id:t.id,text:t.title,color:t.color,project_id:t.project_id}}):[]),this.parse(e.cards),this.defineSettings(),this.bind(),this.renderLabels(),setTimeout(function(){this.inited=!0,this.renderLabels()}.bind(this),150)):app.pages("404").init({title:"The project no longer exists"})}.bind(this),app.log)};i.prototype={get workplace(){return this.controller},implement:function(t,e){if(this.state=t){this.header(),this.helpBar(),this.view(),this.renderLabels();var i=e?app.url():app.url.set({path:this.workplace.slashUrl+"/"+this.id})&&!1;return new Promise(function(e,t){this.cardTree&&setTimeout(function(){if(this.state&&this.cardTree){this.view();var t=!1;i&&("info"===i.hash?this.workplace.openSelfModal():t=this.getCard(i.hash)),t&&t.openModal(),this.scrollTo(t||this.cardTree),forceReflow(this.dom)}e()}.bind(this),200),e()}.bind(this))}return this.selectAll(!1),this.emptyState=0,Promise.resolve()},update:function(t){var e=t.url,i=!!t.url.hash&&this.getCard(e.hash);i&&i.openModal()},get id(){return this.controller.id},renderLabels:function(){this.cardsList.forEach(function(t){t.updateLabel(!1)}),forceReflow(this.dom),this.dom.find(".flowmap__labels--instant").removeClass("flowmap__labels--instant")},highlightLabels:function(){this.cardsList.forEach(function(t){t.highlightLabels(this.filter)},this)},get hiddenCard(){return this._hiddenCard,this._hiddenCard},get inited(){return this._inited||!1},set inited(t){equals(t,this.inited)||(this._inited=t)&&this.readyCallbacks.exec()},get ready(){return new Promise(function(t,e){this.readyCallbacks.add({ctx:this,fn:t,arg:[this]}),this.inited&&this.readyCallbacks.exec()}.bind(this))},get socket(){return this.controller.socket},get method(){return this.controller.method},get accessibility(){return this.controller.accessibility},parse:function(t){this.cardTree=null,this.footerPages=new j({id:"footer",title:"Footer Pages",description:deltaDefine(null),children:[],img:"",date_create:0,date_update:0,child_index:0,owner_id:!1,group:"footer",ignore:!0});var i=function(t){var e=new j(t);return e.addChild(Array.isArray(t.children)&&t.children.length?t.children.map(function(t){return i(t)}):[]),this.grid.append(e.dom),e}.bind(this);if(t.forEach(function(e){if(e.group&&"main"!=e.group)e.group&&("footer"==(e=new j(e)).get("group")&&this.footerPages.addChild(e),this.grid.append(e.dom));else if(null===e.parent_id)this.cardTree=i(e);else{e=i(e);setTimeout(function(){if(this.cardTree&&this.cardTree.id){var t={project:this.id,parent:this.cardTree.id,card:e.id,group:this.cardTree.group,index:this.cardTree.children.length};app.serverRequest("flowmapdrag",t),this.socket.trigger("move",t),this.cardTree.addChild(e)}else this.cardTree&&this.cardTree.die(),this.cardTree=e;this.view()}.bind(this),50)}},this),"default"===this.method){var e=new C({title:"Add Footer Page"});this.footerPages.addChild(e)}},defineSettings:function(){this._zoom=User.getUserSettings(["flowmap",this.id,"zoom"],.8),this._mod=oneOfMany(User.getUserSettings(["flowmap",this.id,"mod"],"default"),["default","minimal"],"default"),this.grid.setTransform({s:this._zoom}),this.grid.toggleClass("flowmap__grid--default","default"===this.mod),this.grid.toggleClass("flowmap__grid--minimal","minimal"===this.mod)},get state(){return this._state},set state(t){equals(t,this.state)||(this._state=t)&&this.cardTree},get loadData(){return this._getData||("default"===this.method?this._getData=app.serverRequest("getFlowmappData",{id:this.id}).then(function(t){var e=!("false"==t.status||0==t.status);return"default"===this.method?{status:e,data:e?t:{}}:"share"===this.method?t:void 0}.bind(this)):"share"===this.method?this._getData=this.workplace.loadedData.then(function(t){return{status:!0,data:{cards:safetyObjectAccess(t,["data","cards"],[]),project:safetyObjectAccess(t,["data","project"],{}),labels:safetyObjectAccess(t,["data","labels"],[])}}}):this._getData=Promise.resolve(!1)),this._getData},get:function(t){return this.data[t]},set:function(t,e){var i={};for(var a in"object"==typeof t?i=t:i[t]=e,i)(function(t,e){if(!equals(this.data[t],e)){switch(t){case"title":this.subscriber("add",{event:t,data:{title:e}}),$("header.header").find(".header__heading .header__title").text(e),app.title(e);break;case"cover":e=e.filename,this.subscriber("add",{event:t,data:e});break;case"discussion":return this.get("discussion")[e.event](e.target,e.data),this.subscriber("add",{event:t,data:e}),!1;case"description":this.subscriber("add",{event:t,data:e});break;case"attaches":return this.get("attaches")[e.event](e.target,e.data),this.subscriber("add",{event:t,data:e}),!1;case"users":$("header").find(".fm-members").replaceWith(app.modules.get("html",{name:"projectMembers",param:{style:{"margin-right":"40px"},id:this.id,list:e,short:!0,cover:"coverLight"}}));break;case"attaches_desc":this.subscriber("add",{event:t,data:e});break;case"labelList":return this.labelList=e,this.renderLabels(),!1}this.data[t]=e}}).bind(this)(a,i[a])},change:function(t,e){var i={};for(var a in"object"==typeof t?i=t:i[t]=e,i)(function(t,e){if(this.set(t,e),"default"==flowmap.method){switch(t){case"title":app.serverRequest("updateproject",{id:this.id,title:e});break;case"cover":app.serverRequest("updateproject",{id:this.id,file_id:e.id});break;case"description":app.serverRequest("updateproject",{id:this.id,description:e});break;case"attaches_desc":app.serverRequest("updateproject",{id:this.id,attaches:e})}var i={event:t,target:"project",data:e};flowmap.socket.trigger("change",i)}}).bind(this)(a,i[a])},die:function(){this.modal&&this.modal.close(),this.cardTree&&this.list().forEach(function(t){t.die(),t.children.length=0,t.parent=null}),this.treeModal()&&this.treeModal().close(),this.subscriber("die"),this.inited&&(this.unbind(),this.dom.find("[data-scroll]").baron().dispose(),this.dom.remove(),this.selectBar.clear()),this.userflow&&this.userflow.die(),flowmap=null,app.modules.get("sideTools",!1)},tree:function(t,e){e="function"==typeof t?t:e,t="string"==typeof t?t:"default";var i={x:0,y:0,rx:0,ry:0,w:0,h:0,d:!0};if(!this.cardTree)return!1;var c=function(i,o,s,r){return s?o=Object.assign({},o,{w:0,h:0,d:!1}):(o={x:o.x,y:o.y+1,rx:0,ry:0,w:1,h:1,d:!0},i.delete&&(o.d=!1,o.w=0,o.h=0,s=!0)),i.children.length&&function(){var a=0,n=0;s=!r&&(!0===s?s:i.ignoreChildren),i.children.forEach(function(t){var e=!t.drag&&s,i=c(t,s?o:Object.assign({},o,{x:o.x+a}),e,r);e||(a+=i.w,n=Math.max(n,i.h))}),o.w=Math.max(a,1),o.h+=n;var t=i.children.filter(function(t){return!t.delete});if(1<o.w){var e=s?t.findIndex(function(t){return t.drag}):Math.floor((t.length-1)/2);o.rx=t[e].position.x+t[e].position.rx-o.x}}(),i.position=o,e(i),o};switch(t){case"each":this.cardTree&&(i=0,c=function(t){i++,t.children.length&&t.children.forEach(function(t){c(t)}),e(t)},this.cardTree&&c(this.cardTree));break;case"list":this.cardTree&&(i=c(this.cardTree,{x:0,y:-1,w:0,h:0},!1,!0));break;case"default":default:this.cardTree&&(i=c(this.cardTree,{x:0,y:-1,w:0,h:0},!1,!1));var a="default"===this.method?Math.ceil(i.rx-(this.footerPages.children.length-1)/2):i.rx-Math.floor(((this.footerPages.children.length||1)-1)/2),n=c(this.footerPages,{x:a,y:i.h+.2-2,w:0,h:0},!1,!1);a=n.x+n.rx;var o=0;this.footerPages.position.addLeft=Math.max(Math.floor((n.w-1)/2)-a,0),this.footerPages.position.addRight=Math.max(Math.ceil((n.w+1)/2)+a-i.w,0),o+=this.footerPages.position.addLeft,o+=this.footerPages.position.addRight,i.h+=1.2,i.w+=o}return t=e=void 0,i},list:function(a){if(!this.cardTree)return[];var n=[],o=function(t){var e=function(){n.push(t)},i=function(){t.children&&t.children.length&&t.children.forEach(o)};a?(i(),e()):(e(),i())};return o(this.cardTree),Array.prototype.push.apply(n,this.footerPages.children),n},get cardsList(){return this.list().filter(function(t){return!t.ignore})},getCard:function(e){return Array.isArray(e)?e.reduce(function(t,e){var i=this.getCard(e);return i&&t.push(i),t}.bind(this),[]):this.list().find(function(t){return t.id==e})},get border(){return this._border||{x:0,y:0}},set border(t){if(!equals(this.border,t)){var e=t.x-this.border.x,i=t.y-this.border.y;this._border=t,this.grid.css({"margin-left":t.x,"margin-top":t.y}),this.scrollBefore.x+=e,this.scrollBefore.y+=i,this.scroller.scrollLeft(this.scrollBefore.x),this.scroller.scrollTop(this.scrollBefore.y)}},get shift(){return this._shift||{x:0,y:0}},set shift(t){if(!equals(this.shift,t)){var e=t.x*this.zoom,i=t.y*this.zoom,a=e-this.shift.x*this.zoom,n=i-this.shift.y*this.zoom;this._shift=t,this.grid.css({left:-e,top:-i}),this.scrollBefore.x-=a,this.scrollBefore.y-=n,this.scroller.scrollLeft(this.scrollBefore.x),this.scroller.scrollTop(this.scrollBefore.y)}},get size(){return this._size||{width:0,height:0}},set size(t){equals(this.shift,t)||(this._size=t,this.container.css({width:t.width,height:t.height}))},get zoom(){return 1*this._zoom||User.getUserSettings(["flowmap",this.id,"zoom"],.8)},set zoom(t){if(t=1*Math.min(Math.max(1*t,.6),1).toFixed(1),this.zooming)this.grid.onTransitionEnd(250).then(function(){this.zoom=t}.bind(this));else if(!equals(t,this.zoom)){this.zooming=!0,$("header").find('input[name="zoom"]').val(t);var e=(this.scroller.scrollLeft()-this.border.x+content.width()/2)/this.params.GridWidth,i=(this.scroller.scrollTop()-this.border.y+content.height()/2)/this.params.GridHeight;this._zoom=t,this.view();var a=this.border.x+this.params.GridWidth*e-content.width()/2,n=this.border.y+this.params.GridHeight*i-content.height()/2,o={x:this.scroller.scrollLeft()-a,y:this.scroller.scrollTop()-n};this.line.css("stroke-width",1/t),this.grid.setTransform({x:o.x,y:o.y,s:t}),this.grid.onTransitionEnd(250).then(function(){this.grid.css({transform:"scale("+t+")",transition:"none"}),this.scroller.scrollLeft(this.scroller.scrollLeft()-o.x),this.scroller.scrollTop(this.scroller.scrollTop()-o.y),this.grid.css({transition:""}),this.zooming=!1}.bind(this)),User.setUserSettings(["flowmap",this.id,"zoom"],t)}},get search(){return this._search||!1},set search(t){equals(this._search,t)||((this._search=t)?this.filter&&$("header").find('select[name="filter"]').flowmapSelect("value","all"):this.list().forEach(function(t){t.indexTitle(!1),t.dom.toggleClass("flowmap__item--search",!1)}),this.view())},get filter(){return this._filter||!1},set filter(t){equals(t,this.filter)||((this._filter=t)?$("header").find(".js-filter").trigger("value",{value:t}):$("header").find(".js-filter").trigger("value",{value:["all"]}),this.highlightLabels(),this.view())},get mod(){return this._mod},set mod(t){equals(this.mod,t)||(this._mod=t,this.grid.toggleClass("flowmap__grid--default","default"==t),this.grid.toggleClass("flowmap__grid--minimal","minimal"==t),User.setUserSettings(["flowmap",this.id,"mod"],t),this.renderLabels(),this.view())},get gridParams(){var t=e[this.mod];return{x:1*t.x,y:1*t.y,ox:1*t.ox,oy:1*t.oy,o:39,s:1}},view:function(t){var e,n=this,i=!this.search?"default":"search",a=this.zoom,o=this.gridParams,s=$(".content"),r=0,c="",l=Object.assign({},this.shift);if(this.scrollBefore={x:this.scroller.scrollLeft(),y:this.scroller.scrollTop()},this.cardTree||(this.cardTree=new C({title:"Create First Page",group:"main"})),this.cardTree.ignore&&this.footerPages.children.length<2)return!(this.emptyState=1);var d=this.list();if(t instanceof j?e={x:t.coord.x,y:t.coord.y}:t="object"==typeof t?(e=t,!1):!(e={x:0,y:0}),"search"===i){var h=new RegExp(this.search.split("").join(" ?"),"i");d.forEach(function(t){t.dom.toggleClass("flowmap__item--search",!0),t.indexTitle(h)}),d.sort(function(t,e){return t.searchIndex-e.searchIndex}),o.y=o.y-o.oy+o.ox,o.oy=o.ox;var u=Math.floor(s.width()/o.x),p=(Math.floor(s.height()/o.y),0),m=0;d.forEach(function(t){var e=0<=t.searchIndex;m=Math.floor(p/u),t.coord={x:(p-m*u)*o.x,y:m*o.y,s:o.s,z:e?p+2:1,o:1&e,p:e},e&&p++}),r=p;var f=(s.width()-10-o.x*u)/2;l.x+=this.scroller.scrollLeft()-this.border.x+f,l.y+=this.scroller.scrollTop()-this.border.y+f,this.footer.setTransform({o:0})}else{var g=this.tree(function(t){var e=(t.position.x+t.position.rx)*o.x,i=(t.position.y+t.position.ry)*o.y,a=!(!n.filter||!t.position.d)&&!n.filter.every(function(e){return[].concat(t.get("label")).find(function(t){return t==e})});t.coord={x:e,y:i,s:o.s,z:"",o:a?.4:1&t.position.d,p:!a&&t.position.d},!t.position.d&&t.select&&n.select(t,!1),t.position.d&&t.children.length&&"main"===t.group&&(t.ignoreChildren?t.nearDrag&&(c+=" "+x([{x:e,y:i+o.y}],{x:e,y:i},o)):c+=" "+x(t.children.reduce(function(t,e){return e.position.d&&t.push({x:(e.position.x+e.position.rx)*o.x,y:(e.position.y+e.position.ry)*o.y}),t},[]),{x:e,y:i},o)),r+=t.position.d});this.params.width=g.w,this.params.height=g.h;var v={width:g.w*o.x-o.ox,height:g.h*o.y-o.oy};this.params.GridWidth=v.width*a,this.params.GridHeight=v.height*a;var b={x:s.width()-(o.x-o.ox)*a,y:s.height()-(o.y-o.oy)*a},_=(g.w*o.x-o.ox)*a,y=(g.h*o.y-o.oy)*a,w={width:_+2*b.x,height:y+2*b.y};l.x+=e.x,l.y+=e.y,t&&(l.x-=t.coord.x,l.y-=t.coord.y),this.line.attr(v),this._drag||(b.x+=(this.footerPages.position.addLeft*o.x-o.ox)*a),this.border=b,this.size=w;this.footerPages.position;var k={};k.realWidth=w.width/a,k.width=2*k.realWidth,k.left=-1*b.x/a-k.realWidth/2,k.top=y/a-o.y,forceReflow(this.container),this.shift=objectEach(l,function(t,e){this[e]=t}),this.footer.setTransform({x:this.footerPages.coord.x+l.x,y:this.footerPages.coord.y+(this.gridParams.y-this.gridParams.oy),s:1/a})}d.forEach(function(t){var e=t.coord;t[n._drag&&t.drag?"shadow":"dom"].setTransform({x:e.x+l.x,y:e.y+l.y,s:e.s,o:e.o,p:e.p})}),this.linePath=c,n.line.setTransform({x:l.x,y:l.y}),this.emptyState=r?0:2,this.subscriber("add",{event:"view"}),app.subscriber("add",{scope:app,event:"sitemapView"}),(this.params.GridWidth>s.width()||this.params.GridHeight>s.height())&&app.subscriber("add",{scope:app,event:"sitemapOffScreen"})},scrollTo:function(t,e){if(safetyObjectAccess(t,["position","d"],!1)){var i=this.gridParams,a=(t.coord.x+(i.x-i.ox)/2)*this.zoom+this.border.x-content.width()/2,n=(t.coord.y+(i.y-i.oy)/2)*this.zoom+this.border.y-content.height()/2+80;this.scroller.stop().animate({scrollLeft:a,scrollTop:n},e||0)}},fitToView:function(t){var e=this.gridParams,i=this.params.width*e.x-e.ox,a=this.params.height*e.y-e.oy,n=content.width(),o=content.height(),s=Math.min(flowmap.footerPages.position.x*e.x,0);if(!0!==t||this._fitToView){if(!1!==t||!this._fitToView)return this._fitToView||!1;var r=i*this._fitToView.k,c=a*this._fitToView.k,l=(n-r)/2,d=(o-c)/2,h=cursorX,u=cursorY-content.offset().top,p=l+(h-l)/r*this.params.GridWidth-h,m=d+(u-d)/c*this.params.GridHeight-u,f=this._fitToView.x-p-this._fitToView.shiftX+s*this._fitToView.k-s*this.zoom,g=this._fitToView.y-m-this._fitToView.shiftY;this.grid.setTransform({x:f,y:g,s:this.zoom}),this.line.css("stroke-width",1/this.zoom),this.grid.onTransitionEnd(250).then(function(){this.grid.css({transform:"scale("+this.zoom+")",transition:"none"}),this.scroller.scrollLeft(this.scroller.scrollLeft()-f),this.scroller.scrollTop(this.scroller.scrollTop()-g),this.grid.css({transition:""}),this._fitToView=!1}.bind(this)),this.scale=!1}else{var v=n-40,b=o-40,_=Math.min(this.zoom,v/i,b/a),y={x:this.shift.x*this.zoom-this.shift.x*_,y:this.shift.y*this.zoom-this.shift.y*_},w=this.scroller.scrollLeft()-this.border.x+y.x-s*_,k=this.scroller.scrollTop()-this.border.y+y.y;this._fitToView={x:w+(n-i*_)/2,y:k+(o-a*_)/2,shiftX:y.x,shiftY:y.y,k:_},this.grid.setTransform({x:this._fitToView.x,y:this._fitToView.y,s:_}),this.line.css("stroke-width",1/_),this.scale=_}},drag:function(l){if(this._drag||"default"!=this.method||!l.parent&&"main"==l.group)return!1;this._drag=!0,l.drag=!0,this.view();var d=!1,h=this,u=this.scale||this.zoom,e=l.parent.id,i=l.childIndex,p=this.gridParams,m=this.scroller,f=(l.position.x+l.position.rx)*p.x,g=(l.position.y+l.position.ry)*p.y,v=cursorX/u,b=cursorY/u,_=m.scrollLeft(),y=m.scrollTop(),t=(content.outerWidth(),content.offset().top,content.offset().top,content.outerHeight(),function(){var t=f+(cursorX/u-v)+(m.scrollLeft()-_),e=g+(cursorY/u-b)+(m.scrollTop()-y),i=h.cellMap,a=Math.floor((e+p.y/2)/p.y);l.children.length?(!d&&a>=i.length-2&&(d=!0,app.modules.get("notify",{mod:"red",content:"You can't move Page with Subpages to the Footerpage Area"})),a=Math.max(Math.min(a,Math.floor(h.params.height-1)),1)):(a=Math.max(Math.min(a,Math.floor(h.params.height)),1))==i.length-2&&e+p.y/4>a*p.y&&a++;var n=Math.floor((t+p.x/2)/p.x);safetyObjectAccess(i,[a,n],!1)||(n=Math.max(Math.min(n,h.params.width-1),Math.min.apply(Math,Object.keys(i[a])))),l.dom.setTransform({x:t+h.shift.x,y:e+h.shift.y,s:p.s,r:3,z:9999999});var o=safetyObjectAccess(i,[a,n],!1);if(o){var s,r,c="c"==o.drt?n*p.x>t?"l":"r":o.drt;"b"==c?(s=o.card,r=o.card.children.length):"l"==c?(s=o.card.parent,r=o.card.childIndex):"r"==c&&(s=o.card.parent,r=o.card.childIndex+1),l.id==s.id||l.parent.id==s.id&&l.childIndex==r||(l.childIndex=r,s.id==l.parent.id?(l.childIndex-=.5,s.sortChild()):(l.parent&&l.parent.removeChild(l),s&&s.addChild(l)),h.view())}}),a=function(){t()},n=function(){t()},o=app.modules.get("sideZoneScroll",{target:content,settings:{scroller:m}});$(document).on("mousemove",a),m.on("scroll",n),$(document).one("mouseup",function(){if($(document).off("mousemove",a),m.off("scroll",n),o.die(),i!=l.childIndex||e!=l.parent.id){var t={project:h.id,parent:l.parent.id,card:l.id,group:l.group,index:l.childIndex};app.serverRequest("flowmapdrag",t),flowmap.socket.trigger("move",t)}setTimeout(function(){h._drag=!1,l.drag=!1,h.view()},50),l.shadow.setTransform({x:l.coord.x+h.shift.x,y:l.coord.y+h.shift.y,s:l.coord.s,o:0}),setTimeout(function(){l.drag||(l.shadow.remove(),l._shadow=null,l.dom.setTransform({z:""}))},150)})},spoiler:function(t,e,i){(t=[].concat(t)).forEach(function(t){t.spoiler=e}),this.view(1<t.length?i||!1:t.first())},getLabel:function(e){return void 0===e?this.labelList:this.labelList.find(function(t){return t.id==e})||!1},setLabel:function(i){this.selected.forEach(function(t){var e=this.getCard(t);e&&e.change("label",i)}.bind(this))},get cellMap(){for(var a=[],t=0;t<=Math.ceil(this.params.height-1);t++)a[t]=[],a[t].length=this.params.width;this.list().forEach(function(t){var e=t.position;if(e.d&&!t.underDrag&&(a[Math.ceil(e.y)][e.x+e.rx]={group:t.group,card:t,drt:"c"},1<e.w))for(var i=0;i<e.w;i++)i<e.rx&&(a[e.y][e.x+i]={group:t.group,card:t,drt:"l"}),i>e.rx&&(a[e.y][e.x+i]={group:t.group,card:t,drt:"r"})});var n=a.last();if(this.footerPages.children.length){var o=function(t,e){var i=n[e];return!i&&0<=e&&e<n.length&&(i=o(t,e+t),n[e]=Object.assign({},i,{drt:0<t?"l":"r"})),i};o(1,0),o(-1,n.length-1)}else for(t=0;t<n.length;t++)n[t]={group:"footer",card:this.footerPages,drt:"b"};for(var e=0;e<a.length;e++)for(var i=a[e],s=0;s<i.length;s++)if(!i[s])for(t=e;0<=t;t--){var r=a[t][s];if(r){i[s]={group:r.group,card:r.card,drt:"b"};break}}return a},get focus(){return this._focus||!1},set focus(t){this._focus=t||!1},get centralCardInView(){var t=this.gridParams,e=this.cellMap,i=this.scroller.scrollLeft()+content.outerWidth()/2-this.border.x,a=this.scroller.scrollTop()+content.outerHeight()/2-this.border.y,n=Math.max(Math.min(Math.floor(i/t.x*this.zoom),this.params.width-1),0),o=Math.max(Math.min(Math.floor(a/t.y*this.zoom),this.params.height-1),1);return!(!e[o]||!e[o][n])&&e[o][n].card},shortCut:{keycode:{32:{event:"scrollMouse"},37:{event:"scrollStep",args:"l"},38:{event:"scrollStep",args:"t"},39:{event:"scrollStep",args:"r"},40:{event:"scrollStep",args:"b"},13:{event:"open",args:!0},27:{event:"deselect"},8:{event:"delete",args:!0},46:{event:"delete",args:!0},"=":{event:"zoom",args:1},"+":{event:"zoom",args:1},"-":{event:"zoom",args:-1},72:{event:"toggleCurrentSpoiler"},18:{event:"outzoom",args:!0}},event:{do:function(t,e){this[t.event]&&this[t.event]&&("object"==typeof this[t.event]?this[t.event].init(t.args,e):"function"==typeof this[t.event]&&this[t.event](t.args,e))},die:function(t,e){this[t.event]&&this[t.event]&&"object"==typeof this[t.event]&&this[t.event].die(t.args,e)},scrollStep:function(t,e){e.preventDefault();var i=flowmap.focus||flowmap.selected.last(),a=flowmap.cellMap;if(i){var n=i.position.x+i.position.rx,o=Math.ceil(i.position.y+i.position.ry),s=null,r=null;switch(t){case"l":for(var c=o;c<a.length;c++){for(var l=n-1;0<=l;l--){if((p=a[c][l])&&p.card.id!=i.id){if("b"!=p.drt){s=p.card;break}r||(r=p.card)}}if(r||s)break}break;case"r":for(c=o;c<a.length;c++){for(l=n+1;l<a[c].length;l++){if((p=a[c][l])&&p.card.id!=i.id){if("b"!=p.drt){s=p.card;break}r||(r=p.card)}}if(r||s)break}break;case"t":for(c=o-1;0<=c;c--){if((p=a[c][n])&&p.card.id!=i.id){s=p.card;break}}break;case"b":for(c=o+1;c<a.length;c++){for(var d=0,h=0,u=!0;u;){var p,m=2;if(n+h<a[c].length){if((p=a[c][n+h])&&p.card.id!=i.id&&"b"!=p.drt){s=p.card;break}}else m-=1;if(0<=n+d){if((p=a[c][n+d])&&p.card.id!=i.id&&"b"!=p.drt){s=p.card;break}}else m-=1;d-=1,h+=1,u=!!m}if(s)break}}i=s||r}else i=flowmap.centralCardInView;i&&(e.shiftKey?flowmap.select(i,!0,!e.shiftKey):flowmap.select(i,!0,!0),flowmap.focus=i,flowmap.scrollTo(i,150))},scrollMouse:{init:function(){if(this.state)return!1;this.state=!0,this.fs=app.modules.get("fakeScroll",{container:flowmap.container,scroller:flowmap.scroller}),this.mouseState=buttonsState.check(1,"mouse"),this.bind()},die:function(){if(!this.state)return!1;this._mouseState=null,this.fs.compensate(),this.state=!1,this.unbind()},move:function(){if(this.mouseState){var t=this.mouseStartX-cursorX,e=this.mouseStartY-cursorY;this.mouseStartX=cursorX,this.mouseStartY=cursorY,this.fs.move({x:t,y:e})}},get mouseState(){return this._mouseState},set mouseState(t){equals(this.mouseState,t)||(this._mouseState=t)&&(this.mouseStartX=cursorX,this.mouseStartY=cursorY)},mousemove:function(){this.move()},mouseup:function(){this.mouseState=!1,this.fs.compensate()},mousedown:function(){this.mouseState=!0},bind:function(){$("body").on("mousemove",$.proxy(this.mousemove,this)).on("mouseup",$.proxy(this.mouseup,this)).on("mousedown",$.proxy(this.mousedown,this))},unbind:function(){$("body").off("mousemove",$.proxy(this.mousemove,this)).off("mouseup",$.proxy(this.mouseup,this)).off("mousedown",$.proxy(this.mousedown,this))}},open:function(){var t=flowmap.focus||flowmap.selected.last()||!1;t&&t.focus.openModal()},delete:function(){flowmap.selected.length?flowmap.removeCard(flowmap.selected):flowmap.focus&&flowmap.removeCard(flowmap.focus.id)},deselect:function(){flowmap.selectAll(!1)},outzoom:{init:function(){if(1==this.state)return this;flowmap.fitToView(!0)},die:function(){return flowmap.fitToView(!1),this}},zoom:function(t){flowmap.zoom+=t/10},toggleCurrentSpoiler:function(t,e){if(e.shiftKey){var i=flowmap.list().filter(function(t){return"main"===t.group});1<i.length&&flowmap.spoiler(i,i.some(function(t){return!1===t.spoiler}),flowmap.cardTree)}else if(flowmap.selected.length){var a=flowmap.selected.map(function(t){return flowmap.getCard(t)}),n=!a.every(function(t){return t.spoiler});flowmap.spoiler(a,n,flowmap.focus||a.last())}}},find:function(t){for(var e in this.keycode)if(t.keyCode==e||t.key==e)return this.keycode[e];return!1},keyup:function(t){if(flowmap.state){var e=$(t.target);if(e.is("input")||e.is("textarea"))return;var i=this.find(t);if(i)return t.preventDefault(),this.event.die(i,t),!1}},keydown:function(t){if(flowmap.state){var e=$(t.target);if(e.is("input")||e.is("textarea")||app.modules.get("modalList",!0).length)return;if(!flowmap.modal){var i=this.find(t);if(i&&(!i.metaKey||t.ctrlKey||t.metaKey))return t.preventDefault(),this.event.do(i,t),!1}}},bind:function(){$(document).on("keyup",$.proxy(this.keyup,this)),$(document).on("keydown",$.proxy(this.keydown,this))},unbind:function(){$(document).off("keyup",$.proxy(this.keyup,this)),$(document).off("keydown",$.proxy(this.keydown,this))}},bind:function(){var a=this;this.shortCut.bind(),this.socket.on("change",function(t){var e="project"===t.target?a:a.getCard(t.target);e&&e.set(t.event,t.data)}).on("move",function(t){if(t.project===a.id){var e="footer"==t.parent?a.footerPages:a.getCard(t.parent),i=a.getCard(t.card);i&&e&&(i.parent.removeChild(i),i.childIndex=t.index,e.addChild(i),a.view())}}).on("remove",function(t){a.disappearCard(t.card)}).on("create",function(t){var e=new j(t);if(t.parent_id){var i=a.getCard(t.parent_id);i&&(i.addChild(e),a.grid.append(e.dom))}else"main"===t.group?(a.cardTree&&a.cardTree.dom.remove(),a.cardTree=e,a.grid.append(e.dom)):"footer"===t.group&&(a.footerPages.addChild(e),a.grid.append(e.dom));a.view()}),this.dom.on("click",function(t){a.focus=!1,$(t.target).closest(".flowmap__item").length||t.shiftKey||(a.filter=!1,a.selectAll(!1))}),this.projectSubscriberKey=app.projects.subscriber("on",{scope:this.id},function(t){var i=["attaches"];t.forEach(function(e){i.forEach(function(t){delete e.data[t]}),"update"==e.event&&a.set(e.data)})}.bind(this))},unbind:function(){this.selectBar.subscriber("off",this.selectBarBindKey),app.projects.subscriber("off",this.projectSubscriberKey),this.shortCut.unbind(),this.socket.off(),this.socket=null},header:function(){var n=this;app.modules.get("header").update({tools:[{name:"headerPanel",content:[{name:"input",param:{mod:["narrow","shortest","horizontal","round"],name:"search",value:n.search||"",placeholder:"",icon:"search",callback:function(t){t.value=t.value.replace(/ /g,""),n.search=!!t.value.length&&t.value}}}]},{name:"headerPanel",param:{mod:"right"},content:[{name:"flowmapLabel",param:{class:"js-filter",mod:["bordered"],get list(){return[{id:"all",text:"All labels",color:"linear-gradient(134.72deg, #D63E81 0%, #5D55FC 52.47%, #00A6FF 100%)",editable:!1}].concat(n.labelList.map(function(t){return Object.assign({editable:"none"!=t.id&&(!!t.project_id||n.get("owner")===User.id)},t)}))},"max-width":430,rerender:!0,multitudeLimit:6,multitude:!0,lonerList:["all","none"],defaultValue:"all",label:"View",newLabel:function(e){return app.serverRequest("addLabel",Object.assign(e,{project_id:n.id})).then(function(t){return n.change("labelList",n.labelList.concat(Object.assign(e,{id:t,project_id:n.id,text:e.title}))),{value:t,project_id:n.id}})},changeLabel:function(a){return app.serverRequest("updateLabel",a).then(function(t){var e=n.labelList.slice(0),i=e.find(function(t){return t.id==a.id});a.project_id=a.project_id.toString()?a.project_id:null,i?(i.color=a.color,i.text=a.title):e.push({color:a.color,text:a.title,id:a.id,project_id:a.project_id||null}),n.change("labelList",e)})},removeLabel:function(e){return n.change("labelList",n.labelList.filter(function(t){return t.id!==e})),app.serverRequest("removeLabel",{id:e})},callback:function(t){n.filter=(1!=t.length||"all"!==t[0])&&t},value:"all"}},{name:"input",param:{mod:["range","narrow","minimal","horizontal"],type:"range",events:"change",label:"Zoom",min:.6,max:1,step:.1,value:n.zoom,name:"zoom",callback:function(t){n.zoom=t.value}}},{name:"buttonStack",param:{name:"mod",value:n.mod,mod:"compact",callback:function(t){n.mod=t.value}},content:[{name:"button",param:{data:{value:"default"},mod:["white","square"],icon:"img"}},{name:"button",param:{data:{value:"minimal"},mod:["white","square"],icon:"noimg"}}]},{name:"button",param:{mod:["white","square"],icon:"tree",callback:function(){n.treeModal(!0)}}}]}]})},helpBar:function(){app.modules.get("sideTools",[["shortcut",[{description:"Move workplace",value:["hold",{name:"key",param:{value:"Space"}}]},{description:"Zoom to fit",value:["hold",{name:"key",param:{value:"Alt"}}]},{description:"Select Page Cards",value:["hold",{name:"key",param:{value:"Shift"}},"plus","click"]},{description:"Deselect",value:{name:"key",param:{value:"Esc"}}},{description:"Move on one Page Card",value:[{name:"key",param:{type:"arrow",value:"left"}},"or",{name:"key",param:{type:"arrow",value:"top"}},"or",{name:"key",param:{type:"arrow",value:"right"}},"or",{name:"key",param:{type:"arrow",value:"bottom"}}]},{description:"Collapse/Expand selected Page Card",value:[{name:"key",param:{value:"H"}}]},{description:"Collapse/Expand All",value:[{name:"key",param:{type:"meta"}},"plus",{name:"key",param:{value:"Shift"}},"plus",{name:"key",param:{value:"H"}}]},{description:"Zoom in",value:{name:"key",param:{value:"+"}}},{description:"Zoom out",value:{name:"key",param:{value:"–"}}}]]])},export:function(t,e){if(a.hasOwnProperty(t))return a[t](e);throw"Undefined export mod"},createNewCard:function(t,n,e,o){var s=this,i=function(e){o=o||(t?t.group:"main"),e=Object.assign(e,t?{project_id:s.id,parent_id:t.id,child_index:n}:{project_id:s.id,child_index:n},{group:o,owner_id:User.id},{id:getRandom()});var i=new j(e),a=i.dom.loader("flowmapCard");return s.grid.append(i.dom),t?t.addChild(i):(s.cardTree&&s.cardTree.dom.remove(),s.cardTree=i),"footer"===o&&delete e.parent_id,s.state&&(s.view(),t||s.scrollTo(i)),app.serverRequest("addflowmap",e).then(function(t){return!1===t.status?(s.disappearCard(i.id),"PAGES_QUOTA_EXCEED"===t.message&&(s.accessibility?app.modules.get("modalTemplates","upgradeSubscriptionModal","pageLimit"):app.modules.get("alert",{heading:"Project quota exceeded!",content:"Oops! Something went wrong. Seems like the owner of this project have exceeded subscription quota. Please contact the project owner.",buttons:["Ok, I understand"]})),!1):(e.id=i.id=t.id,s.socket.trigger("create",e),s.subscriber("add",{event:"view"}),a.done(),4<s.list().length&&app.subscriber("add",{scope:app,event:"sitemapManyPages"}),i.updateLabel(!0),i)})};if("default"===this.method)return e?i(e):app.modules.get("modalTemplates","createPage",{id:flowmap.id,mod:"create",wfc:!0,labels:s.labelList}).then(function(t){if(t){var e=t.callback;return t=t.data,setTimeout(e,300),i({title:t.title,description:t.description,date_create:app.serverTime(),date_update:app.serverTime(),img:t.cover,label_id:t.label})}}).catch(app.error)},treeModal:function(t){var h=this;if(!0!==t||this._treeModal){if(!1!==t||!this._treeModal)return this._treeModal;this._treeModal.close()}else{var e=app.modules.get("modal",{mod:["side","right","small","transparent","nooverlay"],overlay:!1}),i=app.modules.get("html"),u=app.modules.get("executingList")(),a=[function(){return $('<div class="fm-flowmap-heading fm-flowmap-heading--transperant"></div>').append(i({name:"paragraph",param:{mod:["big","gray"]},content:"Project Map"}))},function(){var t=$('<div class="fm-flowmap-content fm-flowmap-content--white fm-flowmap-content--inside"></div>'),c=20,l=28,e=$('<div class="fm-flowmap-tree"></div>').appendTo(t),i=$('<div class="fm-flowmap-tree__grid"></div>').appendTo(e),a=$('<div class="fm-flowmap-tree__separator">Footer Pages</div>').appendTo(i);e.customScroll({drt:"bi"});var n=function(t){this.card=t,this.bind()};n.prototype={get id(){return this.card.id},get title(){return this.card.get("title")},get position(){return this.card.position},get children(){return!!this.card.children.length},get spoiler(){return this.card.spoiler},get label(){return h.getLabel(this.card.get("label")).color},get group(){return this.card.group},get width(){return Math.round(this.titleDom.width()+80)},get even(){return this._even||!1},set even(t){equals(this.even,t)||(this._even=t,this.dom.toggleClass("even",t))},get parent(){return this._parent||!1},set parent(t){equals(this.parent,t)||(this._parent=t,this.dom.toggleClass("parent",t))},update:function(){this.dom.find(".js-label").css("background",this.label),this.dom.find(".js-title").text(this.title)},bind:function(){var e=this.card;this.dom.on("click",function(t){h.focus=e,h.scrollTo(e,250),setTimeout(function(){$(t.target).closest(".js-spoiler").length&&h.spoiler(e,!e.spoiler)},270),this.dom.addClass("selected").siblings().removeClass("selected")}.bind(this)).on("dblclick",function(t){$(t.target).closest(".js-spoiler").length||e.openModal()})},die:function(){this.dom.css({opacity:0,"pointer-events":"none"}),this.card=null,setTimeout(function(){this.dom.off().remove(),this._dom=null}.bind(this),150)},get dom(){return this._dom||(this._dom=this.template,i.append(this._dom)),this._dom},get template(){var t=this.label;return $('<div class="fm-flowmap-tree__item"></div>').append('<div class="fm-flowmap-tree__spoiler js-spoiler"></div>').append('<div class="fm-flowmap-tree__label js-label" style="background: '+(t||"#ffffff")+'"></div>').append('<div class="fm-flowmap-tree__title js-title">'+this.title+"</div>")},get titleDom(){return this._titleDom||(this._titleDom=this.dom.find(".js-title")),this._titleDom}};var d=h.list().reduce(function(t,e){return e.ignore||t.push(new n(e)),t},[]),o=function(){var o=0,s=0,r=!1;d.forEach(function(t){if(t.ignore)return!1;var e,i,a=t.position;if("footer"==t.group?(e=0,i=s+1,r||(r=s*l)):(e=a.y,i=s),e=10+(e+1)*c,i*=l,t.dom.css({"padding-left":e,transform:"translate(0px, "+i+"px)",opacity:a.d?1:0,"z-index":a.z,"pointer-events":a.d?"auto":"none"}),t.even=!!(s%2),t.parent=t.children,t.dom.toggleClass("spoiler",t.children&&t.spoiler),a.d){var n=t.width+e;o<n&&(o=n),s++}}),!1!==r?a.css({opacity:1,transform:"translate( 0px, "+r+"px )"}):a.css({opacity:0,transform:"translate( 0px, "+r+"px )"}),i.css({width:o})},s=function(e){return d.find(function(t){return t.id==e})},r=h.subscriber("on",{event:"view"},function(t){t.forEach(function(e){if(e.hasOwnProperty("scope"))setTimeout(function(){var t=s(e.scope);t&&t.update()},20);else{d.forEach(function(t){t.markToDelete=!0});var t=flowmap.list().reduce(function(t,e){if(e.ignore)return t;var i=s(e.id);return i||(i=new n(e)),i.markToDelete=!1,t.push(i),t},[]);d.forEach(function(t){t.markToDelete&&t.die()}),d=t,o()}})});return u.add({fn:h.subscriber,arg:["off",r]}),o(),t}].map(function(t){return t()});e.insert(a),e.open(),(this._treeModal=e).subscriber("on",{event:"close"},function(){u.exec(),this._treeModal=null}.bind(this))}},getAllAssignedCardId:function(t){var e=[],i=function(t){e.includes(t.id)||e.push(t.id)};return this.getCard(t).forEach(function(t){i(t),t.allChild.forEach(i)}),e},disappearCard:function(t){var e=!1,i=this.getCard([].concat(t));i.forEach(function(t){t.delete=!0}),this.view(),i.forEach(function(t){t.parent?t.parent.removeChild(t):e=!0}),e&&(this.cardTree=null),this.view()},removeCard:function(t,e){if("default"===this.method){var i=[].concat(t),a=this.getAllAssignedCardId(i),n=i.length,o=a.length-n;return a.includes(flowmap.cardTree.id)?app.modules.get("alert",{heading:"You can't delete the Main Page!",content:"Main Page could not been deleted. Please keep it in your Project and edit content inside to start something new.",buttons:["Okay"]}):app.modules.get("alert",{type:"alert",heading:"Delete this Page"+(1<n?"s":"")+"?",content:"Are you sure you wish to delete this page"+(1<n?"s":"")+'?</br>Pay attention, that this action <span class="red">will delete linked pages below</span>, and remove all associated comments and files.',buttons:["Delete "+(1<n?n:"this")+" Page"+(1<n?"s":"")+(0<o?" and "+o+" Subpage"+(1<o?"s":""):""),"Сancel"]},function(t){!0===t&&(app.serverRequest("removeflowmap",{card:i}),this.socket.trigger("remove",{card:i}),this.disappearCard(a)),"function"==typeof e&&e(!0===t)}.bind(this))}"function"==typeof e&&e(!1)},get emptyState(){return this._emptyState||0},set emptyState(t){if(!equals(this.emptyState,t)){var e=this;this._emptyState=t;var i=this.workplace.pages.dom.find(".parallel-pages__container");if(this.placeholder){var a=this.placeholder;a.removeClass("open"),setTimeout(function(){a.remove()},150),this.placeholder=null}switch(app.modules.get("header").disable("tools",1===t),t){case 1:this.placeholder=app.modules.get("html",{name:"emptyPlaceholder",param:{mod:"absolute",template:"flowmapEmpty",callback:function(t){"create"===t&&e.createNewCard(!1,0)}}}).appendTo(i),forceReflow(this.placeholder),this.placeholder.addClass("open");break;case 2:this.placeholder=app.modules.get("html",{name:"emptyPlaceholder",param:{mod:"absolute",template:"flowmapNotFound"}}).appendTo(i),forceReflow(this.placeholder),this.placeholder.addClass("open")}}},select:function(t,e,i){if(e=void 0!==e?e:!t.select,!equals(t.select,e)||i){var a=this,n=this.selected.indexOf(t.id);if(e&&(n<0||i)?t.position.d?(!0===i&&this.selectAll(!1),this.selected.push(t.id)):e=!1:!e&&0<=n&&this.selected.remove(n),t.select=e,this.selectBar.count(this.selected.length),this.selected.length){var o=this.selected.reduce(function(t,e){return t.concat(a.getCard(e).get("label"))},[]).filter(function(t){return"none"!==t}).uniq();this.selectBar.dom.find(".fm-flowmap-labels").trigger("value",{value:o.length?o:["none"]})}else this.selectBar.dom.find(".fm-flowmap-labels").trigger("value",{value:["none"]}),app.subscriber("add",{scope:app,event:"selectBarClose"});app.subscriber("add",{scope:app,event:"sitemapSelect"}),1<this.selected.length&&app.subscriber("add",{scope:app,event:"sitemapManyPagesSelected"})}},selectAll:function(e){if("boolean"!=typeof e)return!1;var i=this;this.list().forEach(function(t){i.select(t,e)})},get selectBar(){if(!this._selectBar){var o=this;this._selectBar=app.modules.get("selectbar",""),this.selectBar.render({textTemplate:function(t){return 1<t?"Pages selected":"Page selected"},events:[{name:"flowmapLabel",param:{mod:["bordered"],get list(){return o.labelList.map(function(t){return Object.assign({editable:"none"!=t.id&&(!!t.project_id||o.get("owner")===User.id)},t)})},width:130,"max-width":430,rerender:!0,multitude:!0,lonerList:["none"],popoverMod:["right","top"],defaultValue:"none",label:"Change label",newLabel:function(e){return app.serverRequest("addLabel",Object.assign(e,{project_id:o.id})).then(function(t){return o.change("labelList",o.labelList.concat(Object.assign(e,{id:t,project_id:o.id,text:e.title}))),{value:t,project_id:o.id}})},changeLabel:function(a){return app.serverRequest("updateLabel",a).then(function(t){var e=o.labelList.slice(0),i=e.find(function(t){return t.id==a.id});a.project_id=a.project_id.toString()?a.project_id:null,i?(i.color=a.color,i.text=a.title):e.push({color:a.color,text:a.title,id:a.id,project_id:a.project_id||null}),o.change("labelList",e)})},removeLabel:function(e){return o.change("labelList",o.labelList.filter(function(t){return t.id!==e})),app.serverRequest("removeLabel",{id:e})},value:"none",valueRender:function(t){return(1<t.length||"none"!==t[0])&&"Choose labels"},input:function(a,n){o.selected.forEach(function(t){var e=o.getCard(t);if(e){var i=e.get("label").slice(0);"none"===a?i=["none"]:n?i.length<6&&(i=[].concat(i,a).findAndRemove("none")):(i.findAndRemove(a),i.length||(i=["none"])),e.change("label",i)}})}}},"delete"]}),this.selectBarBindKey=this.selectBar.subscriber("on",function(t){t.forEach(function(t){switch(t=t.event){case"delete":o.removeCard(o.selected);break;case"select":o.selectAll(!0);break;case"deselect":o.selectAll(!1)}})})}return this._selectBar},get line(){return this._line||(this._line=$('<svg class="flowmap__line"></svg>').appendTo(this.grid)),this._line},get snapLine(){return this._snapLine||(this._snapLine=Snap(this.line.get(0)).path("")),this._snapLine},get linePath(){return this._linePath||""},set linePath(t){equals(this.linePath,t)||(this._linePath=t,this.snapLine.attr("d",t))},get scroller(){return this.controller.scroller},get container(){return this._container||(this._container=this.dom),this._container},get grid(){return this._grid||(this._grid=this.dom.find(".flowmap__grid")),this._grid},get template(){return app.modules.get("html",{param:{class:"flowmap__container"},content:[{param:{class:"flowmap__grid"},content:{param:{class:"flowmap__footer"},content:{param:{class:"flowmap__footer-text"},content:"Footer Pages"}}}]})},get dom(){return this._dom||(this._dom=this.template),this._dom},get footer(){return this._footer||(this._footer=this.container.find(".flowmap__footer")),this._footer}};var j=function(t){var e=this;this.id=t.id,this.data={},this.children=[],Subscriber(this),this.ignore=!!t.ignore,this.data.discussion=this.workplace.Discussion(this,t.msg_cnt||0,{get requestData(){return{id:e.id}},requestUrl:"flowmapDiscussionGet"}),this.data.attaches=this.workplace.Attaches(this,t.attaches||[],{get sendData(){return{card:e.id}}}),this.data.pageStructure=this.workplace.PageStructure(this,(t.pagestructure||[]).filter(function(t){return!!t})),this.data.link_url=t.link_url||"";var i=[].concat(t.label_id).filter(function(t){return!!t&&flowmap.getLabel(t)});this.set({title:t.title||"Unnamed",description:deltaDefine(t.description),attaches_desc:t.attaches_desc||[],cover:t.img,label:i.length?i:["none"],date_create:app.clientTime(t.date_create),date_update:app.clientTime(t.date_update),owner_id:t.owner_id,owner_title:t.owner_title||!1,childIndex:1*t.child_index||0,group:t.group||"main"}),this.updateFlags()};j.prototype={get workplace(){return flowmap.controller},get method(){return flowmap.method},get ownerName(){var t=app.projects.getUser(this.get("owner_id")||this.get("owner"))||!1;return t?User.fullName.call(t):this.get("owner_title")||"DELETED USER"},get:function(t){return this.data[t]},set:function(t,e){var i={};for(var a in"object"==typeof t?i=t:i[t]=e,i)(function(t,e){if(!equals(this.data[t],e)){switch(t){case"title":(void 0===this.searchIndex||this.searchIndex<0)&&this.dom.find('[data-field="title"]').html(e),this.subscriber("add",{event:t,data:{title:e}}),flowmap.subscriber("add",{event:"view",scope:this.id,data:{title:e}});break;case"cover":var i=this.dom.find('[data-field="cover"]');if(e){var a=i.loader("cover");app.img(e).then(function(t){i.css("background-image","url("+t+")"),a.done()}).catch(function(){i.css("background-image",""),a.done()})}else i.css("background-image","");this.subscriber("add",{event:t,data:e});break;case"pageStructure":return this.get("pageStructure")[e.event](e.target,e.data),this.subscriber("add",{event:t,data:e}),!1;case"discussion":return this.get("discussion")[e.event](e.target,e.data),this.subscriber("add",{event:t,data:e}),this.updateFlags(),!1;case"label":return this.data.label=e,this.updateLabel(),this.subscriber("add",{event:t,data:e}),flowmap.subscriber("add",{event:"view",scope:this.id,data:{label:e}}),!1;case"description":return this.subscriber("add",{event:t,data:e}),this.data[t]=e,this.updateFlags(),!1;case"attaches":return this.get("attaches")[e.event](e.target,e.data),this.subscriber("add",{event:t,data:e}),this.updateFlags(),!1;case"group":this.group=e;break;case"attaches_desc":this.subscriber("add",{event:t,data:e});break;case"link_url":this.data[t]=e,this.subscriber("add",{event:t,data:e}),this.updateFlags()}this.data[t]=e}}).bind(this)(a,i[a])},change:function(t,e){var i={};for(var a in"object"==typeof t?i=t:i[t]=e,i)(function(t,e){if(this.set(t,e),"default"===flowmap.method){switch(t){case"title":app.serverRequest("flowmapUpdateCard",{id:this.id,title:e});break;case"label":app.serverRequest("flowmapCardSetLabel",{id:this.id,label:e});break;case"cover":app.serverRequest("flowmapUpdateCard",{id:this.id,img:e});break;case"link_url":app.serverRequest("flowmapUpdateCard",{id:this.id,link_url:e});break;case"description":app.serverRequest("flowmapUpdateCard",{id:this.id,description:e});break;case"attaches_desc":app.serverRequest("flowmapUpdateCard",{id:this.id,attaches:arrayToRequest(e)});break;case"pageStructure":app.serverRequest("flowmapUpdateCard",{id:this.id,page_structure:arrayToRequest(this.data.pageStructure.get())})}var i={event:t,target:this.id,data:e};flowmap.socket.trigger("change",i)}}).bind(this)(a,i[a])},die:function(){this.dom.off(),this.subscriber("die")},get childIndex(){return this.data.childIndex},set childIndex(t){this.data.childIndex=t},addChild:function(e){[].concat(e).forEach(function(t){t instanceof j||t instanceof C?t.childIndex-=.5:t=new j(t),this.children.push(t),t.group=this.group,t.parent=this,e.drag&&(this.nearDrag=!0)}.bind(this)),this.dom.find(".js-spoiler").toggleClass("show",!!this.children.length),this.sortChild()},removeChild:function(t){[].concat(t).forEach(function(e){if(void 0===(e="object"==typeof e?e:this.children.find(function(t){return t.id==e})))return!1;this.children.remove(this.children.findIndex(function(t){return e.id==t.id})),e.parent=!1,e.drag&&(this.nearDrag=!1),e.underDrag&&(e.underDrag=!1),e.focus&&(e.focus=!1,flowmap.focus=!1)}.bind(this)),this.dom.find(".js-spoiler").toggleClass("show",!!this.children.length),this.sortChild()},sortChild:function(){this.children.sort(function(t,e){return t.childIndex-e.childIndex}),this.children.forEach(function(t,e){t.childIndex=e})},get parent(){return this._parent||!1},set parent(t){equals(this.parent,t)||(this._parent=t,this.dom.toggleClass("flowmap__item--children",!!this._parent))},get group(){return this.get("group")},set group(t){if(!equals(this.group,t))switch(this.data.group=t){case"main":this.dom.removeClass("flowmap__item--footer");break;case"footer":this.dom.addClass("flowmap__item--footer")}},get spoiler(){return this._spoiler||!1},set spoiler(t){equals(this.spoiler,t)||(this._spoiler=t,this.dom.find(".js-spoiler").toggleClass("active",this.spoiler))},get drag(){return this._drag||!1},set drag(e){equals(this.drag,e)||(this._drag=e,this.dom.toggleClass("flowmap__item--drag",e),this.parent.nearDrag=e,this.allChild.forEach(function(t){t.underDrag=e}))},get focus(){return this._focus||!1},set focus(t){equals(this.focus,t)||(this._focus=t,this.dom.toggleClass("flowmap__item--focus",t),this.renderLabel())},get labelInteractState(){return this.hover||this.select||"minimal"===flowmap.mod},get allChild(){var e=[];return this.children.forEach(function(t){e.push(t),Array.prototype.push.apply(e,t.allChild)}),e},get select(){return this._select||!1},set select(t){equals(t,this.select)||(this._select=t,this.dom.toggleClass("flowmap__item--select",t),this.dom.find(".js-select").toggleClass("checked",t),this.renderLabel())},get hover(){return this._hover||!1},set hover(t){equals(t,this.hover)||(this._hover=t,this.renderLabel())},get mute(){return this._mute||!1},set mute(t){equals(this.mute,t)||this.dom.toggleClass("flowmap__item--mute",t)},indexTitle:function(t){var e=this.dom.find('[ data-field="title"]'),i=this.get("title");return this.searchIndex=t?i.search(t):-1,-1<this.searchIndex?e.html(i.replace(t,'<span class="matched">$&</span>')):e.html(i),this.searchIndex},updateFlags:function(){this.dom.find(".flowmap__flags").remove(),this.dom.append(this.flagTemplate)},updateLabel:function(t){var e=this.labelTemplate;this.currentDisplayLabel=e,this.dom.find('[data-field="label"]').insert(e.html),this.renderLabel(!0,t)},renderLabel:function(t,e){var i=this.labelInteractState,a=this.dom.find('[data-field="label"]');if(a.off(),t&&a.addClass("flowmap__labels--instant"),i){var n=this.currentDisplayLabel.labels.reduce(function(t,e){return e.width||(e.width=e.dom.scrollWidth+3),t+e.width},0)+5*(this.currentDisplayLabel.labels.length-1)<=133,o=0;a.toggleClass("flowmap__labels--short",!n).toggleClass("flowmap__labels--full",n);var c=[];if(this.currentDisplayLabel.labels.forEach(function(t,e){var i=n?t.width:18,a=$(t.dom);a.css({transform:"translate("+o+"px, 0)",width:i,height:18}),c.push({index:e,realWidth:t.width,x:o,dom:a,width:i}),o+=i+5}),!n){var l=!1,d=function(){l&&(l.dom.css({width:l.width}).removeClass("hover"),l=!1)};a.on("mousemove",function(t){for(var e=$(this).offset(),i=flowmap.zoom,a=cursorX-e.left,n=0;n<c.length;n++){var o=c[n],s=o.x*i,r=o.width*i;if(s<=a&&a<s+r){if(l){if(l.index===o.index)break;d()}return(l=o).dom.css({width:o.realWidth}).addClass("hover"),!0}}133*i<a&&d()}).on("mouseleave",d)}}else this.currentDisplayLabel.labels.forEach(function(t){$(t.dom).css({transform:"",width:"",height:""})});t&&!1!==e&&(forceReflow(a),a.removeClass("flowmap__labels--instant"))},highlightLabels:function(t){var e=this.dom.find('[data-field="label"]');t?e.find(".js-label").each(function(){$(this).toggleClass("flowmap__label--highlight",t.includes($(this).data("label")+""))}):e.find(".flowmap__label--highlight").removeClass("flowmap__label--highlight")},openModal:function(){var i=this;this.workplace.openModal({hash:this.id,heading:{edit:"default"===this.workplace.method,value:this.get("title"),callback:function(t){i.change(t)},change:function(e){var t=i.subscriber("on",{event:"title"},function(t){t.map(function(t){return t.data}).forEach(e)});return{ctx:i.subscriber,fn:i.subscriber,arg:["off",t]}},buttons:"default"===this.workplace.method?[{icon:"delete",alt:"delete",callback:function(){flowmap.removeCard(i.id,function(t){t&&i.workplace.modal.close()})}}]:[]},content:[{name:"Info",modules:[{name:"description",data:{cover:this.get("cover"),attaches:this.get("attaches"),attachesList:this.get("attaches_desc"),description:this.get("description"),owner:this.ownerName,creationDate:formatDate(this.get("date_create"),"M d.yyyy"),get labelList(){return flowmap.labelList},label:this.get("label")},settings:{formIdPrefix:["sitemap",flowmap.id,this.id].join("/"),editable:"default"===this.workplace.method,cover:!0,externalLink:this.get("link_url"),externalLinkKey:"link_url",labels:!0,labelEditable:"default"===this.workplace.method,coverSize:[100,102],coverEditMod:"internal",coverEdit:function(){return app.modules.get("modalTemplates","createPage",{id:flowmap.id,mod:"change",cover:i.get("cover")}).then(function(t){t&&i.change("cover",t.cover)},function(t){})},change:function(t,e){return{ctx:i.subscriber,fn:i.subscriber,arg:["off",i.subscriber("on",{event:e},t)]}},callback:function(t){i.change.apply(i,t)}}},{name:"structure",data:{attaches:this.get("attaches"),list:i.get("pageStructure").get()},settings:{editable:"default"===this.method,formIdPrefix:["sitemap",flowmap.id,this.id].join("/"),callback:function(t){i.change.apply(i,t)},change:function(t){return{ctx:i.subscriber,fn:i.subscriber,arg:["off",i.subscriber("on",{event:"pageStructure"},t)]}}}},"default"===this.workplace.method&&{name:"discussion",data:{edit:"default"===this.workplace.method,accessibility:function(){},get:function(){return i.get("discussion").get.then(function(t){return t}.bind(i))},formIdPrefix:["sitemap",flowmap.id,this.id].join("/")},settings:{change:function(t){return{ctx:i.subscriber,fn:i.subscriber,arg:["off",i.subscriber("on",{event:"discussion"},t)]}},remove:function(t){return app.serverRequest("flowmapDiscussionDelete",Object.assign({},t,{id:i.id}))},edit:function(t){return app.serverRequest("flowmapDiscussionEdit",Object.assign({},t,{id:i.id}))},post:function(t){return app.serverRequest("flowmapDiscussionSend",Object.assign({},t,{id:i.id}))},callback:function(t){i.change("discussion",t)}}}]},"default"===this.workplace.method&&{name:"Files",modules:[{name:"files",data:{list:function(){return i.get("attaches").list}},settings:{mod:"list",remove:function(t){app.serverRequest("flowmapUnAttach",{file_id:t})},callback:function(t){i.change.apply(i,t)},change:function(t){return{ctx:i.subscriber,fn:i.subscriber,arg:["off",i.subscriber("on",{event:"pageStructure"},t)]}}}}]}]})},get ignoreChildren(){return this.spoiler},get flagTemplate(){var t=isDeltaLength(this.get("description")),e=this.get("discussion").count,i=this.get("attaches").count,a=this.get("link_url"),n=app.modules.get("html");return n({param:{class:"flowmap__flags"},content:[{param:{class:"flowmap__flag"+(t?" active":"")},content:[{name:"icon",param:{name:"description",style:{"margin-right":5}}}]},{param:{class:"flowmap__flag"+(0<e?" active":"")},content:[{name:"icon",param:{name:"comment",style:{"margin-right":4}}},e]},{param:{class:"flowmap__flag"+(0<i?" active":"")},content:[{name:"icon",param:{name:"attach",style:{"margin-right":4}}},i]},a.length?{name:"link",param:{class:"flowmap__flag active",href:n.getExternalLink(a),target:"_blank",style:{"margin-right":4}},content:[{name:"icon",param:{name:"link"}}]}:""]})},get labelTemplate(){var n=this.get("label")||[],t=app.modules.get("html",n.reduce(function(t,a){var e,i=flowmap.getLabel(a);return n.length<2&&("none"===a||!i)?e={param:{class:"flowmap__label flowmap__label--empty js-label"+(flowmap.filter&&flowmap.filter.includes(a)?" flowmap__label--highlight":""),attr:{"data-label":a}},content:{param:{tag:"span"},content:"No Label"}}:i&&(e={param:{class:"flowmap__label js-label"+(isColorLight(i.color,225)?" flowmap__label--light":"")+(flowmap.filter&&flowmap.filter.includes(a)?" flowmap__label--highlight":""),attr:{"data-label":a,"data-letter":i.text[0]},style:{background:i.color}},content:{param:{tag:"span"},content:i.text}}),e&&(safetyObjectOverwriting(e,["param","callback"],function(t){if(!t.shiftKey){var e=(flowmap.filter||[]).slice(0),i=!e.includes(a);i&&e.length<6?e.push(a):i||e.findAndRemove(a),flowmap.filter=e}}),t.push(e)),t},[]));return{html:t,length:t.length,labels:$.makeArray(t).map(function(t){return{dom:t,width:!1}})}},get template(){var r=this;return app.modules.get("html",{param:{attr:{draggable:!0},class:"flowmap__item",bind:[{event:"click",callback:function(t){var e=$(t.target),i=this.select;if(this.edit||this.drag||flowmap.shortCut.event.scrollMouse.state)return!1;if(t.shiftKey||e.closest(".js-select").length)flowmap.select(this,!i);else if(e.closest(".js-label").length);else if(e.closest(".js-spoiler").length)flowmap.spoiler(this,!this.spoiler);else if(e.closest(".js-open").length)this.openModal();else if("default"===flowmap.method&&e.closest(".js-title").length){var a=this.dom.find(".js-title input"),n=function(){this.change("title",a.val()),s(!1)}.bind(this),o=!1,s=function(t){equals(o,t)||(r.dom.toggleClass("flowmap__item--edit",t),r.dom.attr("draggable",!t),(o=t)?(r.edit=t,a.val(r.get("title")),a.focus().get(0).select(),a.on("focusout",n),a.on("keydown",function(t){13==t.keyCode?n():27==t.keyCode&&s(!1)})):(setTimeout(function(){r.edit=t},400),a.val(""),a.off(),a.blur()))};s(!0)}else e.closest(".js-add-sibling").length?flowmap.createNewCard(this.parent,this.childIndex+1):e.closest(".js-add-children").length?flowmap.createNewCard(this,this.children.length):e.closest(".js-duplicate").length?flowmap.createNewCard(this.parent,this.childIndex+1,{title:this.get("title"),description:this.get("description"),pagestructure:this.get("pageStructure").get(),img:this.get("cover"),label_id:this.get("label")}):i?this.openModal():i||flowmap.select(this,!0,!0)}.bind(this)},{event:"mouseenter",callback:function(){r.hover=!0}},{event:"mouseleave",callback:function(){r.hover=!1}},{event:"dragstart",callback:function(t){return t.preventDefault(),flowmap.shortCut.event.scrollMouse.state||flowmap.drag(r),!1}}]},content:[{param:{attr:{"data-field":"cover"},class:"flowmap__cover"}},{param:{class:"flowmap__labels",attr:{"data-field":"label"}},content:this.labelTemplate.html},{param:{class:"flowmap__title js-title"},content:[{param:{class:"title",tag:"h4",attr:{"data-field":"title"}}},{param:{class:"input",tag:"input"}}]},{name:"button",param:{mod:["lightblue","round","narrow"],addClass:"flowmap__button flowmap__button--center js-open",icon:"dots"}},{param:{class:"flowmap__button flowmap__spoiler js-spoiler"},content:[{name:"icon",param:{name:"arrow"},style:{width:9,height:6}}]},{param:{class:"flowmap__button flowmap__connector"},content:{name:"icon",param:{name:"arrow",style:{width:3,height:4}}}}].concat("default"===flowmap.method?[{name:"button",param:{mod:["blue","narrow","round"],icon:"plus",addClass:"flowmap__button flowmap__button--bottom js-add-children"}},{name:"button",param:{mod:["blue","narrow","round"],icon:"plus",addClass:"flowmap__button flowmap__button--right js-add-sibling"}},{param:{class:"flowmap__button flowmap__button--hidenseek"}},{name:"button",param:{mod:["blue","narrow","round"],addClass:"flowmap__button flowmap__button--top js-duplicate",icon:"duplicate"}},{param:{class:"flowmap__selection"},content:{param:{class:"c-input__checkbox c-input__checkbox--round js-select"},content:{param:{class:"checkbox"}}}}]:[])})},get dom(){return this._dom||(this._dom=this.template),this._dom},get shadow(){return this._shadow||(this._shadow=$('<div class="flowmap__item flowmap__item--shadow"></div>').appendTo(flowmap.grid)),this._shadow}};var C=function(t){this.data=t,this.children=[],this.ignore=!0,flowmap.grid.append(this.dom)};C.prototype={die:function(){this.dom.remove()},select:function(){},get:function(t){return this.data[t]},set:function(t,e){},change:function(t,e){},get drag(){return!1},set drag(t){},indexTitle:function(){return this.searchIndex=-1,this.searchIndex},get group(){return this.data.group},set group(t){equals(this.group,t)||(this.data.group=t)},set childIndex(t){},get childIndex(){return 999999999},get title(){return this.data.title},get template(){var t=this,e=app.modules.get("html"),i=e({name:"button",param:{mod:["doted","round","narrow","coverage","icon"],icon:"plus"}}),a=e({param:{class:"flowmap__item flowmap__item--creator",callback:function(){flowmap.createNewCard(t.parent||!1,t.parent?t.parent.children.length:0,!1,t.group)}},content:[i,{param:{class:"flowmap__title"},content:{param:{class:"title",tag:"h4"},content:this.title}}]});return a.hover(function(){i.addClass("hover")},function(){i.removeClass("hover")}),a},get dom(){return this._dom||(this._dom=this.template),this._dom}};var a={doc:function(i){return new Promise(function(e,t){app.ajr("/flowmapp/export/doc",i,"get",function(t){e(t)},!0)})},svg:function(f){(f=Object.assign({},{transparent:!1,background:"#ffffff",backgroundBorder:40,border:5,rotate:0,displayMod:"default",titleFontSize:64},f)).displayMod=toBoolean(f.cover)?"default":"minimal";var g=e[f.displayMod];g.width=g.x-g.ox,toBoolean(f.cover)||(toBoolean(f.labels)?g.y=70+g.oy:g.y=40+g.oy),g.height=g.y-g.oy,g.lineOffset=40,g.lineRadius=6;var v=Snap(),a=$("<div></div>").css({position:"fixed",top:"100vh","pointer-events":"none"}).appendTo("body");a.append($(v.node));var l={shiftX:0,shiftY:0,width:0,height:0,list:[]},d=function(t,e){t.forEach(function(t){e(t),d(t.children,e)})};return flowmap.ready.then(function(){var d=function(t,r,c,l){return r=r||0,c=c||0,[].concat(t).reduce(function(t,e){if(e.ignore)return t;var i=d(e.children,r,c+1,!0),a=1,n=1,o=r,s=c;return i.length&&(a=i.reduce(function(t,e){return t+e.width},0),n+=Math.max.apply(Math,i.map(function(t){return t.height})),o=i[Math.floor((i.length-1)/2)].x),r+=a,t.push({x:o,y:s,width:a,height:n,title:e.get("title"),cover:e.get("cover"),labels:e.get("label").reduce(function(t,e){if(e&&"none"!==e){var i=flowmap.getLabel(e);i&&t.push(i)}return t},[]),children:i,parent:!!l}),t},[])};flowmap.cardTree&&!flowmap.cardTree.ignore&&l.list.push({group:"main",groupLabel:!1,groupTitle:"Main pages",list:d(flowmap.cardTree)}),flowmap.footerPages&&flowmap.footerPages.children.length&&l.list.push({group:"footer",groupLabel:!0,groupTitle:"Footer pages",list:d(flowmap.footerPages.children)}),l.list.forEach(function(t,e,i){var a=i[e-1],n=a?a.y+a.height+.2:0,o=0;t.width=t.list.reduce(function(t,e){return t+e.width},0),t.height=t.list.reduce(function(t,e){return Math.max(t,e.height)},0),t.x=0,t.y=n,a&&(o=Math.ceil((a.width-t.width)/2),t.x=0+o,o<0&&(l.shiftX+=-1*o)),l.width=Math.max(t.width,l.width),l.height=Math.max(t.y+t.height,l.height)}),l.width=l.width*g.x-g.ox+1,l.height=l.height*g.y-g.oy+1,l.shiftX=l.shiftX*g.x+1,l.shiftY=l.shiftY*g.y+1}).then(function(){if(f.transparent||(l.width+=2*f.backgroundBorder,l.height+=2*f.backgroundBorder,l.shiftX+=f.backgroundBorder,l.shiftY+=f.backgroundBorder),f.title){var t=v.text(0,0,flowmap.get("title"));$(t.node).attr({"text-anchor":"middle","font-size":f.titleFontSize,"font-family":"Roboto,sans-serif",fill:"#52565f"});var e=t.node.getComputedTextLength()+(f.transparent?0:2*f.backgroundBorder);e>l.width&&(l.shiftX+=(e-l.width)/2,l.width=e),l.shiftY+=2*f.titleFontSize,l.height+=2*f.titleFontSize,t.attr({x:l.width/2,y:f.titleFontSize+(f.transparent?0:f.backgroundBorder)})}f.date&&(l.height+=f.backgroundBorder,$(v.text(l.width-(f.transparent?5:f.backgroundBorder),l.height-(f.transparent?5:f.backgroundBorder),formatDate(app.clientTime(),"dd MM yyyy")).node).attr({"text-anchor":"end","font-size":"14","font-family":"Roboto,sans-serif",fill:"#52565f"})),f.transparent||v.rect(0,0,l.width,l.height).attr({fill:f.background}).prependTo(v),v.attr({width:l.width,height:l.height})}).then(function(){var c={fill:"none",stroke:"#4d9ef6",storeWidth:1};l.list.forEach(function(r){d(r.list,function(t){var o=(t.x+r.x)*g.x+g.lineOffset+-.5+l.shiftX,s=(t.y+r.y)*g.y+g.height+-.5+l.shiftY;t.children.length&&(v.path("M"+o+" "+s+"L"+o+" "+(s+g.oy/2)).attr(c),t.children.forEach(function(t,e,i){var a=(t.x+r.x)*g.x+g.lineOffset+-.5+l.shiftX,n=(t.y+r.y)*g.y-.5+l.shiftY;2<i.length&&0===e?v.path("M"+a+" "+n+"L"+a+" "+(n-g.oy/2+g.lineRadius)+"A"+g.lineRadius+" "+g.lineRadius+" 0 0 1  "+ +(a+g.lineRadius)+" "+(n-g.oy/2)+"L"+o+" "+(s+g.oy/2)).attr(c):1<i.length&&e+1===i.length?v.path("M"+a+" "+n+"L"+a+" "+(n-g.oy/2+g.lineRadius)+"A"+g.lineRadius+" "+g.lineRadius+" 0 0 0  "+ +(a-g.lineRadius)+" "+(n-g.oy/2)+"L"+o+" "+(s+g.oy/2)).attr(c):v.path("M"+a+" "+n+"L"+a+" "+(n-g.oy/2)).attr(c)}))})})}).then(function(){var c=[],m={};return l.list.forEach(function(e,t,i){if(e.list.length){if(e.groupLabel){var a=i[t-1],n=l.width/2,o=((e.y+a.y+a.height)*g.y-g.oy)/2-.5+l.shiftY,s=v.text(n,o+4,e.groupTitle);$(s.node).attr({"text-anchor":"middle","font-size":"14","font-family":"Roboto,sans-serif",fill:"#8c9baa"});var r=s.node.getComputedTextLength();v.path("M 0 "+o+"L"+((l.width-r)/2-10)+" "+o).attr({stroke:"#dee7ec"}),v.path("M "+((l.width+r)/2+10)+" "+o+"L"+l.width+" "+o).attr({stroke:"#dee7ec"})}d(e.list,function(h){var u=(h.x+e.x)*g.x-.5+l.shiftX,p=(h.y+e.y)*g.y-.5+l.shiftY;v.path(RoundedRectPath(u,p,g.width,g.height,5)).attr({fill:"#ffffff",stroke:"#A2CEF9",strokeWidth:1}),svgHelper.snapWrapText(v,h.title,16,{"text-anchor":"middle","font-size":"14","font-family":"Roboto,sans-serif",fill:"#52565f"},{x:u+g.width/2,y:p+g.height-15},160,1,!0);var t=toBoolean(f.cover)?toDataURL(h.cover).then(function(i){return new Promise(function(t){var e=v.el("image").attr({x:u,y:p,width:180,height:185,preserveAspectRatio:"xMidYMin meet"}).node;e.onload=t,e.onerror=t,setTimeout(t,500),e.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",i)})}):Promise.resolve(!0);c.push(t.then(function(){var t,e,i,a,n,o,s,r,c,l,d;h.children.length&&(t=u+g.lineOffset,e=p+g.height,v.circle(t,e,9.5).attr({fill:"#4d9ef6",stroke:"#ffffff","stroke-width":2}),v.path("M"+t+" "+(e-3)+"L"+(t+3)+" "+(e+2)+"L"+(t-3)+" "+(e+2)+"Z").attr({fill:"#ffffff"})),h.parent&&(i=u+g.lineOffset,a=p,v.circle(i,a,4.5).attr({fill:"#4d9ef6",stroke:"#ffffff","stroke-width":2}),v.path("M"+i+" "+(a+1)+"L"+(i+1.5)+" "+(a-1)+"L"+(i-1.5)+" "+(a-1)+"Z").attr({fill:"#ffffff"})),f.labels&&h.labels.length&&(n=u,o=p,s=h.labels,r=s.map(function(t){var e,i=t.text.toUpperCase();if(m.hasOwnProperty(t.id))e=m[t.id];else{var a=v.text(0,0,i);$(a.node).attr({"font-size":"10","font-family":"Roboto,sans-serif"}),e=m[t.id]=a.node.getComputedTextLength(),a.remove()}return{text:i,textWidth:e,fill:t.color}}),c=r.reduce(function(t,e){return t+e.textWidth+5+10},-5)>g.width-10,l=n+10+.5,d=o+15+.5,r.forEach(function(t){var e=c?18:t.textWidth+10;v.path(RoundedRectPath(l,d,e,18,3)).attr({fill:t.fill}),$(v.text(l+e/2,d+(18-8/1.5),c?t.text[0]:t.text).node).attr({"text-anchor":"middle","font-size":10,"font-family":"Roboto,sans-serif",fill:isColorLight(t.fill,225)?"#52565f":"#FFFFFF"}),l+=e+5}))}))})}}),onAllPromiseExecute(c)}).then(function(){var t=(new XMLSerializer).serializeToString(v.node),e=self.URL||self.webkitURL||self,i=new Blob([t],{type:"image/svg+xml"});return v.remove(),a.remove(),{img:e.createObjectURL(i),width:l.width,height:l.height}})},png:function(t){var e=this.svg(t);return"png"===t.extension&&(e=e.then(function(e){return toBoolean(),imgToPng(e.img,{width:toBoolean(t.size)?t.width:e.width,height:toBoolean(t.size)?t.height:e.height}).then(function(t){return Object.assign(e,{img:t})})})),e},pdf:function(i){var a={get:function(e,t,i){this.docDefinition(i).then(function(t){"spyglass"===flowmap.id&&console.log(t),pdfMake.createPdf(t).getDataUrl(e)})},docDefinition:function(r){var e=flowmap,c={content:[{stack:[{text:"Project name:"},{text:e.get("title")}],style:"documentHeading"}],pageMargins:[76,120.46,76,60],styles:{documentHeading:{fontSize:24,bold:!0,alignment:"left",margin:"A4"==r.size?r.landscape?[0,150,0,1e3]:[0,200,0,1e3]:r.landscape?[0,200,0,1e3]:[0,300,0,1e3]},subDocumentHeading:{fontSize:14,bold:!1,alignment:"left"},block:{margin:[0,0,0,4e3]},header:{fontSize:18,bold:!0,margin:[0,0,0,20]},subHeader:{fontSize:14,bold:!0,margin:[0,40,0,0]},litHeader:{fontSize:12,bold:!0,margin:[0,15,0,5]},plainText:{fontSize:12},colontitle:{fontSize:10,color:"#696969"}},pageSize:r.size,pageOrientation:r.landscape?"landscape":"portrait"};return Promise.resolve().then(function(){if(r.project_name||r.date){var t=[];r.project_name&&t.push("Project: ",{text:e.get("title")+" \n",style:{bold:!0}}),r.date&&t.push("Date: ",{text:formatDate(e.get("date_create"),"dd MM yyyy"),style:{bold:!0}}),c.header={text:t,style:"colontitle",margin:[76,47.5,0,0]}}}).then(function(){r.page_numbers&&(c.footer=function(t,e){return{text:t.toString()+" of "+e,style:"colontitle",margin:[76,0,0,0]}})}).then(function(){if(r.project_descr){var t=e.get("description");isDeltaLength(t)&&c.content.push({stack:[{text:"Project description",style:"header"},{text:deltaParse(t),style:"plainText"}],style:"block"})}}).then(function(){return!0}).then(function(){var o=function(t,e,a){e+=1;var i={text:t.get("title"),counter:e};if(t.children&&t.children.length){var n=0;a=a+e+".",i=[i,{ol:t.children.reduce(function(t,e,i){return e.ignore||(t.push(o(e,n,a)),n++),t},[]),separator:[a,"."]}]}return i},t=[e.cardTree];1<e.footerPages.children.length&&t.push(e.footerPages),c.content.push({stack:[{text:"Project structure:",style:"header"},{ol:t.map(function(t,e){return o(t,e,"")}),separator:["","."]}],style:"block"})}).then(function(){if(r.page_descr||r.page_structure||r.empty_pages){var s=function(t,e,i){var a=i+(e+1)+".",n=[];if(r.page_descr&&isDeltaLength(t.get("description"))&&n.push({text:deltaParse(t.get("description")),style:"plainText"}),r.page_structure&&Array.isArray(t.get("pageStructure").list)){var o=[];t.get("pageStructure").list.forEach(function(t){o.push({text:t.title,style:"litHeader"}),o.push({text:deltaParse(t.content),style:"plainText"})}),o.length&&(o.unshift({text:"Page structure:",style:"subHeader"}),n.push(o))}return(n.length||r.empty_pages)&&(n.unshift({text:a+" "+t.get("title"),style:"header"}),c.content.push({stack:n,style:"block"})),t.children&&t.children.length&&t.children.forEach(function(t,e){t.ignore||s(t,e,a)}),r};[e.cardTree,e.footerPages].forEach(function(t,e){s(t,e,"")})}}).then(function(){return c})}};return new Promise(function(t,e){a.get(t,e,i)})}};safetyObjectOverwriting(app,["workplace","modules","flowmap"],{key:"flowmap",descriptor:{name:"Sitemap",description:"",active:!0,urlMatch:function(t){return!t.path.length}},api:{init:function(t){flowmap=new i(t)},get:function(){return flowmap?flowmap.ready:Promise.reject("dead")},implement:function(t,e){return flowmap.implement(t,e)},die:function(){if(flowmap)return flowmap.die()},dom:function(){return flowmap.dom}}})}(),function(){var s={width:220,height:154,padding:20,offset:0},r=function(i){var t=function(t,e){i.hasOwnProperty(t)&&"string"==typeof i[t]?i[t]=JSON.parse(i[t]):i[t]=e};return t("coord",{x:0,y:0}),t("data",{title:"Missing element",figure:"oval",icon:"false",textColor:"#000000",bgColor:"#ffffff",borderColor:"#dee7ec"}),t("lines",[]),i},e=function(t){this.readyCallbacks=app.modules.get("executingList")(),this.controller=t,this.list=[],this.loadData.then(function(t){this.list=t,this.bind(),this.inited=!0}.bind(this))};e.prototype={get id(){return this.controller.id},get workplace(){return this.controller},get inited(){return this._inited||!1},set inited(t){equals(t,this.inited)||(this._inited=t)&&this.readyCallbacks.exec()},get ready(){return new Promise(function(t,e){this.readyCallbacks.add({ctx:this,fn:t,arg:[this]}),this.inited&&this.readyCallbacks.exec()}.bind(this))},get socket(){return this.workplace.socket},get method(){return this.workplace.method},get accessibility(){return this.workplace.accessibility},get currentId(){return!!this.currentUserFlow&&this.currentUserFlow.id},getByid:function(e){return this.list.find(function(t){return t.id==e})},view:function(t,e){if(this.list.length)if(t)this.open(t);else if(this.currentUserFlow)forceReflow(this.currentUserFlow.dom),this.currentUserFlow.scrollInit();else{var i,a,n=this.controller.inProjectUrl.path;"userflow"===n[0]&&n[1]&&(i=1*n[1]),i||(i=User.getUserSettings(["flowmap",this.id,"lastOpenedUF"],!1)),(a=this.getByid(i))||(a=this.list[0]),this.emptyState=0,this.open(a)}var o=app.url().hash,s={path:this.workplace.slashUrl+"/"+this.id+"/userflow",hash:""};this.currentUserFlow?(s.path+="/"+this.currentUserFlow.id,this.emptyState=0,e&&o.length&&("ufinfo"===o&&this.currentUserFlow?(this.currentUserFlow.openModal(),s.hash="ufinfo"):this.controller.getModule("flowmap").then(function(t){t.getCard(o)&&t.getCard(o).openModal()}))):this.emptyState=1,app.url.set(s)},remove:function(e){app.modules.get("alert",{type:"alert",heading:"Remove this UserFlow?",content:"Are you sure you wish to remove this user flow?",buttons:["Yes, Remove!","cancel"]},function(t){!0===t&&(this.list.findAndRemove(function(t){return t.id==e}),this.currentUserFlow&&this.currentUserFlow.id==e&&(this.currentUserFlow.die(),this.currentUserFlow=null,this.view()),app.serverRequest("removeFlowScheme",{id:e}),this.socket.trigger("userflow",{target:"self",event:"userflow",data:{event:"remove",target:e}}),this.view())}.bind(this))},edit:function(t){var e=this.getByid(t);app.modules.get("modalTemplates","oneTitleModal",{label:"User Flow Name",value:e.title,name:"title"}).then(function(t){t&&(this.currentUserFlow&&this.currentUserFlow.id===e.id?this.currentUserFlow.title=t.title:e.title=t.title,app.serverRequest("userFlowScheme",Object.assign({id:e.id},t)),this.socket.trigger("userflow",{target:"self",event:"userflow",data:{event:"change",target:e.id,data:t}}))}.bind(this))},open:function(t){var e="object"==typeof t?t:this.getByid(t);this.currentUserFlow&&this.currentUserFlow.id===e.id||(this.currentUserFlow&&this.currentUserFlow.die(),this.currentUserFlow=new m(e,this),this.currentUserFlow.dom.appendTo(this.dom),this.currentUserFlow.view()),User.setUserSettings(["flowmap",this.id,"lastOpenedUF"],this.currentUserFlow.id),$(".header .header__tools .js-userflow-title").text(this.currentUserFlow.title),app.subscriber("add",{scope:app,event:"userflowOpenSchema"})},create:function(){app.modules.get("modalTemplates","oneTitleModal",{label:"User Flow Name",value:"New User Flow",name:"title"}).then(function(e){if(e){var i=content.loader("backstage");this.workplace.getModule("flowmap").then(function(t){return app.serverRequest("userFlowScheme",Object.assign({project_id:t.id},e))}).then(function(t){this.addUserflow(t),i.done()}.bind(this))}}.bind(this))},duplicate:function(e){var i=content.loader("backstage");this.workplace.getModule("flowmap").then(function(t){return app.serverRequest("userFlowDuplicate",{id:e})}).then(function(t){this.addUserflow(t),i.done()}.bind(this))},addUserflow:function(t){!1===t.status?"SCHEMA_QUOTA_EXCEEDED"===t.message&&(this.accessibility?app.modules.get("alert",{heading:"Userflow quota exceeded!",content:"This User Flow takes you over your (1) userflow limit. It's time to upgrade. Let's do it!",buttons:["Upgrade Plan","Cancel"]},function(t){!0===t&&app.router("/upgradeplan")}):app.modules.get("alert",{heading:"Userflow quota exceeded!",content:"Oops! Something went wrong. Seems like the owner of this project have exceeded subscription quota. Please contact the project owner.",buttons:["Ok, I understand"]})):(this.list.push(t),this.socket.trigger("userflow",{target:"self",event:"userflow",data:{event:"create",data:t}}),this.view(t))},get loadData(){return"default"===this.method?app.serverRequest("userFlowList",{projectID:this.controller.id}).then(function(t){return t.map(function(t){return t.description=deltaDefine(t.description),t})}):"share"===this.method?this.workplace.loadData.then(function(t){return safetyObjectAccess(t,["data","userflow"],[]).map(function(t){return t.description=deltaDefine(t.description),t})}):Promise.resolve([])},headerUpdate:function(){var i=this,t=app.modules.get("html"),e=app.modules.get("header"),a=[{name:"headerPanel",param:{mod:"right"},content:[{name:"input",param:{mod:["range","narrow","minimal","horizontal"],type:"range",label:"Zoom",min:.6,max:1,step:.1,value:safetyObjectAccess(i,["currentUserFlow","zoom"],1),name:"zoom",callback:function(t){i.currentUserFlow&&(i.currentUserFlow.zoom=t.value)}}},{name:"button",param:{tag:"div",mod:["white","square"],icon:"settings"},content:{name:"menu",param:{dots:!1,options:function(){return[{value:"template",name:$('<div class="fm-menu-list__item">Save as Template</div>').prepend(t({name:"icon",param:{name:"add_template",cover:!0,style:{"margin-right":"12px",width:"20px"}}})),selfTemplate:!0,disabled:!0},{value:"grid",name:$('<div class="fm-menu-list__item">'+(safetyObjectAccess(i,["currentUserFlow","_showGrid"],!1)?"Hide Grid":"Show Grid")+"</div>").prepend(t({name:"icon",param:{name:"grid",cover:!0,style:{"margin-right":"12px",width:"20px"}}})),selfTemplate:!0},{value:"comments",name:$('<div class="fm-menu-list__item">Show Comments</div>').prepend(t({name:"icon",param:{name:"show_message",cover:!0,style:{"margin-right":"12px",width:"20px"}}})),selfTemplate:!0,disabled:!0}]},eventPropagation:!1,mod:["absolute","fill","transparent"],settings:{mod:["white","large","bot","center"]},callback:function(t){"grid"===t&&i.currentUserFlow&&i.currentUserFlow.showGrid()}}}},{name:"button",param:{mod:["white","narrow"],text:"Info",icon:"project_info",callback:function(){i.currentUserFlow.openModal()}}}]}];this.list.length&&a.unshift({name:"headerPanel",content:{name:"userFlowList",param:{title:i.currentUserFlow?i.currentUserFlow.title:"title",edit:"default"===this.method,value:function(){return i.currentUserFlow.id},list:function(){return i.list.map(function(t){return{id:t.id,title:t.title,date:t.data_create}})},callback:function(t,e){"open"===t?i.view(e):"edit"===t?i.edit(e):"delete"===t?i.remove(e):"create"===t?i.create():"duplicate"===t&&i.duplicate(e)}}}}),e.update({tools:a}),app.modules.get("header").disable("tools",!this.list.length)},helpBar:function(){app.modules.get("sideTools",[["shortcut",[{description:"Move workplace",value:["hold",{name:"key",param:{value:"Space"}}]},{description:"Zoom to fit",value:["hold",{name:"key",param:{value:"Alt"}}]},{description:"Select multiple items",value:["hold",{name:"key",param:{value:"Shift"}},"plus","click"]},{description:"Multi-select",value:["hold",{name:"key",param:{value:"Shift"}},"plus","Click","plus","Drag"]},{description:"Deselect all",value:{name:"key",param:{value:"Esc"}}},{description:"Zoom in",value:{name:"key",param:{value:"+"}}},{description:"Zoom out",value:{name:"key",param:{value:"–"}}}]]])},implement:function(t,e){if(this.state=t)return this.view(!1,e),this.headerUpdate(),this.helpBar(),new Promise(function(t,e){setTimeout(t,200)});this.currentUserFlow?(this.currentUserFlow.setFocus(!1),this.currentUserFlow.scrollPosition=[this.currentUserFlow.scroller.scrollLeft(),this.currentUserFlow.scroller.scrollTop()]):this.emptyState=0},update:function(t,e){var i=e.path[1];this.view(i,!0)},set emptyState(t){if(!equals(this.emptyState,t)){var e=this;this._emptyState=t;var i=this.workplace.pages.dom.find(".parallel-pages__container");switch(this.placeholder&&(this.placeholder.remove(),this.placeholder=null),t){case 1:this.placeholder=app.modules.get("html",{name:"emptyPlaceholder",param:{template:"default"===this.method?"userFlowEmpty":"userFlowEmptyShare",mod:"absolute",callback:function(){e.create()}}}).appendTo(i),forceReflow(this.placeholder),this.placeholder.addClass("open")}this.headerUpdate()}},get emptyState(){return this._emptyState||!1},export:function(t,e,i){return h.hasOwnProperty(t)?h[t](e,i):Promise.reject("method is unavailable")},bind:function(){"default"===this.method&&this.socket.on("userflow",function(t){var e=t.data,i=e.event,a=e.target,n=e.data;if("self"===t.target)switch(i){case"create":this.list.push(e.data);break;case"remove":this.list.findAndRemove(function(t){return t.id==a}),this.currentUserFlow.id==a&&(app.modules.get("alert",{type:"normal",heading:"This User Flow was removed!",content:"We are sorry, but this User Flow is no longer available",buttons:["Okay"]},function(){}),this.currentUserFlow.die(),this.currentUserFlow=null,this.view());break;case"change":var o=this.getByid(a);if(this.currentUserFlow&&this.currentUserFlow.id==a)for(var s in n)this.currentUserFlow[s]=n[s];else o&&Object.assign(o,n)}else this.currentUserFlow.id==t.target&&this.currentUserFlow.executeMessage(t)}.bind(this))},get dom(){return this._dom||(this._dom=$('<div class="userflow__container" style="height: calc(-148px + 100vh)"></div>')),this._dom},die:function(){this.currentUserFlow&&this.currentUserFlow.die(),app.modules.get("sideTools",!1)}};var m=function(t,e){Subscriber(this),this.data=t,this.id=t.id,this.controller=e,this.itemCreator=new l(this),this.list=[],this.focused=[],this.flags={drag:!1,lineCreate:!1,lineDrag:!1,spaceMove:!1},this.data.discussion=this.workplace.Discussion(this,0,{requestData:{ufid:this.id},requestUrl:"flowmapDiscussionGet"}),this.dom.css({width:"100%",height:"calc(-148px + 100vh)"}),this.container.css({width:"100%",height:"calc(-148px + 100vh)"});var i=content.loader("backstage");this.getList.then(function(t){t.forEach(function(t){this.list.push(new c(t,this,!1))}.bind(this)),this.list.forEach(function(t){t.lines=t.lines.reduce(function(t,e){if(e){var i=new w(e,this,!1);i.inited&&t.push(i)}return t}.bind(this),[])}.bind(this)),i.done(),this.view(),setTimeout(this.scrollInit.bind(this),300),this.list.length||(this.itemCreator.move({coord:{x:-1,y:-1},x:-this.gridParam.width/2,y:-this.gridParam.height/2,s:1}),this.itemCreator.fixed=!0,this.itemCreator.selectBar(!0))}.bind(this)),this.bind(),userflow=this};m.prototype={get owner(){return this.workplace.data.owner},get title(){return this.data.title||"Unnamed"},set title(t){equals(t,this.title)||(this.data.title=t,this.subscriber("add",{event:"title",data:{title:t}}),$(".header .header__tools .js-userflow-title").text(t))},get accessibility(){return this.workplace.accessibility},get description(){return this.data.description},set description(t){equals(t,this.description)||(this.data.description=t,this.subscriber("add",{event:"description",data:t}))},get discussion(){return this.data.discussion},change:function(){if("object"==typeof arguments[0])for(var t in arguments[0])this.change(t,arguments[0][t]);else{var e=arguments[0],i=arguments[1],a=function(){this[e]=i}.bind(this),n={};switch(n[e]=i,e){case"discussion":return this.discussion[i.event](i.target,i.data),this.subscriber("add",{event:e,data:i}),this.socket.trigger("userflow",{target:this.id,event:"userflow",data:{event:"discussion",target:this.id,data:n}}),!1}app.serverRequest("userFlowScheme",Object.assign({id:this.id},n)),this.socket.trigger("userflow",{target:"self",event:"userflow",data:{event:"change",target:this.id,data:n}}),a()}},get flowmap(){return this.controller.flowmap},get method(){return this.controller.method},executeMessage:function(t){var e=t.data,i=e.event,a=e.target,n=e.data;switch(i){case"change":this.getItem(a,function(t){for(var e in n)t.set(e,n[e])});break;case"move":this.getItem(a,function(t){t.move(n)});break;case"create":this.list.push(new c(n,this,!0)),this.updateMap(),this.redrawAllLines();break;case"remove":this.getItem(a,function(t){t.focus&&this.setFocus({target:t,state:!1,multiMod:!0}),this.list.findAndRemove(t),t.remove()});break;case"createLine":this.getItem(a,function(t){var e=new w(n,this,!0);t.lines.push(e)});break;case"changeLine":this.getLine(a,function(t){for(var e in n)t.set(e,n[e])});break;case"removeLine":this.getLine(a,function(t){t.die()});break;case"discussion":this.subscriber("add",{event:i,data:n.discussion}),this.discussion[n.discussion.event](n.discussion.target,n.discussion.value)}},get workplace(){return this.controller.workplace},get getList(){return"default"===this.method?app.serverRequest("getSchema",{id:this.id}).then(function(t){return t.items||[]}).catch(function(t){app.log(t)}):"share"===this.method?Promise.resolve(this.data.items||[]):Promise.resolve([])},getItem:function(e,t){var i=this.list.find(function(t){return t.id==e});return t&&(i&&t.call(this,i),t=null),i},getLine:function(e,t){var i=this.allLines.find(function(t){return t.id==e});return t&&(i&&t.call(this,i),t=null),i},updateMap:function(){var t,e,i,a,r=[];if(this.list.length){var n=[0],o=[0];this.list.forEach(function(t){n.push(t.coord.x),o.push(t.coord.y)}),i=Math.min.apply(Math,n),a=Math.min.apply(Math,o);var c=i,l=a;this.list.forEach(function(t){for(var e=t.coord.x-c,i=t.coord.y-l,a=0;a<t.size.width;a++)for(var n=0;n<t.size.height;n++){var o=e+a,s=i+n;r[o]||(r[o]=[]),r[o][s]=t}});var s=[0];r.forEach(function(t){s.push(t.length)}),t=r.length,e=Math.max.apply(Math,s);for(var d=0;d<t;d++){r[d]||(r[d]=[]);for(var h=r[d],u=0;u<e;u++)h[u]||(h[u]=0)}}else a=i=e=t=0;return this._map={width:t,height:e,shiftX:i,shiftY:a,map:r},this._gridPathMap=null,r},get map(){return this._map||this.updateMap(),this._map},calculateGridPathMap:function(){var r=this.map,c=r.shiftX,l=r.shiftY;r=[],this.list.forEach(function(t){for(var e=2*(t.coord.x-c)+1,i=2*(t.coord.y-l)+1,a=0;a<2*t.size.width-1;a++)for(var n=e+a,o=0;o<2*t.size.height-1;o++){var s=i+o;r[n]||(r[n]=[]),r[n][s]=1}});var e=[0];r.forEach(function(t){e.push(t.length)});for(var t=r.length,i=Math.max.apply(Math,e),a=0;a<t+2;a++){r[a]||(r[a]=[]);for(var n=r[a],o=0;o<i+2;o++)n[o]||(n[o]=0)}return r.map(function(t){return t.map(function(t){return 1*!t})})},get gridPathMap(){return this._gridPathMap||(this._gridPathMap=this.calculateGridPathMap()),this._gridPathMap},createItem:function(a,i,t){a=Object.assign({list_id:this.id},a);var n=function(t){return app.serverRequest("userFlowItem",t).then(function(t){return r(t)})},o=function(t){return this.socket.trigger("userflow",{target:this.id,event:"userflow",data:{event:"create",data:t}}),Promise.resolve(t)}.bind(this),e=function(t){var e=new c(t,this,i);return this.list.push(e),this.itemCreator.state=!1,this.view(),this.redrawAllLines(),this.setFocus({target:e,state:!0}),"UFItem"==e.type&&e.content.focusTitle(),Promise.resolve(e)}.bind(this);if(t){var s=getRandom();return a.id=s,e(a).then(function(e){var i=e.content.dom.loader("blockLight");convertToPromise(t).then(function(t){t?(a=Object.assign(a,t,{list_id:this.id},{id:void 0}),e.set("cardId",t.data.id),n(a).then(o).then(function(t){e.id=t.id}),i.done()):userflow.removeItem(e)}.bind(this),function(){userflow.removeItem(e)})}.bind(this)),!1}return n(a).then(o).then(e)},removeItem:function(t,i){t=[].concat(t);var a=[];t.forEach(function(t){if("UFLine"==t.type)t.remove();else{"UFImage"==t.type&&t.content.unsetFile();var e=t.id;a.push(e),!1!==i&&this.setFocus({target:t,state:!1,multiMod:!0}),t.remove(),this.list.findAndRemove(t),this.socket.trigger("userflow",{target:this.id,event:"userflow",data:{event:"remove",target:e}})}},this),app.serverRequest("removeUserFlowItem",{id:a}),this.view()},get CursorPointer(){return this._CursorPointer||(this._CursorPointer=$('<div style="position: absolute;width: 50px;height: 50px;margin: -25px 0px 0px -25px;border-radius: 50%;background: red;z-index: 9999999999;transition: 0.3s"></div>'),this.dom.append(this._CursorPointer)),this._CursorPointer},get getCursorPosition(){return this.calcCursorPosition({cell:!0,angle:!0})},calcCursorPosition:function(t){var e=this.gridParam,i=t.multiplier||1,a=this.scrollOffset,n=this.param.shift,o={};t=Object.assign({cell:!1,angle:!1,cellShift:{x:0,y:0}},t);var s=e.width,r=e.height,c=e.offset,l=this.scale||this.zoom,d=this.fitToView()||{x:0,y:0},h=cursorX+a.x,u=cursorY+a.y-content.offset().top;h-=Math.round(n.x/this.zoom*l),u-=Math.round(n.y/this.zoom*l),h=(h-d.x)/l,u=(u-d.y)/l,o.mouseX=h,o.mouseY=u;var p=(s+c)*i,m=(r+c)*i;return t.cell&&(o.x=Math.floor(h/p+t.cellShift.x),o.y=Math.floor(u/m+t.cellShift.y),t.angle&&(o.angle=180*Math.atan2((o.x+.5)*p-u,(o.y+.5)*m-h)/Math.PI+180)),o},get zoom(){return this._zoom||(this._zoom=1),1*this._zoom},set zoom(t){if(t=1*Math.min(Math.max(1*t,.6),1).toFixed(1),this.zooming)this.zooming=t;else if(!equals(this._zoom,t)){this.zooming=t,$("header").find('input[name="zoom"]').val(t);var c=this._zoom,l=t;this._zoom=t;var e=function(t){var e,i,a,n,o=this.scrollOffset;n=t?(e=this.param.shift.x/c*l-o.x,i=this.param.shift.y/c*l-o.y,this.view(),o=this.scrollOffset,a=this.param.shift.x-o.x,this.param.shift.y-o.y):(e=this.param.shift.x-o.x,i=this.param.shift.y-o.y,this.view(),o=this.scrollOffset,a=this.param.shift.x/l*c-o.x,this.param.shift.y/l*c-o.y);var s=a-e,r=n-i;this.scroller.scrollLeft(o.x+s),this.scroller.scrollTop(o.y+r)}.bind(this),i=function(){var t=this.scrollOffset,e=this.param,i=t.x+content.width()/2,a=t.y+content.height()/2,n=i/e.size.width,o=a/e.size.height,s=n*e.size.width*(c-l)/c,r=o*e.size.height*(c-l)/c;return this.dom.css({transform:"translate("+s+"px, "+r+"px) scale("+l+")"}),this.dom.onTransitionEnd(250).then(function(){this.dom.css({transition:"none",transform:"scale("+l+")"}),this.scroller.scrollLeft(t.x-s),this.scroller.scrollTop(t.y-r),forceReflow(this.dom),this.dom.css({transition:""})}.bind(this))}.bind(this),a=function(){var t=this.zooming;t&&(this.zooming=!1,this.zoom=t)}.bind(this);c<l?(e(!1),i().then(a)):i().then(function(){e(!0)}).then(a)}},selectArea:function(t){for(var e=[],i=0<t.width?1:-1,a=0<t.height?1:-1,n=t.x;n!==t.x+t.width;n+=i)for(var o=t.y;o!==t.y+t.height;o+=a){var s=this.getByCoord({x:n,y:o});s&&!e.includes(s)&&e.push(s)}this.setFocus(!!e.length&&{target:e})},mouseSelectArea:function(t){var s=!(this.flags.mouseSelectArea=!0),r=this.getCursorPosition,c=app.modules.get("html",{param:{class:"userflow__selectarea",style:{transform:"translate("+r.mouseX+"px, "+r.mouseY+"px) scale(1, 1)"}}}).appendTo(this.dom),e=app.modules.get("sideZoneScroll",{target:content,settings:{scroller:this.scroller,triggerZone:.05}}),i=function(){var t=this.getCursorPosition,e={x:t.mouseX-r.mouseX,y:t.mouseY-r.mouseY},i={x:Math.abs(e.x),y:Math.abs(e.y)};if(s){var a=1<e.x?1:-1,n=1<e.y?1:-1;c.css({width:i.x,height:i.y,opacity:1,transform:"translate("+r.mouseX+"px, "+r.mouseY+"px) scale("+a+", "+n+")"});var o=this.calcCursorPosition({cell:!0,angle:!1,cellShift:{x:.6*a,y:.6*n}});this.selectArea({x:r.x,y:r.y,width:Math[0<a?"max":"min"](o.x-r.x,0),height:Math[0<n?"max":"min"](o.y-r.y,0)})}else(15<i.x||15<i.y)&&(s=!0)}.bind(this);$(document).on("mousemove",i),this.scroller.on("scroll",i),$(document).one("mouseup",function(){$(document).off("mousemove",i),this.scroller.off("scroll",i),e.die(),c.css("opacity",0),setTimeout(function(){c.remove()},150),this.flags.mouseSelectArea=!1}.bind(this))},view:function(){this.updateMap();var t=this.gridParam,e=this.map,i=this.zoom;for(var a in t)t[a]=t[a]*i;var n=Math.ceil(content.width()/t.width+1)*t.width*2,o=Math.ceil(content.height()/t.height+1)*t.height*2,s=e.width*t.width,r=e.height*t.height,c=s+n,l=r+o,d=n/2-e.shiftX*t.width,h=o/2-e.shiftY*t.height,u={x:d-safetyObjectAccess(this,["param","shift","x"],0),y:h-safetyObjectAccess(this,["param","shift","y"],0)};this.param={size:{width:c,height:l},contentSize:{width:s,height:r},additionalSize:{width:n,height:o},shift:{x:d,y:h},deltaShift:u},this.dom.css({width:c/i,height:l/i,padding:h/i+"px 0 0 "+d/i+"px"}),this.container.css({width:c+1,height:l+1}),forceReflow(this.dom),this.scroller.scrollLeft(this.scroller.scrollLeft()+u.x),this.scroller.scrollTop(this.scroller.scrollTop()+u.y),this.redrawAllLines()},isEmpty:function(t){return!this.getByCoord(t)},insertCalculate:function(t,e,i,a){for(var n=[],o=t.size.width,s=t.size.height,r=void 0===a?[t.id]:[t.id].concat(a),c=function(t){for(var e=0;e<t.length;e++){var i=this.getByCoord(t[e]);if(i&&!r.includes(i.id))return!1}return!0}.bind(this),l=0;l<o;l++)for(var d=0;d<s;d++)n.push({x:e.x+l,y:e.y+d});if(c(n))return e;if(i){var h=this.gridParam,u=e.mouseX,p=e.mouseY,m=[0,0],f=180*Math.atan2((e.y+s/2)*(h.height+h.offset)-p,(e.x+o/2)*(h.width+h.offset)-u)/Math.PI+180,g=this.getDirectionByAngle(f,4,1);return 1===g?m[0]++:3===g&&m[0]--,0===g?m[1]--:2===g&&m[1]++,e=Object.assign({},e,{x:e.x+m[0],y:e.y+m[1]}),this.insertCalculate(t,e,"once"!==i)}return!1},getByCoord:function(t){var e=this.map.map,i=t.x-this.map.shiftX,a=t.y-this.map.shiftY;if(e[i])return e[i][a]},getAngle:function(t,e){var i=this.gridParam,a=e.mouseX||e.x||0,n=e.mouseY||e.y||0,o=(t.coord.x+1*t.size.width/2)*i.width*1,s=(t.coord.y+1*t.size.height/2)*i.height*1;return 180*Math.atan2(s-n,o-a)/Math.PI+180},getDirectionByAngle:function(t,e,i){return e=void 0!==e?e:4,i=i||0,Math.abs((Math.floor(t/(360/e)+.5)+i)%e)},drag:function(t){this.flags.drag=!0,this.itemCreator.state=!1,this.itemCreator.fixed=!0;var s=this.gridParam,r=this.focused.filter(function(t){return"UFLine"!==t.type}).map(function(t){t.drag=!0,t.assignedLines.forEach(function(t){t.change("additionalPoints",[])});var e=this.shadow.append(t.shadowTemplate);return e.css({width:t.size.width*s.width,height:t.size.height*s.height,transform:"translate("+t.coord.x*s.width+"px, "+t.coord.y*s.height+"px)","will-change":"transform","z-index":3}),{item:t,shadow:e,startCoord:t.coord}},this);this.updateMap();var c=this.getCursorPosition,e=app.modules.get("sideZoneScroll",{target:content,settings:{scroller:this.scroller}}),l={x:0,y:0},d={x:0,y:0},h=function(t,e,i){return this.insertCalculate(e.item,{x:e.startCoord.x+t.x,y:e.startCoord.y+t.y},!1,i)}.bind(this),i=function(t){var e=this.getCursorPosition,i=e.mouseX-c.mouseX,a=e.mouseY-c.mouseY,n={x:e.x-c.x,y:e.y-c.y};if(r.forEach(function(t){t.item.dom.css({transform:"translate("+(t.startCoord.x*s.width+i)+"px, "+(t.startCoord.y*s.height+a)+"px) rotate(3deg)"})}),!equals(n,d)&&!equals(d=n,l)){var o=r.map(function(t){return t.item.id});r.every(function(t){return h(n,t,o)})&&(r.forEach(function(t){var e={x:t.startCoord.x+n.x,y:t.startCoord.y+n.y};t.item._coord=e,t.shadow.transform({x:e.x*s.width,y:e.y*s.height,z:3})}),l=n,this.updateMap(),this.redrawAllLines())}}.bind(this);i(),$(document).on("mousemove",i),this.scroller.on("scroll",i),$(document).one("mouseup",function(){$(document).off("mousemove",i),this.scroller.off("scroll",i),e.die(),this._drag=!1,r.forEach(function(t){t.item.drag=!1,t.shadow.css({opacity:0})}),forceReflow(this.dom),r.forEach(function(t){t.item._coord=!1,t.item.coord={x:t.startCoord.x+l.x,y:t.startCoord.y+l.y}}),this.view(),setTimeout(function(){r.forEach(function(t){t.shadow.remove()}),this.itemCreator.fixed=!1,this.flags.drag=!1}.bind(this),150)}.bind(this))},createLine:function(r,c){this.flags.lineCreate=!0,r.focus||this.setFocus({target:r,state:!0});var l,d=$(r.entryPointsArray.get(c)),h=this.topContainer.path(""),t=this.gridParam;this.scale||this.zoom;h.attr({stroke:"#4D9EF6",fill:"none","stroke-width":"1"}),d.addClass("drag");var u=[];u[0]=r.coord.x*t.width+r.entryPoints[c][0]+(t.width*r.size.width-r.contentSize.width)/2+.5+(1==c?15:3==c?-15:0),u[1]=r.coord.y*t.height+r.entryPoints[c][1]+(t.height*r.size.height-r.contentSize.height)/2+.5+(0==c?-15:2==c?15:0);var p=null,m="",f=function(){var t=this.getCursorPosition,e=this.getByCoord(t),i=(this.fitToView(),t.mouseX+.5),a=t.mouseY+.5;if(h.attr({d:"M"+u[0]+" "+u[1]+" L"+i+" "+a}),e)var n=this.getAngle(e,this.getCursorPosition),o=this.getDirectionByAngle(n,4,1);if(e&&e.id!=r.id){var s="id"+e.id+"drt"+o;l&&l.id==e.id||(l=e,this.setHover(e)),m!=s&&(m=s,p&&p.removeClass("hover"),p=$(e.entryPointsArray.get(o)).addClass("hover"))}else p&&(p.removeClass("hover"),p=null),l&&(this.setHover(!1),l=null,m="")}.bind(this),g=app.modules.get("sideZoneScroll",{target:content,settings:{scroller:this.scroller,triggerZone:.05}});this.dom.on("mousemove",f),this.scroller.on("scroll",f),$(document).one("mouseup",function(t){this.dom.off("mousemove",f),this.scroller.off("scroll",f),g.die(),h.remove(),this.flags.lineCreate=!1,d.removeClass("drag"),p&&p.removeClass("hover"),this.setHover(!1);var e=this.getCursorPosition,i=this.getByCoord(e);if(i&&i.id!==r.id){var a=this.getAngle(i,this.getCursorPosition),n=this.getDirectionByAngle(a,4,1),o={id:getRandom(r.lines.map(function(t){return t.id})),departure:{target:r.id,point:c,connector:"circle"},destination:{target:i.id,point:n,connector:"arrow"}},s=new w(o,this,!0);r.lines.push(s),this.setFocus({target:s,state:!0}),s.save(),this.socket.trigger("userflow",{target:this.id,event:"userflow",data:{event:"createLine",target:r.id,data:o}})}}.bind(this))},setFocus:function(t){var e=Object.assign({target:null,state:!1,multiMod:!1},t||{});if(e.multiMod)if(e.target&&"object"==typeof e.target)e.state?[].concat(e.target).forEach(function(t){t.focus=!0,this.focused.includes(t)||this.focused.push(t)},this):[].concat(e.target).forEach(function(t){this.focused.findAndRemove(t),t.focus=!1},this);else{if(!e.state)throw new Error("Target is required argument then miltiMod active && state !== true");this.focused=this.list.map(function(t){return t.focus=!0,t})}else{if(e.target){var i=[].concat(e.target);this.focused.forEach(function(t){return!!i.includes(t)||(t.focus=!1)}),(this.focused=i).forEach(function(t){t.focus=!0})}else this.focused.forEach(function(t){t.focus=!1}),this.focused.length=0;this.focused.forEach(function(t){t.focus=!1}),e.target?this.focused=[].concat(e.target).map(function(t){return t.focus=!0,t}):this.focused.length=0}this.selectBar(this.focused)},setHover:function(t){this.hovered=t?(t.hover=!0,this.hovered&&this.hovered.id!=t.id&&(this.hovered.hover=!1),t):(this.hovered&&(this.hovered.hover=!1),!1)},get placeholderCalculation(){return Object.values(this.flags).every(function(t){return!t})},mouseSignaturePosition:function(t,e){if(!1===t&&this._mouseSignature)return this._mouseSignature.remove(),this._mouseSignature=null,!1;var i="M "+(t+=this.param.shift.x/this.zoom)+" "+(e+=this.param.shift.y/this.zoom)+"m -20, 0a 20,20 0 1, 0  40,0a 20,20 0 1, 0  "+-40+",0";this.mouseSignature.attr({d:i,style:"stroke-width: 1px; fill: #000000;"})},get mouseSignature(){return this._mouseSignature||(this._mouseSignature=this.hat.path(""),this._mouseSignature.attr({fill:"none"})),this._mouseSignature},selectBar:function(){var o=this,t=!!this.focused.length&&this.focused.reduce(function(t,e){return e.type!==t?"delete":t},this.focused[0].type),a=app.modules.get("html");app.subscriber("add",{scope:app,event:"userflowSelectbar"+t});var n='<svg xmlns="http://www.w3.org/2000/svg" width="58" height="1" viewBox="0 0 58 1"><path d="M0 0.5h58.5z"></path></svg>',e=function(t,e,i){return{param:{class:"page-selectbar__item",callback:e||!1},content:[].concat(t,i?{name:"icon",param:{name:"arrowSolid",style:{transform:"translateX(5px)","pointer-events":"none"},cover:!0}}:[])}},s=function(a,n){return o.focused.reduce(function(t,e){var i=Array.isArray(a)?safetyObjectAccess(e,a):e.get(a);return null!=t?i===t?i:n:i},null)||n},i={UFItem:[["figure",{key:"icon",data:{key:"icon"}}],[{key:"color",data:{key:"borderColor",icon:"stroke"}},{key:"color",data:{key:"bgColor",icon:"fill"}},{key:"color",data:{key:"textColor",icon:"letterA"}}],["delete"]],FMItem:["pageSelect","delete"],UFLine:[["dashArray"],[{key:"color",data:{key:"color",icon:"stroke"}}],[{key:"icon",data:{key:"icon"}}],[{key:"connectors",data:{reverse:!0,key:"connectorOut"}},{key:"connectors",data:{reverse:!1,key:"connectorIn"}}],["delete"]],UFImage:1<o.focused.length?["delete"]:[["replace","download","delete"]],delete:["delete"]},r={figure:function(){return e({name:"menuSelect",param:{type:"icon",value:s("figure",!1),placeholder:{name:"icon",param:{name:"several_forms",cover:!0}},options:d,callback:function(e){o.focused.forEach(function(t){t.change("figure",e)})}}},!1,!0)},icon:function(t){return e({name:"menuSelect",param:{type:"icon",scroll:!0,search:!0,listStyle:{height:156},settings:{width:226,colStyle:{width:32,height:32}},placeholder:{name:"icon",param:{name:"several_icons",cover:!0}},value:s(t.key,!1),options:app.modules.get("sprites","userflow",!0,!0).then(function(t){return t.map(function(t){var e=Object.assign({value:t.id},t);return Object.defineProperty(e,"dom",{get:function(){return t.dom},enumerable:!0,configurable:!0}),e})}),callback:function(e){o.focused.forEach(function(t){t.change("icon",e)})}}},!1,!0)},color:function(i){return e({name:"menuSelect",param:{type:"color2",icon:i.icon,placeholderColor:1<o.focused.length&&"linear-gradient(134.72deg, #D63E81 0%, #5D55FC 52.47%, #00A6FF 100%)",value:s(i.key,!1),onInput:function(e){o.focused.forEach(function(t){t.set(i.key,e)})},callback:function(e){o.focused.forEach(function(t){t.change(i.key,e)})}}},!1,!0)},delete:function(){return e({name:"icon",param:{name:"delete",cover:!0}},function(){o.removeItem(o.focused,!1),o.setFocus()})},pageSelect:function(){return e({name:"icon",param:{name:"page",cover:!0}},function(){var i,t={name:"flowmapTree",param:{flowmap:o.workplace.getModule("flowmap"),callback:function(t,e){"select"===t&&o.focused.forEach(function(t){t.change("cardId",e)}),i.close()}}};i=$(this).popover(t,{mod:["huge","top","center"],height:360})},!0)},download:function(){return e({name:"icon",param:{name:"download",cover:!0}},function(){o.focused.forEach(function(t){t.content.download()})})},connectors:function(i){return e({name:"menuSelect",param:{type:"list",value:1===o.focused.length&&o.focused[0][i.key].icon,options:x.mapToArray(function(t,e){return{value:e,content:a({param:{class:"userflow-line"+(i.reverse?" userflow-line--reverse":"")},content:[{param:{class:"userflow-line__line"},content:$(n)},{param:{class:"userflow-line__icon"},content:$(t).css("fill","#A2CEF9")}]})}}),callback:function(e){o.focused.forEach(function(t){t.change(i.key,{icon:e})})}}},!1,!0)},dashArray:function(){return e({name:"menuSelect",param:{type:"list",value:1===o.focused.length?o.focused[0].dashArray:"0px 0px",options:[{value:"0px 0px",content:$('<div class="userflow-line"><div class="userflow-line__line">'+n+"</div></div>")},{value:"2px 2px",content:$('<div class="userflow-line"><div class="userflow-line__line userflow-line__line--doted">'+n+"</div></div>")},{value:"3px 3px",content:$('<div class="userflow-line"><div class="userflow-line__line userflow-line__line--dashed">'+n+"</div></div>")}],callback:function(e){o.focused.forEach(function(t){t.change("dashArray",e)})}}},!1,!0)},replace:function(){return e({name:"icon",param:{name:"replace",cover:!0}},function(){o.focused.forEach(function(t){t.content.replace()})})}},c=function(t){return Array.isArray(t)?{param:{class:"page-selectbar__group"},content:t.map(c)}:("string"==typeof t&&(t={key:t,data:{}}),r.hasOwnProperty(t.key)?r[t.key](t.data):"")};return t&&i.hasOwnProperty(t)?(this.selectBarDom.find(".js-tools").html(a(i[t].map(c))),forceReflow(this.selectBarDom),this.selectBarDom.addClass("open")):(this.selectBarDom.removeClass("open"),app.subscriber("add",{scope:app,event:"selectBarClose"})),this.selectBarDom.find(".js-count").text(this.focused.length),this.selectBarDom.find(".js-text").text("Element"+(1!==this.focused.length?"s":"")+" selected"),this.selectBarDom.find(".js-similar").toggle(t&&i.hasOwnProperty(t)&&"delete"!==t),!1},get selectBarDom(){if(!this._selectBarDom){var i=this;this._selectBarDom=app.modules.get("html",{param:{class:"page-selectbar js-useflow-selectbar"},content:{param:{class:"page-selectbar__container"},content:[{param:{class:"page-selectbar__panel page-selectbar__panel--center js-tools"}},{param:{class:"page-selectbar__panel page-selectbar__panel--absolute page-selectbar__panel--left"},content:{param:{class:"page-selectbar__info"},content:[{param:{class:"page-selectbar__num js-count"}},{param:{class:"page-selectbar__text js-text"}},{name:"buttonRow",param:{style:{"margin-left":"14px"}},content:[{name:"link",param:{class:"js-similar",callback:function(){var e=i.focused[0].type,t="UFLine"===e?i.allLines:i.list.filter(function(t){return t.type===e});i.setFocus({target:t,state:!0})}},content:"Select all similar"},{name:"link",param:{callback:function(){i.setFocus(!1)}},content:"Deselect all"}]}]}}]}}).appendTo(content)}return this._selectBarDom},get gridParam(){return Object.assign({},s)},get scrollOffset(){return{x:this.scroller.scrollLeft(),y:this.scroller.scrollTop()}},get shadow(){return $('<div class="userflow__cell userflow__cell--shadow"></div>').appendTo(this.dom)},scrollInit:function(){var t=[];if(this.scrollPosition)t=this.scrollPosition;else{var e=this.param,i=this.gridParam;if(this.list.length){var a=this.map.map.map(function(t){return t[0]}).filter(function(t){return!!t}),n=a[Math.floor(a.length/2+.5)-1];t[0]=(n.coord.x+n.size.width/2)*i.width+e.shift.x-content.width()/2,t[1]=n.coord.y*i.height+e.shift.y}else t[0]=e.size.width/2-i.width+i.width/2-content.outerWidth()/2,t[1]=e.size.height/2-i.height+i.height/2-content.outerHeight()/2}this.scroller.scrollLeft(t[0]),this.scroller.scrollTop(t[1])},get lineFilter(){if(!this._lineFilter){var t=this.hat;this._lineFilter={active:t.paper.filter(Snap.filter.shadow(0,0,1.5,"#58a8f7",1)).attr("filterUnits","objectBoundingBox"),hover:t.paper.filter(Snap.filter.shadow(0,0,.5,"#58a8f7",.8)).attr("filterUnits","objectBoundingBox"),normal:t.paper.filter(Snap.filter.shadow(0,1,2,"#8c9baa",.1)).attr("filterUnits","objectBoundingBox")}}return this._lineFilter},shortCut:{keycode:{32:{event:"scrollMouse"},13:{event:"open"},27:{event:"focusOut"},8:{event:"delete"},46:{event:"delete"},"=":{event:"zoom",args:1},"+":{event:"zoom",args:1},"-":{event:"zoom",args:-1},18:{event:"outzoom"}},event:{do:function(t,e){this[t.event]&&this[t.event]&&("object"==typeof this[t.event]?this[t.event].init(t.args,e):"function"==typeof this[t.event]&&this[t.event](t.args,e))},die:function(t,e){this[t.event]&&this[t.event]&&"object"==typeof this[t.event]&&this[t.event].die(t.args,e)},open:function(){var t=userflow.focused;t&&"FMItem"==t.type&&t.content.openModal()},focusOut:function(){userflow.setFocus(!1)},scrollStep:function(t,e){e.preventDefault();var i=flowmap.focus,a=flowmap.cellMap;if(i){var n=i.position.x+i.position.rx,o=i.position.y+i.position.ry,s=null,r=null;switch(t){case"l":for(var c=o;c<a.length;c++){for(var l=n-1;0<=l;l--){if((p=a[c][l])&&p.card.id!=i.id){if("b"!=p.drt){s=p.card;break}r||(r=p.card)}}if(r||s)break}break;case"r":for(c=o;c<a.length;c++){for(l=n+1;l<a[c].length;l++){if((p=a[c][l])&&p.card.id!=i.id){if("b"!=p.drt){s=p.card;break}r||(r=p.card)}}if(r||s)break}break;case"t":for(c=o-1;0<=c;c--){if((p=a[c][n])&&p.card.id!=i.id){s=p.card;break}}break;case"b":for(c=o+1;c<a.length;c++){for(var d=0,h=0,u=!0;u;){var p,m=2;if(n+h<a[c].length){if((p=a[c][n+h])&&p.card.id!=i.id&&"b"!=p.drt){s=p.card;break}}else m-=1;if(0<=n+d){if((p=a[c][n+d])&&p.card.id!=i.id&&"b"!=p.drt){s=p.card;break}}else m-=1;d-=1,h+=1,u=!!m}if(s)break}}i=s||r}else i=flowmap.centralCardInView;i&&(flowmap.focus=i,flowmap.scrollTo(i,150))},scrollMouse:{init:function(){if(this.state)return!1;this.state=!0,userflow.container.css("transition","none"),this.fs=app.modules.get("fakeScroll",{container:userflow.container,scroller:userflow.scroller}),userflow.container.css("will-change","transform"),this.mouseState=buttonsState.check(1,"mouse"),this.bind(),userflow.flags.spaceMove=!0},die:function(){if(this.mouseState=!1,this.fs.compensate(),forceReflow(userflow.container),userflow.container.css("transition",""),!this.state)return!1;this._mouseState=null,this.state=!1,this.unbind(),userflow.flags.spaceMove=!1,userflow.container.css("will-change","")},move:function(){if(this.mouseState){var t=this.mouseStartX-cursorX,e=this.mouseStartY-cursorY;this.mouseStartX=cursorX,this.mouseStartY=cursorY,this.fs.move({x:t,y:e})}},get mouseState(){return this._mouseState},set mouseState(t){equals(this.mouseState,t)||(this._mouseState=t)&&(this.mouseStartX=cursorX,this.mouseStartY=cursorY)},mousemove:function(){this.move()},mouseup:function(){this.mouseState=!1,this.fs.compensate()},mousedown:function(){this.mouseState=!0},bind:function(){$("body").on("mousemove",$.proxy(this.mousemove,this)).on("mouseup",$.proxy(this.mouseup,this)).on("mousedown",$.proxy(this.mousedown,this))},unbind:function(){$("body").off("mousemove",$.proxy(this.mousemove,this)).off("mouseup",$.proxy(this.mouseup,this)).off("mousedown",$.proxy(this.mousedown,this))}},delete:function(){userflow.focused.length&&userflow.removeItem(userflow.focused)},zoom:function(t){userflow.zoom+=t/10},outzoom:{init:function(){if(1==this.state)return this;userflow.fitToView(!0)},die:function(){return userflow.fitToView(!1),this}}},find:function(t){for(var e in this.keycode)if(t.keyCode==e||t.key==e)return this.keycode[e];return!1},keyup:function(t){if(ufController.state){var e=$(t.target);if(e.is("input")||e.is("textarea"))return;var i=this.find(t);if(i)return t.preventDefault(),this.event.die(i,t),!1}},keydown:function(t){if(ufController.state){var e=$(t.target);if(e.is("input")||e.is("textarea")||app.modules.get("modalList",!0).length)return;var i=this.find(t);if(!app.modules.get("modalList",!0).length&&i)return t.preventDefault(),this.event.do(i,t),!1}},bind:function(){$(document).on("keyup",$.proxy(this.keyup,this)),$(document).on("keydown",$.proxy(this.keydown,this))},unbind:function(){$(document).off("keyup",$.proxy(this.keyup,this)),$(document).off("keydown",$.proxy(this.keydown,this))}},bind:function(){"default"===this.workplace.method&&this.dom.on("mousemove",function(){if(this.placeholderCalculation){var t=this.gridParam,e=this.getCursorPosition,i=this.getByCoord(e);this.map;i?this.itemCreator.state=!1:(this.itemCreator.hover=e.mouseX>=e.x*t.width+t.padding&&e.mouseX<=(e.x+1)*t.width-t.padding&&e.mouseY>=e.y*t.height+t.padding&&e.mouseY<=(e.y+1)*t.height-t.padding,this.itemCreator.move({coord:{x:e.x,y:e.y},x:t.width*e.x+t.padding,y:t.height*e.y+t.padding,s:1}))}else this.itemCreator.state=!1}.bind(this)).on("mouseleave",function(){this.itemCreator.state=!1}.bind(this)).on("mousedown",function(t){t.shiftKey&&this.mouseSelectArea(t)}.bind(this)).on("click",function(t){if(userflow.shortCut.event.scrollMouse.state||this.flags.drag)return!1;var e=$(t.target),i=this.getCursorPosition,a=this.mouseSignature,n=t.shiftKey;if(this.mouseSignaturePosition(i.mouseX,i.mouseY),e.closest(".userflow__item").length)!(e=this.getByCoord(this.getCursorPosition)||!1)&&n||this.setFocus({target:e,multiMod:n,state:e&&n&&!e.focus});else if(e.parents(".userflow-creator__icon").length)this.setFocus(!1);else{var o=this.allLines.filter(function(t){return!!Snap.path.intersection(t.hat,a).length}),s=o.findIndex(function(t){return t.focus}),r=-1<s?o[(s+1)%o.length]:o.find(function(t){return t.hover});!r&&n||this.setFocus({target:r,multiMod:n,state:r&&n&&!r.focus})}this.mouseSignaturePosition(!1)}.bind(this)),this.shortCut.bind()},unbind:function(){this.dom.off(),this.shortCut.unbind()},die:function(){this.setFocus(),this.unbind(),this.list.forEach(function(t){t.die()}),this.container.css({width:"",height:""}),this.dom.remove(),this.subscriber("die")},get container(){return this.controller.dom},get hat(){return this._hat||(this._hat=Snap(this.dom.find(".userflow__hat").get(0))),this._hat},get linesContainer(){return this._linesContainer||(this._linesContainer=this.dom.find(".userflow__line")),this._linesContainer},get topContainer(){return this._topContainer||(this._topContainer=Snap($('<svg class="userflow__top"></svg>').appendTo(this.dom).get(0))),this._topContainer},get serviceContainer(){return this._serviceContainer||(this._serviceContainer=Snap($('<svg class="userflow__service"></svg>').appendTo(this.dom).get(0))),this._serviceContainer},get dom(){return this._dom||(this._dom=$('<div class="userflow__grid"><svg class="userflow__line"></svg><svg class="userflow__hat"></svg></div>'),"default"!==this.workplace.method&&this._dom.addClass("userflow__grid--static"),this.highlight(!1)),this._dom},get scroller(){return this._scroller||(this._scroller=this.controller.controller.scroller),this._scroller},get socket(){return this.controller.socket},get allLines(){return this.list.reduce(function(t,e){return t.concat(e.lines)},[])},showGrid:function(t){"boolean"!=typeof t&&(t=!this._showGrid),this._showGrid=t,this.dom.toggleClass("userflow__grid--show-grid",t)},fitToView:function(t){var e=this.param,i=e.contentSize.width,a=e.contentSize.height,n=this.gridParam,o=content.width(),s=content.height(),r=(this.map,this.zoom),c=this.map.shiftX*n.width+e.shift.x/r,l=this.map.shiftY*n.height+e.shift.y/r;if(!0!==t||this._fitToView){if(!1!==t||!this._fitToView)return this._fitToView||!1;var d=i/r*this._fitToView.k,h=a/r*this._fitToView.k,u=(o-d)/2,p=(s-h)/2,m=cursorX,f=cursorY-content.offset().top,g=(m-u)/d,v=(f-p)/h,b=this.scroller.scrollLeft()-(this.map.shiftX*n.width*r+e.shift.x)-g*i+m,_=this.scroller.scrollTop()-(this.map.shiftY*n.height*r+e.shift.y)-v*a+f;this.dom.transform({x:b,y:_,s:this.zoom}),this.dom.onTransitionEnd(250).then(function(){this.dom.css({transform:"scale("+this.zoom+")",transition:"none"}),this.scroller.scrollLeft(this.scroller.scrollLeft()-b),this.scroller.scrollTop(this.scroller.scrollTop()-_),this.dom.css({transition:""}),this._fitToView=!1}.bind(this)),this.scale=!1}else{var y=o-40,w=s-40,k=Math.min(this.zoom,y/(i/r),w/(a/r)),x=(o-i/r*k)/2,j=(s-a/r*k)/2,C=this.scroller.scrollLeft()-c*k+x,S=this.scroller.scrollTop()-l*k+j;this._fitToView={x:C,y:S,k:k},this.scale=k,this.dom.transform({x:C,y:S,s:k})}},redrawAllLines:function(e){this.allLines.forEach(function(t){t.redraw(e),t.drawHat()})},highlight:function(t){this.dom.toggleClass("debug",!!t)},openModal:function(){var i=this;this.workplace.openModal({hash:"ufinfo",heading:{edit:this.accessibility,value:this.title,callback:i.change.bind(this),change:function(e){return{ctx:i.subscriber,fn:i.subscriber,arg:["off",i.subscriber("on",{event:"title"},function(t){t.map(function(t){return t.data}).forEach(e)})]}}},content:[{name:"Info",modules:[{name:"description",data:{description:this.description,owner:this.ownerName,creationDate:formatDate(this.data.date_create,"M d.yyyy")},settings:{formIdPrefix:["userflow",this.id,"info"].join("/"),editable:this.accessibility,change:function(t,e){return{ctx:i.subscriber,fn:i.subscriber,arg:["off",i.subscriber("on",{event:e},t)]}},callback:function(t){i.change.apply(i,t)}}},"default"===this.method&&{name:"discussion",data:{edit:"default"===this.method,get:function(){return i.discussion.get.then(function(t){return t.forEach(function(t){t.accessibility=i.owner==User.id||t.from_id==User.id}),t}.bind(i))},formIdPrefix:["userflow",i.id,"info"].join("/")},settings:{change:function(t){return{ctx:i.subscriber,fn:i.subscriber,arg:["off",i.subscriber("on",{event:"discussion"},t)]}},remove:function(t){return app.serverRequest("flowmapDiscussionDelete",Object.assign({},t,{ufid:i.id}))},edit:function(t){return app.serverRequest("flowmapDiscussionEdit",Object.assign({},t,{ufid:i.id}))},post:function(t){return app.serverRequest("flowmapDiscussionSend",Object.assign({},t,{ufid:i.id}))},callback:function(t){i.change("discussion",t)}}}]}]})},calculateGap:function(t,e,i,a){for(var n={width:t,height:e},o=function(t){var e=this.getByCoord(t);return e&&e.id!==a}.bind(this),s=Math.min(t,e),r=0;r<s;r++){for(var c=r,l=r;c<t&&!o({x:c+i.x,y:r+i.y});c++);for(;l<e&&!o({x:r+i.x,y:l+i.y});l++);n.width=Math.min(n.width,c),n.height=Math.min(n.height,l)}return n}},userflowClass=m;var c=function(t,e,i){this.lines=t.lines||[],this.incomeLines=[],this.connectors=[],this.id=t.id,this.type=t.type,this.userflow=e,this.defineContent(t.data),t.coord=t.coord?{x:1*t.coord.x,y:1*t.coord.y}:{x:0,y:0},this._coord=Object.assign({},t.coord,{s:1,o:1}),i&&(this.dom.transform(Object.assign({},this.coord,{x:this.coord.x*this.userflow.gridParam.width,y:this.coord.y*this.userflow.gridParam.height,z:4,s:.8,o:0})),forceReflow(this.dom)),this.dom.transform(Object.assign({},this.coord,{x:this.coord.x*this.userflow.gridParam.width,y:this.coord.y*this.userflow.gridParam.height,z:4,s:1,o:1})),this.bind()};c.prototype={get workplace(){return this.userflow.workplace},get drag(){return this._drag||!1},set drag(t){equals(this.drag,t)||(this.dom.toggleClass("drag",t),t?this._drag=t:setTimeout(function(){this._drag=t}.bind(this),35))},get size(){return this._size||{width:0,height:0}},set size(t){if(!equals(this.size,t)){this._size=t;var e=this.userflow.gridParam;this.dom.css({width:t.width*e.width,height:t.height*e.height})}},set:function(t,e){this.content[t]=e},get:function(t){return this.content[t]},change:function(t,e){this.set.apply(this,Array.prototype.slice.apply(arguments));var i={};i[t]=e,app.serverRequest("userFlowItem",Object.assign({id:this.id},{data:this.content.data})),this.userflow.socket.trigger("userflow",{target:this.userflow.id,event:"userflow",data:{event:"change",target:this.id,data:i}})},defineContent:function(t){"UFItem"===this.type?(this.content=new i(t,this),this.size={width:1,height:1}):"FMItem"===this.type?(this.content=new n(t,this),this.size={width:1,height:2}):"UFImage"===this.type&&(this.content=new o(t,this),this.size=this.content.size)},get loadData(){return{id:this.id,type:this.type,coord:this.coord,lines:this.lines.length?this.lines.map(function(t){return t.loadData}):"",data:this.content.data}},get focus(){return this._focus||!1},set focus(t){equals(this.focus,t)||(this._focus=t,this.dom.toggleClass("userflow__cell--focus",t),this.content.focus=t)},get hover(){return this._hover||!1},set hover(t){equals(this.hover,t)||(this._hover=t,this.dom.toggleClass("userflow__cell--hover",t))},get coord(){return this._coord||{x:-1,y:-1,s:1,o:1,p:!0}},set coord(t){equals(this.coord,t)||(this._coord=Object.assign(this.coord,t),this.dom.transform(Object.assign({},this.coord,{x:this.coord.x*this.userflow.gridParam.width,y:this.coord.y*this.userflow.gridParam.height,z:4})),!0!==this.delete&&(app.serverRequest("userFlowItem",Object.assign({id:this.id},{coord:{x:t.x,y:t.y}})),this.userflow.socket.trigger("userflow",{target:this.userflow.id,event:"userflow",data:{event:"move",target:this.id,data:t}})))},move:function(t){this._coord=Object.assign(this.coord,t),this.dom.transform(Object.assign({},this.coord,{x:this.coord.x*this.userflow.gridParam.width,y:this.coord.y*this.userflow.gridParam.height,z:4})),this.userflow.updateMap(),this.userflow.redrawAllLines()},remove:function(){for(this.delete=!0,this.coord={x:this.coord.x,y:this.coord.y,o:0,s:.85};this.lines.length;)this.lines[0].remove();for(;this.incomeLines.length;)this.incomeLines[0].remove();this.dom.off(),this.content&&"function"==typeof this.content.remove&&this.content.remove(),this.content&&"function"==typeof this.content.die&&this.content.die(),setTimeout(function(){this.dom.remove()}.bind(this),150)},die:function(){this.content&&"function"==typeof this.content.die&&this.content.die(),this.dom.off(),this.dom.remove()},bind:function(){var i=this;this.dom.on("dragstart",function(t){if(t.preventDefault(),userflow.shortCut.event.scrollMouse.state||"default"!==userflow.method||t.shiftKey)return!1;var e=$(t.target);return e.is(".userflow__entry")?i.userflow.createLine(i,e.index()):(i.focus||userflow.setFocus({target:i,state:!0}),userflow.drag(i)),!1}).on("hover",function(){i.dom.addClass("userflow__cell--hover")},function(){i.dom.removeClass("userflow__cell--hover")})},get template(){return app.modules.get("html",{param:{class:"userflow__cell"},content:this.content.dom})},get dom(){return this._dom||(this._dom=this.template.appendTo(this.userflow.dom)),this._dom},save:function(){app.serverRequest("userFlowItem",this.loadData)},updateLines:function(){this.assignedLines.forEach(function(t){t.redraw()})},drawConnector:function(t){(t?[].concat(t):this.connectors).forEach(function(t){t.hasOwnProperty("dom")||(t.dom=$('<div class="userflow__connector" draggable="true"><div class="icon"></div></div>')),t.drag&&!t.hasOwnProperty("shadowDom")&&(t.shadowDom=$('<div class="userflow__connector userflow__connector--shadow"></div>'));var e=t.drag?30:15,i=t.drag?30:15,a=t.drag?t.shadowDom:t.dom;a.parent().is(this.content.dom)||this.content.dom.append(a);var n=this.entryPoints[t.drt],o=90*t.drt+180*t.revert,s=t.color;a.css({width:e,height:i,left:Math.round(n[0]-e/2),top:Math.round(n[1]-i/2)});var r=$(x[t.icon]||x.circle);(t.iconDom=r).css("fill",s),a.find(".icon").css("transform","rotate("+o+"deg)").html(r)}.bind(this))},get assignedLines(){return[].concat(this.lines,this.incomeLines)},get contentSize(){return this.content.contentSize},get entryPointsArray(){return this.content.entryPointsArray},get entryPoints(){return this.content.entryPoints},get shadowTemplate(){return this.content.shadowTemplate}};var i=function(t,e){this.item=e,this.data=t};i.prototype={get id(){return this.item.id},get focus(){return this._focus||!1},set focus(t){equals(this.focus,t)||(this._focus=t)},get hover(){return this.item.hover},defineFilter:function(){var t=this.focus?"active":this.hover?"hover":"normal";this.figurePath.attr({filter:this.filters[t]})},get dragState(){return void 0===this._dragState||this._dragState},set dragState(t){equals(this.dragState,t)||(this._dragState=t,this.dom.attr("draggable",t))},get drag(){return this.item.drag},get title(){return this.data.title},set title(t){equals(this.title,t)||(this.data.title=t,this.dom.find(".js-title").trigger("value",t))},focusTitle:function(){this.dom.find(".js-title").trigger("edit",!0)},get figure(){return this.data.figure},set figure(t){if(!equals(this.figure,t)){this.data.figure=t;var e=k[this.figure]();this.figurePath.animate({d:e.path},200,Transition.linear),this.contentSize=e.contentSize,this.hoverSize=e.hoverZone||e.contentSize;var i=e.entryPoints;i[0][1]+=2,i[1][0]-=2,i[2][1]-=2,i[3][0]+=2,this.entryPoints=i,this.item.drawConnector()}},get icon(){return this.data.icon||"none"},set icon(t){if(t="none"!=t&&t,!equals(this.icon,t)){this.data.icon=t;var e=this.dom.find(".js-icon").html("").get(0);t&&app.modules.get("sprites","userflow",t).then(function(t){t&&t.dom.appendTo(e)}.bind(this))}},get textColor(){return this.data.textColor||"#52565f"},set textColor(t){equals(this.textColor,t)||(this.data.textColor=t,this.dom.find(".js-title").css("color",t))},get bgColor(){return this.data.bgColor||!1},set bgColor(t){equals(this.bgColor,t)||(this.data.bgColor=t,this.figurePath.animate({fill:t},200,Transition.linear))},get borderColor(){return this.data.borderColor||!1},set borderColor(t){equals(this.borderColor,t)||(this.data.borderColor=t,this.figurePath.animate({stroke:t},200,Transition.linear))},get entryPoints(){return this._entryPoints||[]},set entryPoints(t){if(!equals(this.entryPoints,t)){this._entryPoints=t;var a=this.entryPointsArray;t.forEach(function(t,e){var i=$(a.get(e));"default"===this.item.workplace.method?i.css({left:Math.round(t[0]),top:Math.round(t[1])}):i.hide()}.bind(this))}},get contentSize(){return this._contentSize||{width:0,height:0}},set contentSize(t){equals(t,this.contentSize)||(this._contentSize=t,this.dom.css({width:t.width,height:t.height}))},get hoverSize(){return this._hoverSize||{width:0,height:0}},set hoverSize(t){equals(t,this.hoverSize)||(this._hoverSize=t,this.hoverZone.css({width:t.width+34,height:t.height+34}))},get figurePath(){if(!this._figurePath){var t=k[this.figure]();this._figurePath=Snap(this.dom.find(".userflow__figure").get(0)).path(t.path),this.bgColor&&this._figurePath.attr({fill:this.bgColor}),this.borderColor&&this._figurePath.attr({stroke:this.borderColor}),this.filters={active:this._figurePath.paper.filter(Snap.filter.shadow(0,0,7,"#58a8f7",.7)),hover:this._figurePath.paper.filter(Snap.filter.shadow(0,1,10,"#8c9baa",.2)),normal:this._figurePath.paper.filter(Snap.filter.shadow(0,1,2,"#8c9baa",.1))},this.contentSize=t.contentSize,this.hoverSize=t.hoverZone||t.contentSize;var e=t.entryPoints;e[0][1]+=1,e[1][0]+=1,e[2][1]+=1,e[3][0]+=1,this.entryPoints=e}return this._figurePath},get entryPointsArray(){return this._entryPointsArray||(this._entryPointsArray=this.dom.find(".userflow__entry")),this._entryPointsArray},get template(){var e=this,a=function(){return this.focus&&"default"===this.item.workplace.method&&!this.drag&&!userflow.shortCut.event.scrollMouse.state}.bind(this),i=app.modules.get("html",{name:"html",param:{class:"userflow__item",attr:{draggable:!0},bind:[{event:"dragstart",callback:function(t){if(!e.dragState)return t.preventDefault(),t.stopPropagation(),!1}},{event:"dblclick",callback:function(){a()&&e.focusTitle()}}]},content:[{param:{class:"userflow__entry",attr:{draggable:!0},count:4}},{param:{class:"userflow__hover-zone js-hover"}},{param:{class:"userflow__design"},content:$('<svg class="userflow__figure"></svg>')},{param:{class:"userflow__content"},content:[{param:{class:"userflow__icon js-icon"}},{name:"customTextarea",param:{style:{color:this.textColor},state:!1,class:"userflow__title js-title",stopPropagation:!0,multiLine:!0,callback:function(t,e,i){if("beforeFocus"===e)return a();"change"===e?this.item.change("title",i.value):"focus"===e?this.dragState=!1:"blur"===e&&(this.dragState=!0)}.bind(this),value:this.title}},{param:{class:"userflow__title-line"}}]}]});return this.icon&&"false"!=this.icon&&"none"!=this.icon&&app.modules.get("sprites","userflow",this.icon).then(function(t){t&&t.dom.appendTo(i.find(".js-icon").html("").get(0))}.bind(this)),i},get hoverZone(){return this._hoverZone||(this._hoverZone=this.dom.find(".js-hover")),this._hoverZone},get dom(){return this._dom||(this._dom=this.template,this.figurePath),this._dom},get shadowTemplate(){return $('<div class="userflow__item" style="width: '+this.contentSize.width+"px; height: "+this.contentSize.height+'px"><svg class="userflow__figure" height="114px" width="180px"><path d="'+this.figurePath.node.attributes.d.value+'" stroke="#bfc8d0" stroke-dasharray="2px 2px" fill="#e1eaf3"></path></svg></div>')},die:function(){}};var a,n=function(t,e){this.subKeys={},this.item=e,this.cardId=t.id};n.prototype={get focus(){return this._focus||!1},set focus(t){equals(this.focus,t)||(this._focus=t,this.dom.find(".flowmap__item").toggleClass("flowmap__item--focus",t))},defineFilter:function(){},get data(){return{id:this.cardId}},get title(){return this.card.then(function(t){return t?t.get("title"):"REMOVED CARD"})},get cover(){return this.card.then(function(t){return!!t&&t.get("cover")})},get cardId(){return this._cardId},set cardId(t){equals(this.cardId,t)||(this.unbind(this.card),this._cardId=t,this.card.then(function(t){t&&(this.update(),this.bind(this.card))}.bind(this)))},get card(){return this._card&&this._card.id==this.cardId||(this._card=this.item.workplace.getModule("flowmap").then(function(t){var e=t.getCard(this.cardId);return e||!1}.bind(this))),this._card},get entryPoints(){return this._entryPoints||[]},set entryPoints(t){if(!equals(this.entryPoints,t)){this._entryPoints=t;var a=this.entryPointsArray;t.forEach(function(t,e){var i=$(a.get(e));"default"===this.item.workplace.method?i.css({left:Math.round(t[0]),top:Math.round(t[1])}):i.hide()}.bind(this))}},get contentSize(){return this._contentSize||{width:0,height:0}},set contentSize(t){equals(t,this.contentSize)||(this._contentSize=t,this.dom.css({width:t.width,height:t.height}))},update:function(){this.updateTimer&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(function(){this.dom.find(".flowmap__item").replaceWith(this.cardTemplate)}.bind(this),160)},bind:function(t){t.then(function(t){t&&(this.subKeys[t.id]=t.subscriber("on",this.update.bind(this)))}.bind(this))},unbind:function(t){t.then(function(t){t&&t.subscriber&&this.subKeys.hasOwnProperty(t.id)&&(t.subscriber("off",this.subKeys[t.id]),delete this.subKeys[t.id])}.bind(this))},get entryPointsArray(){return this._entryPointsArray||(this._entryPointsArray=this.dom.find(".userflow__entry")),this._entryPointsArray},get cardTemplate(){var s=app.modules.get("html",{param:{class:"flowmap__item flowmap__item--default"+(this.focus?" flowmap__item--focus":"")},content:[{param:{class:"flowmap__cover",attr:{"data-field":"cover"}}},$('<div class="flowmap__title js-title"><h4 class="title" data-field="title"></h4><input class="input"></div>'),{name:"button",param:{addClass:["flowmap__button","flowmap__button--center","js-open-card"],mod:["lightblue","round","narrow"],icon:"dots"}},this.card.flagTemplate,this.card.labelTemplate]}),t=s.loader("cover"),r=this;return this.card.then(function(n){if(n){s.find(".js-open-card").on("click",function(){n.openModal()}),s.find('[data-field="title"]').text(n.get("title")),s.find('[data-field="cover"]').setBackground(n.get("cover"));var o=!1;s.on("click",".js-title",function(t){if(!userflow.shortCut.event.scrollMouse.state)if(o)t.stopPropagation();else if("default"===this.item.userflow.method){var e=s.find(".js-title input"),i=function(){s.find('[data-field="title"]').text(e.val()),n.change("title",e.val()),a(!1)}.bind(this),a=function(t){s.attr("draggable",!t),r.dom.attr("draggable",!t),s.toggleClass("flowmap__item--edit",t),t?(o=t,e.val(n.get("title")),e.inputFocus(!0),e.on("focusout",i),e.on("keydown",function(t){13==t.keyCode?i():27==t.keyCode&&a(!1)})):(setTimeout(function(){o=t},400),e.val(""),e.off(),e.blur())};a(!0)}}.bind(this))}else s.find('[data-field="title"]').text("DELETED PAGE");t.done()}.bind(this)),s},get template(){return app.modules.get("html",{name:"html",param:{class:"userflow__item",attr:{draggable:!0}},content:[{param:{class:"userflow__entry",attr:{draggable:!0},count:4}},{param:{class:"userflow__hover-zone js-hover",style:{width:214,height:254}}},this.cardTemplate]})},get dom(){return this._dom||(this._dom=this.template,this.contentSize={width:180,height:220},this.entryPoints=[[this.contentSize.width/2,0],[this.contentSize.width,this.contentSize.height/2],[this.contentSize.width/2,this.contentSize.height],[0,this.contentSize.height/2]]),this._dom},get shadowTemplate(){return $('<div class="userflow__item" style="width: '+this.contentSize.width+"px; height: "+this.contentSize.height+'px"><div class="flowmap__item flowmap__item--default flowmap__item--shadow"></div></div>')},die:function(){this.unbind(this.card)}};var t=function(e){a&&a.remove();var i=["image/jpeg","image/png","image/svg+xml","image/gif","image/bmp"];(a=document.createElement("input")).type="file",a.accept=i.join(","),$(a).on("change",function(){var t=a.files[0];if(t){if(!i.includes(t.type))return alert("Unsupported file format!"),!1;"function"==typeof e&&e(t)}}).css("opacity",0).appendTo(content),a.click()},o=function(t,e){this.item=e,this.data={},t instanceof File?this.parseFile(t).then(function(t){this.data.meta=t.meta,this.defineSize(),this.item.userflow.updateMap(),this.showLoader(!0),this.upload(t.file,function(t,e){var i=this.item.coord;if(t){this.data=Object.assign(this.data,e);e={coord:{x:i.x,y:i.y},data:this.data,list_id:this.item.userflow.id,type:"UFImage"};app.serverRequest("userFlowItem",e).then(function(t){this.item.id=t.id,this.item.lines.forEach(function(t){t.data.departure.target=this.id},this),this.item.incomeLines.forEach(function(t){t.data.destination.target=this.id,t.save()},this),e.id=this.item.id,e.lines=this.item.lines.map(function(t){return t.loadData}),this.item.userflow.socket.trigger("userflow",{target:this.item.userflow.id,event:"userflow",data:{event:"create",data:e}}),this.showLoader(!1),this.imageView()}.bind(this))}}.bind(this))}.bind(this)):(this.data=t,this.imageView())};o.prototype={get size(){return this.data.size||{width:1,height:1}},set size(t){equals(this.size,t)||(this.data.size=t,this.item.size=t)},get link(){return this.data.link},get fileId(){return this.data.file_id},get imageWidth(){return safetyObjectAccess(this.data,["meta","width"],0)},get imageHeight(){return safetyObjectAccess(this.data,["meta","height"],0)},get title(){return this.data.meta.title},get name(){return this.data.meta.name},get extension(){return this.data.meta.extension},get imageSize(){return this.data.imageSize||null},set imageSize(t){equals(t,this.imageSize)||(this.data.imageSize=t,this.imageView())},get entryPoints(){return this._entryPoints||[]},set entryPoints(t){if(!equals(this.entryPoints,t)){this._entryPoints=t;var a=this.entryPointsArray;t.forEach(function(t,e){var i=$(a.get(e));"default"===this.item.workplace.method?i.css({left:Math.round(t[0]),top:Math.round(t[1])}):i.hide()}.bind(this))}},get contentSize(){var t=userflow.gridParam;return{width:this.size.width*t.width-2*t.padding,height:this.size.height*t.height-2*t.padding}},set setNewImage(t){this.data.meta.width!=t.meta.width&&this.data.meta.height!=t.meta.height&&(t.imageSize=null),this.data=t,this.imageView()},get image(){return this._image},set image(t){equals(this._image,t)||this.imageContainer.setBackground(t)},imageView:function(){var t=this.calcImageSize(),e=this.contentSize,i={x:(e.width-t.width)/2,y:(e.height-t.height)/2};this.imageContainer.css({width:"auto",height:"auto",right:i.x,bottom:i.y,left:i.x,top:i.y}),this.entryPoints=[[i.x+t.width/2,i.y+0],[i.x+1*t.width,i.y+t.height/2+1],[i.x+t.width/2,i.y+1*t.height],[i.x+0,i.y+t.height/2+1]],this.image=this.link},getKoeficient:function(t){var e=this.item.userflow.gridParam;return Math.min((t.width*e.width-2*e.padding)/this.imageWidth,(t.height*e.height-2*e.padding)/this.imageHeight)},calcImageSize:function(){if(this.imageSize)return this.imageSize;var t=this.getKoeficient(this.size);return t="svg"===this.extension?t:Math.min(1,t),{width:this.imageWidth*t,height:this.imageHeight*t}},defineSize:function(t,e){var i=this.item.userflow.gridParam,a=i.width-2*i.padding,n=i.height-2*i.padding;t=t||Math.min(2,Math.max(1,Math.round(this.imageWidth/a))),e=e||Math.min(2,Math.max(1,Math.round(this.imageHeight/n)));var o=this.item.userflow.calculateGap(t,e,this.item.coord,this.item.id),s=this.getKoeficient(o),r=Math.max(1,Math.round(this.imageWidth*s/a)),c=Math.max(1,Math.round(this.imageHeight*s/n));this.size={width:r,height:c}},upload:function(t,e){app.upload({file:t,data:{id:this.item.userflow.id},url:"userflowAttach",progress:this.setLoaderState.bind(this),done:function(t){t=JSON.parse(t),e&&(t.status?e(!0,{link:t.file.filename,file_id:t.file.id}):e(!1))}.bind(this),error:function(){e&&e(!1)}})},unsetFile:function(){app.serverRequest("userflowUnAttach",1*this.fileId)},download:function(){return downloadURI(location.origin+this.link,this.name)},replace:function(){t(function(t){t&&this.parseFile(t).then(function(i){this.showLoader(!0),this.upload(i.file,function(t,e){t&&(this.unsetFile(),this.item.change("setNewImage",Object.assign({},this.data,e,{meta:i.meta}))),this.showLoader(!1)}.bind(this))}.bind(this))}.bind(this))},parseFile:function(o){return new Promise(function(t,e){var i=new Image,a=window.URL.createObjectURL(o),n={};n.name=o.name,n.title=o.name.substring(0,o.name.lastIndexOf(".")),n.type=o.type,n.size=o.size,n.extension=n.name.split(".").pop(),i.onload=function(){n.width=i.width,n.height=i.height,t({localUrl:a,meta:n,file:o})},i.onerror=e,i.src=a})},showLoader:function(t){this.loader&&this.loader.remove(),t&&(this.loader=app.modules.get("html",{param:{class:"userflow__img-loader",attr:{"data-title":this.title}},content:[{param:{tag:"img",attr:{width:93,height:69,src:app.root+"/img/emptystate/empty_img_uf.png"}}},{param:{class:"loadbar"},content:{param:{class:"loadbar__progress js-progress"}}}]}),this.dom.append(this.loader))},setLoaderState:function(t){this.loader&&this.loader.find(".js-progress").css("width",t+"%")},get imageResize(){return this._imageResize},set imageResize(t){equals(this.imageResize,t)||(this._imageResize=t,this.size=t.size,this.item.coord=t.coord,this.imageSize=t.imageSize,this.item.userflow.view(),this.item.drawConnector())},resize:function(a,t){t.stopPropagation();var e=a.index(),r=this.item.userflow,c=r.gridParam,i=this.item.size,n=this.item.coord,l=this.calcImageSize(),o=this.contentSize;r.itemCreator.state=!1,r.itemCreator.fixed=!0,this.item.dom.addClass("userflow__cell--resize"),a.addClass("active");var d="",h="",u=(o.width-l.width)/2,p=(o.height-l.height)/2,s=(i.width-l.width/c.width)/2,m=(i.height-l.height/c.height)/2,f={},g={},v=1,b=1,_=1,y=1;d=0===e||3===e?(f.x=n.x+1*i.width,g.x=n.x,"left"):(f.x=n.x,g.x=n.x+1*i.width,_=0,v=-1,"right"),h=0===e||1===e?(f.y=n.y+1*i.height,g.y=n.y,"top"):(f.y=n.y,g.y=n.y+1*i.height,y=0,b=-1,"bottom");var w,k,x,j={x:f.x-s*v,y:f.y-m*b},C=Math.vectorLength(j.x,j.y,g.x+s*v,g.y+m*b);this.imageContainer.css("transition","none");var S=function(){var t=r.getCursorPosition,e=Math.vectorLength(t.mouseX/c.width,t.mouseY/c.height,j.x,j.y)/C,i={},a={width:l.width*e,height:l.height*e},n={width:Math.ceil((a.width+2*c.padding)/c.width),height:Math.ceil((a.height+2*c.padding)/c.height)},o={x:Math.round(f.x-n.width*_),y:Math.round(f.y-n.height*y)},s=r.calculateGap(n.width,n.height,o,this.item.id);equals(n,s)&&(w=s,k=o,x=a,i[d]=u-(a.width-l.width),i[h]=p-(a.height-l.height),this.imageContainer.css(i))}.bind(this);return S(),r.dom.on("mousemove",S),r.dom.one("mouseup",function(){if(r.dom.off("mousemove",S),this.item.dom.css("transition","none"),w&&k&&x){this.size=w,this.item.coord=k,r.view();var t={},e=(this.size.width*c.width-2*c.padding-x.width)/2,i=(this.size.height*c.height-2*c.padding-x.height)/2;t[d]=e+e-u,t[h]=i+i-p,this.imageContainer.css(t),forceReflow(this.item.dom),this.imageContainer.css("transition",""),this.item.dom.css("transition",""),this.imageSize=x,this.item.drawConnector(),this._imageResize={coord:k,size:w,imageSize:x},this.item.change("imageResize",this.imageResize)}this.imageContainer.css("transition",""),this.item.dom.css("transition",""),a.removeClass("active"),this.item.dom.removeClass("userflow__cell--resize"),r.itemCreator.fixed=!1}.bind(this)),!1},get shadowTemplate(){this.item.userflow.gridParam;return app.modules.get("html",{param:{class:"userflow__item",style:{width:"100%",height:"100%"}},param:{style:{width:"auto",height:"auto",top:20,left:20,right:20,bottom:20},class:"flowmap__item flowmap__item--default flowmap__item--shadow"}})},get imageContainer(){return this.dom.find(".userflow__image")},get image(){return this.dom.find(".userflow__image .image")},get template(){var i=this;return app.modules.get("html",{name:"html",param:{class:"userflow__item userflow__item--image",attr:{draggable:!0}},content:[{param:{class:"userflow__entry",attr:{draggable:!0},count:4}},{param:{class:"userflow__image"},content:[{param:{class:"image"}},{param:{class:"userflow__hover-zone js-hover",style:{width:"calc(100%  + 28px)",height:"calc(100% + 28px)"}}},{param:{class:"userflow__resize"},content:{param:{class:"resize__point",attr:{draggable:!0},count:4,event:"dragstart",callback:function(t){var e=$(this);return i.resize(e,t)}}}}]}]})},get hoverZone(){return this.dom.find(".js-hover")},get entryPointsArray(){return this._entryPointsArray||(this._entryPointsArray=this.dom.find(".userflow__entry")),this._entryPointsArray},get dom(){return this._dom||(this._dom=this.template,this.contentSize={width:180,height:220},this.entryPoints=[[this.contentSize.width/2,0],[this.contentSize.width,this.contentSize.height/2],[this.contentSize.width/2,this.contentSize.height],[0,this.contentSize.height/2]]),this._dom}};var w=function(t,e,i){if(this.inited=!0,this.type="UFLine",this.data=t,this.currentPath=[],this.userflow=e,this.data.id||(this.data.id=getRandom()),!this.destination||!this.departure)return this.departure.lines.findAndRemove(function(t){return t.id==this.id}.bind(this)),this.save(),this.inited=!1;this.destination.incomeLines.push(this),this._connectorOut={icon:this.data.departure.connector||"circle",drt:this.data.departure.point||"0",color:this.color,revert:!0},this.departure.connectors.push(this.connectorOut),this.departure.drawConnector(this.connectorOut),this._connectorIn={icon:this.data.destination.connector||"circle",drt:this.data.destination.point||"0",color:this.color,revert:!1},this.destination.connectors.push(this.connectorIn),this.destination.drawConnector(this.connectorIn),this.hover=!1,this.updateIcon(!0),i?this.animateDraw(this.generatePath(),this.bind.bind(this)):this.bind()};w.prototype={get id(){return this.data.id},get connectorIn(){return this._connectorIn},set connectorIn(t){if(t=Object.assign({},this.connectorIn,t),!equals(this.connectorIn,t)){this._connectorIn=t;var e=this.data.destination;e.connector=t.icon,e.point=t.drt,this.destination.drawConnector(this.connectorIn)}},get connectorOut(){return this._connectorOut},set connectorOut(t){if(t=Object.assign({},this.connectorOut,t),!equals(this.connectorOut,t)){this._connectorOut=t;var e=this.data.departure;e.connector=t.icon,e.point=t.drt,this.departure.drawConnector(this.connectorOut)}},get additionalPoints(){return this.data.additionalPoints||[]},set additionalPoints(t){this.data.additionalPoints=t,this.redraw()},get loadData(){return this.data},set:function(t,e){Array.isArray(t)&&t.forEach(function(t){this.set(t.key,t.value)}.bind(this)),this[t]=e},get:function(t){return this[t]},change:function(t,e){Array.isArray(t)&&t.forEach(function(t){this.change(t.key,t.value)}.bind(this)),this.set(t,e);var i={};i[t]=e,this.userflow.socket.trigger("userflow",{target:this.userflow.id,event:"userflow",data:{event:"changeLine",target:this.id,data:i}}),this.save()},die:function(a){var t=function(t){var e=t.findIndex(function(t){return t.id==this.id}.bind(this));-1<e&&t.remove(e)}.bind(this),e=function(e,t){e.dom.addClass("remove"),e.id=getRandom(),t.remove(t.findIndex(function(t){return e.id==t.id}))},i=this.connectorOut.dom.add(this.connectorIn.dom);if(e(this.connectorOut,this.departure.connectors),e(this.connectorIn,this.destination.connectors),t(this.departure.lines),t(this.destination.incomeLines),a){var n=Snap.parsePathString(this.path.node.attributes.d.value),o=n.length;(a=function(t,e){if(0<t){var i=n.slice(0,t).map(function(t){return t.join(" ")}).join(" ");this.path.animate({d:i},40,Transition.linear,function(){a(t-1,e)})}else"function"==typeof e&&e()}.bind(this))(o-1,function(){i.remove(),this.path.remove()}.bind(this))}else this.path.remove();this.hat.remove(),this.serviceLine.remove(),this.currentIcon&&this.currentIcon.remove()},remove:function(){this.die(!0),this.userflow.socket.trigger("userflow",{target:this.userflow.id,event:"userflow",data:{event:"removeLine",target:this.id}}),this.save()},get icon(){return this.data.icon||"none"},set icon(t){t="none"!=t&&t,equals(this.icon,t)||(this.data.icon=t,this.updateIcon(!0))},get iconCoord(){return this.data.iconCoord||!1},set iconCoord(t){equals(this.iconCoord,t)||(this.data.iconCoord=t,this.drawIcon())},defineFilter:function(){},get departure(){return this.userflow.getItem(this.data.departure.target)},set departure(t){this.departure.connectors.findAndRemove(function(t){return t===this.connectorOut}.bind(this)),this.departure.lines.findAndRemove(function(t){return t.id===this.id}.bind(this)),this.data.departure=t,this._connectorOut=Object.assign(this._connectorOut,{icon:t.connector||"circle",drt:t.point||"0",color:this.color,revert:!0}),this.departure.connectors.push(this.connectorOut),this.departure.lines.push(this),this.departure.drawConnector(this.connectorOut),this.redraw()},get departurePointCoord(){return this.calcPointCoord(this.departure.coord,this.departure.size,this.data.departure.point)},get destination(){return this.userflow.getItem(this.data.destination.target)},set destination(t){this.destination.connectors.findAndRemove(function(t){return t===this.connectorIn}.bind(this)),this.destination.incomeLines.findAndRemove(function(t){return t.id===this.id}.bind(this)),this.data.destination=t,this._connectorIn=Object.assign(this._connectorIn,{icon:t.connector||"circle",drt:t.point||"0",color:this.color,revert:!1}),this.destination.connectors.push(this.connectorIn),this.destination.incomeLines.push(this),this.destination.drawConnector(),this.redraw()},get destinationPointCoord(){return this.calcPointCoord(this.destination.coord,this.destination.size,this.data.destination.point)},get dashArray(){return this.data.dashArray||"0px 0px"},set dashArray(t){equals(this.dashArray,t)||(this.data.dashArray=t,debug=this.path.node.style,this.path.animate({"stroke-dasharray":t},150,Transition.linear))},get color(){return this.data.color||"#4D9EF6"},set color(t){equals(this.color,t)||(this.data.color=t,this.connectorIn.iconDom.css("fill",t),this.connectorOut.iconDom.css("fill",t),this.path.animate({stroke:t},150,Transition.linear))},get focus(){return this._focus},set focus(t){equals(t,this.focus)||(this._focus=t,this.path.attr({filter:t?this.userflow.lineFilter.active:"",stroke:this.color}),!t&&this._mouseSeeker&&(this._mouseSeeker.remove(),this._mouseSeeker=null))},calcPointCoord:function(t,e,i){return t=[1*t.x,1*t.y],0==i?t[0]+=e.width/2:1==i?(t[0]+=1*e.width,t[1]+=e.height/2):2==i?(t[0]+=e.width/2,t[1]+=1*e.height):3==i&&(t[1]+=e.height/2),t},findPath:function(t,e,i,a){var n=this.userflow.gridPathMap,o=f.find([[2*(t-map.shiftX),2*(e-map.shiftY)],[2*(i-map.shiftX),2*(a-map.shiftY)]],n,this.data.departure.point);return f.pathPointModify(o,function(t,e){return t/2+(e?map.shiftY:map.shiftX)})},generatePath:function(){var t=this.departure,e=this.destination;if(!t||!e)return[];var i=this.userflow.map,a=[t.coord.x+t.size.width/2,t.coord.y+t.size.height/2],n=[e.coord.x+e.size.width/2,e.coord.y+e.size.height/2],o=this.departurePointCoord,s=this.destinationPointCoord,r=f.pathPointModify([].concat([o],this.additionalPoints,[s]),function(t,e){return 2*(t-(e?i.shiftY:i.shiftX))}),c=f.find(r,this.userflow.gridPathMap,this.data.departure.point);c=f.compressPath(f.pathPointModify(c,function(t,e){return t/2+(e?i.shiftY:i.shiftX)}));var l=this.pathArray=c;return l.unshift(a),l.unshift([a[0]+.01,a[1]+.01]),l.unshift([a[0]-.01,a[1]-.01]),l.push(n),l.push([n[0]+.01,n[1]+.01]),l.push([n[0]-.01,n[1]-.01]),l},save:function(t){return t=t||this.departure,app.serverRequest("userFlowItem",Object.assign({id:t.id},{lines:t.loadData.lines}))},updateIcon:function(i){this.currentIcon&&this.currentIcon.remove();var l=this,a=function(n){if("default"!==this.userflow.workplace.method)return!1;var i=!1,o=null,s=null,r=null,a=1*n.attr("width"),c=1*n.attr("height");n.drag(function(){i?function(t,e){var i=o.x+t,a=o.y+e;n.attr({x:i,y:a}),r=Snap.closestPoint(l.serviceLine,i,a),s.attr({cx:r.x,cy:r.y})}.apply(null,argsToArray({arguments:arguments})):function(){i=!0,o={x:1*n.attr("x"),y:1*n.attr("y")},(s=l.userflow.topContainer.circle(o.x,o.y,12.5).attr({fill:"#e1eaf3","stroke-width":"1","stroke-dasharray":"2px 2px",stroke:"#BFC8D0"})).insertBefore(n),l.userflow.setFocus({target:l,state:!0,multiMod:!0}),l.userflow.itemCreator.state=!1,l.userflow.itemCreator.fixed=!0}.apply(null,argsToArray({arguments:arguments}))},function(){},function(t){i&&(t.preventDefault(),t.stopPropagation(),function(){if(i=!1,!s||!r)return!1;var t=s,e={x:r.x,y:r.y};n.animate({x:e.x-a/2,y:e.y-c/2},150,Transition.linear,function(){t.remove()}),l.data.iconCoord=e,l.change("iconCoord",e),l.userflow.setFocus({target:l,state:!0,multiMod:!0}),l.userflow.itemCreator.fixed=!1}.apply(null,argsToArray({arguments:arguments})))}),n.click(function(){l.userflow.setFocus({target:l,state:!0})})};this.icon&&"none"!==this.icon&&convertToPromise(app.modules.get("sprites","userflow",this.icon)).then(function(t){if(t){this.currentIcon=t.dom.appendTo(this.userflow.topContainer);var e=this.currentIcon.children().filter(function(t){return"#text"!==t.type})[0];e.attr("fill","#ffffff"),this.currentIcon.circle(this.currentIcon.attr("width")/2,this.currentIcon.attr("height")/2,12.5).attr("fill","#58a8f7").insertBefore(e),i&&this.drawIcon(!0),a(this.currentIcon)}else this.change("icon","none")}.bind(this))},drawIcon:function(t){var e;this.currentIcon&&(this.iconCoord&&(e={x:(e=Snap.closestPoint(this.serviceLine,this.iconCoord.x,this.iconCoord.y)).x,y:e.y}),e||(e={x:(e=this.centerPoint)[0],y:e[1]}),e.x=e.x-this.currentIcon.attr("width")/2,e.y=e.y-this.currentIcon.attr("height")/2,t?this.currentIcon.attr(e):this.currentIcon.animate(e,150,Transition.linear))},redraw:function(t,e){var i=this.userflow.gridParam,a=f.pathPointModify(e||this.generatePath(),function(t,e){return t*(e?i.height:i.width)+.5});if(!equals(a,this.currentPath)){this.currentPath=a.slice(),this.drawHat(),this.drawService();var n="M"+(a=f.compressPath(a)).slice(0,2).join("L")+svgHelper.buildPath(a.slice(2,-2),function(t,e,i){return svgHelper.arcsCommandFor90DegreeAngle(t,e,i,10)},!0)+"L"+a.slice(-2).join("L");t?this.path.attr({d:n}):this.path.stop().animate({d:n},150,Transition.linear,function(){this.path.attr({d:n})}.bind(this))}this.drawIcon(t)},animateDraw:function(e,i){this.redraw(!0);var a=(e=Snap.parsePathString(this.path.node.attributes.d.value)).length;this.path.attr({d:""});var n=function(t){++t<=a?this.path.animate({d:e.slice(0,t).map(function(t){return t.join(" ")}).join(" ")},40,Transition.linear,function(){n(t)}):"function"==typeof i&&i()}.bind(this);n(0)},drawHat:function(){var e=this.userflow.zoom,i=this.userflow.param.shift,t=this.currentPath.slice(2,this.currentPath.length-2).map(function(t){return[t[0]+i.x/e,t[1]+i.y/e]});this.hat.attr({d:"M"+t.join("L")})},drawService:function(){var t=this.currentPath.length,e=[].concat([Math.averagePointByRatio(this.currentPath[3],this.currentPath[2],100)],this.currentPath.slice(3,t-3),[Math.averagePointByRatio(this.currentPath[t-4],this.currentPath[t-3],100)]);this.serviceLine.attr({d:"M"+e.join("L")})},get centerPoint(){return this.calcCenterPoint(this.currentPath)},calcCenterPoint:function(t){var e=t.slice(2,t.length-2);if((e=t.slice()).length%2)return e[(e.length-1)/2];var i=e[e.length/2-1],a=e[e.length/2];return[(i[0]+a[0])/2,(i[1]+a[1])/2]},get hat(){return this._hat||(this._hat=this.userflow.hat.path("")),this._hat},get path(){return this._path||(this._path=Snap(this.userflow.linesContainer.get(0)).path(""),this._path.attr({stroke:this.color,"stroke-dasharray":this.dashArray,fill:"none","stroke-width":"1"})),this._path},get serviceLine(){return this._serviceLine||(this._serviceLine=this.userflow.serviceContainer.path("")),this._serviceLine},get mouseSeeker(){return this._mouseSeeker||(this._mouseSeeker=this.userflow.hat.circle(0,0,4.5).attr({fill:"#4d9ef6"}),this.path.after(this.mouseSeeker)),this._mouseSeeker},bind:function(){var c=this.userflow,o=!1,a=!1,e=function(t){if(a&&!o){this.userflow.param.shift;var e=c.getCursorPosition,i=Snap.closestPoint(this.path,e.mouseX,e.mouseY);this.mouseSeeker.attr({cx:i.x,cy:i.y})}}.bind(this);this.hat.hover(function(){this.hover=!0,this.focus?a=!0:this.path.attr({stroke:shadeColor(this.color,-.2)})},function(t){this.hover=!1,a=!1,this.focus||this.path.attr({stroke:this.color}),!o&&this.mouseSeeker&&(this.mouseSeeker.remove(),this._mouseSeeker=null)},this,this),this.hat.mousemove(function(t){this.focus&&(a=!0),e(t)}.bind(this));var s=!1,r=!1,t=null,l=function(){t=app.modules.get("sideZoneScroll",{target:content,settings:{scroller:c.scroller,triggerZone:.05}})},d=function(){t&&t.die(),t=null},h=function(t){l(),this.userflow.flags.lineDrag=!0;var e=this.userflow.param.shift,i=this.userflow.gridParam,a=t.layerX-e.x,n=t.layerY-e.y,o=Snap.closestPoint(this.path,a,n);({x:Math.round(o.x/i.width),y:Math.round(o.y/i.height)}),this.focus=!1}.bind(this),u=function(t){var e=this.userflow.gridParam,i=this.userflow.getCursorPosition,a=[Math.round(2*i.mouseX/e.width)/2,Math.round(2*i.mouseY/e.height)/2],n=[2*(a[0]-this.userflow.map.shiftX),2*(a[1]-this.userflow.map.shiftY)];!equals(s,a)&&n.every(function(t){return 0<=t})&&1==safetyObjectAccess(this.userflow.gridPathMap,n,0)&&(this.mouseSeeker.animate({cx:a[0]*e.width,cy:a[1]*e.height},150),s=a,r||(r=!0,setTimeout(function(){this.set("additionalPoints",[s]),r=!1}.bind(this),250)))}.bind(this),i=function(t){d(),e(t),this.userflow.flags.lineDrag=!1,s&&this.change("additionalPoints",[s]),this.focus=!0,this.mouseSeeker&&(this.mouseSeeker.remove(),this._mouseSeeker=null)}.bind(this);this.hat.drag(function(t,e,i,a,n){!o&&this.focus&&(o=!0,h(n,t,e,i,a)),o&&u(n,t,e,i,a)},function(){},function(t){o&&(t.preventDefault(),t.stopPropagation(),o=!1,i(t))},this,this,this);var n=function(t,o,s,r,e,i){if("default"===c.method){t.stopPropagation(),t.preventDefault(),o.drag=!0,s.drawConnector(o),o.dom.addClass("drag"),c.dom.append(o.dom.css({top:0,left:0})),c.itemCreator.state=!1,c.itemCreator.fixed=!0,c.flags.lineDrag=!0,c.setFocus({target:this,state:!0,multiMod:!0});var a=s;o.dom.find(".icon").css("transform","scale("+("circle"===o.icon?4:2)+")");var n=function(){var t=c.getCursorPosition,e=c.getByCoord(t),i=!1;if(e){var a=c.getAngle(e,t),n=c.getDirectionByAngle(a,4,1);n!=o.drt&&(o.drt=r.point=n,i=!0),e!==s&&(s.connectors.findAndRemove(function(t){return t===o}),(s=e).connectors.push(o),r.target=s.id,i=!0),i&&(s.drawConnector(o),this.redraw())}o.dom.transform({x:t.mouseX+c.param.shift.x/c.zoom-7,y:t.mouseY+c.param.shift.y/c.zoom-7,z:9999999})}.bind(this);l(),c.dom.on("mousemove",n),c.scroller.on("mousemove",n),c.dom.one("mouseup",function(){c.dom.off("mousemove",n),c.scroller.off("mousemove",n),d(),o.drag=!1,o.dom.removeClass("drag"),o.dom.css("z-index",""),o.shadowDom.remove(),delete o.shadowDom,o.dom.css("transform","").find(".icon").css("transform",""),s.drawConnector(o),this.redraw();var t=Object.assign({},this.data[i]);this.data[i].target=a.id,this.change(i,t),this.save(a),c.flags.lineDrag=!1,c.itemCreator.fixed=!1}.bind(this)),n()}}.bind(this);this.connectorIn.dom.on("dragstart",function(t){n(t,this.connectorIn,this.destination,this.data.destination,"incomeLines","destination")}.bind(this)),this.connectorOut.dom.on("dragstart",function(t){n(t,this.connectorOut,this.departure,this.data.departure,"lines","departure")}.bind(this))}};var l=function(t){this.userflow=t,this.clearList=[]};l.prototype={view:function(){if(this.fixed)return!1;this.dom.removeClass("active"),this.state&&(this.dom.css("transform","translate("+safetyObjectAccess(this,["position","x"],-9999999)+"px, "+safetyObjectAccess(this,["position","y"],-9999999)+"px)"),forceReflow(this.dom),this.dom.addClass("active"),this.selectBar(!1))},get fixed(){return this._fixed||!1},set fixed(t){equals(this.fixed,t)||(this._fixed=t,this.view())},get hover(){return this._hover||!1},set hover(t){equals(this._hover,t)||(this._hover=t,this.dom.toggleClass("hover",t))},set holdSelectBar(t){equals(t,this.holdSelectBar)||(this._selectBar=t)},get holdSelectBar(){return this._holdSelectBar||!1},move:function(t){this.state||(this.state=!0),equals(this.position,t)||(this.position=t,this.state&&this.view())},createFigure:function(e,t){var i=d.find(function(t){return t.value===e});this.userflow.createItem({data:{title:i&&i.title||"New symbol",figure:e||"oval",textColor:"#52565f",bgColor:"#ffffff"},type:"UFItem",coord:t||this.savedCoord},!0),this.selectBar(!1)},createPageLink:function(t,e){var i,a;a=t instanceof Promise?(i=t).then(function(t){return{data:{id:t.id}}}):!(i={id:t}),this.userflow.createItem({type:"FMItem",data:i,coord:e||this.savedCoord},!0,a),this.selectBar(!1)},createImage:function(){var i=this.savedCoord;t(function(t){this.fixed=!1,this.state=!1;var e=new c({coord:i,data:t,date_create:app.serverTime(),date_update:app.serverTime(),id:getRandom(),lines:[],list_id:this.userflow.id,type:"UFImage"},this.userflow,!0);this.userflow.list.push(e),this.userflow.view(),this.userflow.redrawAllLines(),this.userflow.setFocus({target:e,state:!0})}.bind(this))},selectBar:function(t){t?(this.fixed=!0,this.savedCoord=this.position.coord,this.dom.append(this.selectBarTemplate),this.dom.addClass("open")):this.holdSelectBar||(this.dom.find(".userflow-creator__bar").remove(),this.fixed=!1,this.clearList.forEach(function(t){t()}),this.clearList.length=0,this.dom.removeClass("open"))},get selectBarTemplate(){var e=!!this.userflow.insertCalculate({size:{width:1,height:2}},this.savedCoord,!1),n=this,t=app.modules.get("html",{param:{class:"userflow-creator__bar"},content:[{param:{class:"userflow-creator__item",attr:{title:"Process"},callback:function(){n.createFigure("rectangle")}},content:{name:"icon",param:{name:"rectangle",cover:!0}}},{param:{class:"userflow-creator__item",attr:{title:"Terminator"},callback:function(){n.createFigure("oval")}},content:{name:"icon",param:{name:"oval",cover:!0}}},{param:{class:"userflow-creator__item",attr:{title:"Decision"},callback:function(){n.createFigure("rhombus")}},content:{name:"icon",param:{name:"rhombus",cover:!0}}},{param:{class:"userflow-creator__item"},content:[{name:"menuSelect",param:{type:"icon",placeholder:"More",value:!1,options:d.exclude(["rhombus","oval","rectangle"],!1,["value"]),settings:{mouseleaveDelay:2e3,mod:["white","medium","bot","center"]},callback:function(t){n.createFigure(t)}}},{name:"icon",param:{name:"arrowSolid",style:{transform:"translateX(5px)"},cover:!0}}]},{param:{class:"userflow-creator__item"+(e?"":" userflow-creator__item--disabled"),attr:{title:e?"Page":"Can't insert page here!"},callback:function(){if(!e)return!1;var i,a=n.savedCoord,t=app.modules.get("html",{name:"flowmapTree",param:{create:!0,flowmap:n.userflow.workplace.getModule("flowmap"),callback:function(t,e){"select"===t?n.createPageLink(e):"create"===t&&n.createPageLink(e,a),i.close()}}});i=$(this).parent().popover(t,{mod:["huge","center"],height:360})}},content:{name:"icon",param:{name:"page",cover:!0}}},{param:{class:"userflow-creator__item",attr:{title:"Upload Image"},callback:function(){n.createImage()}},content:[{name:"icon",param:{name:"borderimg",cover:!0}}]}]});return setTimeout(function(){this.clearList.push(t.clickOutside(function(){n.selectBar(!1)}))}.bind(this),20),t},get state(){return void 0===this._state||this._state},set state(t){equals(this.state,t)||(this._state=t,this.view(),t||(this.coord={x:NaN,y:NaN}))},get template(){var t=this,e=app.modules.get("html",{param:{class:"userflow__creator"},content:[{param:{attr:{"data-note":"Page"},class:"userflow-creator__icon"},content:{name:"button",param:{mod:["doted","round","narrow"],icon:"plus",callback:function(){t.selectBar(!0)}}}}]});return e.mouseLeaveTimer(function(){t.selectBar(!1)},4e3),e},get dom(){return this._dom||(this._dom=this.template.appendTo(this.userflow.dom)),this._dom}};var k={rectangle:function(){var t=(s.width-2*s.padding-179)/2+.5,e=(s.height-2*s.padding-63)/2+.5;return{path:"M"+t+" "+e+"L"+(t+89.5)+" "+e+"L"+(t+179)+" "+e+"L"+(t+179)+" "+e+"L"+(t+179)+" "+(e+31.5)+"L"+(t+179)+" "+(e+63)+"L"+(t+179)+" "+(e+63)+"L"+(t+89.5)+" "+(e+63)+"L"+t+" "+(e+63)+"L"+t+" "+(e+63)+"L"+t+" "+(e+31.5)+"L"+t+" "+e+"Z",contentSize:{width:179,height:63},entryPoints:[[89.5,0],[179,31.5],[89.5,63],[0,31.5]]}},rhombicRectangle:function(){var t=(s.width-2*s.padding-179)/2+.5,e=(s.height-2*s.padding-63)/2+.5;return{path:"M"+(t+20)+" "+e+"L"+(t+89.5)+" "+e+"L"+(t+179-20)+" "+e+"L"+(t+179-20)+" "+e+"L"+(t+179)+" "+(e+31.5)+"L"+(t+179-20)+" "+(e+63)+"L"+(t+179-20)+" "+(e+63)+"L"+(t+89.5)+" "+(e+63)+"L"+(t+20)+" "+(e+63)+"L"+(t+20)+" "+(e+63)+"L"+t+" "+(e+31.5)+"L"+(t+20)+" "+e+"Z",contentSize:{width:179,height:63},entryPoints:[[89.5,0],[179,31.5],[89.5,63],[0,31.5]]}},rhombus:function(){var t=179,e=105,i=30,a=0,n=(s.width-2*s.padding-t)/2+.5,o=(s.height-2*s.padding-e)/2+.5;return{path:"M"+(n+t/4)+" "+(o+e/4)+"L"+(n+t/2)+" "+o+"L"+(n+.75*t)+" "+(o+e/4)+"L"+(n+.75*t)+" "+(o+e/4)+"L"+(n+t)+" "+(o+e/2)+"L"+(n+.75*t)+" "+(o+.75*e)+"L"+(n+.75*t)+" "+(o+.75*e)+"L"+(n+t/2)+" "+(o+e)+"L"+(n+t/4)+" "+(o+.75*e)+"L"+(n+t/4)+" "+(o+.75*e)+"L"+n+" "+(o+e/2)+"L"+(n+t/4)+" "+(o+e/4)+"Z",contentSize:{width:t-i,height:e-a},hoverZone:{width:t,height:e},entryPoints:[[t/2,0],[t,e/2],[t/2,e],[0,e/2]].map(function(t){return[t[0]-i/2,t[1]-a/2]})}},hexagon:function(){var t=(s.width-2*s.padding-179)/2+.5,e=(s.height-2*s.padding-83)/2+.5;return{path:"M"+t+" "+(e+20)+"L"+(t+89.5)+" "+e+"L"+(t+179)+" "+(e+20)+"L"+(t+179)+" "+(e+20)+"L"+(t+179)+" "+(e+41.5)+"L"+(t+179)+" "+(e+83-20)+"L"+(t+179)+" "+(e+83-20)+"L"+(t+89.5)+" "+(e+83)+"L"+t+" "+(e+83-20)+"L"+t+" "+(e+83-20)+"L"+t+" "+(e+41.5)+"L"+t+" "+(e+20)+"Z",contentSize:{width:179,height:83},entryPoints:[[89.5,0],[179,41.5],[89.5,83],[0,41.5]]}},wavyBottomRectangle:function(){var t=(s.width-2*s.padding-179)/2+.5,e=(s.height-2*s.padding-77)/2+.5;return{path:"M"+t+" "+e+" L"+(t+89.5)+" "+e+" L"+(t+179)+" "+e+" L"+(t+179)+" "+e+" L"+(t+179)+" "+(e+38.5)+" L"+(t+179)+" "+(e+77)+" C"+(t+179-9)+" "+(e+77-7)+" "+(t+Math.round(153.582))+" "+(e+77-10)+" "+(t+Math.round(129.596))+" "+(e+77-10)+" C"+(t+Math.round(93.617))+" "+(e+77-10)+" "+(t+Math.round(85.741))+" "+(e+77)+" "+(t+Math.round(179*.278))+" "+(e+77)+" C"+(t+Math.round(179*.1448))+" "+(e+77)+" "+(t+Math.round(179*.05))+" "+(e+77-3)+" "+t+" "+(e+77-10)+" L"+t+" "+(e+77-10)+" L"+t+" "+(e+38.5)+" L"+t+" "+e+" Z",contentSize:{width:179,height:77},entryPoints:[[89.5,0],[179,38.5],[89.5,72],[0,38.5]]}},wavyRectangle:function(){var t=Math.round(9.831),e=(s.width-2*s.padding-179)/2+.5,i=(s.height-2*s.padding-87)/2+.5;return{path:"M"+e+" "+i+" C"+(e+Math.round(8.9679))+" "+(i+Math.round(6.9165))+" "+(e+Math.round(179*.1448))+" "+(i+t)+" "+(e+Math.round(179*.278))+" "+(i+t)+" C"+(e+Math.round(85.741))+" "+(i+t)+" "+(e+Math.round(179*.5236))+" "+i+" "+(e+Math.round(129.596))+" "+i+" C"+(e+Math.round(153.5641))+" "+i+" "+(e+Math.round(170.408))+" "+(i+Math.round(2.958))+" "+(e+179)+" "+(i+t)+" L"+(e+179)+" "+(i+43.5)+" L"+(e+179)+" "+(i+87)+" C"+(e+179-.9*t)+" "+(i+87-.7*t)+" "+(e+Math.round(153.582))+" "+(i+87-t)+" "+(e+Math.round(129.596))+" "+(i+87-t)+" C"+(e+Math.round(93.617))+" "+(i+87-t)+" "+(e+Math.round(85.741))+" "+(i+87)+" "+(e+Math.round(179*.278))+" "+(i+87)+" C"+(e+Math.round(179*.1448))+" "+(i+87)+" "+(e+Math.round(179*.05))+" "+(i+87-.3*t)+" "+e+" "+(i+87-t)+" L"+e+" "+(i+87-t)+" L"+e+" "+(i+43.5)+" L"+e+" "+i+" Z",contentSize:{width:179,height:87},entryPoints:[[89.5,0+t/2],[179,43.5],[89.5,87-t/2],[0,43.5]]}},rectangleOval:function(){var t=(s.width-2*s.padding-173)/2+.5,e=(s.height-2*s.padding-65)/2+.5;return{path:"M"+t+" "+e+"L"+(t+86.5)+" "+e+"L"+(t+173-32.5)+" "+e+"L"+(t+173-32.5)+" "+e+"A32.5 32.5 0 0 1 "+(t+173)+" "+(e+32.5)+"A32.5 32.5 0 0 1 "+(t+173-32.5)+" "+(e+65)+"L"+(t+173-32.5)+" "+(e+65)+"L"+(t+86.5)+" "+(e+65)+"L"+(t+32.5)+" "+(e+65)+"L"+t+" "+(e+65)+"L"+t+" "+(e+32.5)+"L"+t+" "+e+"Z",contentSize:{width:173,height:65},entryPoints:[[86.5,0],[173,32.5],[86.5,65],[0,32.5]]}},triangle:function(){var t=(s.width-2*s.padding-179)/2+.5,e=(s.height-2*s.padding-111)/2+.5;return{path:"M"+(t+89.5)+" "+e+"L"+(t+89.5)+" "+e+"L"+(t+89.5)+" "+e+"L"+(t+89.5)+" "+e+"L"+(t+89.5+44.75)+" "+(e+55.5)+"L"+(t+179)+" "+(e+111)+"L"+(t+179)+" "+(e+111)+"L"+(t+89.5)+" "+(e+111)+"L"+t+" "+(e+111)+"L"+t+" "+(e+111)+"L"+(t+44.75)+" "+(e+55.5)+"L"+(t+89.5)+" "+e+"Z",contentSize:{width:179,height:111},entryPoints:[[89.5,0],[134.25,55.5],[89.5,111],[44.75,55.5]]}},parallelogramLeft:function(){var t=(s.width-2*s.padding-179)/2+.5,e=(s.height-2*s.padding-63)/2+.5;return{path:"M"+t+" "+e+"L"+(t+79.5)+" "+e+"L"+(t+159)+" "+e+"L"+(t+159)+" "+e+"L"+(t+169)+" "+(e+31.5)+"L"+(t+179)+" "+(e+63)+"L"+(t+179)+" "+(e+63)+"L"+(t+79.5)+" "+(e+63)+"L"+(t+20)+" "+(e+63)+"L"+(t+20)+" "+(e+63)+"L"+(t+10)+" "+(e+31.5)+"L"+t+" "+e+"Z",contentSize:{width:179,height:63},entryPoints:[[89.5,0],[169,31.5],[89.5,63],[10,31.5]]}},parallelogramRight:function(){var t=(s.width-2*s.padding-179)/2+.5,e=(s.height-2*s.padding-63)/2+.5;return{path:"M"+(t+20)+" "+e+"L"+(t+79.5)+" "+e+"L"+(t+179)+" "+e+"L"+(t+179)+" "+e+"L"+(t+169)+" "+(e+31.5)+"L"+(t+159)+" "+(e+63)+"L"+(t+159)+" "+(e+63)+"L"+(t+79.5)+" "+(e+63)+"L"+t+" "+(e+63)+"L"+t+" "+(e+63)+"L"+(t+10)+" "+(e+31.5)+"L"+(t+20)+" "+e+"Z",contentSize:{width:179,height:63},entryPoints:[[89.5,0],[169,31.5],[89.5,63],[10,31.5]]}},trapezium:function(){var t=(s.width-2*s.padding-179)/2+.5,e=(s.height-2*s.padding-63)/2+.5;return{path:"M"+(t+20)+" "+e+"L"+(t+89.5)+" "+e+"L"+(t+159)+" "+e+"L"+(t+159)+" "+e+"L"+(t+169)+" "+(e+31.5)+"L"+(t+179)+" "+(e+63)+"L"+(t+179)+" "+(e+63)+"L"+(t+89.5)+" "+(e+63)+"L"+t+" "+(e+63)+"L"+t+" "+(e+63)+"L"+(t+10)+" "+(e+31.5)+"L"+(t+20)+" "+e+"Z",contentSize:{width:179,height:63},entryPoints:[[89.5,0],[169,31.5],[89.5,63],[10,31.5]]}},trapeziumReverse:function(){var t=(s.width-2*s.padding-179)/2+.5,e=(s.height-2*s.padding-63)/2+.5;return{path:"M"+t+" "+e+"L"+(t+89.5)+" "+e+"L"+(t+179)+" "+e+"L"+(t+179)+" "+e+"L"+(t+169)+" "+(e+31.5)+"L"+(t+159)+" "+(e+63)+"L"+(t+159)+" "+(e+63)+"L"+(t+89.5)+" "+(e+63)+"L"+(t+20)+" "+(e+63)+"L"+(t+20)+" "+(e+63)+"L"+(t+10)+" "+(e+31.5)+"L"+t+" "+e+"Z",contentSize:{width:179,height:63},entryPoints:[[89.5,0],[169,31.5],[89.5,63],[10,31.5]]}},circle:function(){var e=107,t=107,i=(s.width-2*s.padding-e)/2+.5,a=(s.height-2*s.padding-t)/2+.5,n=e/2,o=n-Math.sqrt(Math.pow(n,2)/2);return{path:"M"+(i+o)+" "+(a+o)+" A"+n+" "+n+" 0 0 1 "+(i+e/2)+" "+a+" A"+n+" "+n+" 0 0 1 "+(i+e-o)+" "+(a+o)+" L"+(i+e-o)+" "+(a+o)+" A"+n+" "+n+" 0 0 1 "+(i+e)+" "+(a+t/2)+" A"+n+" "+n+" 0 0 1 "+(i+e-o)+" "+(a+t-o)+" L"+(i+e-o)+" "+(a+t-o)+"A"+n+" "+n+" 0 0 1 "+(i+e/2)+" "+(a+t)+" A"+n+" "+n+" 0 0 1 "+(i+o)+" "+(a+t-o)+" L"+(i+o)+" "+(a+t-o)+"A"+n+" "+n+" 0 0 1 "+i+" "+(a+t/2)+" A"+n+" "+n+" 0 0 1 "+(i+o)+" "+(a+o)+" Z",contentSize:{width:120,height:t},entryPoints:[[e/2,0],[e,t/2],[e/2,t],[0,t/2]].map(function(t){return t[0]=t[0]+(120-e)/2,t})}},oval:function(){var t=32.5,e=(s.width-2*s.padding-173)/2+.5,i=(s.height-2*s.padding-65)/2+.5;return{path:"M"+(e+t)+" "+i+"L"+(e+86.5)+" "+i+"L"+(e+173-t)+" "+i+"L"+(e+173-t)+" "+i+"A"+t+" "+t+" 0 0 1 "+(e+173)+" "+(i+32.5)+"A"+t+" "+t+" 0 0 1 "+(e+173-t)+" "+(i+65)+"L"+(e+173-t)+" "+(i+65)+"L"+(e+86.5)+" "+(i+65)+"L"+(e+t)+" "+(i+65)+"L"+(e+t)+" "+(i+65)+"A"+t+" "+t+" 0 0 1 "+e+" "+(i+32.5)+"A"+t+" "+t+" 0 0 1 "+(e+t)+" "+i+"Z",contentSize:{width:173,height:65},entryPoints:[[86.5,0],[173,32.5],[86.5,65],[0,32.5]]}},displayShape:function(){var t=(s.width-2*s.padding-179)/2+.5,e=(s.height-2*s.padding-63)/2+.5;return{path:"M"+(t+20)+" "+e+"L"+(t+89.5)+" "+e+"L"+(t+179)+" "+e+"L"+(t+179)+" "+e+"L"+(t+179)+" "+(e+31.5)+"L"+(t+179)+" "+(e+63)+"L"+(t+179)+" "+(e+63)+"L"+(t+89.5)+" "+(e+63)+"L"+(t+20)+" "+(e+63)+"L"+(t+10)+" "+(e+47.25)+"L"+t+" "+(e+31.5)+"L"+(t+10)+" "+(e+63/4)+"Z",contentSize:{width:179,height:63},entryPoints:[[89.5,0],[179,31.5],[89.5,63],[0,31.5]]}}},d=[{value:"rhombus",icon:"rhombus",title:"Decision"},{value:"oval",icon:"oval",title:"Terminator"},{value:"circle",icon:"ring",title:"Circle"},{value:"rectangle",icon:"rectangle",title:"Process"},{value:"parallelogramLeft",icon:"parallelogramLeft",title:"Parallelogram"},{value:"parallelogramRight",icon:"parallelogramRight",title:"Data input"},{value:"trapezium",icon:"trapezium",title:"Trapezium"},{value:"trapeziumReverse",icon:"trapezium_flip",title:"Manual operation"},{value:"triangle",icon:"triangle",title:"Triangle"},{value:"hexagon",icon:"hexagon",title:"Hexagon"},{value:"wavyBottomRectangle",icon:"document",title:"Document"},{value:"wavyRectangle",icon:"wave",title:"Paper tape "},{value:"rectangleOval",icon:"delay",title:"Delay"},{value:"rhombicRectangle",icon:"preparation",title:"Preparation"},{value:"displayShape",icon:"display",title:"Display"}],x=(Snap.filter.shadow(0,0,7,"#58a8f7",.7),Snap.filter.shadow(0,1,2,"#8c9baa",.1),{arrow:'<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13"><path d="M0,6.5a6.5,6.5 0 1,0 13,0a6.5,6.5 0 1,0 -13,0"></path><g fill="none" fill-rule="evenodd"><polygon fill="#FFF" points="3 5 6.5 10 10 5"/></g></svg>',circle:'<svg xmlns="http://www.w3.org/2000/svg" width="5" height="5"><path d="M0,2.5a2.5,2.5 0 1,0 5,0a2.5,2.5 0 1,0 -5,0"></path></svg>',rhombus:'<svg xmlns="http://www.w3.org/2000/svg" width="15" height="15"><path d="M0.292893219,6.70710678 L6.70710678,0.292893219 L6.70710678,0.292893219 C6.89464316,0.10535684 7.14899707,9.36897899e-16 7.41421356,8.8817842e-16 L7.58578644,0 L7.58578644,0 C7.85100293,1.86840084e-16 8.10535684,0.10535684 8.29289322,0.292893219 L14.7071068,6.70710678 L14.7071068,6.70710678 C14.8946432,6.89464316 15,7.14899707 15,7.41421356 L15,7.58578644 L15,7.58578644 C15,7.85100293 14.8946432,8.10535684 14.7071068,8.29289322 L8.29289322,14.7071068 L8.29289322,14.7071068 C8.10535684,14.8946432 7.85100293,15 7.58578644,15 L7.41421356,15 L7.41421356,15 C7.14899707,15 6.89464316,14.8946432 6.70710678,14.7071068 L0.292893219,8.29289322 L0.292893219,8.29289322 C0.10535684,8.10535684 4.85199941e-13,7.85100293 4.85167462e-13,7.58578644 L4.8316906e-13,7.41421356 L4.8316906e-13,7.41421356 C4.83136581e-13,7.14899707 0.10535684,6.89464316 0.292893219,6.70710678 Z"/><g fill="none" fill-rule="evenodd"><path stroke="#FFF" stroke-width="2" d="M1,7.41421356 L1,7.58578644 L7.41421356,14 L7.58578644,14 L14,7.58578644 L14,7.41421356 L7.58578644,1 L7.41421356,1 L1,7.41421356 Z"/></g></svg>'}),f={pathPointModify:function(t,e){return"function"!=typeof e&&(e=function(t){return t}),t.map(function(t){return t.map(e)})},interpolate:function(t,e,i,a){var n,o,s,r,c,l,d=Math.abs,h=[];for(n=t<i?1:-1,o=e<a?1:-1,c=(s=d(i-t))-(r=d(a-e));h.push([t,e]),t!==i||e!==a;)-r<(l=2*c)&&(c-=r,t+=n),l<s&&(c+=s,e+=o);return h},expandPath:function(t){var e,i,a,n,o,s,r=[],c=t.length,l=this.interpolate;if(c<2)return r;for(o=0;o<c-1;++o)for(e=t[o],i=t[o+1],n=(a=l(e[0],e[1],i[0],i[1])).length,s=0;s<n-1;++s)r.push(a[s]);return r.push(t[c-1]),r},compressPath:function(t){if(t.length<3)return t;var e,i,a,n,o,s,r=[],c=t[0][0],l=t[0][1],d=t[1][0],h=t[1][1],u=d-c,p=h-l;for(u/=o=Math.sqrt(u*u+p*p),p/=o,r.push([c,l]),s=2;s<t.length;s++)e=d,i=h,a=u,n=p,u=(d=t[s][0])-e,p=(h=t[s][1])-i,p/=o=Math.sqrt(u*u+p*p),(u/=o)===a&&p===n||r.push([e,i]);return r.push([d,h]),r},shiftPathPoint:function(t,i,a){return t.map(function(t){return t.map(function(t,e){return(t+i[e])*a})})},checkLine:function(t,e,i,a,n){for(var o=t<e?1:-1,s=Math.abs(e-t),r=0,c=0;c<=s;c++){if(a[n]=c*o+t,!i[a[0]])return-1;var l=i[a[0]][a[1]];if(0!=l)return-1;r+=l}return r},findStraightPath:function(t,e,i,a){var n={path:[[t[0],t[1]],[e[0],t[1]],[e[0],e[1]]],pathsLength:[this.checkLine(t[0],e[0],i,[0,t[1]],[0]),this.checkLine(t[1],e[1],i,[e[0],0],[1])]},o={path:[[t[0],t[1]],[t[0],e[1]],[e[0],e[1]]],pathsLength:[this.checkLine(t[1],e[1],i,[t[0],0],[1]),this.checkLine(t[0],e[0],i,[0,e[1]],[0])]},s=(1==a||3==a?[n,o]:[o,n]).find(function(t){return t.pathsLength.every(function(t){return-1<t})});return s?this.expandPath(s.path):[]},findAnyPath:function(t,e,i){var a=new PF.Grid(transponse2d(i));return new PF.BreadthFirstFinder({allowDiagonal:!1}).findPath(t[0],t[1],e[0],e[1],a)},find:function(t,e,i){var a=this.pathPointModify(e,function(t){return 1*!t});if((t=t.filter(function(t){return 1===safetyObjectAccess(e,t,0)})).length<2)return[];var d=function(t,e,i,a){var n=this.findStraightPath(t,e,i,a);return n.length||(n=this.findAnyPath(t,e,i)),n}.bind(this),h=function(e,t){t.forEach(function(t){safetyObjectOverwriting(e,t,1)})},n=function(t,e,i,a,n){var o=t,s=[],r=[];a&&o.reverse();for(var c=1;c<o.length;c++){r.length&&!n&&h(e,r.slice(0,r.length-1));var l=d(t[c-1],t[c],e,i);if(!l.length)return!1;Array.prototype.push.apply(s,l.slice(!!(c-1)+0)),r=l}return a&&s.reverse(),s};return this.compressPath(n(t,cloneMatrix(a),i,!1,!1)||n(t,cloneMatrix(a),i,!0,!1)||n(t,cloneMatrix(a),i,!1,!0)||n(t,cloneMatrix(a),i,!0,!0))}},h={svg:function(c,i){var a={destination:"",state:0,emit:function(t,e){"function"==typeof i&&(this.description=void 0===e?this.description:e,void 0!==t&&(this.state=t),i(this.state,this.description))}},v=s,e=c.id,u={},p={},b={titleFontSize:64,textColor:"#52565f",transparent:!1,background:"#ffffff",backgroundBorder:40,canvasBackground:"#ffffff",lineColor:"#4d9ef6",lineDashArray:"0 0",lineIconBackground:"#58a8f7",cardRadius:3,cardShadowColor:"rgba(140,155,170,.15)",cardShadowOffsetX:0,cardShadowOffsetY:1,cardShadowBlur:2,cardBackground:"#ffffff",cardBorderSize:1,cardBorderColor:"#dee7ec",cardUndefinedTitle:"DELETED PAGE",cardImageHeight:185,cardTitleColor:"#52565F",defaultSchemeFigure:"rectangle",figureBorderColor:"#4d96e0",figureBorderSize:2,figureBackground:"#ffffff",figureTextColor:"#52565F",figureTextPadding:15,figureFontSize:14,figureLineHeight:19,figureShadowColor:"rgba(140,155,170,.1)",figureShadowOffsetX:0,figureShadowOffsetY:1,figureShadowBlur:3,imgShift:.5},_=(c=Object.assign({},b,c,{transparent:toBoolean(c.transparent),title:toBoolean(c.title),date:toBoolean(c.date)})).border||{x:0,y:0},y=Snap(),n=$("<div></div>").css({position:"fixed",top:"100vh","pointer-events":"none"}).appendTo("body");return n.append($(y.node)),promiseSerialExecute([function(){return a.emit(10,"loading data"),app.serverRequest("getSchema",{id:e}).then(function(t){return t.id==e?(t.list=t.items.map(function(t){return"UFItem"===t.type?(t.size={width:1,height:1},t.data.title=removeHTMLfromString(t.data.title)):"FMItem"===t.type?t.size={width:1,height:2}:"UFImage"===t.type&&(safetyObjectAccess(t,["data","size","width"],!1)&&safetyObjectAccess(t,["data","size","height"],!1)?t.size=t.data.size:t.size={width:1,height:1}),t.coord=objectMap(t.coord,function(t){return 1*t}),t.size=objectMap(t.size,function(t){return 1*t}),t.connectors=[],t}),u=t):Promise.reject("UserFlow schema is not available ")})},function(){return a.emit(15,"creating entity map"),m.prototype.updateMap.call(u),(p=u.map=u._map).gridPathMap=m.prototype.calculateGridPathMap.call(u),Promise.resolve(!0)},function(){a.emit(30,"draw canvas");var t=p.size={width:p.width*v.width,height:p.height*v.height};if(c.transparent||(t.width+=2*c.backgroundBorder,t.height+=2*c.backgroundBorder,_.x+=c.backgroundBorder,_.y+=c.backgroundBorder),c.title){var e=y.text(0,0,u.title);$(e.node).attr({"text-anchor":"middle","font-size":c.titleFontSize,"font-family":"Roboto,sans-serif",fill:c.textColor});var i=e.node.getComputedTextLength()+(c.transparent?0:2*c.backgroundBorder);i>t.width&&(_.x+=(i-t.width)/2,t.width=i),_.y+=2*c.titleFontSize,t.height+=2*c.titleFontSize,e.attr({x:t.width/2,y:c.titleFontSize+(c.transparent?0:c.backgroundBorder)})}c.date&&(t.height+=c.backgroundBorder,$(y.text(t.width-(c.transparent?5:c.backgroundBorder),t.height-(c.transparent?5:c.backgroundBorder),formatDate(app.clientTime(),"dd MM yyyy")).node).attr({"text-anchor":"end","font-size":"14","font-family":"Roboto,sans-serif",fill:c.textColor})),c.transparent||y.rect(0,0,t.width,t.height).attr({fill:c.background}).prependTo(y),console.log(t),y.attr({width:t.width,height:t.height,viewBox:[0,0,t.width,t.height].join(" ")})},function(){var r=[];a.emit(40,"draw lines");var h=Snap();return h.remove(),u.list.forEach(function(s){s.lines.forEach(function(l){if(!l)return!1;var t=s,e=m.prototype.getItem.call(u,l.destination.target);if(!e)return!1;var i=w.prototype.calcPointCoord.call(null,t.coord,t.size,l.departure.point),a=w.prototype.calcPointCoord.call(null,e.coord,e.size,l.destination.point),n=l.color||b.lineColor;t.connectors.push({point:1*l.departure.point,icon:l.departure.connector,color:n,reverse:!1}),e.connectors.push({point:1*l.destination.point,icon:l.destination.connector,color:n,reverse:!0});var o=f.pathPointModify([].concat([i],l.additionalPoints||[],[a]),function(t,e){return 2*(t-(e?p.shiftY:p.shiftX))}),d=f.pathPointModify(f.find(o,p.gridPathMap,l.departure.point),function(t,e){return t/2});d.unshift([t.coord.x-p.shiftX+t.size.width/2,t.coord.y-p.shiftY+t.size.height/2]),d.push([e.coord.x-p.shiftX+e.size.width/2,e.coord.y-p.shiftY+e.size.height/2]),d=d.map(function(t){return[t[0]*v.width,t[1]*v.height]}),$(y.path(svgHelper.buildPath(d.map(function(t){return[t[0]+_.x-.5,t[1]+_.y-.5]}),function(t,e,i){return svgHelper.arcsCommandFor90DegreeAngle(t,e,i,10)})).node).attr({fill:"none",stroke:n,"stroke-width":1,"stroke-dasharray":l.dashArray?l.dashArray:b.lineDashArray}),l.icon&&r.push(app.modules.get("sprites","userflow",l.icon).then(function(t){if(t.dom){var e=$(t.dom.node).clone().removeAttr("id");e.children("path").each(function(){$(this).attr({fill:"#ffffff"})}),y.append(e.get(0));var i=h.path("M"+d.join("L")),a=l.iconCoord?[1*l.iconCoord.x-p.shiftX*v.width,1*l.iconCoord.y-p.shiftY*v.height]:w.prototype.calcCenterPoint(d),n=Snap.closestPoint(i,a[0],a[1]),o=Math.round(n.x+_.x)-.5,s=Math.round(n.y+_.y)-.5,r=e.width(),c=e.height();y.circle(o,s,12).attr({fill:b.lineIconBackground}),y.append(e.get(0)),e.attr({x:o-r/2,y:s-c/2})}}))})}),a.emit(30,"draw lines"),onAllPromiseExecute(r)},function(){a.emit(70,"draw elements");var m=[],f=function(t,e,i){return{x:_.x+(t.x-p.shiftX)*v.width+(v.width*e.width-i.width)/2,y:_.y+(t.y-p.shiftY)*v.height+(v.height*e.height-i.height)/2}},t=ufController.workplace.getModule("flowmap");m.push(t);var g=function(t,l,d){var h=[];t.forEach(function(t){if(!h.includes(t.point)){h.push(t.point);var e=Snap.parse(x[t.icon]||x.circle),i=t.color,a=d[t.point];y.append(e);var n=$(e.node),o=n.width(),s=n.height(),r=Math.round(l.x+a[0])-.5,c=Math.round(l.y+a[1])-.5;n.attr({x:r-o/2,y:c-s/2,transform:"rotate("+[90*t.point+180*!t.reverse,r,c].join(", ")+")"}),n.find("path").attr({fill:i})}})},e={FMItem:function(d){t.then(function(t){var e=t.getCard(d.data.id),i=d.coord,a={width:180,height:220},n=180,o=185,s=e?e.get("title"):b.cardUndefinedTitle,r=e?e.get("cover"):b.cardUndefinedTitle,c=f(i,{width:1,height:2},a),l=function(){g(d.connectors,c,[[a.width/2,0],[a.width,a.height/2],[a.width/2,a.height],[0,a.height/2]])};y.path(RoundedRectPath(c.x,c.y,a.width,a.height,5)).attr({fill:"#ffffff",stroke:"#A2CEF9",strokeWidth:1}),svgHelper.snapWrapText(y,s,16,{"text-anchor":"middle","font-size":"14","font-family":"Roboto,sans-serif",fill:"#52565f"},{x:c.x+a.width/2,y:c.y+a.height-15},a.width-20,2,!0),m.push(toDataURL(r).then(function(i){return l(),new Promise(function(t){var e=y.el("image").attr({x:c.x,y:c.y,width:n,height:o,preserveAspectRatio:"xMidYMin meet"}).node;e.onload=t,e.onerror=t,setTimeout(t,500),e.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",i),l()})}))})},UFItem:function(n){var t={width:v.width,height:v.height},d=n.size||{width:1,height:1},e=n.coord,h=f(e,d,t),i=(k[n.data.figure]||k[b.defaultSchemeFigure])(),a=!(!toBoolean(n.data.icon)||"none"===n.data.icon)&&n.data.icon,o=h.x+v.padding-.5,s=h.y+v.padding-.5;$(y.path(i.path).attr({transform:"translate("+o+", "+s+")"}).node).attr({fill:n.data.bgColor||c.figureBackground,stroke:n.data.borderColor&&!["#ffffff","#FFFFFF"].includes(n.data.borderColor)?n.data.borderColor:c.figureBorderColor,"stroke-width":c.figureBorderSize}),g(n.connectors,{x:h.x+(d.width*v.width-i.contentSize.width)/2,y:h.y+(d.height*v.height-i.contentSize.height)/2},i.entryPoints);var r=$("<p>"+(n.data.title||"")+"</p>").text(),u=function(t,e,i,a){return svgHelper.snapWrapText(y,r,16,{"text-anchor":e,"font-size":"14","font-family":"Roboto,sans-serif",fill:n.data.textColor||"#52565f"},{x:i,y:a+5},t,3,!0)},p=i.contentSize.width-2*b.figureTextPadding;o=Math.round(h.x+v.width*d.width/2),s=Math.round(h.y+v.height*d.height/2);a?m.push(app.modules.get("sprites","userflow",a).then(function(t){if(t.dom){var e=$(t.dom.node).clone().attr("id","");y.append(e.get(0));var i=e.width(),a=e.height(),n=Math.round(h.x+(v.width*d.width-p)/2),o=Math.round(h.y+v.height*d.height/2),s=u(p-i-7,"start",n,o),r=Math.max.apply(Math,s.map(function(t){return $(t.node).width()}));p=r+i+7;var c=Math.round(h.x+(v.width*d.width-p)/2),l=c+i+7;e.attr({x:c,y:o-a/2}),s.forEach(function(t){t.attr({x:l})})}else u(p,"middle",n,o)}.bind(this))):u(p,"middle",o,s)},UFImage:function(t){var a={},e={width:t.size.width||1,height:t.size.height||1},i=t.coord;if(t.data.imageSize)a={width:Math.floor(t.data.imageSize.width),height:Math.floor(t.data.imageSize.height)};else{var n=Math.min((e.width*v.width-2*v.padding)/t.data.meta.width,(e.height*v.height-2*v.padding)/t.data.meta.height);n="svg"===t.data.meta.extension?n:Math.min(1,n),a={width:t.data.meta.width*n,height:t.data.meta.height*n}}var o=f(i,e,a),s=safetyObjectAccess(t,["data","link"],!1),r=function(){g(t.connectors,o,[[a.width/2,0],[a.width,a.height/2],[a.width/2,a.height],[0,a.height/2]])};s?m.push(toDataURL(s).then(function(i){return y.rect(o.x,o.y,a.width,a.height).attr({fill:"#ffffff"}),new Promise(function(t){var e=y.el("image").attr({x:o.x,y:o.y,width:a.width,height:a.height}).node;e.onload=t,e.onerror=t,setTimeout(t,500),e.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",i),r()})})):(y.rect(o.x,o.y,a.width,a.height,10,10),r())}};return u.list.forEach(function(t){e.hasOwnProperty(t.type)?e[t.type](t):y.rect((t.coord.x-p.shiftX)*v.width+_.x,(t.coord.y-p.shiftY)*v.height+_.y,t.size.width*v.width,t.size.height*v.height,10,10)}),onAllPromiseExecute(m)}]).then(function(){a.emit(100,"creating document");var t=(new XMLSerializer).serializeToString(y.node),e=self.URL||self.webkitURL||self,i=new Blob([t],{type:"image/svg+xml"});return y.remove(),n.remove(),{img:e.createObjectURL(i),width:p.size.width,height:p.size.height}})},png:function(t,e){var i=this.svg(t,e);return"png"===t.extension&&(i=i.then(function(e){return imgToPng(e.img,{width:toBoolean(t.size)?t.width:e.width,height:toBoolean(t.size)?t.height:e.height}).then(function(t){return Object.assign(e,{img:t})})})),i}};safetyObjectOverwriting(app,["workplace","modules","userflow"],{key:"userflow",descriptor:{name:"User Flow",description:function(t){return"β"},active:function(t){return!0},urlMatch:function(t){return"userflow"===t.path[0]}},api:{init:function(t){ufController=new e(t)},get:function(){return ufController.ready},implement:function(t,e){return ufController.implement(t,e)},die:function(){if(ufController)return ufController.die()},dom:function(){return ufController.dom}}})}();